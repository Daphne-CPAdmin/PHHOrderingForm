<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Pep Haulers Hub | Order Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Lobster&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fdf8ff;
            --bg-secondary: #fef1f8;
            --bg-card: rgba(255, 255, 255, 0.85);
            --bg-input: rgba(255, 248, 253, 0.9);
            --accent-primary: #e879a9;
            --accent-secondary: #c084fc;
            --accent-gold: #d4a574;
            --accent-rose: #f9a8d4;
            --accent-lavender: #ddd6fe;
            --accent-blush: #fecdd3;
            --accent-glow: #f0abfc;
            --text-primary: #4a1942;
            --text-secondary: #831843;
            --text-muted: #be185d;
            --border: rgba(236, 72, 153, 0.2);
            --border-glow: rgba(240, 171, 252, 0.5);
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Animated Background with Vials */
        body {
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 25%, #fbcfe8 50%, #f472b6 75%, #fce7f3 100%);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(244, 114, 182, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(192, 132, 252, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(240, 171, 252, 0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 20%, rgba(249, 168, 212, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 20% 80%, rgba(221, 214, 254, 0.12) 0%, transparent 45%);
            pointer-events: none;
            z-index: 0;
        }

        /* Floating Vials Background */
        .vial-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .vial {
            position: absolute;
            opacity: 0.08;
            animation: floatVial 20s ease-in-out infinite;
        }

        .vial:nth-child(1) { left: 5%; top: 10%; animation-delay: 0s; }
        .vial:nth-child(2) { left: 15%; top: 60%; animation-delay: -5s; }
        .vial:nth-child(3) { left: 85%; top: 20%; animation-delay: -10s; }
        .vial:nth-child(4) { left: 75%; top: 70%; animation-delay: -15s; }
        .vial:nth-child(5) { left: 45%; top: 85%; animation-delay: -7s; }
        .vial:nth-child(6) { left: 92%; top: 45%; animation-delay: -12s; }
        .vial:nth-child(7) { left: 8%; top: 35%; animation-delay: -3s; }
        .vial:nth-child(8) { left: 60%; top: 5%; animation-delay: -18s; }

        @keyframes floatVial {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(3deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(15px) rotate(-3deg); }
        }

        /* Sparkle Animation */
        .sparkle {
            position: fixed;
            pointer-events: none;
            z-index: 0;
        }

        .sparkle::before, .sparkle::after {
            content: '‚ú¶';
            position: absolute;
            font-size: 12px;
            color: var(--accent-rose);
            animation: twinkle 3s ease-in-out infinite;
        }

        .sparkle:nth-child(1)::before { left: 10%; top: 15%; animation-delay: 0s; }
        .sparkle:nth-child(1)::after { left: 85%; top: 25%; animation-delay: 1s; }
        .sparkle:nth-child(2)::before { left: 75%; top: 60%; animation-delay: 0.5s; }
        .sparkle:nth-child(2)::after { left: 20%; top: 80%; animation-delay: 1.5s; }
        .sparkle:nth-child(3)::before { left: 50%; top: 10%; animation-delay: 2s; }
        .sparkle:nth-child(3)::after { left: 30%; top: 40%; animation-delay: 2.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem; 
            position: relative; 
            z-index: 1; 
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.08);
        }

        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(232, 121, 169, 0.3);
        }

        .nav-tab.admin {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15) 0%, rgba(232, 121, 169, 0.1) 100%);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .nav-tab.admin:hover {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-primary) 100%);
            color: white;
            border-color: transparent;
        }

        /* Header */
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 {
            font-family: 'Lobster', cursive;
            font-size: 4rem;
            font-weight: 400;
            background: linear-gradient(90deg, #9333ea 0%, #c084fc 25%, #f472b6 50%, #ec4899 75%, #dc2626 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.02em;
            animation: shimmer-gradient 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(196, 69, 105, 0.3));
        }
        
        @keyframes shimmer-gradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Shimmering Header Title */
        .header h1 {
            background: linear-gradient(90deg, #9333ea 0%, #c084fc 25%, #f472b6 50%, #ec4899 75%, #dc2626 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer-gradient 3s ease-in-out infinite;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        @keyframes shimmer-gradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        .header-subtitle {
            font-family: 'Lobster', cursive;
            font-size: 1.3rem;
            background: linear-gradient(90deg, #9f1239 0%, #db2777 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 0.75rem;
            letter-spacing: 0.05em;
            text-shadow: 0 0 30px rgba(219, 39, 119, 0.3);
        }
        
        /* Consolidated Stats Section */
        .stats-banner {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(254, 205, 211, 0.7) 50%, rgba(251, 207, 232, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(244, 114, 182, 0.3);
            border-radius: 24px;
            padding: 1.5rem 2rem;
            margin: 1.5rem 0;
            box-shadow: 0 8px 32px rgba(244, 114, 182, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(244, 114, 182, 0.2);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-family: 'Lobster', cursive;
            font-size: 2rem;
            background: linear-gradient(135deg, #be185d 0%, #c084fc 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Individual progress bar for each stat card */
        .stat-progress {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(244, 114, 182, 0.1);
        }
        
        .stat-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
        }
        
        .stat-progress-percentage-label {
            font-weight: 700;
            background: linear-gradient(90deg, #9333ea 0%, #c084fc 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 0.75rem;
        }
        
        .stat-progress-bar {
            height: 18px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 9px;
            overflow: hidden;
            border: 2px solid rgba(244, 114, 182, 0.4);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(244, 114, 182, 0.2);
        }
        
        .stat-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #be185d 0%, #c084fc 50%, #f472b6 100%);
            border-radius: 7px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(190, 24, 93, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
        }
        
        .stat-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            border-radius: 7px;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .stat-progress-fill.goal-reached {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        /* Progress to Goal */
        .goal-section {
            margin-top: 1rem;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .goal-label {
            font-family: 'Lobster', cursive;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .goal-amount {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .goal-bar {
            height: 24px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(251, 207, 232, 0.5));
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(244, 114, 182, 0.3);
            position: relative;
        }
        
        .goal-fill {
            height: 100%;
            background: linear-gradient(90deg, #f472b6 0%, #ec4899 30%, #db2777 60%, #be185d 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .goal-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
            animation: goalShimmer 2s ease-in-out infinite;
        }
        
        @keyframes goalShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .goal-percentage {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            font-size: 0.85rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .goal-reached {
            background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%) !important;
        }
        
        /* Products with Orders Section */
        .orders-summary-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.85) 0%, rgba(221, 214, 254, 0.5) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 0.375rem;
            position: relative;
            z-index: 1;
        }
        
        .orders-summary-title {
            font-family: 'Lobster', cursive;
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .orders-product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .order-product-card {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 16px;
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .order-product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(192, 132, 252, 0.15);
        }
        
        .order-product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .order-product-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.2;
        }
        
        .order-product-code {
            font-size: 0.8rem;
            color: #e11d48;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .order-product-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .order-vials-count {
            color: #e11d48;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .order-kits-count {
            color: #8b5cf6;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .missing-slots {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .kit-complete {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }
        
        /* Complete kits - green border for products with >10 vials OR at least 1 kit */
        .order-product-card.kit-complete-card {
            border: 2px solid #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            position: relative;
        }
        
        .order-product-card.kit-complete-card::before {
            content: "‚úì";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1rem;
            background: #10b981;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
            font-weight: bold;
        }
        
        /* Almost complete indicator - products with >5 vials ordered AND need ‚â§4 vials to complete */
        .order-product-card.almost-complete {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
            position: relative;
        }
        
        .order-product-card.almost-complete::before {
            content: "üî•";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1.2rem;
            background: #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .almost-complete-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }
        
        /* In danger indicator - products with ‚â§5 vials ordered AND need ‚â•5 vials to next kit */
        .order-product-card.in-danger {
            border: 2px solid #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            position: relative;
        }
        
        .order-product-card.in-danger::before {
            content: "‚ö†Ô∏è";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1.2rem;
            background: #ef4444;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .in-danger-badge {
            background: linear-gradient(135deg, #f87171, #ef4444);
            color: #fef3c7;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        /* Rate Banner - Glass Morphism */
        .rate-banner {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 8px 32px rgba(236, 72, 153, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        }

        .rate-item { display: flex; align-items: center; gap: 0.75rem; }
        .rate-label { 
            font-size: 0.75rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            font-weight: 500;
        }
        .rate-value { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 1.25rem; 
            font-weight: 600; 
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .rate-value.amber { 
            background: linear-gradient(135deg, var(--accent-gold) 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Main Grid - Equal width sections */
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 2rem; 
            align-items: start;
            margin-bottom: 500px; /* Extra spacing to allow product dropdown to show at least 7 items */
        }
        .supplier-carts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        @media (max-width: 1024px) { 
            .main-grid { 
                grid-template-columns: 1fr;
                margin-bottom: 500px; /* Same spacing on mobile */
            }
            .supplier-carts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards - Glass Morphism */
        .card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 
                0 8px 32px rgba(232, 121, 169, 0.1),
                0 2px 8px rgba(192, 132, 252, 0.08),
                inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 
                0 12px 40px rgba(232, 121, 169, 0.15),
                0 4px 12px rgba(192, 132, 252, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }

        .card-title .icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(232, 121, 169, 0.3);
        }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            margin-bottom: 0.5rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
        }
        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(232, 121, 169, 0.2);
            border-radius: 14px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(232, 121, 169, 0.05);
        }
        .form-input::placeholder { color: var(--text-muted); opacity: 0.6; }
        .form-input:focus { 
            outline: none; 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 4px rgba(232, 121, 169, 0.15), 0 4px 12px rgba(232, 121, 169, 0.1);
        }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* Toggle - Two Clear Buttons */
        .order-type-toggle { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .toggle-btn {
            padding: 1rem 1.25rem;
            border: 2px solid var(--accent-primary);
            background: rgba(255, 255, 255, 0.8);
            color: var(--accent-primary);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-btn:hover {
            background: rgba(232, 121, 169, 0.1);
            transform: translateY(-2px);
        }
        .toggle-btn.active { 
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); 
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(232, 121, 169, 0.4);
        }

        /* Buttons - Elegant with Glow */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 30px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        .btn:hover::before { left: 100%; }
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(232, 121, 169, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 30px rgba(232, 121, 169, 0.4);
        }
        .btn-secondary { 
            background: rgba(255, 255, 255, 0.8); 
            border: 1px solid rgba(232, 121, 169, 0.3); 
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--accent-primary);
        }
        .btn-violet { 
            background: linear-gradient(135deg, var(--accent-secondary) 0%, #a855f7 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.3);
        }
        .btn-violet:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(192, 132, 252, 0.4);
        }
        .btn-rose { 
            background: linear-gradient(135deg, rgba(249, 168, 212, 0.2) 0%, rgba(244, 114, 182, 0.15) 100%); 
            border: 1px solid var(--accent-rose); 
            color: var(--text-secondary);
        }
        .btn-rose:hover {
            background: linear-gradient(135deg, var(--accent-rose) 0%, #f472b6 100%);
            color: white;
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-full { width: 100%; }

        /* Product Dropdown */
        .product-search-container { position: relative; z-index: 10000; }
        .product-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            max-height: 600px; /* Increased to utilize available space before Products with Active Orders */
            overflow-y: auto;
            z-index: 99999;
            display: none;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .product-dropdown.show { display: block; }
        .product-option {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .product-option:hover { background: rgba(20, 184, 166, 0.1); }
        .product-option.locked { opacity: 0.5; pointer-events: none; }
        .product-option-name { font-weight: 500; margin-bottom: 0.25rem; }
        .product-option-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 1rem; }
        .product-option-meta span { font-family: 'JetBrains Mono', monospace; }
        .locked-badge { background: var(--accent-rose); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* Inventory Stats */
        .inventory-stats {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .inventory-title { font-size: 0.75rem; font-weight: 600; color: var(--accent-emerald); text-transform: uppercase; margin-bottom: 0.75rem; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .inventory-item { text-align: center; }
        .inventory-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; }
        .inventory-value.highlight { color: var(--accent-amber); }
        .inventory-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

        /* Cart */
        .cart-empty { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .cart-items { 
            /* Remove scrolling - show all items */
            overflow-y: visible;
            max-height: none;
        }
        .cart-item {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
        }
        .cart-item-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .cart-item-name { font-weight: 500; }
        .cart-item-code { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-teal); background: rgba(20, 184, 166, 0.1); padding: 2px 8px; border-radius: 4px; }
        .cart-item-details { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary); }
        .cart-item-price { font-family: 'JetBrains Mono', monospace; color: var(--accent-amber); }
        .cart-item-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(244, 63, 94, 0.1);
            color: var(--accent-rose);
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
        }
        .cart-item:hover .cart-item-remove { opacity: 1; }

        .cart-summary {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .summary-row { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem; }
        .summary-row.grand-total { font-size: 1.25rem; font-weight: 700; color: var(--accent-teal); border-top: 2px solid var(--border); margin-top: 0.5rem; padding-top: 1rem; }
        .summary-label { color: var(--text-secondary); }
        .summary-value { font-family: 'JetBrains Mono', monospace; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(88, 28, 135, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #fdf4ff 50%, #fce7f3 100%);
            border: 2px solid #e9d5ff;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(168, 85, 247, 0.25), 0 10px 25px rgba(236, 72, 153, 0.15);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-input);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
        }
        .modal-body { margin-bottom: 1.5rem; }
        .modal-footer { display: flex; gap: 1rem; justify-content: flex-end; }

        /* Order Summary in Modal */
        .order-summary-header { text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(252, 231, 243, 0.9) 0%, rgba(249, 168, 212, 0.7) 100%); border-radius: 12px; margin-bottom: 1.5rem; }
        .order-summary-header h2 { 
            background: linear-gradient(135deg, #be185d 0%, #dc2626 50%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        .order-id { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 1.25rem; 
            background: linear-gradient(135deg, #be185d 0%, #dc2626 50%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .order-items-list { margin-bottom: 1.5rem; }
        .order-item-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .order-item-info { flex: 1; }
        .order-item-qty { color: var(--text-muted); font-size: 0.85rem; }

        /* Payment Upload */
        .payment-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border); }
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .upload-area:hover { border-color: var(--accent-teal); background: rgba(20, 184, 166, 0.05); }
        .upload-area.has-file { border-color: var(--accent-emerald); background: rgba(16, 185, 129, 0.1); }
        .upload-preview { max-width: 200px; max-height: 150px; margin-top: 1rem; border-radius: 8px; }

        /* Full-Width Inventory Section */
        .inventory-full-section {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .inventory-card {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }
        
        /* Darker gradient for products with registered orders */
        .inventory-card.has-orders {
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.25) 0%, rgba(232, 121, 169, 0.3) 50%, rgba(251, 146, 60, 0.2) 100%);
            border: 2px solid var(--accent-purple);
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.2);
        }
        
        .inventory-card.has-orders .inv-card-name {
            color: var(--accent-purple);
            font-weight: 600;
        }
        
        .inventory-card.has-orders .inv-stat-value {
            color: var(--accent-purple);
        }

        .inventory-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(232, 121, 169, 0.15);
            border-color: var(--accent-primary);
        }
        
        .inventory-card.has-orders:hover {
            box-shadow: 0 8px 25px rgba(192, 132, 252, 0.3);
            border-color: var(--accent-purple);
        }
        
        .inventory-card.clickable {
            cursor: pointer;
        }
        
        .inventory-card.clickable:not(.card-locked):hover {
            background: rgba(232, 121, 169, 0.1);
            border-color: var(--accent-primary);
        }
        
        .inventory-card.clickable.has-orders:not(.card-locked):hover {
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.35) 0%, rgba(232, 121, 169, 0.4) 50%, rgba(251, 146, 60, 0.3) 100%);
        }
        
        .inventory-card.clickable:not(.card-locked):active {
            transform: scale(0.98);
        }
        
        .inventory-card.card-locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .inv-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .inv-card-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.3;
            flex: 1;
            padding-right: 0.5rem;
        }

        .inv-card-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-primary);
            background: rgba(232, 121, 169, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .inv-card-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .inv-stat {
            text-align: center;
            flex: 1;
        }

        .inv-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
        }

        .inv-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .inv-card-progress {
            margin-bottom: 0.75rem;
        }

        .inv-progress-bar-full {
            width: 100%;
            height: 8px;
            background: rgba(232, 121, 169, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .inv-card-status {
            text-align: center;
        }

        .inv-product-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
            font-weight: 500;
        }
        .inv-kits-badge {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            background: rgba(232, 121, 169, 0.15);
            color: var(--accent-primary);
        }
        .inv-lock-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .inv-lock-badge.open {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }
        .inv-lock-badge.locked {
            background: rgba(244, 63, 94, 0.15);
            color: #f43f5e;
        }
        .inventory-search {
            margin-bottom: 1rem;
        }
        .inventory-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .inventory-scroll {
            max-height: 350px;
            overflow-y: auto;
        }
        .inv-progress-bar {
            width: 60px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .inv-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Edit Quantity Button */
        .edit-qty-btn {
            background: rgba(232, 121, 169, 0.1);
            border: 1px solid var(--accent-primary);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .edit-qty-btn:hover {
            background: var(--accent-primary);
            transform: scale(1.1);
        }

        /* Returning Customer Banner */
        .returning-customer-banner {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: gentle-pulse 2s infinite;
        }
        @keyframes gentle-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 15px 3px rgba(16, 185, 129, 0.2); }
        }
        .returning-customer-banner .banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .returning-customer-banner strong {
            color: #059669;
        }

        /* Payment QR Buttons */
        .payment-qr-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--accent-primary);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 2px solid var(--accent-primary);
            transition: all 0.2s;
        }
        .payment-qr-btn:hover {
            background: white;
            color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 121, 169, 0.3);
        }

        /* Add to Order Banner */
        .add-to-order-banner {
            background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: var(--accent-primary); box-shadow: 0 0 0 0 rgba(232, 121, 169, 0.4); }
            50% { border-color: var(--accent-purple); box-shadow: 0 0 10px 2px rgba(232, 121, 169, 0.3); }
        }
        .banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .banner-icon {
            font-size: 1.5rem;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .banner-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .banner-text strong {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
        }
        .banner-cancel {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .banner-cancel:hover {
            background: rgba(244, 63, 94, 0.2);
        }

        /* Orders List */
        .orders-section { margin-top: 2rem; }
        .orders-search { margin-bottom: 1rem; }
        .orders-list { max-height: 400px; overflow-y: auto; }
        .order-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .order-card:hover { border-color: var(--accent-teal); transform: translateX(4px); }
        .order-card-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .order-card-id { font-family: 'JetBrains Mono', monospace; color: var(--accent-teal); }
        .order-card-date { font-size: 0.8rem; color: var(--text-muted); }
        .order-card-customer { font-weight: 500; margin-bottom: 0.25rem; }
        .order-card-total { font-family: 'JetBrains Mono', monospace; color: var(--accent-amber); }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-badge.pending { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .status-badge.paid { background: rgba(16, 185, 129, 0.15); color: var(--accent-emerald); }
        .status-badge.unpaid { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        .status-badge.waiting { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .status-badge.locked { background: rgba(139, 92, 246, 0.15); color: var(--accent-violet); }
        .status-badge.cancelled { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); }
        
        /* Order Status Tags */
        .order-status-tag {
            width: 100%;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        
        .order-status-tag.locked {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: #ffffff;
            border: 2px solid #991b1b;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .order-status-tag.paid {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: #ffffff;
            border: 2px solid #065f46;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .order-status-tag.pending-payment {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
            color: #ffffff;
            border: 2px solid #9a3412;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-teal);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-icon { width: 32px; height: 32px; background: var(--accent-teal); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-primary); }

        /* Quantity Controls */
        .qty-input-group { display: flex; align-items: center; gap: 0.5rem; }
        .qty-btn {
            width: 44px;
            height: 44px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 1.25rem;
            cursor: pointer;
        }
        .qty-btn:hover { border-color: var(--accent-teal); color: var(--accent-teal); }
        .qty-input { width: 80px; text-align: center; font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        /* Quantity Control for Inventory Cards */
        .inv-qty-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        .inv-qty-btn {
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .inv-qty-btn:hover {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            border-color: #ec4899;
        }
        .inv-qty-btn:active {
            transform: scale(0.95);
        }
        .inv-qty-input {
            width: 40px;
            height: 24px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--accent-primary);
            border-radius: 8px;
            padding: 0;
        }

        /* Click to Add Button */
        .btn-click-to-add {
            width: 100%;
            padding: 0.5rem;
            background: linear-gradient(135deg, #10b981, #14b8a6);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-click-to-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-click-to-add:active {
            transform: scale(0.95);
        }

        /* Price Display */
        .price-display { background: var(--bg-input); border-radius: 10px; padding: 1rem; margin-top: 1rem; }
        .price-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
        .price-row:last-child { border-bottom: none; }
        .price-label { color: var(--text-secondary); }
        .price-value { font-family: 'JetBrains Mono', monospace; font-weight: 500; }

        /* Progress Bar */
        .kit-progress { margin-top: 0.75rem; }
        .kit-progress-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .kit-progress-bar { height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .kit-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-teal), var(--accent-emerald)); border-radius: 4px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        /* Theme Styles */
        {% if current_theme == 'merry_christmas' %}
        :root {
            --bg-primary: #fef2f2;
            --bg-secondary: #fff7ed;
            --accent-primary: #dc2626;
            --accent-secondary: #16a34a;
            --accent-gold: #f59e0b;
            --text-primary: #7f1d1d;
            --text-secondary: #991b1b;
        }
        body {
            background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 25%, #fef2f2 50%, #dcfce7 75%, #fef2f2 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(220, 38, 38, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(22, 163, 74, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
        }
        {% elif current_theme == 'happy_new_year' %}
        :root {
            --bg-primary: #f0f9ff;
            --bg-secondary: #eff6ff;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-gold: #fbbf24;
            --text-primary: #1e3a8a;
            --text-secondary: #1e40af;
        }
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #eff6ff 25%, #e0e7ff 50%, #ddd6fe 75%, #f0f9ff 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(251, 191, 36, 0.1) 0%, transparent 50%);
        }
        {% elif current_theme == 'chinese_new_year' %}
        :root {
            --bg-primary: #fef2f2;
            --bg-secondary: #fff7ed;
            --accent-primary: #dc2626;
            --accent-secondary: #f59e0b;
            --accent-gold: #fbbf24;
            --text-primary: #991b1b;
            --text-secondary: #b45309;
        }
        body {
            background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 25%, #fef2f2 50%, #fff7ed 75%, #fef2f2 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(220, 38, 38, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(245, 158, 11, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(251, 191, 36, 0.1) 0%, transparent 50%);
        }
        {% elif current_theme == 'summer' %}
        :root {
            --bg-primary: #f0fdf4;
            --bg-secondary: #ecfdf5;
            --accent-primary: #10b981;
            --accent-secondary: #06b6d4;
            --accent-gold: #f59e0b;
            --text-primary: #065f46;
            --text-secondary: #047857;
        }
        body {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 25%, #d1fae5 50%, #a7f3d0 75%, #f0fdf4 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
        }
        {% elif current_theme == 'valentines' %}
        :root {
            --bg-primary: #fdf2f8;
            --bg-secondary: #fce7f3;
            --accent-primary: #ec4899;
            --accent-secondary: #f472b6;
            --accent-gold: #f9a8d4;
            --text-primary: #831843;
            --text-secondary: #9f1239;
        }
        body {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 25%, #fbcfe8 50%, #f9a8d4 75%, #fdf2f8 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(236, 72, 153, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(244, 114, 182, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(249, 168, 212, 0.15) 0%, transparent 50%);
        }
        {% elif current_theme == 'halloween' %}
        :root {
            --bg-primary: #1c1917;
            --bg-secondary: #292524;
            --accent-primary: #f59e0b;
            --accent-secondary: #dc2626;
            --accent-gold: #fbbf24;
            --text-primary: #fbbf24;
            --text-secondary: #f59e0b;
        }
        body {
            background: linear-gradient(135deg, #1c1917 0%, #292524 25%, #3f3f46 50%, #292524 75%, #1c1917 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(245, 158, 11, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(220, 38, 38, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(251, 191, 36, 0.15) 0%, transparent 50%);
        }
        .card, .btn, .form-input {
            background: rgba(41, 37, 36, 0.9) !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
            color: #fbbf24 !important;
        }
        {% elif current_theme == 'holy_week' %}
        :root {
            --bg-primary: #fef3c7;
            --bg-secondary: #fde68a;
            --accent-primary: #92400e;
            --accent-secondary: #78350f;
            --accent-gold: #d97706;
            --text-primary: #78350f;
            --text-secondary: #92400e;
        }
        body {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 25%, #fcd34d 50%, #fde68a 75%, #fef3c7 100%);
        }
        body::before {
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(146, 64, 14, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(120, 53, 15, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(217, 119, 6, 0.08) 0%, transparent 50%);
        }
        {% endif %}
    </style>
</head>
<body>
    <!-- Floating Vials Background -->
    <div class="vial-bg">
        <svg class="vial" width="60" height="120" viewBox="0 0 60 120" fill="none">
            <defs>
                <linearGradient id="vialGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#f9a8d4;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect x="15" y="25" width="30" height="85" rx="5" fill="url(#vialGrad1)" opacity="0.6"/>
            <rect x="20" y="5" width="20" height="25" rx="3" fill="#ddd6fe" opacity="0.8"/>
            <ellipse cx="30" cy="5" rx="12" ry="4" fill="#e879a9" opacity="0.7"/>
            <rect x="22" y="40" width="16" height="50" rx="2" fill="white" opacity="0.3"/>
        </svg>
        <svg class="vial" width="50" height="100" viewBox="0 0 50 100" fill="none">
            <defs>
                <linearGradient id="vialGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ddd6fe;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f9a8d4;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect x="12" y="20" width="26" height="72" rx="4" fill="url(#vialGrad2)" opacity="0.5"/>
            <rect x="16" y="4" width="18" height="20" rx="2" fill="#fecdd3" opacity="0.7"/>
            <ellipse cx="25" cy="4" rx="10" ry="3" fill="#c084fc" opacity="0.6"/>
        </svg>
        <svg class="vial" width="45" height="90" viewBox="0 0 45 90" fill="none">
            <rect x="10" y="18" width="25" height="65" rx="4" fill="#f9a8d4" opacity="0.4"/>
            <rect x="14" y="4" width="17" height="18" rx="2" fill="#ddd6fe" opacity="0.6"/>
            <ellipse cx="22" cy="4" rx="9" ry="3" fill="#e879a9" opacity="0.5"/>
        </svg>
        <svg class="vial" width="55" height="110" viewBox="0 0 55 110" fill="none">
            <rect x="13" y="22" width="29" height="78" rx="5" fill="#c084fc" opacity="0.35"/>
            <rect x="18" y="5" width="19" height="22" rx="3" fill="#fecdd3" opacity="0.5"/>
            <ellipse cx="27" cy="5" rx="11" ry="4" fill="#f9a8d4" opacity="0.4"/>
        </svg>
        <svg class="vial" width="40" height="85" viewBox="0 0 40 85" fill="none">
            <rect x="8" y="16" width="24" height="62" rx="4" fill="#ddd6fe" opacity="0.45"/>
            <rect x="12" y="3" width="16" height="17" rx="2" fill="#f9a8d4" opacity="0.55"/>
            <ellipse cx="20" cy="3" rx="8" ry="3" fill="#c084fc" opacity="0.5"/>
        </svg>
        <svg class="vial" width="48" height="95" viewBox="0 0 48 95" fill="none">
            <rect x="11" y="19" width="26" height="68" rx="4" fill="#fecdd3" opacity="0.4"/>
            <rect x="15" y="4" width="18" height="19" rx="2" fill="#c084fc" opacity="0.5"/>
            <ellipse cx="24" cy="4" rx="9" ry="3" fill="#ddd6fe" opacity="0.45"/>
        </svg>
        <svg class="vial" width="52" height="105" viewBox="0 0 52 105" fill="none">
            <rect x="12" y="21" width="28" height="76" rx="5" fill="#f9a8d4" opacity="0.35"/>
            <rect x="17" y="5" width="18" height="20" rx="3" fill="#ddd6fe" opacity="0.45"/>
            <ellipse cx="26" cy="5" rx="10" ry="3" fill="#e879a9" opacity="0.4"/>
        </svg>
        <svg class="vial" width="42" height="88" viewBox="0 0 42 88" fill="none">
            <rect x="9" y="17" width="24" height="64" rx="4" fill="#c084fc" opacity="0.3"/>
            <rect x="13" y="4" width="16" height="17" rx="2" fill="#fecdd3" opacity="0.5"/>
            <ellipse cx="21" cy="4" rx="8" ry="3" fill="#f9a8d4" opacity="0.4"/>
        </svg>
    </div>

    <!-- Sparkles -->
    <div class="sparkle"></div>
    <div class="sparkle"></div>
    <div class="sparkle"></div>

    <div class="container">
        <!-- Navigation -->
        <nav class="nav-bar">
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="new-order">Customer Order Section</button>
            </div>
            <a href="/admin" class="nav-tab admin">Admin Panel</a>
        </nav>

        <!-- Header -->
        <header class="header">
            <h1>‚ú® Pep Haulers Order Form ‚ú®</h1>
            <p class="header-subtitle">Your access to high purity (99%) affordable peptide reservations</p>
        </header>

        <!-- Consolidated Order Stats Banner - Per Supplier -->
        {% if not order_form_locked %}
        {% for supplier in suppliers %}
        {% set supplier_stats = order_stats.get('by_supplier', {}).get(supplier, {}) %}
        <div class="stats-banner supplier-stats" data-supplier="{{ supplier }}" style="margin-bottom: 1.5rem;">
            <div style="margin-bottom: 0.75rem; font-weight: 600; color: var(--text-primary); font-size: 1.1rem;">
                üìä Order Statistics - {{ supplier }}
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">‚úÖ Total Completed Kits Value</div>
                    <div class="stat-value">${{ "%.2f"|format(supplier_stats.get('total_completed_kits_usd', 0.0)) }}</div>
                    <div class="stat-count">{{ supplier_stats.get('total_completed_kits_count', 0) }} kit{{ 's' if supplier_stats.get('total_completed_kits_count', 0) != 1 else '' }} completed</div>
                    <!-- Progress to Goal for Completed Kits -->
                    <div class="stat-progress">
                        <div class="stat-progress-label">
                            <span>Progress to Goal <span class="stat-progress-percentage-label">{% if order_goal > 0 %}{% set completed_kits_progress = (supplier_stats.get('total_completed_kits_usd', 0.0) / order_goal * 100) %}{% set completed_kits_progress_pct = completed_kits_progress if completed_kits_progress < 100 else 100 %}{{ completed_kits_progress_pct|round(1) }}%{% else %}0.0%{% endif %}</span></span>
                            <span>${{ "%.2f"|format(supplier_stats.get('total_completed_kits_usd', 0.0)) }} / ${{ "%.0f"|format(order_goal) }}</span>
                        </div>
                        {% if order_goal > 0 %}
                            {% set completed_kits_progress = (supplier_stats.get('total_completed_kits_usd', 0.0) / order_goal * 100) %}
                            {% set completed_kits_progress_pct = completed_kits_progress if completed_kits_progress < 100 else 100 %}
                        {% else %}
                            {% set completed_kits_progress_pct = 0 %}
                        {% endif %}
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill{% if completed_kits_progress_pct >= 100 %} goal-reached{% endif %}" style="width: {{ completed_kits_progress_pct|round(1) }}%;"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚ö†Ô∏è Total Incomplete Kits Vial Value</div>
                    <div class="stat-value">${{ "%.2f"|format(supplier_stats.get('total_incomplete_vials_usd', 0.0)) }}</div>
                    <div class="stat-count">{{ supplier_stats.get('total_incomplete_vials_count', 0) }} vial{{ 's' if supplier_stats.get('total_incomplete_vials_count', 0) != 1 else '' }} (incomplete)</div>
                    <!-- Progress to Goal for Incomplete Vials -->
                    <div class="stat-progress">
                        <div class="stat-progress-label">
                            <span>Progress to Goal <span class="stat-progress-percentage-label">{% if order_goal > 0 %}{% set incomplete_vials_progress = (supplier_stats.get('total_incomplete_vials_usd', 0.0) / order_goal * 100) %}{% set incomplete_vials_progress_pct = incomplete_vials_progress if incomplete_vials_progress < 100 else 100 %}{{ incomplete_vials_progress_pct|round(1) }}%{% else %}0.0%{% endif %}</span></span>
                            <span>${{ "%.2f"|format(supplier_stats.get('total_incomplete_vials_usd', 0.0)) }} / ${{ "%.0f"|format(order_goal) }}</span>
                        </div>
                        {% if order_goal > 0 %}
                            {% set incomplete_vials_progress = (supplier_stats.get('total_incomplete_vials_usd', 0.0) / order_goal * 100) %}
                            {% set incomplete_vials_progress_pct = incomplete_vials_progress if incomplete_vials_progress < 100 else 100 %}
                        {% else %}
                            {% set incomplete_vials_progress_pct = 0 %}
                        {% endif %}
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill{% if incomplete_vials_progress_pct >= 100 %} goal-reached{% endif %}" style="width: {{ incomplete_vials_progress_pct|round(1) }}%;"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">üíé Combined Total</div>
                    <div class="stat-value">${{ "%.2f"|format(supplier_stats.get('combined_total_usd', 0.0)) }}</div>
                    <div class="stat-count">Completed Kits + Incomplete Vials</div>
                    <!-- Progress to Goal for Combined -->
                    <div class="stat-progress">
                        <div class="stat-progress-label">
                            <span>Progress to Goal <span class="stat-progress-percentage-label">{% if order_goal > 0 %}{% set combined_progress = (supplier_stats.get('combined_total_usd', 0.0) / order_goal * 100) %}{% set combined_progress_pct = combined_progress if combined_progress < 100 else 100 %}{{ combined_progress_pct|round(1) }}%{% else %}0.0%{% endif %}</span></span>
                            <span>${{ "%.2f"|format(supplier_stats.get('combined_total_usd', 0.0)) }} / ${{ "%.0f"|format(order_goal) }}</span>
                        </div>
                        {% if order_goal > 0 %}
                            {% set combined_progress = (supplier_stats.get('combined_total_usd', 0.0) / order_goal * 100) %}
                            {% set combined_progress_pct = combined_progress if combined_progress < 100 else 100 %}
                        {% else %}
                            {% set combined_progress_pct = 0 %}
                        {% endif %}
                        <div class="stat-progress-bar">
                            <div class="stat-progress-fill{% if combined_progress_pct >= 100 %} goal-reached{% endif %}" style="width: {{ combined_progress_pct|round(1) }}%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        {% if order_form_locked %}
        <!-- Order Form Locked Banner -->
        <div class="locked-banner" style="background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border: 2px solid #ef4444; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
            <h2 style="color: #991b1b; margin-bottom: 0.75rem; font-size: 1.5rem;">Orders Currently Closed</h2>
            <div style="color: #7f1d1d; font-size: 1rem; max-width: 650px; margin: 0 auto;">
                {% if order_form_lock_message %}
                    {{ order_form_lock_message|safe }}
                {% else %}
                    The order form is currently locked. New orders cannot be submitted at this time. Please check back later!
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Timeline Section - Only show when form is locked -->
        {% if order_form_locked %}
        <div id="timeline-section" style="display: none; margin-bottom: 2rem;">
            <div class="card" style="border: 2px solid #fbbf24; background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(251, 191, 36, 0.02) 100%);">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìÖ Order Timeline
                </h2>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Track the latest updates and transaction details</p>
                <div id="timeline-content" style="min-height: 100px;">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading timeline...</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Rate Banner -->
        <div class="rate-banner">
            <div class="rate-item">
                <span class="rate-label">USD to PHP</span>
                <span class="rate-value">‚Ç±{{ "%.2f"|format(exchange_rate) }}</span>
            </div>
            <div class="rate-item">
                <span class="rate-label">Admin Fee</span>
                <span class="rate-value amber">‚Ç±{{ "%.2f"|format(admin_fee) }}</span>
            </div>
            <div class="rate-item">
                <span class="rate-label">Vials/Kit</span>
                <span class="rate-value" style="color: var(--accent-violet);">{{ vials_per_kit }}</span>
            </div>
        </div>

        <!-- View: New / Update Order -->
        <div id="view-new-order" class="view-content">
            <!-- Customer Section and Order Summary Side by Side -->
            <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                <!-- Customer Order Section - Left Half -->
                <div class="card" style="flex: 1; min-width: 0; margin-bottom: 2rem;">
                    <h2 class="card-title"><span class="icon">üì¶</span> Customer Order Section</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1.5rem;">üí° Enter your Name and Telegram username and your existing orders will auto-populate in the Order Summary</p>

                <div class="form-row" style="margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="form-input" id="full-name" placeholder="Juan Dela Cruz" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telegram Username <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="form-input" id="telegram" placeholder="@username" required>
                    </div>
                </div>

                <div class="form-group product-search-container">
                    <label class="form-label">Select Product</label>
                    <input type="text" class="form-input" id="product-search" placeholder="Please enter your Name and Telegram username first..." autocomplete="off" disabled>
                    <div class="product-dropdown" id="product-dropdown">
                        <!-- Products loaded dynamically via JavaScript -->
                    </div>
                    <small id="product-search-hint" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem; display: block; font-weight: 500;">‚ö†Ô∏è Name and Telegram username are required before selecting products</small>
                </div>

                <div id="selected-product" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Selected</label>
                        <div class="form-input" style="background: rgba(20, 184, 166, 0.1); border-color: var(--accent-teal);">
                            <span id="selected-name"></span>
                            <span id="selected-code" style="float: right; font-family: 'JetBrains Mono', monospace; color: var(--accent-teal);"></span>
                        </div>
                    </div>

                    <div class="inventory-stats">
                        <div class="inventory-title">üìä Inventory</div>
                        <div class="inventory-grid">
                            <div class="inventory-item">
                                <div class="inventory-value" id="inv-total-vials">0</div>
                                <div class="inventory-label">Total Vials</div>
                            </div>
                            <div class="inventory-item">
                                <div class="inventory-value" id="inv-kits">0</div>
                                <div class="inventory-label">Kits Generated</div>
                            </div>
                            <div class="inventory-item">
                                <div class="inventory-value" id="inv-remaining">0</div>
                                <div class="inventory-label">Extra Vials</div>
                            </div>
                            <div class="inventory-item">
                                <div class="inventory-value highlight" id="inv-slots">0</div>
                                <div class="inventory-label">Slots Left</div>
                            </div>
                        </div>
                        <div class="kit-progress">
                            <div class="kit-progress-label">
                                <span>Progress to Next Kit</span>
                                <span id="progress-text">0/{{ vials_per_kit }}</span>
                            </div>
                            <div class="kit-progress-bar">
                                <div class="kit-progress-fill" id="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1.25rem;">
                        <label class="form-label">Order Type</label>
                        <div class="order-type-toggle">
                            <button type="button" class="toggle-btn" data-type="Kit">Kit ({{ vials_per_kit }} vials)</button>
                            <button type="button" class="toggle-btn active" data-type="Vial">Per Vial</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <div class="qty-input-group">
                            <button type="button" class="qty-btn" id="qty-minus">‚àí</button>
                            <input type="number" class="form-input qty-input" id="quantity" value="1" min="1">
                            <button type="button" class="qty-btn" id="qty-plus">+</button>
                        </div>
                    </div>

                    <div class="price-display">
                        <div class="price-row">
                            <span class="price-label">Unit Price (USD)</span>
                            <span class="price-value" id="unit-price-usd">$0.00</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Line Total (USD)</span>
                            <span class="price-value" id="line-total-usd">$0.00</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">Line Total (PHP)</span>
                            <span class="price-value" id="line-total-php">‚Ç±0.00</span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary btn-full" style="margin-top: 1.5rem;" id="add-to-cart">Add to Order</button>
                </div>
                </div>

                <!-- Order Summary Section - Right Half -->
                <div style="flex: 1; min-width: 0;">
            <!-- Cart - One per Supplier - Side by Side -->
            <div class="supplier-carts-grid" style="margin-top: 0;">
                {% for supplier in suppliers %}
                <div class="card supplier-cart" data-supplier="{{ supplier }}">
                    <h2 class="card-title"><span class="icon">üõí</span> Order Summary - {{ supplier }}</h2>
                    
                    <!-- Status Tags Container -->
                    <div class="order-summary-status-tags" data-supplier="{{ supplier }}" style="margin-bottom: 1rem;"></div>

                    <!-- Paid Order Section (Locked) -->
                    <div class="paid-order-section" data-supplier="{{ supplier }}" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.05); border: 2px solid var(--accent-emerald); border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <h3 style="font-size: 1rem; font-weight: 700; color: var(--accent-emerald); display: flex; align-items: center; gap: 0.5rem;">
                                <span>üîí</span> Paid Order (Locked)
                            </h3>
                            <div class="paid-order-id" data-supplier="{{ supplier }}" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-muted);"></div>
                        </div>
                        <div class="paid-order-items" data-supplier="{{ supplier }}" style="margin-bottom: 0.75rem;"></div>
                        <div class="paid-order-summary cart-summary" data-supplier="{{ supplier }}" style="border-top: 1px solid rgba(16, 185, 129, 0.2); padding-top: 0.75rem;"></div>
                    </div>

                    <div class="cart-empty" data-supplier="{{ supplier }}">
                        <p>No items yet</p>
                    </div>

                    <!-- New Order Section (for items added after payment) -->
                    <div class="new-order-section" data-supplier="{{ supplier }}" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--accent-amber);">
                        <h3 style="font-size: 1rem; font-weight: 700; color: var(--accent-amber); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ûï</span> New Order
                        </h3>
                        <div class="new-order-items cart-items" data-supplier="{{ supplier }}" style="display: none;"></div>
                        <div class="new-order-summary cart-summary" data-supplier="{{ supplier }}" style="display: none;"></div>
                    </div>

                    <div class="cart-items" data-supplier="{{ supplier }}" style="display: none;"></div>

                    <div class="cart-summary" data-supplier="{{ supplier }}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="summary-label" style="color: var(--text-secondary);">Subtotal (USD)</span>
                            <span class="summary-value summary-usd" data-supplier="{{ supplier }}" style="font-weight: 600;">$0.00</span>
                        </div>
                        <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="summary-label" style="color: var(--text-secondary);">Subtotal (PHP)</span>
                            <span class="summary-value summary-php" data-supplier="{{ supplier }}" style="font-weight: 600;">‚Ç±0.00</span>
                        </div>
                        <div class="summary-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="summary-label" style="color: var(--text-secondary);">Admin Fee</span>
                            <span class="summary-value" style="font-weight: 600;">‚Ç±{{ "%.2f"|format(admin_fee) }}</span>
                        </div>
                        <div class="summary-row grand-total" style="display: flex; justify-content: space-between; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 2px solid var(--accent-amber);">
                            <span class="summary-label" style="color: var(--accent-amber); font-weight: 700; font-size: 1.1rem;">Grand Total</span>
                            <span class="summary-value grand-total-value" data-supplier="{{ supplier }}" style="color: var(--accent-amber); font-weight: 700; font-size: 1.1rem;">‚Ç±0.00</span>
                        </div>
                    </div>

                    <!-- Shipping Details Button (shown for paid orders) -->
                    <div class="shipping-details-button-container" data-supplier="{{ supplier }}" style="margin-top: 1rem; display: none;">
                        <button type="button" class="btn btn-primary btn-full add-shipping-details-btn" data-supplier="{{ supplier }}">üì¨ Add Shipping Details</button>
                    </div>

                    <!-- Button container for dynamic buttons (always visible, buttons controlled by JS) -->
                    <div class="order-action-buttons" data-supplier="{{ supplier }}" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <button type="button" class="btn btn-violet btn-full submit-order" data-supplier="{{ supplier }}" disabled>Submit Order - {{ supplier }}</button>
                        <button type="button" class="btn btn-amber btn-full create-new-order-btn" data-supplier="{{ supplier }}" style="display: none;">‚ûï Create New Order</button>
                        <button type="button" class="btn btn-violet btn-full update-order-btn" data-supplier="{{ supplier }}" style="display: none;">Update Order</button>
                        <button type="button" class="btn btn-emerald btn-full pay-order-btn" data-supplier="{{ supplier }}" style="display: none;">üí≥ Pay Order</button>
                        <button type="button" class="btn btn-rose btn-full cancel-order-btn" data-supplier="{{ supplier }}" style="display: none;">üóëÔ∏è Cancel Order</button>
                    </div>
                    {% if order_form_locked %}
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(156, 163, 175, 0.1); border-radius: 8px; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                        üîí Orders are currently closed. You can still pay for existing orders.
                    </div>
                    {% endif %}

                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Customer Summary Section (shown when order form is closed) - Full Width -->
        {% if order_form_locked %}
        <div class="orders-summary-section" id="customer-summary-section">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="background: linear-gradient(135deg, #e879a9, #c084fc); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 1.5rem;">üìä</span>
                </div>
                <div>
                    <h3 class="orders-summary-title" style="margin: 0;">Customer Summary</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">Your order overview</p>
                </div>
            </div>
            
            <div id="customer-summary-content" style="min-height: 100px;">
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <p>Loading orders...</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- View My Orders Section -->
        <div id="my-orders-section" class="orders-summary-section" style="display: none;">
            <div class="card">
                <h2 class="card-title"><span class="icon">üì¶</span> My Orders</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">View and manage your orders</p>
                
                <div style="margin-bottom: 1rem;">
                    <input type="text" class="form-input" id="my-orders-search" placeholder="üîç Search by Order ID or product..." style="max-width: 400px;">
                </div>
                
                <div id="my-orders-list" style="display: grid; gap: 1rem;">
                    <!-- Orders populated by JavaScript -->
                </div>
                
                <div id="my-orders-empty" style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
                    <p>No orders found. Create your first order above!</p>
                </div>
            </div>
        </div>

        <!-- Incomplete Kits Section - One per Supplier -->
        {% if not order_form_locked %}
        {% for supplier in suppliers %}
        <div class="orders-summary-section supplier-incomplete-kits" data-supplier="{{ supplier }}" style="border: 2px solid #f472b6;">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="background: linear-gradient(135deg, #f472b6, #c084fc); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                </div>
                <div>
                    <h3 class="orders-summary-title" style="margin: 0;">Incomplete Kits - {{ supplier }}</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">Products needing more vials to complete a kit (1 kit = 10 vials)</p>
                </div>
            </div>
            {% set supplier_incomplete_kits = incomplete_kits_by_supplier.get(supplier, []) %}
            {% if supplier_incomplete_kits and supplier_incomplete_kits|length > 0 %}
            <div class="table-container" style="margin-top: 1rem; background: rgba(255, 255, 255, 0.4); padding: 1rem; border-radius: 12px;">
                <table class="products-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Product Name</th>
                            <th style="text-align: center;">Code</th>
                            <th style="text-align: center;">Total Vials</th>
                            <th style="text-align: center;">Kits Generated</th>
                            <th style="text-align: center;">Extra Vials</th>
                            <th style="text-align: center;">Vials Needed to Complete Kit</th>
                            <th style="text-align: center;">Pep Hauler/s</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in supplier_incomplete_kits %}
                        {% set total_vials = product.inventory.total_vials %}
                        {% set vials_per_kit = product.vials_per_kit or 10 %}
                        {% set kits_generated = product.inventory.kits_generated %}
                        {% set remaining_vials = total_vials % vials_per_kit %}
                        {% set pending_vials = vials_per_kit - remaining_vials %}
                        {% set pep_haulers = product.pep_haulers or [] %}
                        {% if pending_vials <= 2 %}
                            {% set row_bg = 'rgba(167, 139, 250, 0.15)' %}
                            {% set badge_bg = 'rgba(167, 139, 250, 0.3)' %}
                            {% set badge_color = '#7c3aed' %}
                        {% elif pending_vials <= 5 %}
                            {% set row_bg = 'rgba(249, 168, 212, 0.15)' %}
                            {% set badge_bg = 'rgba(249, 168, 212, 0.3)' %}
                            {% set badge_color = '#ec4899' %}
                        {% elif pending_vials <= 8 %}
                            {% set row_bg = 'rgba(244, 114, 182, 0.2)' %}
                            {% set badge_bg = 'rgba(244, 114, 182, 0.35)' %}
                            {% set badge_color = '#db2777' %}
                        {% else %}
                            {% set row_bg = 'rgba(244, 114, 182, 0.25)' %}
                            {% set badge_bg = 'rgba(244, 114, 182, 0.4)' %}
                            {% set badge_color = '#be185d' %}
                        {% endif %}
                        <tr style="background: {{ row_bg }};">
                            <td style="font-weight: 500; text-align: center;">{{ product.name }}</td>
                            <td style="text-align: center;"><span class="product-code">{{ product.code }}</span></td>
                            <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600; text-align: center;">{{ total_vials }}</td>
                            <td style="text-align: center;"><span class="kits-badge normal">{{ kits_generated }}</span></td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: #ec4899; font-weight: 600; text-align: center;">{{ remaining_vials }}</td>
                            <td style="text-align: center;">
                                <span style="display: inline-block; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: {{ badge_bg }}; color: {{ badge_color }};">
                                    {{ pending_vials }} vial{{ 's' if pending_vials != 1 else '' }}
                                </span>
                            </td>
                            <td style="text-align: center;">
                                {% if pep_haulers and pep_haulers|length > 0 %}
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: center;">
                                        {% for username in pep_haulers %}
                                            {% set first_char = username[0] if username else 'a' %}
                                            {% set last_char = username[-1] if username else 'z' %}
                                            {% set char_code_sum = (first_char|length * 7 + last_char|length * 3 + username|length) %}
                                            {% set color_index = char_code_sum % 10 %}
                                            {% if color_index == 0 %}
                                                {% set badge_bg = 'rgba(124, 58, 237, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(124, 58, 237, 0.5)' %}
                                            {% elif color_index == 1 %}
                                                {% set badge_bg = 'rgba(139, 92, 246, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(139, 92, 246, 0.5)' %}
                                            {% elif color_index == 2 %}
                                                {% set badge_bg = 'rgba(168, 85, 247, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(168, 85, 247, 0.5)' %}
                                            {% elif color_index == 3 %}
                                                {% set badge_bg = 'rgba(219, 39, 119, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(219, 39, 119, 0.5)' %}
                                            {% elif color_index == 4 %}
                                                {% set badge_bg = 'rgba(236, 72, 153, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(236, 72, 153, 0.5)' %}
                                            {% elif color_index == 5 %}
                                                {% set badge_bg = 'rgba(190, 24, 93, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(190, 24, 93, 0.5)' %}
                                            {% elif color_index == 6 %}
                                                {% set badge_bg = 'rgba(147, 51, 234, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(147, 51, 234, 0.5)' %}
                                            {% elif color_index == 7 %}
                                                {% set badge_bg = 'rgba(107, 33, 168, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(107, 33, 168, 0.5)' %}
                                            {% elif color_index == 8 %}
                                                {% set badge_bg = 'rgba(79, 70, 229, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(79, 70, 229, 0.5)' %}
                                            {% else %}
                                                {% set badge_bg = 'rgba(99, 102, 241, 0.4)' %}
                                                {% set badge_text = '#ffffff' %}
                                                {% set badge_shadow = '0 0 8px rgba(99, 102, 241, 0.5)' %}
                                            {% endif %}
                                            <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: {{ badge_bg }}; color: {{ badge_text }}; text-shadow: {{ badge_shadow }}; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                                                @{{ username }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span style="color: var(--text-muted); font-size: 0.85rem;">‚Äî</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <p style="font-size: 1rem; margin-bottom: 0.5rem;">üéâ All kits are complete!</p>
                <p style="font-size: 0.85rem;">No incomplete kits found</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        <!-- Products with Active Orders Summary - One per Supplier -->
        {% if not order_form_locked %}
        {% for supplier in suppliers %}
        <div class="orders-summary-section supplier-active-orders" data-supplier="{{ supplier }}">
            <h3 class="orders-summary-title">üõí Products with Active Orders - {{ supplier }}</h3>
            {% set supplier_products = products_with_orders_by_supplier.get(supplier, []) %}
            {% if supplier_products and supplier_products|length > 0 %}
            <div class="orders-product-grid">
                {% for product in supplier_products %}
                {% set total_vials = product.inventory.total_vials %}
                {% set kits_generated = product.inventory.kits_generated %}
                {% set slots_needed = product.inventory.slots_to_next_kit %}
                {% set has_remaining = product.inventory.remaining_vials > 0 %}
                {% set is_complete_kit = total_vials > 10 or kits_generated >= 1 %}
                {% set is_almost_complete = total_vials > 5 and slots_needed <= 4 and slots_needed > 0 and has_remaining %}
                {% set is_in_danger = total_vials <= 5 and slots_needed >= 5 and slots_needed > 0 and has_remaining %}
                <div class="order-product-card {% if is_complete_kit %}kit-complete-card{% elif is_almost_complete %}almost-complete{% elif is_in_danger %}in-danger{% endif %}">
                    <div class="order-product-info">
                        <div class="order-product-name">{{ product.name }}</div>
                        <div class="order-product-code">{{ product.code }}</div>
                    </div>
                    <div class="order-product-stats">
                        <span class="order-vials-count">{{ total_vials }} vials</span>
                        {% if kits_generated > 0 %}
                        <span class="order-kits-count">{{ kits_generated }} kit{{ 's' if kits_generated != 1 else '' }}</span>
                        {% endif %}
                        {% if is_complete_kit %}
                        {% if kits_generated > 0 %}
                        <span class="missing-slots kit-complete">‚úì {{ kits_generated }} kit{{ 's' if kits_generated != 1 else '' }} complete</span>
                        {% else %}
                        <span class="missing-slots kit-complete">‚úì {{ total_vials }} vials ordered</span>
                        {% endif %}
                        {% elif is_almost_complete %}
                        <span class="almost-complete-badge">‚ö° {{ slots_needed }} to next kit</span>
                        {% elif is_in_danger %}
                        <span class="in-danger-badge">‚ö†Ô∏è {{ slots_needed }} to next kit</span>
                        {% elif slots_needed > 0 and has_remaining %}
                        <span class="missing-slots">{{ slots_needed }} to next kit</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <p style="font-size: 1rem; margin-bottom: 0.5rem;">üì¶ No product orders yet</p>
                <p style="font-size: 0.85rem;">Orders will appear here once customers start ordering</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        <!-- Live Product Inventory Section - One per Supplier -->
        {% for supplier in suppliers %}
        <div class="orders-summary-section supplier-inventory" data-supplier="{{ supplier }}">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="background: linear-gradient(135deg, #ec4899, #8b5cf6); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 1.5rem;">üìä</span>
                </div>
                <div>
                    <h3 class="orders-summary-title" style="margin: 0;">Live Product Inventory - {{ supplier }}</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">Real-time tracking of peptide reservations and kit availability</p>
                </div>
            </div>

            <div class="inventory-search" style="max-width: 400px; margin-bottom: 1.5rem;">
                <input type="text" class="form-input inventory-search-input" data-supplier="{{ supplier }}" placeholder="üîç Search products by name or code...">
            </div>

            <div class="inventory-grid">
                {% for product in products_by_supplier.get(supplier, []) %}
                <div class="inventory-card {% if product.inventory.total_vials > 0 %}has-orders{% endif %} {% if product.inventory.is_locked %}card-locked{% endif %}"
                     data-code="{{ product.code }}"
                     data-name="{{ product.name }}"
                     data-supplier="{{ supplier }}"
                     data-kit-price="{{ product.kit_price }}"
                     data-vial-price="{{ product.vial_price }}">
                    <div class="inv-card-header">
                        <span class="inv-card-name">{{ product.name }}</span>
                        <span class="inv-card-code">{{ product.code }}</span>
                    </div>
                    <div class="inv-card-prices" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(232, 121, 169, 0.1); border-radius: 8px; display: flex; justify-content: space-between; gap: 1rem; font-size: 0.85rem;">
                        <div style="flex: 1;">
                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Kit Price</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary);">
                                ${{ "%.2f"|format(product.kit_price) }} <span style="color: var(--text-secondary);">(‚Ç±{{ "%.2f"|format(product.kit_price * exchange_rate) }})</span>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Vial Price</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary);">
                                ${{ "%.2f"|format(product.vial_price) }} <span style="color: var(--text-secondary);">(‚Ç±{{ "%.2f"|format(product.vial_price * exchange_rate) }})</span>
                            </div>
                        </div>
                    </div>
                    <div class="inv-card-stats">
                        <div class="inv-stat">
                            <span class="inv-stat-value">{{ product.inventory.kits_generated }}</span>
                            <span class="inv-stat-label">KITS</span>
                            <div class="inv-qty-control" style="margin-top: 0.5rem;">
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Kit', -1)">‚àí</button>
                                <input type="number" class="inv-qty-input" id="inv-kit-qty-{{ product.code }}" value="0" min="0" max="99" readonly>
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Kit', 1)">+</button>
                            </div>
                        </div>
                        <div class="inv-stat">
                            <span class="inv-stat-value">{{ product.inventory.total_vials }}</span>
                            <span class="inv-stat-label">VIALS</span>
                            <div class="inv-qty-control" style="margin-top: 0.5rem;">
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Vial', -1)">‚àí</button>
                                <input type="number" class="inv-qty-input" id="inv-vial-qty-{{ product.code }}" value="0" min="0" max="99" readonly>
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Vial', 1)">+</button>
                            </div>
                        </div>
                        <div class="inv-stat">
                            <span class="inv-stat-value">{{ product.inventory.remaining_vials }}/{{ product.vials_per_kit }}</span>
                            <span class="inv-stat-label">NEXT KIT</span>
                        </div>
                    </div>
                    <div class="inv-card-progress">
                        <div class="inv-progress-bar-full">
                            <div class="inv-progress-fill" style="width: {{ (product.inventory.remaining_vials / product.vials_per_kit * 100)|int if product.vials_per_kit > 0 else 0 }}%;"></div>
                        </div>
                    </div>
                    <div class="inv-card-status">
                        {% if product.inventory.is_locked %}
                        <span class="inv-lock-badge locked">üîí Locked</span>
                        {% else %}
                        <button class="btn-click-to-add" onclick="quickAddToCart('{{ product.code }}', '{{ product.name }}', '{{ supplier }}')">
                            ‚ú® Click to Add
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- Price Comparison Section - At Bottom -->
        {% if price_comparison|length > 0 %}
        <div class="orders-summary-section" style="margin-top: 2rem;">
            <div class="card">
                <h2 class="card-title"><span class="icon">üí∞</span> Price Comparison: YIWU vs WWB</h2>
                
                {% set ns = namespace(count=0) %}
                {% for item in price_comparison %}
                    {% if item.available_in_wwb %}
                        {% set diff = item.yiwu_kit_price - item.wwb_kit_price %}
                        {% if diff < 0 %}
                            {% set ns.count = ns.count + 1 %}
                        {% endif %}
                    {% else %}
                        {% set ns.count = ns.count + 1 %}
                    {% endif %}
                {% endfor %}
                
                <div class="table-container" style="overflow-x: auto; margin-top: 1.5rem;">
                    <table class="products-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Product Code</th>
                                <th style="text-align: left;">Product Name</th>
                                <th style="text-align: center;">YIWU Kit Price</th>
                                <th style="text-align: center;">WWB Kit Price</th>
                                <th style="text-align: center;">Price Difference</th>
                                <th style="text-align: center;">Remarks <span style="color: var(--accent-violet); font-weight: bold;">‚úì: {{ ns.count }}</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in price_comparison %}
                            {% if item.available_in_wwb %}
                                {% set diff = item.yiwu_kit_price - item.wwb_kit_price %}
                                {% set has_checkmark = diff < 0 %}
                            {% else %}
                                {% set diff = 0 %}
                                {% set has_checkmark = True %}
                            {% endif %}
                            <tr style="{% if has_checkmark %}background: rgba(192, 132, 252, 0.15);{% elif item.available_in_wwb %}background: rgba(192, 132, 252, 0.05);{% else %}background: rgba(239, 68, 68, 0.05);{% endif %}">
                                <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-violet);">
                                    {{ item.code }}
                                </td>
                                <td>{{ item.name }}</td>
                                <td style="text-align: center; font-weight: 600;">
                                    ${{ "%.2f"|format(item.yiwu_kit_price) }}
                                </td>
                                <td style="text-align: center; font-weight: 600; {% if item.available_in_wwb %}color: var(--accent-emerald);{% else %}color: var(--text-muted);{% endif %}">
                                    {% if item.available_in_wwb %}
                                        ${{ "%.2f"|format(item.wwb_kit_price) }}
                                    {% else %}
                                        <span style="color: var(--text-muted);">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center; font-weight: 700; {% if item.available_in_wwb %}{% if diff < 0 %}color: var(--accent-emerald);{% elif diff > 0 %}color: var(--accent-rose);{% else %}color: var(--text-primary);{% endif %}{% else %}color: var(--text-muted);{% endif %}">
                                    {% if item.available_in_wwb %}
                                        {% if diff < 0 %}
                                            -${{ "%.2f"|format(-diff) }}
                                        {% elif diff > 0 %}
                                            +${{ "%.2f"|format(diff) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    {% else %}
                                        <span style="color: var(--text-muted);">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center;">
                                    {% if item.available_in_wwb %}
                                        {% if diff < 0 %}
                                            <span style="color: var(--accent-violet); font-size: 1.2rem; font-weight: bold;" title="YIWU is cheaper">‚úì</span>
                                        {% elif diff > 0 %}
                                            <span style="color: var(--accent-violet); font-size: 1.2rem; font-weight: bold;" title="YIWU is more expensive">‚ö†</span>
                                        {% else %}
                                            <span style="color: var(--text-muted); font-size: 1rem;">‚Äî</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: var(--accent-violet); font-size: 1.2rem; font-weight: bold;" title="YIWU only product">‚úì</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- Order Confirmation Modal (Before Submission) -->
    <div class="modal" id="order-confirmation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Review Your Order</h3>
                <button class="modal-close" onclick="closeModal('order-confirmation-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Please review your order before submitting. You can remove items if needed.</p>
                
                <div id="confirmation-items-list" style="margin-bottom: 1.5rem;">
                    <!-- Items will be populated here -->
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (USD)</span>
                        <span class="summary-value" id="confirmation-subtotal-usd">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (PHP)</span>
                        <span class="summary-value" id="confirmation-subtotal-php">‚Ç±0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Admin Fee</span>
                        <span class="summary-value">‚Ç±{{ "%.2f"|format(admin_fee) }}</span>
                    </div>
                    <div class="summary-row grand-total">
                        <span class="summary-label">Grand Total</span>
                        <span class="summary-value" id="confirmation-grand-total">‚Ç±0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('order-confirmation-modal')">Cancel</button>
                <button class="btn btn-violet" id="confirm-submit-btn" onclick="confirmOrderSubmission()">Confirm & Submit Order</button>
            </div>
        </div>
    </div>

    <!-- Order Summary Modal (After Submission) -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Submitted!</h3>
                <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="order-summary-header">
                    <h2>Thank You!</h2>
                    <div class="order-id" id="modal-order-id">ORD-123456</div>
                </div>

                <div class="pep-haul-message" style="background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 2px dashed #d946ef; text-align: center;">
                    <p style="font-size: 1.1rem; font-weight: 600; color: #a855f7; margin-bottom: 0.75rem;">Hello Pep Hauler! üíú</p>
                    <p style="font-size: 0.95rem; color: #7c3aed; line-height: 1.6; margin-bottom: 0.5rem;">
                        <strong style="color: #ec4899;">Please SCREENSHOT or SAVE this Total Summary!</strong>
                    </p>
                    <p style="font-size: 0.85rem; color: #9333ea; line-height: 1.5; margin-bottom: 0.75rem;">
                        This on-screen summary serves as your official reference for all current reservations and totals.
                    </p>
                    
                    <p style="font-size: 0.95rem; font-weight: 500; color: #d946ef; margin-top: 0.5rem;">
                        Thank you for joining the Pep Haul! ‚ú®
                    </p>
                </div>

                <div class="order-items-list" id="modal-items"></div>

                <div class="cart-summary">
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (USD)</span>
                        <span class="summary-value" id="modal-subtotal-usd">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (PHP)</span>
                        <span class="summary-value" id="modal-subtotal-php">‚Ç±0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Admin Fee</span>
                        <span class="summary-value">‚Ç±{{ "%.2f"|format(admin_fee) }}</span>
                    </div>
                    <div class="summary-row grand-total">
                        <span class="summary-label">Grand Total</span>
                        <span class="summary-value" id="modal-grand-total">‚Ç±0.00</span>
                    </div>
                </div>

                <!-- Payment Instructions -->
                <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(20, 184, 166, 0.1)); border-radius: 12px;">
                    <p style="font-size: 1rem; font-weight: 600; color: var(--accent-emerald); margin-bottom: 0.5rem;">üì± Order submitted successfully!</p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Enter your Telegram username in the form to view and update your orders</p>
                    <button class="btn btn-primary" onclick="closeModal('order-modal');">
                        Got it!
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('order-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="order-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <button class="modal-close" onclick="closeModal('order-details-modal')">&times;</button>
            </div>
            <div class="modal-body" id="order-details-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer" id="order-details-footer">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Cancel Order Confirmation Modal -->
    <div class="modal" id="cancel-order-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #ef4444;">‚ö†Ô∏è Cancel Order</h3>
                <button class="modal-close" onclick="closeModal('cancel-order-modal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üóëÔ∏è</div>
                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Are you sure you want to cancel this order?</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                    This action <strong>cannot be undone</strong>.<br>
                    Your order will be permanently deleted and all product reservations will be released.<br>
                    You will need to create a <strong>new order</strong> to reserve products again.
                </p>
                <div id="cancel-countdown" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-rose); margin-bottom: 1.5rem; min-height: 2rem;"></div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="undo-cancel-btn" onclick="undoCancelOrder()" style="min-width: 150px;">Undo (5s)</button>
                <button class="btn btn-rose" id="confirm-cancel-btn" onclick="confirmCancelOrder()" style="min-width: 150px;">Yes, Cancel Order</button>
            </div>
        </div>
    </div>


    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üí≥ Make Payment</h3>
                <button class="modal-close" onclick="closeModal('payment-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-section" style="padding: 1.5rem; background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 16px; border: 2px solid var(--accent-primary);">
                    <!-- Payment QR Options -->
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-align: center;">Choose your payment method:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1rem;">
                        <a href="https://drive.google.com/file/d/1-Fbib327N9RXsGH4rtHGTtitag5-UbLl/view?usp=drive_link" target="_blank" class="payment-qr-btn">GCash</a>
                        <a href="https://drive.google.com/file/d/1RF4q3tZhzohS_Ic3-WdA83xpWgYLU1WY/view?usp=drive_link" target="_blank" class="payment-qr-btn">Maya</a>
                        <a href="https://drive.google.com/file/d/1k2aR2xHxLWaAY4T0JMzo0i7dHXUZ5V_b/view?usp=drive_link" target="_blank" class="payment-qr-btn">BPI</a>
                        <a href="https://drive.google.com/file/d/1jhlG1vlTarnNxvji__QtzwrtIGhlNa6f/view?usp=drive_link" target="_blank" class="payment-qr-btn">UnionBank</a>
                        <a href="https://drive.google.com/file/d/1P7KvA5Sgk0yl4L-Kn_W2OV4ek3HSueFU/view?usp=drive_link" target="_blank" class="payment-qr-btn">CIMB</a>
                        <a href="https://drive.google.com/file/d/1kuBfTepRzzNfvuXh9-kgz29-Dccvhjuh/view?usp=drive_link" target="_blank" class="payment-qr-btn">MariBank</a>
                        <a href="https://drive.google.com/file/d/12dqI1EVUNCI_V3Ht4zYaFHLLzEhvysfT/view?usp=sharing" target="_blank" class="payment-qr-btn">GoTyme</a>
                    </div>
                    
                    <!-- Friendly Reminder -->
                    <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px dashed var(--accent-purple);">
                        <p style="font-size: 0.95rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 0.5rem; text-align: center;">‚ú® Friendly Pep_Haul Reminder! ‚ú®</p>
                        <p style="font-size: 0.85rem; color: var(--text-secondary);">Please leave the <strong>Notes section blank</strong>, pretty please! üß¨üí´ If you must write something, just your <strong>telegram username</strong> is perfect.</p>
                        <p style="font-size: 0.85rem; color: #ef4444; margin-top: 0.5rem;">‚ùå No "peptide payment," "payment," or anything super serious like that.</p>
                        <p style="font-size: 0.85rem; color: var(--accent-primary); text-align: center; margin-top: 0.5rem;">Thank you! üíïü•∞</p>
                    </div>
                    
                    <!-- Order Summary in Payment Modal -->
                    <div id="payment-order-summary" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.9); border-radius: 12px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button class="btn btn-primary" id="payment-sent-btn" onclick="markPaymentSentFromModal()" style="width: 100%; font-size: 1rem; padding: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">üí∏</span>
                    <span>Payment Sent to PepHaul Admin</span>
                </button>
                <p style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin: 0;">PepHaul Admin will be notified via Telegram</p>
                <button class="btn btn-secondary" onclick="closeModal('payment-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Shipping Details Modal -->
    <div class="modal" id="mailing-address-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">üì¨ Add Shipping Details</h3>
                <button class="modal-close" onclick="closeModal('mailing-address-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
                    Your payment has been confirmed! üéâ Please provide your shipping details:
                </p>
                <div style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 0.75rem; margin-bottom: 1.5rem; border-radius: 6px;">
                    <p style="color: #1e40af; font-size: 0.85rem; font-weight: 600; margin: 0;">‚ö†Ô∏è Please review and make sure everything added is accurate before saving.</p>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Full Name (Receiver) <span style="color: #ef4444;">*</span></label>
                    <input type="text" class="form-input" id="mailing-name" placeholder="Enter your full name (required for shipping)">
                    <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 0.25rem;">‚ö†Ô∏è Full Name is required for shipping address</small>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Contact Number</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="display: flex; align-items: center; padding: 0 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px 0 0 10px; color: var(--text-secondary); font-size: 0.9rem;">+63</span>
                        <input type="tel" class="form-input" id="mailing-phone" style="border-radius: 0 10px 10px 0; flex: 1;" placeholder="9XX XXX XXXX" maxlength="10">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Full Mailing Address</label>
                    <textarea class="form-input" id="mailing-address-input" rows="3" style="resize: vertical;" placeholder="Street, Village, Barangay, City, Province, Zipcode" maxlength="500"></textarea>
                    <small style="color: var(--text-muted); font-size: 0.75rem;">Include: Street, Village/Subdivision, Barangay, City, Province, Zipcode (max 500 characters)</small>
                    <div style="text-align: right; margin-top: 0.25rem;">
                        <span id="mailing-address-char-count" style="color: var(--text-muted); font-size: 0.75rem;">0/500</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('mailing-address-modal')">Cancel</button>
                <button class="btn btn-primary" id="save-mailing-btn" onclick="saveMailingAddress()">üíæ Save Address</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon">‚úì</div>
        <span id="toast-message">Success!</span>
    </div>

    <script>
        // Helper function to escape JavaScript strings (handles quotes, braces, brackets, parentheses)
        function escapeJS(str) {
            if (!str) return '';
            return String(str)
                .replace(/\\/g, '\\\\')  // Escape backslashes first
                .replace(/'/g, "\\'")    // Escape single quotes
                .replace(/"/g, '\\"')    // Escape double quotes
                .replace(/\n/g, '\\n')   // Escape newlines
                .replace(/\r/g, '\\r')   // Escape carriage returns
                .replace(/\t/g, '\\t');  // Escape tabs
        }
        
        // Helper function to escape HTML content
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Config
        const EXCHANGE_RATE = {{ exchange_rate|default(59.0)|tojson }};
        const ADMIN_FEE = {{ admin_fee|default(300.0)|tojson }};
        const VIALS_PER_KIT = {{ vials_per_kit|default(10)|tojson }};
        const SUPPLIERS = {{ suppliers|tojson|safe }};
        
        // Supplier filter state
        let supplierFilter = localStorage.getItem('supplierFilter') || 'all';
        
        // Listen for supplier filter changes from admin panel
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'supplierFilter') {
                supplierFilter = event.data.filter;
                localStorage.setItem('supplierFilter', supplierFilter);
                applySupplierFilterToPage();
            }
            // Listen for tab switch messages to reload timeline
            if (event.data && event.data.type === 'tabSwitched') {
                const orderFormLocked = {{ order_form_locked|tojson }};
                if (orderFormLocked) {
                    loadTimeline(); // Reload timeline for new tab
                }
            }
        });
        
        // Apply supplier filter on page load
        function applySupplierFilterToPage() {
            if (!SUPPLIERS || SUPPLIERS.length === 0) return;
            
            // Show/hide supplier sections based on filter
            document.querySelectorAll('.supplier-cart, .supplier-inventory, .supplier-active-orders, .supplier-incomplete-kits, .supplier-stats').forEach(section => {
                const sectionSupplier = section.getAttribute('data-supplier');
                let shouldShow = false;
                
                if (supplierFilter === 'all') {
                    shouldShow = true;
                } else {
                    // Filter matches supplier name exactly
                    shouldShow = sectionSupplier === supplierFilter;
                }
                
                section.style.display = shouldShow ? 'block' : 'none';
            });
            
            // Also filter product dropdown by supplier
            filterProductDropdownBySupplier();
        }
        
        // Apply filter on page load
        document.addEventListener('DOMContentLoaded', () => {
            applySupplierFilterToPage();
        });
        
        // State
        let selectedProduct = null;
        let orderType = 'Vial';
        let cartItems = [];
        let currentOrderId = null;
        let paymentFile = null;
        // Removed items tracking no longer needed - we send all items when updating

        // DOM Elements
        const productSearch = document.getElementById('product-search');
        const productDropdown = document.getElementById('product-dropdown');
        const selectedProductDiv = document.getElementById('selected-product');
        const quantityInput = document.getElementById('quantity');
        const fullNameInput = document.getElementById('full-name');
        const telegramInput = document.getElementById('telegram');
        const productSearchHint = document.getElementById('product-search-hint');
        
        // Function to check if required fields are filled and enable/disable product search
        function checkRequiredFields() {
            const fullName = fullNameInput.value.trim();
            const telegram = telegramInput.value.trim();
            const isFilled = fullName && telegram;
            
            if (!productSearch) return;
            
            if (isFilled) {
                productSearch.disabled = false;
                productSearch.placeholder = 'Search products...';
                if (productSearchHint) productSearchHint.style.display = 'none';
                productSearch.style.cursor = 'text';
            } else {
                productSearch.disabled = true;
                productSearch.placeholder = 'Please enter your Name and Telegram username first...';
                if (productSearchHint) productSearchHint.style.display = 'block';
                productSearch.style.cursor = 'not-allowed';
                // Hide dropdown if shown
                if (productDropdown) productDropdown.classList.remove('show');
            }
        }
        
        // Check required fields on input
        if (fullNameInput) {
            fullNameInput.addEventListener('input', () => {
                checkRequiredFields();
                checkReturningCustomer(); // Also check for existing orders
            });
        }
        if (telegramInput) {
            telegramInput.addEventListener('input', () => {
                // Reload orders for Customer Summary when telegram changes (if form is locked)
                const orderFormLocked = {{ order_form_locked|tojson }};
                if (orderFormLocked && typeof loadAllOrdersForSummary === 'function') {
                    // Debounce: wait 500ms after user stops typing
                    clearTimeout(window.telegramDebounceTimer);
                    window.telegramDebounceTimer = setTimeout(() => {
                        loadAllOrdersForSummary();
                    }, 500);
                }
                checkRequiredFields();
                checkReturningCustomer(); // Also check for existing orders
            });
        }
        
        // Initial check
        checkRequiredFields();

        // Toast Notification Function (must be defined early)
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            if (toast && toastMessage) {
                toastMessage.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            } else {
                console.log('Toast:', message);
            }
        }

        // Navigation (simplified - single tab only)
        document.querySelectorAll('.nav-tab[data-view]').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab[data-view]').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.view-content').forEach(v => v.style.display = 'none');
                document.getElementById('view-' + tab.dataset.view).style.display = 'block';
            });
        });

        // Load Products Dynamically
        let allProducts = [];
        async function loadProducts() {
            try {
                console.log('Loading products...');
                const response = await fetch('/api/products');
                allProducts = await response.json();
                console.log('Loaded products:', allProducts.length);
                renderProductDropdown(allProducts);
                attachProductClickHandlers();
                console.log('Products rendered and ready');
            } catch (error) {
                console.error('Error loading products:', error);
                productDropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">Error loading products. Please refresh the page.</div>';
            }
        }

        function renderProductDropdown(products) {
            productDropdown.innerHTML = products.map(product => {
                const isLocked = product.inventory && product.inventory.is_locked;
                const productSupplier = product.supplier || 'Default';
                return `
                    <div class="product-option ${isLocked ? 'locked' : ''}"
                         data-code="${product.code}" 
                         data-name="${product.name}" 
                         data-supplier="${productSupplier}"
                         data-kit="${product.kit_price}" 
                         data-vial="${product.vial_price}"
                         data-vials-per-kit="${product.vials_per_kit || 10}"
                         data-locked="${isLocked}"
                         data-total-vials="${product.inventory ? product.inventory.total_vials : 0}"
                         data-kits="${product.inventory ? product.inventory.kits_generated : 0}"
                         data-remaining="${product.inventory ? product.inventory.remaining_vials : 0}"
                         data-slots="${product.inventory ? product.inventory.slots_to_next_kit : (product.vials_per_kit || 10)}">
                        <div class="product-option-name">
                            ${product.name}
                            ${isLocked ? '<span class="locked-badge">LOCKED</span>' : ''}
                        </div>
                        <div class="product-option-meta">
                            <span>${product.code}</span>
                            <span>Kit: $${product.kit_price.toFixed(2)} (‚Ç±${(product.kit_price * EXCHANGE_RATE).toFixed(2)})</span>
                            <span>Vial: $${product.vial_price.toFixed(2)} (‚Ç±${(product.vial_price * EXCHANGE_RATE).toFixed(2)})</span>
                        </div>
                    </div>
                `;
            }).join('');
            // Apply supplier filter after rendering
            filterProductDropdownBySupplier();
        }
        
        function filterProductDropdownBySupplier() {
            if (!productDropdown) return;
            
            // Get current supplier filter
            const currentFilter = supplierFilter || 'all';
            
            // Get current search query
            const searchQuery = productSearch ? productSearch.value.toLowerCase().trim() : '';
            
            // Filter product options by supplier (and search query if present), limit to first 7 matches
            let visibleCount = 0;
            const maxVisible = 7;
            
            productDropdown.querySelectorAll('.product-option').forEach(option => {
                const optionSupplier = option.dataset.supplier || 'Default';
                let supplierMatch = true;
                
                // Apply supplier filter
                if (currentFilter !== 'all') {
                    supplierMatch = optionSupplier === currentFilter;
                }
                
                // Apply search filter if query exists
                let searchMatch = true;
                if (searchQuery) {
                    const nameMatch = option.dataset.name.toLowerCase().includes(searchQuery) || 
                                     option.dataset.code.toLowerCase().includes(searchQuery);
                    searchMatch = nameMatch;
                }
                
                // Show only if both filters match and within limit
                if (supplierMatch && searchMatch && visibleCount < maxVisible) {
                    option.style.display = 'block';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function attachProductClickHandlers() {
            productDropdown.querySelectorAll('.product-option:not(.locked)').forEach(option => {
                option.addEventListener('click', () => {
                    // Validate required fields before allowing product selection
                    const fullName = fullNameInput.value.trim();
                    const telegram = telegramInput.value.trim();
                    
                    if (!fullName || !telegram) {
                        showToast('Please enter your Name and Telegram username first', 3000);
                        productDropdown.classList.remove('show');
                        return;
                    }
                    
                    const productVialsPerKit = parseInt(option.dataset.vialsPerKit) || VIALS_PER_KIT;
                    const isLocked = option.dataset.locked === 'true';
                    const productSupplier = option.dataset.supplier || 'Default';
                    selectedProduct = {
                        code: option.dataset.code,
                        name: option.dataset.name,
                        supplier: productSupplier,
                        kit_price: parseFloat(option.dataset.kit),
                        vial_price: parseFloat(option.dataset.vial),
                        vials_per_kit: productVialsPerKit,
                        inventory: {
                            total_vials: parseInt(option.dataset.totalVials) || 0,
                            kits_generated: parseInt(option.dataset.kits) || 0,
                            remaining_vials: parseInt(option.dataset.remaining) || 0,
                            slots_to_next_kit: parseInt(option.dataset.slots) || productVialsPerKit,
                            vials_per_kit: productVialsPerKit,
                            is_locked: isLocked
                        }
                    };
                    
                    const selectedNameEl = document.getElementById('selected-name');
                    const selectedCodeEl = document.getElementById('selected-code');
                    if (selectedNameEl) selectedNameEl.textContent = selectedProduct.name;
                    if (selectedCodeEl) selectedCodeEl.textContent = selectedProduct.code;
                    if (selectedProductDiv) selectedProductDiv.style.display = 'block';
                    if (productSearch) productSearch.value = selectedProduct.name;
                    // Hide dropdown after selection
                    if (productDropdown) productDropdown.classList.remove('show');
                    
                    updateInventoryDisplay();
                    updatePricePreview();
                });
            });
        }

        // Load products on page load
        loadProducts();

        // Product Search - Show dropdown when typing (only if fields are filled)
        if (productSearch) {
            productSearch.addEventListener('focus', () => {
            // Check if required fields are filled
            const fullName = fullNameInput.value.trim();
            const telegram = telegramInput.value.trim();
            
            if (!fullName || !telegram) {
                showToast('Please enter your Name and Telegram username first', 3000);
                if (productSearch) productSearch.blur();
                return;
            }
            
            // Show products when user focuses on search (filtered by supplier)
            if (allProducts.length > 0 && productDropdown) {
                productDropdown.classList.add('show');
                filterProductDropdownBySupplier();
            }
            });
        }
        
        if (productSearch) {
            productSearch.addEventListener('input', (e) => {
            // Check if required fields are filled
            const fullName = fullNameInput.value.trim();
            const telegram = telegramInput.value.trim();
            
            if (!fullName || !telegram) {
                if (productDropdown) productDropdown.classList.remove('show');
                return;
            }
            
            if (!productDropdown) return;
            
            const query = e.target.value.toLowerCase().trim();
            console.log('Search query:', query);
            
            // Always show dropdown when there's input or when focused
            productDropdown.classList.add('show');
            
            // Filter products by name or code AND supplier, limit to first 7 matches
            const currentFilter = supplierFilter || 'all';
            let visibleCount = 0;
            const maxVisible = 7;
            
            productDropdown.querySelectorAll('.product-option').forEach(option => {
                const optionSupplier = option.dataset.supplier || 'Default';
                let supplierMatch = true;
                
                // Apply supplier filter
                if (currentFilter !== 'all') {
                    supplierMatch = optionSupplier === currentFilter;
                }
                
                if (!query) {
                    // Show all matching supplier if empty query (limit to first 7)
                    if (supplierMatch && visibleCount < maxVisible) {
                        option.style.display = 'block';
                        visibleCount++;
                    } else {
                        option.style.display = 'none';
                    }
                } else {
                    // Filter by search query AND supplier (limit to first 7 matches)
                    const nameMatch = option.dataset.name.toLowerCase().includes(query) || option.dataset.code.toLowerCase().includes(query);
                    if (nameMatch && supplierMatch && visibleCount < maxVisible) {
                        option.style.display = 'block';
                        visibleCount++;
                    } else {
                        option.style.display = 'none';
                    }
                }
            });
            });
        }
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.product-search-container') && productDropdown) {
                productDropdown.classList.remove('show');
            }
        });

        function updateInventoryDisplay() {
            if (!selectedProduct) return;
            const inv = selectedProduct.inventory;
            const vialsPerKit = selectedProduct.vials_per_kit || VIALS_PER_KIT;
            document.getElementById('inv-total-vials').textContent = inv.total_vials;
            document.getElementById('inv-kits').textContent = inv.kits_generated;
            document.getElementById('inv-remaining').textContent = inv.remaining_vials;
            document.getElementById('inv-slots').textContent = inv.slots_to_next_kit;
            
            const progressPercent = (inv.remaining_vials / vialsPerKit) * 100;
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `${inv.remaining_vials}/${vialsPerKit}`;
        }

        // Order Type Toggle
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                orderType = btn.dataset.type;
                updatePricePreview();
            });
        });

        // Quantity Controls
        const qtyMinusBtn = document.getElementById('qty-minus');
        const qtyPlusBtn = document.getElementById('qty-plus');
        if (qtyMinusBtn && quantityInput) {
            qtyMinusBtn.addEventListener('click', () => {
                const current = parseInt(quantityInput.value) || 1;
                if (current > 1) { quantityInput.value = current - 1; updatePricePreview(); }
            });
        }
        if (qtyPlusBtn && quantityInput) {
            qtyPlusBtn.addEventListener('click', () => {
                quantityInput.value = (parseInt(quantityInput.value) || 1) + 1;
                updatePricePreview();
            });
        }
        if (quantityInput) {
            quantityInput.addEventListener('input', updatePricePreview);
        }

        function updatePricePreview() {
            if (!selectedProduct) {
                const addToCartBtn = document.getElementById('add-to-cart');
                if (addToCartBtn) {
                    addToCartBtn.disabled = true;
                    addToCartBtn.style.opacity = '0.5';
                    addToCartBtn.style.cursor = 'not-allowed';
                }
                return;
            }
            
            const qty = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;
            const unitPrice = orderType === 'Kit' ? selectedProduct.kit_price : selectedProduct.vial_price;
            const lineTotalUsd = unitPrice * qty;
            const lineTotalPhp = lineTotalUsd * EXCHANGE_RATE;
            
            const unitPriceEl = document.getElementById('unit-price-usd');
            const lineTotalUsdEl = document.getElementById('line-total-usd');
            const lineTotalPhpEl = document.getElementById('line-total-php');
            if (unitPriceEl) unitPriceEl.textContent = `$${unitPrice.toFixed(2)}`;
            if (lineTotalUsdEl) lineTotalUsdEl.textContent = `$${lineTotalUsd.toFixed(2)}`;
            if (lineTotalPhpEl) lineTotalPhpEl.textContent = `‚Ç±${lineTotalPhp.toFixed(2)}`;
            
            // Disable add-to-cart button if product is locked
            const addToCartBtn = document.getElementById('add-to-cart');
            const isProductLocked = selectedProduct.inventory && selectedProduct.inventory.is_locked;
            if (addToCartBtn) {
                if (isProductLocked) {
                    addToCartBtn.disabled = true;
                    addToCartBtn.style.opacity = '0.5';
                    addToCartBtn.style.cursor = 'not-allowed';
                    addToCartBtn.title = 'This product is locked and cannot be added to your order';
                } else {
                    addToCartBtn.disabled = false;
                    addToCartBtn.style.opacity = '1';
                    addToCartBtn.style.cursor = 'pointer';
                    addToCartBtn.title = '';
                }
            }
        }

        // Add to Cart
        const addToCartBtn = document.getElementById('add-to-cart');
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', () => {
            console.log('Add to Order button clicked');
            console.log('Selected product:', selectedProduct);
            
            if (!selectedProduct) {
                showToast('Please select a product first');
                return;
            }
            
            // Check if product is locked
            if (selectedProduct.inventory && selectedProduct.inventory.is_locked) {
                showToast('‚ùå This product is locked and cannot be added to your order');
                return;
            }
            
            const qty = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;
            if (qty <= 0) {
                showToast('Please enter a quantity greater than 0');
                return;
            }
            
            const unitPrice = orderType === 'Kit' ? selectedProduct.kit_price : selectedProduct.vial_price;
            
            // Check if same product_code + order_type + supplier already exists in cart - consolidate!
            const productSupplier = selectedProduct.supplier || 'Default';
            const existingIndex = cartItems.findIndex(item => 
                item.product_code === selectedProduct.code && 
                item.order_type === orderType &&
                (item.supplier || 'Default') === productSupplier
            );
            
            if (existingIndex !== -1) {
                // Consolidate: Add to existing quantity
                cartItems[existingIndex].qty += qty;
                cartItems[existingIndex].line_total_usd = cartItems[existingIndex].qty * unitPrice;
                cartItems[existingIndex].line_total_php = cartItems[existingIndex].line_total_usd * EXCHANGE_RATE;
                // If consolidating with existing item, mark as new (user is updating)
                cartItems[existingIndex].isExisting = false;
                showToast('‚úÖ Quantity updated!');
            } else {
                // Check if there's a paid order - mark new items accordingly
                const paidOrder = existingCustomerOrders.find(o => 
                    o.status !== 'Cancelled' && 
                    o.payment_status && 
                    o.payment_status.toLowerCase() === 'paid'
                );
                
                // New item
                cartItems.push({
                    product_code: selectedProduct.code,
                    product_name: selectedProduct.name,
                    order_type: orderType,
                    supplier: productSupplier,
                    qty: qty,
                    unit_price_usd: unitPrice,
                    line_total_usd: unitPrice * qty,
                    line_total_php: unitPrice * qty * EXCHANGE_RATE,
                    isExisting: false,  // Mark as new item
                    isNewOrder: paidOrder ? true : false // Mark as new order if paid order exists
                });
                showToast('‚úÖ Item added to cart!');
            }
            
            console.log('Cart updated:', cartItems);
            updateCart();
            saveCart();
            resetSelection();
            });
        }

        function saveCart() {
            try {
                localStorage.setItem('pephaul_cart', JSON.stringify(cartItems));
            } catch (e) {
                console.warn('Could not save cart to localStorage:', e);
            }
        }

        function loadCart() {
            // Only load cart if Name and Telegram username are filled
            const telegram = fullNameInput && telegramInput ? telegramInput.value.trim() : '';
            const fullName = fullNameInput ? fullNameInput.value.trim() : '';
            
            // If fields are empty, don't load cart - clear it instead
            if (!telegram || !fullName) {
                cartItems = [];
                currentOrderId = null;
                originalOrderItems = []; // Clear original order items
                updateCart();
                saveCart();
                return;
            }
            
            try {
                const saved = localStorage.getItem('pephaul_cart');
                if (saved) {
                    // Only load if we have matching telegram username
                    // Otherwise, clear cart and check for existing orders
                    cartItems = JSON.parse(saved);
                    // Verify the saved cart matches current telegram username
                    // If not, clear and reload from server
                    updateCart();
                }
            } catch (e) {
                console.warn('Could not load cart from localStorage:', e);
                cartItems = [];
                updateCart();
            }
        }

        function resetSelection() {
            selectedProduct = null;
            if (selectedProductDiv) selectedProductDiv.style.display = 'none';
            if (productSearch) productSearch.value = '';
            if (quantityInput) quantityInput.value = 1;
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            const vialToggleBtn = document.querySelector('.toggle-btn[data-type="Vial"]');
            if (vialToggleBtn) vialToggleBtn.classList.add('active');
            orderType = 'Vial';
        }

        function updateCart() {
            // Find paid order
            const paidOrder = existingCustomerOrders.find(o => 
                o.status !== 'Cancelled' && 
                o.payment_status && 
                o.payment_status.toLowerCase() === 'paid'
            );
            
            // Update each supplier's cart separately
            if (!SUPPLIERS || SUPPLIERS.length === 0) {
                console.warn('No suppliers found');
                return;
            }
            
            SUPPLIERS.forEach(supplier => {
                updateSupplierCart(supplier, paidOrder);
            });
            
            // Update status tags and editing controls
            updateOrderSummaryStatusTags();
            updateEditingControls();
            
            // Save updated cart items with corrected prices
            saveCart();
            updateSubmitButtonText();
        }
        
        function updateSupplierCart(supplier, paidOrder) {
            // Get supplier-specific cart elements
            const cartSection = document.querySelector(`.supplier-cart[data-supplier="${supplier}"]`);
            if (!cartSection) return;
            
            const empty = cartSection.querySelector(`.cart-empty[data-supplier="${supplier}"]`);
            const items = cartSection.querySelector(`.cart-items[data-supplier="${supplier}"]`);
            const summary = cartSection.querySelector(`.cart-summary[data-supplier="${supplier}"]`);
            const submitBtn = cartSection.querySelector(`.submit-order[data-supplier="${supplier}"]`);
            const paidOrderSection = cartSection.querySelector(`.paid-order-section[data-supplier="${supplier}"]`);
            const paidOrderItems = cartSection.querySelector(`.paid-order-items[data-supplier="${supplier}"]`);
            const paidOrderSummary = cartSection.querySelector(`.paid-order-summary[data-supplier="${supplier}"]`);
            const paidOrderId = cartSection.querySelector(`.paid-order-id[data-supplier="${supplier}"]`);
            const newOrderSection = cartSection.querySelector(`.new-order-section[data-supplier="${supplier}"]`);
            const newOrderItems = cartSection.querySelector(`.new-order-items[data-supplier="${supplier}"]`);
            const newOrderSummary = cartSection.querySelector(`.new-order-summary[data-supplier="${supplier}"]`);
            const createNewOrderBtn = cartSection.querySelector(`.create-new-order-btn[data-supplier="${supplier}"]`);
            
            // Filter cart items by supplier
            const supplierCartItems = cartItems.filter(item => (item.supplier || 'Default') === supplier);
            console.log(`[updateSupplierCart] Supplier: ${supplier}, Total cart items: ${cartItems.length}, Supplier items: ${supplierCartItems.length}`, supplierCartItems);
            
            // Separate paid order items from new items for this supplier
            const paidOrderItemsList = paidOrder ? (paidOrder.items || []).filter(item => {
                // Try to match by product code and supplier
                const product = allProducts?.find(p => p.code === item.product_code);
                return product && (product.supplier || 'Default') === supplier;
            }) : [];
            const newItems = supplierCartItems.filter(item => !item.isExisting || item.isNewOrder);
            const hasNewItems = newItems.length > 0;
            
            // Show/hide paid order section
            if (paidOrder && paidOrderItemsList.length > 0) {
                if (paidOrderSection) paidOrderSection.style.display = 'block';
                if (paidOrderId) paidOrderId.textContent = paidOrder.order_id;
                
                // Display paid order items (locked/read-only)
                if (paidOrderItems) {
                    paidOrderItems.innerHTML = paidOrderItemsList.map(item => `
                        <div class="cart-item" style="opacity: 0.9; border-left: 3px solid var(--accent-emerald);">
                            <div class="cart-item-header">
                                <span class="cart-item-name">${item.product_name || item.product_code}</span>
                                <span class="cart-item-code">${item.product_code}</span>
                            </div>
                            <div class="cart-item-details" style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="flex: 1;">${item.order_type || 'Vial'} √ó ${item.qty || 0}</span>
                                <span class="cart-item-price">‚Ç±${(item.line_total_php || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Calculate paid order totals
                let paidTotalUsd = 0;
                let paidTotalPhp = 0;
                paidOrderItemsList.forEach(item => {
                    paidTotalUsd += parseFloat(item.line_total_usd || 0);
                    paidTotalPhp += parseFloat(item.line_total_php || 0);
                });
                const paidGrandTotal = paidTotalPhp + (paidOrder.admin_fee_php || ADMIN_FEE);
                
                // Display paid order summary
                if (paidOrderSummary) {
                    paidOrderSummary.innerHTML = `
                        <div class="summary-row">
                            <span class="summary-label">Subtotal (PHP)</span>
                            <span class="summary-value">‚Ç±${paidTotalPhp.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Admin Fee</span>
                            <span class="summary-value">‚Ç±${(paidOrder.admin_fee_php || ADMIN_FEE).toFixed(2)}</span>
                        </div>
                        <div class="summary-row grand-total" style="border-top: 2px solid var(--accent-emerald); margin-top: 0.5rem; padding-top: 0.5rem;">
                            <span class="summary-label" style="color: var(--accent-emerald); font-weight: 700;">Grand Total</span>
                            <span class="summary-value" style="color: var(--accent-emerald); font-weight: 700;">‚Ç±${paidGrandTotal.toFixed(2)}</span>
                        </div>
                    `;
                }
            } else {
                if (paidOrderSection) paidOrderSection.style.display = 'none';
            }
            
            // Show/hide new order section
            if (hasNewItems && paidOrder) {
                if (newOrderSection) newOrderSection.style.display = 'block';
                if (newOrderItems) {
                    newOrderItems.style.display = 'block';
                    newOrderItems.innerHTML = newItems.map((item, i) => {
                        const itemIndex = cartItems.indexOf(item);
                        return `
                            <div class="cart-item" style="border-left: 3px solid var(--accent-amber);">
                                <button class="cart-item-remove" onclick="removeItem(${itemIndex})" style="position: absolute; top: 0.5rem; right: 0.5rem; width: 24px; height: 24px; border: none; background: var(--accent-rose); color: white; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; justify-content: center; line-height: 1; z-index: 10;">√ó</button>
                                <div class="cart-item-header">
                                    <span class="cart-item-name">${item.product_name}</span>
                                    <span class="cart-item-code">${item.product_code}</span>
                                </div>
                                <div class="cart-item-details" style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="flex: 1;">${item.order_type} √ó <span id="qty-${itemIndex}">${item.qty}</span></span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-input); border-radius: 8px; padding: 0.25rem;">
                                        <button type="button" class="qty-btn-minus" data-index="${itemIndex}" data-action="decrease" style="width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-rose); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: auto; z-index: 10; position: relative;">‚àí</button>
                                        <span id="qty-display-${itemIndex}" style="min-width: 30px; text-align: center; font-weight: 600; color: var(--text-primary);">${item.qty}</span>
                                        <button type="button" class="qty-btn-plus" data-index="${itemIndex}" data-action="increase" style="width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-teal); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: auto; z-index: 10; position: relative;">+</button>
                                    </div>
                                    <span class="cart-item-price">‚Ç±<span id="price-${itemIndex}">${(item.line_total_php || 0).toFixed(2)}</span></span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Calculate new order totals
                let newTotalUsd = 0;
                let newTotalPhp = 0;
                newItems.forEach(item => {
                    let itemUsd = parseFloat(item.line_total_usd || 0);
                    let itemPhp = parseFloat(item.line_total_php || 0);
                    if (isNaN(itemUsd) || itemUsd === 0) {
                        if (!isNaN(itemPhp) && itemPhp > 0) {
                            itemUsd = itemPhp / EXCHANGE_RATE;
                        } else {
                            const unitPrice = parseFloat(item.unit_price_usd) || 0;
                            const qty = parseFloat(item.qty) || 1;
                            itemUsd = unitPrice * qty;
                            itemPhp = itemUsd * EXCHANGE_RATE;
                        }
                    }
                    if (isNaN(itemPhp) || itemPhp === 0) {
                        itemPhp = itemUsd * EXCHANGE_RATE;
                    }
                    newTotalUsd += itemUsd;
                    newTotalPhp += itemPhp;
                });
                const newGrandTotal = newTotalPhp + ADMIN_FEE;
                
                // Display new order summary
                if (newOrderSummary) {
                    newOrderSummary.style.display = 'block';
                    newOrderSummary.innerHTML = `
                        <div class="summary-row">
                            <span class="summary-label">Subtotal (USD)</span>
                            <span class="summary-value">$${newTotalUsd.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Subtotal (PHP)</span>
                            <span class="summary-value">‚Ç±${newTotalPhp.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Admin Fee</span>
                            <span class="summary-value">‚Ç±${ADMIN_FEE.toFixed(2)}</span>
                        </div>
                        <div class="summary-row grand-total" style="border-top: 2px solid var(--accent-amber); margin-top: 0.5rem; padding-top: 0.5rem;">
                            <span class="summary-label" style="color: var(--accent-amber); font-weight: 700;">Grand Total</span>
                            <span class="summary-value" style="color: var(--accent-amber); font-weight: 700;">‚Ç±${newGrandTotal.toFixed(2)}</span>
                        </div>
                    `;
                }
            } else {
                if (newOrderSection) newOrderSection.style.display = 'none';
            }
            
            // Handle empty cart for this supplier
            if (supplierCartItems.length === 0 && paidOrderItemsList.length === 0) {
                if (empty) empty.style.display = 'block';
                if (items) items.style.display = 'none';
                if (summary) summary.style.display = 'none';
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            
            // For non-paid orders or when no paid order exists, show regular cart
            // Show regular cart if there's no paid order OR if there's a paid order but no new items
            // CRITICAL: Always show cart if there are items and no paid order
            const shouldShowRegularCart = !paidOrder || (paidOrder && !hasNewItems);
            
            // Show cart if there are items (existing or new) - always show when items exist
            if (supplierCartItems.length > 0) {
                console.log(`[updateSupplierCart] Displaying cart for supplier: ${supplier}, ${supplierCartItems.length} items`);
                if (empty) empty.style.display = 'none';
                if (items) {
                    items.style.display = 'block';
                    console.log(`[updateSupplierCart] Items element found and set to display: block for supplier: ${supplier}`);
                } else {
                    console.error(`[updateSupplierCart] Items element NOT FOUND for supplier: ${supplier}`);
                }
                if (summary) summary.style.display = 'block';
                if (submitBtn) submitBtn.disabled = supplierCartItems.length === 0;
                
                // Check if order is editable
                const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled');
                const isEditable = !pendingOrder || (!pendingOrder.locked && pendingOrder.payment_status !== 'Paid' && pendingOrder.payment_status !== 'Waiting for Confirmation');
                
                // Display all items together with + - X buttons (filtered by supplier)
                if (items) {
                    console.log(`[updateSupplierCart] Rendering ${supplierCartItems.length} items for supplier: ${supplier}`, supplierCartItems);
                    const itemsHTML = supplierCartItems.map((item, i) => {
                        const itemIndex = cartItems.indexOf(item);
                        const isExisting = item.isExisting === true;
                        const hasChanged = item.originalQty !== undefined && item.qty !== item.originalQty;
                        const orderFormLocked = {{ order_form_locked|tojson }};
                        const canRemove = isEditable && (!isExisting || !orderFormLocked);
                        const removeBtnStyle = canRemove ? 
                            'position: absolute; top: 0.5rem; right: 0.5rem; width: 24px; height: 24px; border: none; background: var(--accent-rose); color: white; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; justify-content: center; line-height: 1; z-index: 10;' :
                            'position: absolute; top: 0.5rem; right: 0.5rem; width: 24px; height: 24px; border: none; background: var(--accent-rose); color: white; border-radius: 50%; cursor: not-allowed; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; justify-content: center; line-height: 1; z-index: 10; opacity: 0.5; pointer-events: none;';
                        const qtyBtnStyle = isEditable ?
                            'width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-rose); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: auto; z-index: 10; position: relative;' :
                            'width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: not-allowed; display: flex; align-items: center; justify-content: center; color: var(--accent-rose); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: none; z-index: 10; position: relative; opacity: 0.5;';
                        const qtyBtnPlusStyle = isEditable ?
                            'width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-teal); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: auto; z-index: 10; position: relative;' :
                            'width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: not-allowed; display: flex; align-items: center; justify-content: center; color: var(--accent-teal); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: none; z-index: 10; position: relative; opacity: 0.5;';
                        // Format product code for tag (first 3-4 characters, uppercase)
                        const productCodeTag = item.product_code ? item.product_code.substring(0, 4).toUpperCase() : '';
                        
                        return `
                            <div class="cart-item" style="position: relative; padding: 1rem; margin-bottom: 0.75rem; background: white; border-radius: 8px; border: 1px solid var(--border); ${isExisting ? 'border-left: 3px solid var(--accent-amber);' : ''}">
                                ${productCodeTag ? `<div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="background: rgba(236, 72, 153, 0.1); color: var(--accent-rose); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${productCodeTag}</span>
                                    <button class="cart-item-remove" onclick="removeItem(${itemIndex})" ${!canRemove ? 'disabled' : ''} style="${removeBtnStyle}" ${isExisting && orderFormLocked ? 'title="Cannot remove items from existing orders when order form is locked"' : ''}>√ó</button>
                                </div>` : `<button class="cart-item-remove" onclick="removeItem(${itemIndex})" ${!canRemove ? 'disabled' : ''} style="${removeBtnStyle}" ${isExisting && orderFormLocked ? 'title="Cannot remove items from existing orders when order form is locked"' : ''}>√ó</button>`}
                                <div class="cart-item-header" style="margin-bottom: 0.5rem;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${item.product_name}${hasChanged ? ' <span style="font-size: 0.75rem; color: var(--accent-teal);">(Updated)</span>' : ''}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${item.order_type} √ó <span id="qty-${itemIndex}">${item.qty}</span></div>
                                </div>
                                <div class="cart-item-details" style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-input); border-radius: 8px; padding: 0.25rem;">
                                        <button type="button" class="qty-btn-minus" data-index="${itemIndex}" data-action="decrease" ${!isEditable ? 'disabled' : ''} style="${qtyBtnStyle}">‚àí</button>
                                        <span id="qty-display-${itemIndex}" style="min-width: 30px; text-align: center; font-weight: 600; color: var(--text-primary);">${item.qty}</span>
                                        <button type="button" class="qty-btn-plus" data-index="${itemIndex}" data-action="increase" ${!isEditable ? 'disabled' : ''} style="${qtyBtnPlusStyle}">+</button>
                                    </div>
                                    <span class="cart-item-price" style="font-weight: 600; color: var(--text-primary);">‚Ç±<span id="price-${itemIndex}">${(item.line_total_php || 0).toFixed(2)}</span></span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    console.log(`[updateSupplierCart] Generated HTML for ${supplierCartItems.length} items, HTML length: ${itemsHTML.length} characters`);
                    
                    // Set innerHTML first
                    items.innerHTML = itemsHTML;
                    console.log(`[updateSupplierCart] Items innerHTML set for supplier: ${supplier}, items element:`, items);
                    console.log(`[updateSupplierCart] Items element children count after innerHTML:`, items.children.length);
                    
                    // Remove any existing listeners by cloning and replacing
                    const clonedItems = items.cloneNode(true);
                    items.parentNode.replaceChild(clonedItems, items);
                    
                    // Attach event listener to the new element
                    clonedItems.addEventListener('click', function(e) {
                        try {
                            const btn = e.target.closest('.qty-btn-minus, .qty-btn-plus');
                            if (btn) {
                                const index = parseInt(btn.getAttribute('data-index'));
                                const action = btn.getAttribute('data-action');
                                if (!isNaN(index) && index >= 0 && index < cartItems.length) {
                                    const change = action === 'increase' ? 1 : -1;
                                    updateItemQty(index, change);
                                } else {
                                    console.warn('Invalid button click - index out of range:', index);
                                }
                            }
                        } catch (error) {
                            console.error('Error handling quantity button click:', error);
                            showToast('‚ùå Error updating quantity. Please try again.', 3000);
                        }
                    });
                    console.log(`[updateSupplierCart] Event listeners attached for supplier: ${supplier}`);
                } else {
                    console.error(`[updateSupplierCart] Items element is null for supplier: ${supplier}`);
                }
                
                // Calculate totals for this supplier
                let totalUsd = 0;
                let totalPhp = 0;
                supplierCartItems.forEach(item => {
                    let itemUsd = parseFloat(item.line_total_usd);
                    let itemPhp = parseFloat(item.line_total_php);
                    
                    if (isNaN(itemUsd) || itemUsd === 0) {
                        if (!isNaN(itemPhp) && itemPhp > 0) {
                            itemUsd = itemPhp / EXCHANGE_RATE;
                            item.line_total_usd = itemUsd;
                        } else {
                            const unitPrice = parseFloat(item.unit_price_usd) || 0;
                            const qty = parseFloat(item.qty) || 1;
                            itemUsd = unitPrice * qty;
                            itemPhp = itemUsd * EXCHANGE_RATE;
                            item.line_total_usd = itemUsd;
                            item.line_total_php = itemPhp;
                        }
                    }
                    
                    if (isNaN(itemPhp) || itemPhp === 0) {
                        if (!isNaN(itemUsd) && itemUsd > 0) {
                            itemPhp = itemUsd * EXCHANGE_RATE;
                            item.line_total_php = itemPhp;
                        }
                    }
                    
                    if (!isNaN(itemUsd) && itemUsd > 0) {
                        totalUsd += itemUsd;
                    }
                    if (!isNaN(itemPhp) && itemPhp > 0) {
                        totalPhp += itemPhp;
                    } else if (!isNaN(itemUsd) && itemUsd > 0) {
                        const calculatedPhp = itemUsd * EXCHANGE_RATE;
                        totalPhp += calculatedPhp;
                    }
                });
                
                if (totalPhp === 0 && totalUsd > 0) {
                    totalPhp = totalUsd * EXCHANGE_RATE;
                }
                if (totalUsd === 0 && totalPhp > 0) {
                    totalUsd = totalPhp / EXCHANGE_RATE;
                }
                
                const grandTotal = totalPhp + ADMIN_FEE;
                
                // Update summary displays for this supplier
                const summaryUsdEl = cartSection.querySelector(`.summary-usd[data-supplier="${supplier}"]`);
                const summaryPhpEl = cartSection.querySelector(`.summary-php[data-supplier="${supplier}"]`);
                const grandTotalEl = cartSection.querySelector(`.grand-total-value[data-supplier="${supplier}"]`);
                
                if (summaryUsdEl) summaryUsdEl.textContent = `$${totalUsd.toFixed(2)}`;
                if (summaryPhpEl) summaryPhpEl.textContent = `‚Ç±${totalPhp.toFixed(2)}`;
                if (grandTotalEl) grandTotalEl.textContent = `‚Ç±${grandTotal.toFixed(2)}`;
            }
            
            // Update button visibility for this supplier
            if (paidOrder && hasNewItems) {
                if (createNewOrderBtn) {
                    createNewOrderBtn.style.display = 'block';
                    createNewOrderBtn.disabled = false;
                }
                if (submitBtn) submitBtn.style.display = 'none';
            } else {
                if (createNewOrderBtn) createNewOrderBtn.style.display = 'none';
                if (submitBtn && supplierCartItems.length > 0) submitBtn.disabled = false;
            }
        }

        function removeItem(index) {
            if (index < 0 || index >= cartItems.length) {
                console.error('Invalid index for removeItem:', index);
                return;
            }
            
            const item = cartItems[index];
            
            // Removed items tracking no longer needed - we send all items when updating
            
            cartItems.splice(index, 1);
            updateCart();
            saveCart();
            updateSubmitButtonText(); // Update button state when items are removed
        }
        
        // Expose removeItem to global scope for onclick handlers
        window.removeItem = removeItem;
        
        // Function to update quantity of any item
        function updateItemQty(index, change) {
            // Validate index
            if (index < 0 || index >= cartItems.length) {
                console.error('Invalid index for updateItemQty:', index, 'cartItems.length:', cartItems.length);
                return;
            }
            
            const item = cartItems[index];
            if (!item) {
                console.error('Item not found at index:', index);
                return;
            }
            
            // Store original qty if not set (for existing items)
            if (item.isExisting === true && item.originalQty === undefined) {
                item.originalQty = item.qty;
            }
            
            const originalQty = item.originalQty !== undefined ? item.originalQty : item.qty;
            const newQty = Math.max(0, item.qty + change);
            
            if (newQty === item.qty) return; // No change
            
            // Update quantity
            item.qty = newQty;
            
            // Recalculate line totals
            const unitPriceUsd = parseFloat(item.unit_price_usd) || 0;
            item.line_total_usd = unitPriceUsd * newQty;
            item.line_total_php = item.line_total_usd * EXCHANGE_RATE;
            
            // Mark as updated if quantity changed from original
            if (newQty !== originalQty) {
                item.isUpdated = true; // Mark as updated for change detection
            } else {
                item.isUpdated = false; // Revert if quantity matches original
            }
            
            // If quantity is 0, remove from cart
            if (newQty === 0) {
                cartItems.splice(index, 1);
                showToast(`‚úÖ ${item.product_name} removed from cart`, 3000);
            } else {
                showToast(newQty > originalQty ? `‚úÖ ${item.product_name} quantity increased to ${newQty}` : `‚úÖ ${item.product_name} quantity decreased to ${newQty}`, 3000);
            }
            
            // Update cart display and button state
            updateCart();
            saveCart();
            updateSubmitButtonText(); // Update button state when items change
        }
        window.updateItemQty = updateItemQty; // Expose to global scope

        // Auto-lookup returning customers
        let customerLookupTimeout = null;
        let existingCustomerOrders = [];
        let originalOrderItems = []; // Track original order items for change detection
        
        // Function to update status tags in Order Summary
        function updateOrderSummaryStatusTags() {
            const tagsContainer = document.getElementById('order-summary-status-tags');
            if (!tagsContainer) return;
            
            // Find the pending order (including locked ones for tag display)
            // First try to find non-cancelled, non-locked order (for editing)
            // If not found, find any non-cancelled order (for tag display)
            let pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled' && !o.locked);
            if (!pendingOrder) {
                pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled');
            }
            
            if (!pendingOrder || cartItems.length === 0) {
                tagsContainer.innerHTML = '';
                return;
            }
            
            // Determine status tag to show (priority: locked > paid > awaiting confirmation)
            let statusTagHtml = '';
            if (pendingOrder.locked) {
                statusTagHtml = '<div class="order-status-tag locked">LOCKED üîê</div>';
            } else if (pendingOrder.payment_status === 'Paid') {
                statusTagHtml = '<div class="order-status-tag paid">PAID ü§ë</div>';
                
                // Check if column W (mailing_address) is not empty
                const hasMailingAddress = pendingOrder.mailing_address && pendingOrder.mailing_address.trim() !== '';
                
                if (hasMailingAddress) {
                    // Display shipping details: Full Name (column U), Contact Number (column V), Mailing Address (column W), Tracking Number (column X)
                    statusTagHtml += '<div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 6px;">';
                    statusTagHtml += '<div style="color: #065f46; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">üì¨ Shipping Details</div>';
                    
                    // Column U: Full Name (mailing_name)
                    const mailingName = pendingOrder.mailing_name || pendingOrder.full_name || 'N/A';
                    // Column V: Contact Number (mailing_phone)
                    const mailingPhone = pendingOrder.mailing_phone || pendingOrder.contact_number || 'N/A';
                    // Column W: Mailing Address
                    const mailingAddress = pendingOrder.mailing_address || 'N/A';
                    // Column X: Tracking Number
                    const trackingNumber = pendingOrder.tracking_number || '';
                    
                    statusTagHtml += '<div style="color: #047857; font-size: 0.8rem; margin-bottom: 0.25rem;"><strong>Full Name:</strong> ' + mailingName + '</div>';
                    statusTagHtml += '<div style="color: #047857; font-size: 0.8rem; margin-bottom: 0.25rem;"><strong>Contact Number:</strong> ' + mailingPhone + '</div>';
                    statusTagHtml += '<div style="color: #047857; font-size: 0.8rem; margin-bottom: 0.25rem;"><strong>Mailing Address:</strong> ' + mailingAddress + '</div>';
                    if (trackingNumber && trackingNumber.trim() !== '') {
                        statusTagHtml += '<div style="color: #059669; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 600;"><strong>üì¶ Tracking Number:</strong> ' + trackingNumber + '</div>';
                    }
                    statusTagHtml += '<div style="color: #047857; font-size: 0.75rem; font-style: italic;">Need to update? Contact PepHaul admin for changes.</div>';
                    statusTagHtml += '</div>';
                }
            } else if (pendingOrder.payment_status === 'Waiting for Confirmation') {
                statusTagHtml = '<div class="order-status-tag pending-payment">AWAITING ADMIN TO CONFIRM PAYMENT ü§ë</div>';
            }
            
            tagsContainer.innerHTML = statusTagHtml;
        }
        
        // Function to disable/enable editing controls based on order status
        function updateEditingControls() {
            // Find any non-cancelled order (including locked ones)
            const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled');
            const isEditable = !pendingOrder || (!pendingOrder.locked && pendingOrder.payment_status !== 'Paid' && pendingOrder.payment_status !== 'Waiting for Confirmation');
            
            // Disable quantity buttons
            document.querySelectorAll('.qty-btn-minus, .qty-btn-plus').forEach(btn => {
                if (isEditable) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            });
            
            // Disable remove buttons
            document.querySelectorAll('.cart-item-remove').forEach(btn => {
                if (isEditable) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            });
        }
        
        // Function to update submit button text and state based on existing order
        function updateSubmitButtonText() {
            // Update buttons for each supplier
            if (!SUPPLIERS || SUPPLIERS.length === 0) {
                return;
            }
            
            SUPPLIERS.forEach(supplier => {
                updateSupplierSubmitButtons(supplier);
            });
        }
        
        function updateSupplierSubmitButtons(supplier) {
            const cartSection = document.querySelector(`.supplier-cart[data-supplier="${supplier}"]`);
            if (!cartSection) return;
            
            const orderActionButtons = cartSection.querySelector(`.order-action-buttons[data-supplier="${supplier}"]`);
            if (!orderActionButtons) return;
            
            const submitBtn = orderActionButtons.querySelector(`.submit-order[data-supplier="${supplier}"]`);
            const updateOrderBtn = orderActionButtons.querySelector(`.update-order-btn[data-supplier="${supplier}"]`);
            const payOrderBtn = orderActionButtons.querySelector(`.pay-order-btn[data-supplier="${supplier}"]`);
            const cancelOrderBtn = orderActionButtons.querySelector(`.cancel-order-btn[data-supplier="${supplier}"]`);
            
            if (!submitBtn || !updateOrderBtn || !payOrderBtn || !cancelOrderBtn) {
                // Buttons might not exist yet, skip silently
                return;
            }
            
            // Get cart items for this supplier (use same logic as updateSupplierCart)
            const supplierCartItems = cartItems.filter(item => (item.supplier || 'Default') === supplier);
            
            // Check if there's a pending order for this supplier (including locked ones for status checks)
            // Match by supplier field OR by checking if order items belong to this supplier
            const pendingOrder = existingCustomerOrders.find(o => {
                if (o.status === 'Cancelled' || o.locked) return false;
                // Check if order has supplier field that matches
                if (o.supplier === supplier) return true;
                // If no supplier field, check if any items belong to this supplier
                if (o.items && o.items.length > 0) {
                    return o.items.some(item => {
                        const product = allProducts?.find(p => p.code === item.product_code);
                        return product && (product.supplier || 'Default') === supplier;
                    });
                }
                return false;
            });
            const anyPendingOrder = existingCustomerOrders.find(o => 
                o.status !== 'Cancelled' && 
                o.supplier === supplier
            );
            
            // Check if there are any changes (new items, updated quantities, or removed items) for this supplier
            const supplierOriginalItems = originalOrderItems.filter(item => (item.supplier || 'Default') === supplier);
            const hasNewItems = supplierCartItems.some(item => item.isExisting !== true);
            const hasUpdatedItems = supplierCartItems.some(item => item.isUpdated === true);
            
            // Check if items were removed by comparing with original order
            const hasRemovedItems = supplierOriginalItems.length > 0 && 
                (supplierCartItems.length < supplierOriginalItems.length || 
                 supplierOriginalItems.some(origItem => {
                     // Check if original item is missing from cart (match by product_code, order_type, AND supplier)
                     return !supplierCartItems.some(cartItem => 
                         cartItem.product_code === origItem.product_code && 
                         cartItem.order_type === origItem.order_type &&
                         (cartItem.supplier || 'Default') === (origItem.supplier || 'Default')
                     );
                 }));
            
            // Check if quantities changed from original
            const hasQuantityChanges = supplierCartItems.some(item => {
                if (item.isExisting === true && item.originalQty !== undefined) {
                    return item.qty !== item.originalQty;
                }
                return false;
            });
            
            const hasChanges = hasNewItems || hasUpdatedItems || hasRemovedItems || hasQuantityChanges;
            
            // Handle shipping details button visibility for this supplier
            const shippingDetailsContainer = cartSection.querySelector(`.shipping-details-button-container[data-supplier="${supplier}"]`);
            const addShippingDetailsBtn = cartSection.querySelector(`.add-shipping-details-btn[data-supplier="${supplier}"]`);
            
            // Check if order form is locked
            const orderFormLocked = {{ order_form_locked|tojson }};
            
            if (pendingOrder) {
                // Existing order exists - show Update Order, Pay Order, and Cancel Order buttons
                
                // Hide Submit Order button (for new orders)
                submitBtn.style.display = 'none';
                
                // Show Update Order button - always show when there's a pending order
                // Disable if order form is locked or no changes (but still visible so user can see it)
                updateOrderBtn.style.display = 'block';
                const shouldDisableUpdate = orderFormLocked || !hasChanges || supplierCartItems.length === 0;
                updateOrderBtn.disabled = shouldDisableUpdate;
                console.log(`[updateSupplierSubmitButtons] Supplier: ${supplier}, pendingOrder: ${pendingOrder.order_id}, hasChanges: ${hasChanges}, shouldDisableUpdate: ${shouldDisableUpdate}, supplierCartItems.length: ${supplierCartItems.length}`);
                if (orderFormLocked) {
                    updateOrderBtn.title = 'Order form is locked - cannot update orders';
                } else if (!hasChanges) {
                    updateOrderBtn.title = 'No changes detected. Make changes to enable this button.';
                } else {
                    updateOrderBtn.title = 'Update your existing order with the changes';
                }
                
                // Show Pay Order button - always show for existing orders (for paying submitted orders)
                // Payment is allowed even when order form is locked
                const isPaid = pendingOrder.payment_status && pendingOrder.payment_status.toLowerCase() === 'paid';
                payOrderBtn.style.display = isPaid ? 'none' : 'block';
                payOrderBtn.disabled = false;
                payOrderBtn.title = isPaid ? 'Order already paid' : 'Pay for your submitted order';
                
                // Show Cancel Order button - disable when order form is locked, cancelled, locked, paid, or awaiting payment confirmation
                const isCancelled = pendingOrder.status === 'Cancelled';
                const isLocked = pendingOrder.locked === true;
                const isPaidStatus = pendingOrder.payment_status && (pendingOrder.payment_status === 'Paid' || pendingOrder.payment_status.toLowerCase() === 'paid');
                const isAwaitingConfirmation = pendingOrder.payment_status === 'Waiting for Confirmation';
                const shouldHideCancel = orderFormLocked || isCancelled || isLocked || isPaidStatus || isAwaitingConfirmation;
                
                cancelOrderBtn.style.display = shouldHideCancel ? 'none' : 'block';
                cancelOrderBtn.disabled = shouldHideCancel;
                if (shouldHideCancel) {
                    if (orderFormLocked) {
                        cancelOrderBtn.title = 'Order form is locked - cannot cancel orders';
                    } else if (isPaidStatus) {
                        cancelOrderBtn.title = 'Cannot cancel order - payment has been confirmed';
                    } else if (isAwaitingConfirmation) {
                        cancelOrderBtn.title = 'Cannot cancel order - payment confirmation pending';
                    } else if (isLocked) {
                        cancelOrderBtn.title = 'Cannot cancel order - order is locked by admin';
                    } else {
                        cancelOrderBtn.title = 'Cannot cancel order';
                    }
                } else {
                    cancelOrderBtn.title = 'Cancel this order (cannot be undone)';
                }
                
                // Show "Add Shipping Details" button only if column W (mailing_address) is empty
                const hasMailingAddress = pendingOrder.mailing_address && pendingOrder.mailing_address.trim() !== '';
                if (isPaidStatus && !isCancelled && !hasMailingAddress) {
                    if (shippingDetailsContainer) shippingDetailsContainer.style.display = 'block';
                    if (addShippingDetailsBtn) {
                        addShippingDetailsBtn.onclick = () => {
                            openMailingAddressModal(pendingOrder.order_id, pendingOrder.full_name);
                        };
                    }
                } else {
                    if (shippingDetailsContainer) shippingDetailsContainer.style.display = 'none';
                }
                
            } else {
                // No pending order - show Submit Order button for new orders
                
                // Show Submit Order button
                submitBtn.style.display = 'block';
                submitBtn.textContent = `Submit Order - ${supplier}`;
                // Disable if cart is empty OR if order form is locked
                const shouldDisableSubmit = supplierCartItems.length === 0 || orderFormLocked;
                submitBtn.disabled = shouldDisableSubmit;
                if (orderFormLocked) {
                    submitBtn.title = 'Order form is locked - cannot submit new orders. You can still add items to your cart.';
                } else if (supplierCartItems.length === 0) {
                    submitBtn.title = 'Add items to cart first';
                } else {
                    submitBtn.title = `Submit your new order for ${supplier}`;
                }
                
                // Hide Update Order button (no existing order to update)
                updateOrderBtn.style.display = 'none';
                
                // Hide Pay Order button (no submitted order to pay)
                payOrderBtn.style.display = 'none';
                
                // Hide Cancel Order button (no submitted order to cancel)
                cancelOrderBtn.style.display = 'none';
                
                // Hide shipping details button (no paid order)
                if (shippingDetailsContainer) shippingDetailsContainer.style.display = 'none';
            }
        }
        
        function checkReturningCustomer() {
            const telegram = document.getElementById('telegram').value.trim();
            const fullName = document.getElementById('full-name').value.trim();
            
            // Need both name and telegram to populate orders
            if (!telegram || !fullName) {
                hideMyOrdersSection();
                hideReturningCustomerBanner();
                // Clear cart if fields are cleared
                if (!telegram || !fullName) {
                    currentOrderId = null;
                    cartItems = [];
                    originalOrderItems = []; // Clear original order items
                    // Removed items tracking no longer needed
                    updateCart();
                    saveCart();
                    updateSubmitButtonText();
                }
                return;
            }
            
            // Clear previous timeout
            if (customerLookupTimeout) clearTimeout(customerLookupTimeout);
            
            // Debounce the lookup
            customerLookupTimeout = setTimeout(async () => {
                try {
                    console.log('Looking up orders for telegram:', telegram);
                    const response = await fetch(`/api/orders/lookup?telegram=${encodeURIComponent(telegram)}`);
                    const orders = await response.json();
                    console.log('Found orders:', orders);
                    
                    if (orders && orders.length > 0) {
                        existingCustomerOrders = orders;
                        
                        // Find the most recent unpaid/pending (non-cancelled, not locked) order
                        // Paid orders are locked and should NOT be loaded into cart, but will be shown in locked section
                        const pendingOrder = orders.find(o => 
                            o.status !== 'Cancelled' && 
                            !o.locked && 
                            o.payment_status && 
                            o.payment_status.toLowerCase() !== 'paid'
                        );
                        
                        if (pendingOrder && pendingOrder.items && pendingOrder.items.length > 0) {
                            // Store pending order ID for button text
                            currentOrderId = pendingOrder.order_id;
                            
                            // Update status tags
                            updateOrderSummaryStatusTags();
                            
                            // Filter out items with 0 quantity before populating cart
                            const validItems = pendingOrder.items.filter(item => {
                                const qty = parseFloat(item.qty) || 0;
                                return qty > 0;
                            });
                            
                            // First, map all items with proper price calculations
                            const mappedItems = validItems.map(item => {
                                // Ensure we have all required fields with proper defaults
                                const qty = parseFloat(item.qty) || 1;
                                
                                // Try to get prices from item, prioritizing PHP since that's what's stored
                                let lineTotalPhp = parseFloat(item.line_total_php) || 0;
                                let lineTotalUsd = parseFloat(item.line_total_usd) || 0;
                                
                                // If PHP exists but USD doesn't, calculate USD from PHP
                                if (lineTotalPhp > 0 && (lineTotalUsd === 0 || isNaN(lineTotalUsd))) {
                                    lineTotalUsd = lineTotalPhp / EXCHANGE_RATE;
                                }
                                
                                // If USD exists but PHP doesn't, calculate PHP from USD
                                if (lineTotalUsd > 0 && (lineTotalPhp === 0 || isNaN(lineTotalPhp))) {
                                    lineTotalPhp = lineTotalUsd * EXCHANGE_RATE;
                                }
                                
                                // If both are missing, try to calculate from unit price
                                if ((lineTotalUsd === 0 || isNaN(lineTotalUsd)) && (lineTotalPhp === 0 || isNaN(lineTotalPhp))) {
                                    const unitPriceUsd = parseFloat(item.unit_price_usd) || 0;
                                    if (unitPriceUsd > 0) {
                                        lineTotalUsd = unitPriceUsd * qty;
                                        lineTotalPhp = lineTotalUsd * EXCHANGE_RATE;
                                    } else {
                                        // Last resort: try to calculate from PHP price if available
                                        const unitPricePhp = parseFloat(item.unit_price_php) || 0;
                                        if (unitPricePhp > 0) {
                                            lineTotalPhp = unitPricePhp * qty;
                                            lineTotalUsd = lineTotalPhp / EXCHANGE_RATE;
                                        }
                                    }
                                }
                                
                                // Calculate unit price if missing
                                const unitPriceUsd = parseFloat(item.unit_price_usd) || (qty > 0 ? lineTotalUsd / qty : 0);
                                
                                // Get supplier from product if available, otherwise from item or default
                                let itemSupplier = item.supplier || 'Default';
                                if (!itemSupplier || itemSupplier === 'Default') {
                                    const product = allProducts?.find(p => p.code === item.product_code);
                                    itemSupplier = product?.supplier || 'Default';
                                }
                                
                                return {
                                    product_code: item.product_code,
                                    product_name: item.product_name,
                                    order_type: item.order_type || 'Vial',
                                    supplier: itemSupplier,
                                    qty: qty,
                                    unit_price_usd: unitPriceUsd,
                                    line_total_usd: lineTotalUsd,
                                    line_total_php: lineTotalPhp
                                };
                            });
                            
                            // Consolidate items with same product_code, order_type, AND supplier
                            const consolidatedMap = new Map();
                            mappedItems.forEach(item => {
                                const key = `${item.product_code}|${item.order_type}|${item.supplier || 'Default'}`;
                                if (consolidatedMap.has(key)) {
                                    // Merge: sum quantities and totals
                                    const existing = consolidatedMap.get(key);
                                    existing.qty += item.qty;
                                    existing.line_total_usd += item.line_total_usd;
                                    existing.line_total_php += item.line_total_php;
                                    // Recalculate unit price based on new totals
                                    existing.unit_price_usd = existing.qty > 0 ? existing.line_total_usd / existing.qty : existing.unit_price_usd;
                                } else {
                                    // First occurrence, add to map
                                    consolidatedMap.set(key, { ...item });
                                }
                            });
                            
                            // Convert map back to array and mark as existing
                            cartItems = Array.from(consolidatedMap.values()).map(item => ({
                                ...item,
                                isExisting: true,
                                originalQty: item.qty  // Store original quantity for comparison
                            }));
                            
                            // Store original order items for change detection (after consolidation)
                            originalOrderItems = cartItems.map(item => ({
                                product_code: item.product_code,
                                product_name: item.product_name,
                                order_type: item.order_type || 'Vial',
                                supplier: item.supplier || 'Default',
                                qty: item.qty
                            }));
                            
                            updateCart();
                            saveCart();
                            updateSubmitButtonText(); // Update buttons after loading existing items
                            updateOrderSummaryStatusTags();
                            updateEditingControls();
                            showToast(`‚úÖ Loaded ${cartItems.length} item(s) from your existing order`, 3000);
                        } else {
                            // No pending unpaid order, clear cart and reset order ID
                            // Paid orders will be shown in locked section via updateCart()
                            currentOrderId = null;
                            cartItems = [];
                            originalOrderItems = []; // Clear original order items
                            updateCart(); // This will show paid orders in locked section if they exist
                            saveCart();
                        }
                        
                        // Update button text and cart display (will show paid orders in locked section)
                        updateSubmitButtonText();
                        updateOrderSummaryStatusTags();
                        updateEditingControls();
                        
                        hideReturningCustomerBanner();
                        
                        // Always show My Orders section with all orders (including unpaid with Pay Order buttons)
                        // This allows users to pay any unpaid order, not just the most recent one
                        // showMyOrdersSection will filter by telegram username for privacy
                        showMyOrdersSection(orders);
                    } else {
                        console.log('No orders found for', telegram);
                        currentOrderId = null;
                        cartItems = [];
                        originalOrderItems = []; // Clear original order items
                        // Removed items tracking no longer needed
                        updateCart();
                        saveCart();
                        updateSubmitButtonText();
                        hideReturningCustomerBanner();
                        hideMyOrdersSection();
                        
                        // Reload all orders for Customer Summary if order form is locked
                        const orderFormLocked = {{ order_form_locked|tojson }};
                        if (orderFormLocked) {
                            loadAllOrdersForSummary();
                        }
                    }
                } catch (error) {
                    console.error('Customer lookup error:', error);
                    hideReturningCustomerBanner();
                    hideMyOrdersSection();
                    
                    // Reload all orders for Customer Summary on error if order form is locked
                    const orderFormLocked = {{ order_form_locked|tojson }};
                    if (orderFormLocked) {
                        loadAllOrdersForSummary();
                    }
                }
            }, 500);
        }
        
        // Function to load all orders for Customer Summary (when order form is locked)
        async function loadAllOrdersForSummary() {
            const orderFormLocked = {{ order_form_locked|tojson }};
            if (!orderFormLocked) return;
            
            const summarySection = document.getElementById('customer-summary-section');
            const summaryContent = document.getElementById('customer-summary-content');
            
            if (!summarySection || !summaryContent) return;
            
            try {
                // Always load all orders (grouped by Order ID, same as admin panel)
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    throw new Error(`Failed to load orders: ${response.status}`);
                }
                const allOrders = await response.json();
                
                // Get telegram from input field
                const telegramInput = document.getElementById('telegram');
                const currentTelegram = telegramInput?.value.trim().toLowerCase().replace('@', '') || '';
                
                // Filter orders by telegram username to only show current user's orders (for privacy)
                let filteredOrders = allOrders;
                if (currentTelegram) {
                    filteredOrders = allOrders.filter(order => {
                        const orderTelegram = (order.telegram || '').toLowerCase().replace('@', '');
                        return orderTelegram === currentTelegram;
                    });
                }
                
                // If telegram is provided and we have orders, also try lookup endpoint for additional orders
                if (currentTelegram && filteredOrders.length === 0) {
                    try {
                        const lookupResponse = await fetch(`/api/orders/lookup?telegram=${encodeURIComponent(currentTelegram)}`);
                        if (lookupResponse.ok) {
                            const lookupOrders = await lookupResponse.json();
                            if (lookupOrders && lookupOrders.length > 0) {
                                filteredOrders = lookupOrders;
                            }
                        }
                    } catch (lookupError) {
                        console.warn('Lookup endpoint failed, using main orders:', lookupError);
                    }
                }
                
                // Store orders for payOrderById function
                existingCustomerOrders = filteredOrders;
                
                // Show orders with Pay Order buttons in My Orders section
                if (filteredOrders.length > 0) {
                    showMyOrdersSection(filteredOrders);
                }
                
                // Store mailing_address and tracking_number status before removing for privacy
                filteredOrders.forEach(order => {
                    order._hasShippingDetails = !!(order.mailing_address && order.mailing_address.trim() !== '');
                    order._hasTrackingNumber = !!(order.tracking_number && typeof order.tracking_number === 'string' && order.tracking_number.trim() !== '');
                    // Remove mailing_address and tracking_number to protect privacy
                    delete order.mailing_address;
                    delete order.tracking_number;
                });
                
                // Update customer summary with the orders table (grouped by Order ID, same as admin panel)
                updateCustomerSummary(filteredOrders);
            } catch (error) {
                console.error('Error loading all orders for summary:', error);
                summaryContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>Error loading orders. Please refresh the page.</p></div>';
            }
        }
        
        // Function to update Customer Summary section
        function updateCustomerSummary(orders) {
            const summarySection = document.getElementById('customer-summary-section');
            const summaryContent = document.getElementById('customer-summary-content');
            
            if (!summarySection || !summaryContent) return;
            
            const orderFormLocked = {{ order_form_locked|tojson }};
            if (!orderFormLocked) {
                summarySection.style.display = 'none';
                return;
            }
            
            summarySection.style.display = 'block';
            
            if (!orders || orders.length === 0) {
                summaryContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>No orders found</p></div>';
                return;
            }
            
            // Filter out cancelled orders
            const validOrders = orders.filter(o => o.status !== 'Cancelled');
            
            if (validOrders.length === 0) {
                summaryContent.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><p>No active orders found</p></div>';
                return;
            }
            
            // Count paid vs total orders
            const paidOrders = validOrders.filter(o => {
                const paymentStatus = o.payment_status || '';
                return paymentStatus.toLowerCase() === 'paid';
            });
            const paidCount = paidOrders.length;
            const totalCount = validOrders.length;
            const paymentProgress = totalCount > 0 ? (paidCount / totalCount) * 100 : 0;
            
            // Build table HTML
            let tableHtml = '<div style="overflow-x: auto; margin-bottom: 1.5rem;">';
            tableHtml += '<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">';
            tableHtml += '<thead>';
            tableHtml += '<tr style="background: rgba(192, 132, 252, 0.1); border-bottom: 2px solid var(--border);">';
            tableHtml += '<th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Order Number</th>';
            tableHtml += '<th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-primary);">Payment Status</th>';
            tableHtml += '<th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary);">Action</th>';
            tableHtml += '</tr>';
            tableHtml += '</thead>';
            tableHtml += '<tbody>';
            
            validOrders.forEach(order => {
                const paymentStatus = order.payment_status || 'Unpaid';
                const isPaid = paymentStatus.toLowerCase() === 'paid';
                const isWaitingForConfirmation = paymentStatus.toLowerCase() === 'waiting for confirmation';
                
                // Set status color and background based on payment status
                let statusColor, statusBg, statusText;
                if (isPaid) {
                    statusColor = '#10b981';
                    statusBg = 'rgba(16, 185, 129, 0.1)';
                    statusText = '‚úÖ PAID';
                } else if (isWaitingForConfirmation) {
                    statusColor = '#3b82f6';
                    statusBg = 'rgba(59, 130, 246, 0.1)';
                    statusText = '‚è≥ WAITING FOR CONFIRMATION';
                } else {
                    statusColor = '#f59e0b';
                    statusBg = 'rgba(245, 158, 11, 0.1)';
                    statusText = '‚è≥ UNPAID';
                }
                
                // Check if shipping details and tracking number exist (using stored flags from before removing for privacy)
                const hasShippingDetails = order._hasShippingDetails === true;
                const hasTrackingNumber = order._hasTrackingNumber === true;
                
                tableHtml += '<tr style="border-bottom: 1px solid var(--border);">';
                tableHtml += `<td style="padding: 0.75rem; font-family: "JetBrains Mono", monospace; color: var(--accent-primary); font-weight: 600;">${order.order_id || 'N/A'}</td>`;
                tableHtml += `<td style="padding: 0.75rem;"><span style="display: inline-block; padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: ${statusBg}; color: ${statusColor};">${statusText}</span></td>`;
                
                // Action column logic - check tracking number first (highest priority)
                if (hasTrackingNumber && isPaid) {
                    // Show fulfillment message when tracking number is added
                    tableHtml += '<td style="padding: 0.75rem; text-align: center;"><span style="color: #10b981; font-size: 0.85rem; font-weight: 600;">üöö Order is fulfilled. Soon to be at your doorstep.</span></td>';
                } else if (isWaitingForConfirmation) {
                    // Show waiting message for orders waiting for confirmation
                    tableHtml += '<td style="padding: 0.75rem; text-align: center;"><span style="color: #3b82f6; font-size: 0.85rem; font-weight: 600;">‚è≥ Pending payment confirmation by PepHaul Admin. Thank you for your patience.</span></td>';
                } else if (!isPaid && !isWaitingForConfirmation) {
                    // Show "Pay Order" button for unpaid orders
                    const escapedOrderId = escapeJS(order.order_id);
                    tableHtml += `<td style="padding: 0.75rem; text-align: center;"><button type="button" class="btn btn-emerald" onclick="payOrderByIdFromSummary('${escapedOrderId}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">üí≥ Pay Order</button></td>`;
                } else if (isPaid && !hasShippingDetails) {
                    // Show "Add Shipping Details" button for paid orders without shipping details
                    const escapedOrderId = escapeJS(order.order_id);
                    const escapedFullName = escapeJS(order.full_name || '');
                    tableHtml += `<td style="padding: 0.75rem; text-align: center;"><button type="button" class="btn btn-violet" onclick="openMailingAddressModal('${escapedOrderId}', '${escapedFullName}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;" title="Contact @deejay1992 for shipping details updates">üì¨ Add Shipping Details</button></td>`;
                } else if (isPaid && hasShippingDetails && !hasTrackingNumber) {
                    // Show note when shipping details have been recorded but no tracking yet
                    tableHtml += '<td style="padding: 0.75rem; text-align: center;"><span style="color: var(--accent-emerald); font-size: 0.85rem; font-weight: 600; cursor: help;" title="Shipping details recorded. No further action required. For updates, contact PepHaul Admin @deejay1992">‚úÖ Shipping details recorded. No further action required.</span></td>';
                } else {
                    tableHtml += '<td style="padding: 0.75rem; text-align: center;"></td>';
                }
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody>';
            tableHtml += '</table>';
            tableHtml += '</div>';
            
            // Add progress bar
            tableHtml += '<div style="margin-top: 1.5rem;">';
            tableHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">';
            tableHtml += '<span style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">Payment Progress</span>';
            tableHtml += `<span style="font-size: 0.85rem; color: var(--text-secondary);">${paidCount} of ${totalCount} paid</span>`;
            tableHtml += '</div>';
            tableHtml += '<div style="width: 100%; height: 24px; background: rgba(156, 163, 175, 0.2); border-radius: 12px; overflow: hidden; position: relative;">';
            tableHtml += `<div style="width: ${paymentProgress}%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s ease; border-radius: 12px;"></div>`;
            tableHtml += '</div>';
            tableHtml += `<div style="text-align: center; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">${paymentProgress.toFixed(0)}% Complete</div>`;
            tableHtml += '</div>';
            
            summaryContent.innerHTML = tableHtml;
        }
        
        function showMyOrdersSection(orders) {
            const section = document.getElementById('my-orders-section');
            const list = document.getElementById('my-orders-list');
            const empty = document.getElementById('my-orders-empty');
            
            // CRITICAL: Filter orders by current telegram username for privacy/security
            const telegramInput = document.getElementById('telegram');
            const currentTelegram = telegramInput?.value.trim().toLowerCase().replace('@', '') || '';
            
            // Only show orders if telegram is provided and filter orders to match
            if (!currentTelegram) {
                // Hide section if no telegram entered
                section.style.display = 'none';
                return;
            }
            
            // Filter orders to only show those matching current telegram username
            const filteredOrders = orders.filter(order => {
                const orderTelegram = (order.telegram || '').toLowerCase().replace('@', '');
                return orderTelegram === currentTelegram;
            });
            
            if (filteredOrders.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
                section.style.display = 'block';
                return;
            }
            
            // Use filtered orders instead of original orders
            orders = filteredOrders;
            
            // Separate paid and unpaid orders
            const paidOrders = orders.filter(o => {
                const paymentStatus = o.payment_status || '';
                return paymentStatus.toLowerCase() === 'paid';
            });
            const unpaidOrders = orders.filter(o => {
                const paymentStatus = o.payment_status || '';
                return paymentStatus.toLowerCase() !== 'paid';
            });
            
            // Calculate totals for each section
            const paidTotal = paidOrders.reduce((sum, o) => sum + (o.grand_total_php || 0), 0);
            const unpaidTotal = unpaidOrders.reduce((sum, o) => sum + (o.grand_total_php || 0), 0);
            
            let html = '';
            
            // Paid Orders Section (Locked with Admin Fee)
            if (paidOrders.length > 0) {
                html += '<div style="margin-bottom: 2rem;">';
                html += '<h3 style="font-size: 1.1rem; font-weight: 700; color: var(--accent-emerald); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"><span>üîí</span> Paid Orders (Locked)</h3>';
                
                // Track shipping details for display
                let shippingDetailsHtml = '';
                
                paidOrders.forEach(order => {
                    const items = order.items || [];
                    const itemsPreview = items.map(i => `${i.product_name || i.product_code} (${i.order_type || 'Vial'} x${i.qty || 0})`).join(', ');
                    
                    // Calculate subtotal and admin fee for display
                    const itemsTotal = items.reduce((sum, i) => sum + (i.line_total_php || 0), 0);
                    const adminFee = (order.grand_total_php || 0) - itemsTotal;
                    
                    // Check if shipping details exist (mailing_address in column W)
                    const hasShippingDetails = order.mailing_address && order.mailing_address.trim() !== '';
                    // When shipping details exist, mailing_name is in column U, mailing_phone is in column V
                    const mailingName = hasShippingDetails ? (order.mailing_name || order.full_name || '') : '';
                    const mailingPhone = hasShippingDetails ? (order.mailing_phone || order.contact_number || '') : '';
                    const mailingAddress = order.mailing_address || '';
                    
                    html += `
                        <div class="card" style="cursor: pointer; padding: 1.5rem; border: 2px solid var(--accent-emerald); background: rgba(16, 185, 129, 0.05); margin-bottom: 1rem;" onclick="viewOrder('${escapeJS(order.order_id)}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary); font-weight: 700; font-size: 1.1rem; margin-bottom: 0.35rem;">${order.order_id}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">${order.order_date}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--accent-emerald); margin-bottom: 0.35rem;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                    <div style="display: inline-block; padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: rgba(16, 185, 129, 0.2); color: #065f46;">‚úÖ PAID üîí</div>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500;">üì¶ Items:</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 0.75rem;">${itemsPreview}</div>
                            <div style="border-top: 1px solid rgba(16, 185, 129, 0.2); padding-top: 0.75rem; font-size: 0.85rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span style="color: var(--text-secondary);">Items Subtotal:</span>
                                    <span style="font-weight: 600;">‚Ç±${itemsTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span style="color: var(--text-secondary);">Admin Fee:</span>
                                    <span style="font-weight: 600;">‚Ç±${adminFee.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: 700; color: var(--accent-emerald); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                    <span>Total:</span>
                                    <span>‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                </div>
                            </div>
                            ${!hasShippingDetails ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                    <button type="button" class="btn btn-violet" onclick="event.stopPropagation(); openMailingAddressModal('${escapeJS(order.order_id)}', '${escapeJS(order.full_name || '')}')" style="width: 100%; padding: 0.75rem 1rem; font-size: 0.9rem;" title="Contact @deejay1992 for shipping details updates">üì¨ Add Shipping Details</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Collect shipping details for summary card
                    if (hasShippingDetails) {
                        shippingDetailsHtml += `
                            <div class="card" style="padding: 1.25rem; border: 2px solid var(--accent-violet); background: rgba(192, 132, 252, 0.05); margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span style="font-size: 1.1rem;">üì¨</span>
                                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--accent-violet); margin: 0;">Shipping Details - ${order.order_id}</h4>
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-primary); line-height: 1.6;">
                                    ${mailingName ? `<div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeJS(mailingName)}</div>` : ''}
                                    ${mailingPhone ? `<div style="color: var(--text-secondary); margin-bottom: 0.25rem;">${escapeJS(mailingPhone)}</div>` : ''}
                                    <div style="color: var(--text-secondary); white-space: pre-wrap;">${escapeJS(mailingAddress)}</div>
                                </div>
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(192, 132, 252, 0.2); font-size: 0.8rem; color: var(--text-muted);">
                                    <span>üí° Need to update address? Contact PepHaul Admin @deejay1992</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--accent-emerald); gap: 1.5rem; flex-wrap: wrap;">`;
                if (shippingDetailsHtml) {
                    html += `<div style="flex: 1; min-width: 300px;">`;
                    html += '<h3 style="font-size: 1rem; font-weight: 600; color: var(--accent-violet); margin-bottom: 0.75rem;">üì¨ Shipping Details</h3>';
                    html += shippingDetailsHtml;
                    html += `</div>`;
                } else {
                    html += `<div style="flex: 1;"></div>`;
                }
                html += `<div style="text-align: right; flex: 0 0 auto; align-self: flex-start;">`;
                html += `<div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Total Paid Orders:</div>`;
                html += `<div style="font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--accent-emerald);">‚Ç±${paidTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>`;
                html += `</div>`;
                html += `</div>`;
                html += '</div>';
            }
            
            // Unpaid Orders Section (New items with separate Admin Fee)
            if (unpaidOrders.length > 0) {
                html += '<div>';
                html += '<h3 style="font-size: 1.1rem; font-weight: 700; color: var(--accent-amber); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"><span>‚ûï</span> Additional Orders (Unpaid)</h3>';
                
                unpaidOrders.forEach(order => {
                    const items = order.items || [];
                    const itemsPreview = items.map(i => `${i.product_name || i.product_code} (${i.order_type || 'Vial'} x${i.qty || 0})`).join(', ');
                    
                    // Calculate subtotal and admin fee for display
                    const itemsTotal = items.reduce((sum, i) => sum + (i.line_total_php || 0), 0);
                    const adminFee = (order.grand_total_php || 0) - itemsTotal;
                    
                    html += `
                        <div class="card" style="padding: 1.5rem; border: 2px solid var(--accent-amber); background: rgba(245, 158, 11, 0.05); margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div style="cursor: pointer; flex: 1;" onclick="viewOrder('${escapeJS(order.order_id)}')">
                                    <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary); font-weight: 700; font-size: 1.1rem; margin-bottom: 0.35rem;">${order.order_id}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">${order.order_date}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--accent-amber); margin-bottom: 0.35rem;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                    <div style="display: inline-block; padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: rgba(245, 158, 11, 0.2); color: #92400e;">‚è≥ UNPAID</div>
                                </div>
                            </div>
                            <div style="cursor: pointer;" onclick="viewOrder('${escapeJS(order.order_id)}')">
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500;">üì¶ Items:</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 0.75rem;">${itemsPreview}</div>
                                <div style="border-top: 1px solid rgba(245, 158, 11, 0.2); padding-top: 0.75rem; font-size: 0.85rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span style="color: var(--text-secondary);">Items Subtotal:</span>
                                        <span style="font-weight: 600;">‚Ç±${itemsTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span style="color: var(--text-secondary);">Admin Fee:</span>
                                        <span style="font-weight: 600;">‚Ç±${adminFee.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-weight: 700; color: var(--accent-amber); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(245, 158, 11, 0.2);">
                                        <span>Total:</span>
                                        <span>‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                    </div>
                                </div>
                            </div>
                            ${order.payment_screenshot ? '<div style="margin-top: 0.75rem; margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--accent-teal);">üì∑ Payment screenshot uploaded - pending confirmation</div>' : ''}
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-emerald btn-full" onclick="event.stopPropagation(); payOrderById('${escapeJS(order.order_id)}')" style="flex: 1;">üí≥ Pay Order</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `<div style="text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--accent-amber);">`;
                html += `<div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Total Unpaid Orders:</div>`;
                html += `<div style="font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--accent-amber);">‚Ç±${unpaidTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>`;
                html += `</div>`;
                html += '</div>';
            }
            
            list.innerHTML = html;
            list.style.display = 'block';
            empty.style.display = 'none';
            section.style.display = 'block';
            
            // Scroll to show the orders section
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }
        
        function hideMyOrdersSection() {
            const section = document.getElementById('my-orders-section');
            section.style.display = 'none';
        }
        
        function showReturningCustomerBanner(orders) {
            // Remove existing banner if any
            hideReturningCustomerBanner();
            
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.status !== 'Cancelled').length;
            const unpaidOrders = orders.filter(o => o.payment_status && o.payment_status.toLowerCase() !== 'paid').length;
            
            const banner = document.createElement('div');
            banner.id = 'returning-customer-banner';
            banner.style.cssText = `
                background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15));
                border: 2px solid var(--accent-violet);
                border-radius: 16px;
                padding: 1.25rem;
                margin-bottom: 1.5rem;
                animation: slideIn 0.3s ease;
            `;
            banner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div style="background: linear-gradient(135deg, #8b5cf6, #ec4899); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 1.75rem;">üëã</span>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; color: var(--text-primary);">Welcome back!</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            You have <strong style="color: var(--accent-violet);">${pendingOrders}</strong> existing order(s)
                            ${unpaidOrders > 0 ? ` ‚Ä¢ <strong style="color: var(--accent-amber);">${unpaidOrders}</strong> unpaid` : ''}
                        </div>
                    </div>
                    <button class="btn btn-violet" style="padding: 0.65rem 1.25rem; font-size: 0.9rem; font-weight: 600;" onclick="scrollToMyOrders()">
                        üìã View My Orders Below
                    </button>
                </div>
            `;
            
            // Insert at the top of customer info section
            const customerInfo = document.querySelector('.customer-info-card');
            if (customerInfo) {
                customerInfo.insertBefore(banner, customerInfo.firstChild);
            }
        }
        
        function scrollToMyOrders() {
            const section = document.getElementById('my-orders-section');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function hideReturningCustomerBanner() {
            const banner = document.getElementById('returning-customer-banner');
            if (banner) banner.remove();
        }
        
        function viewMyExistingOrders() {
            // Scroll to orders section (orders auto-populate when telegram username is entered)
            const section = document.getElementById('my-orders-section');
            if (section && section.style.display !== 'none') {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Add event listeners for customer lookup
        // checkReturningCustomer is now called from the required fields check above

        // Submit Order - Show confirmation modal first
        // Create New Order button handler (for adding items to paid orders)
        const createNewOrderBtn = document.getElementById('create-new-order-btn');
        if (createNewOrderBtn) {
            createNewOrderBtn.addEventListener('click', () => {
            const fullName = document.getElementById('full-name').value.trim();
            const telegram = document.getElementById('telegram').value.trim();
            
            if (!fullName || !telegram) {
                showToast('Please fill in name and telegram username');
                return;
            }
            
            // Filter only new items (not from paid order)
            const newItems = cartItems.filter(item => !item.isExisting || item.isNewOrder);
            
            if (newItems.length === 0) {
                showToast('Please add items to create a new order', 3000);
                return;
            }
            
            // Show confirmation modal with only new items
            showOrderConfirmationModal();
            });
        }
        
        // Handle supplier-specific submit buttons using event delegation
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('submit-order')) {
                const supplier = e.target.getAttribute('data-supplier');
                const fullName = document.getElementById('full-name').value.trim();
                const telegram = document.getElementById('telegram').value.trim();
                
                if (!fullName || !telegram) {
                    showToast('Please fill in name and telegram username');
                    return;
                }
                
                // Filter cart items by supplier
                const supplierCartItems = cartItems.filter(item => (item.supplier || 'Default') === supplier);
                
                if (supplierCartItems.length === 0) {
                    showToast(`Your cart is empty for ${supplier}`);
                    return;
                }
                
                // Store supplier for confirmation modal
                window.currentSubmitSupplier = supplier;
                
                // Show confirmation modal
                showOrderConfirmationModal(supplier);
            }
        });
        
        // Handle supplier-specific Update Order buttons using event delegation
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('update-order-btn')) {
                const supplier = e.target.getAttribute('data-supplier');
                const fullName = document.getElementById('full-name').value.trim();
                const telegram = document.getElementById('telegram').value.trim();
                
                if (!fullName || !telegram) {
                    showToast('Please fill in name and telegram username', 3000);
                    return;
                }
                
                // Filter cart items by supplier
                const supplierCartItems = cartItems.filter(item => (item.supplier || 'Default') === supplier);
                
                if (supplierCartItems.length === 0) {
                    showToast(`Your cart is empty for ${supplier}`, 3000);
                    return;
                }
                
                // Check if there are changes for this supplier
                const supplierOriginalItems = originalOrderItems.filter(item => (item.supplier || 'Default') === supplier);
                const hasNewItems = supplierCartItems.some(item => item.isExisting !== true);
                const hasUpdatedItems = supplierCartItems.some(item => item.isUpdated === true);
                const hasRemovedItems = supplierOriginalItems.length > 0 && 
                    (supplierCartItems.length < supplierOriginalItems.length || 
                     supplierOriginalItems.some(origItem => {
                         return !supplierCartItems.some(cartItem => 
                             cartItem.product_code === origItem.product_code && 
                             cartItem.order_type === origItem.order_type &&
                             (cartItem.supplier || 'Default') === (origItem.supplier || 'Default')
                         );
                     }));
                const hasQuantityChanges = supplierCartItems.some(item => {
                    if (item.isExisting === true && item.originalQty !== undefined) {
                        return item.qty !== item.originalQty;
                    }
                    return false;
                });
                const hasChanges = hasNewItems || hasUpdatedItems || hasRemovedItems || hasQuantityChanges;
                
                if (!hasChanges) {
                    showToast('‚ùå No changes detected. Please add, update, or remove items before updating.', 3000);
                    return;
                }
                
                // Store supplier for confirmation modal
                window.currentSubmitSupplier = supplier;
                
                // Show confirmation modal (same as submit)
                showOrderConfirmationModal(supplier);
            }
        });
        
        // Pay Order button - Show payment modal
        const payOrderBtn = document.getElementById('pay-order-btn');
        if (payOrderBtn) {
            // Remove any existing listeners by cloning
            const newPayBtn = payOrderBtn.cloneNode(true);
            payOrderBtn.parentNode.replaceChild(newPayBtn, payOrderBtn);
            
            newPayBtn.addEventListener('click', () => {
                const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled' && !o.locked);
                if (pendingOrder) {
                    showPaymentModal(pendingOrder);
                } else {
                    showToast('No active order found', 3000);
                }
            });
        }
        
        // Cancel Order button - Cancel the submitted order
        const cancelOrderBtn = document.getElementById('cancel-order-btn');
        if (cancelOrderBtn) {
            // Remove any existing listeners by cloning
            const newCancelBtn = cancelOrderBtn.cloneNode(true);
            cancelOrderBtn.parentNode.replaceChild(newCancelBtn, cancelOrderBtn);
            
            newCancelBtn.addEventListener('click', () => {
                const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled' && !o.locked);
                if (pendingOrder) {
                    const telegram = document.getElementById('telegram').value.trim() || pendingOrder.telegram || '';
                    cancelOrder(pendingOrder.order_id, telegram);
                } else {
                    showToast('No active order found to cancel', 3000);
                }
            });
        }
        
        // Store current order ID for payment modal
        let currentPaymentOrderId = null;
        
        // Function to pay order by ID (for use in order cards)
        function payOrderById(orderId) {
            const order = existingCustomerOrders.find(o => o.order_id === orderId);
            if (order) {
                showPaymentModal(order);
            } else {
                showToast('Order not found', 3000);
            }
        }
        
        // Function to pay order by ID from Customer Summary (fetches order if not in memory)
        async function payOrderByIdFromSummary(orderId) {
            // First check if order is in existingCustomerOrders
            const order = existingCustomerOrders.find(o => o.order_id === orderId);
            if (order) {
                showPaymentModal(order);
                return;
            }
            
            // If not found, fetch order details from API
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch order: ${response.status}`);
                }
                const orderData = await response.json();
                if (orderData) {
                    // Add to existingCustomerOrders for future use
                    if (!existingCustomerOrders.find(o => o.order_id === orderId)) {
                        existingCustomerOrders.push(orderData);
                    }
                    showPaymentModal(orderData);
                } else {
                    showToast('Order not found', 3000);
                }
            } catch (error) {
                console.error('Error fetching order:', error);
                showToast('Error loading order. Please try again.', 3000);
            }
        }
        
        // Expose to global scope
        window.payOrderById = payOrderById;
        window.payOrderByIdFromSummary = payOrderByIdFromSummary;
        
        function showPaymentModal(order) {
            const modal = document.getElementById('payment-modal');
            const summaryEl = document.getElementById('payment-order-summary');
            
            if (!modal || !summaryEl) {
                showToast('Payment modal not found', 3000);
                return;
            }
            
            // Store order ID for the payment sent button
            currentPaymentOrderId = order.order_id;
            
            // Calculate totals
            const items = order.items || [];
            const subtotalPhp = items.reduce((sum, item) => sum + (parseFloat(item.line_total_php) || 0), 0);
            const grandTotalPhp = order.grand_total_php || (subtotalPhp + ADMIN_FEE);
            
            // Populate order summary
            summaryEl.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary); font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem;">${order.order_id}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.75rem;">${order.order_date}</div>
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">Subtotal:</span>
                        <span style="font-weight: 600;">‚Ç±${subtotalPhp.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">Admin Fee:</span>
                        <span style="font-weight: 600;">‚Ç±${ADMIN_FEE.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: 700; color: var(--accent-primary); margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                        <span>Grand Total:</span>
                        <span>‚Ç±${grandTotalPhp.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            // Show/hide payment sent button based on payment status
            const paymentSentBtn = document.getElementById('payment-sent-btn');
            if (paymentSentBtn) {
                const paymentStatus = (order.payment_status || '').toLowerCase();
                if (paymentStatus === 'paid' || paymentStatus === 'waiting for confirmation') {
                    paymentSentBtn.style.display = 'none';
                } else {
                    paymentSentBtn.style.display = 'flex';
                }
            }
            
            modal.classList.add('show');
        }
        
        // Mark payment as sent from payment modal
        async function markPaymentSentFromModal() {
            if (!currentPaymentOrderId) {
                showToast('Order ID not found', 3000);
                return;
            }
            
            await markPaymentSent(currentPaymentOrderId);
            // Close modal after marking payment as sent
            closeModal('payment-modal');
        }
        
        // Show order confirmation modal
        function showOrderConfirmationModal(supplier = null) {
            const modal = document.getElementById('order-confirmation-modal');
            const itemsList = document.getElementById('confirmation-items-list');
            
            // Filter items by supplier if provided
            let filteredCartItems = supplier 
                ? cartItems.filter(item => (item.supplier || 'Default') === supplier)
                : cartItems;
            
            // Check if there's a paid order - if so, only show new items
            const paidOrder = existingCustomerOrders.find(o => 
                o.status !== 'Cancelled' && 
                o.payment_status && 
                o.payment_status.toLowerCase() === 'paid'
            );
            
            const itemsToShow = paidOrder ? 
                filteredCartItems.filter(item => !item.isExisting || item.isNewOrder) : 
                filteredCartItems;
            
            // Render cart items with remove buttons
            itemsList.innerHTML = itemsToShow.map((item, i) => {
                // Find original index in cartItems for remove functionality
                const originalIndex = cartItems.indexOf(item);
                return `
                <div class="cart-item" id="confirmation-item-${i}">
                    <button class="cart-item-remove" onclick="removeFromConfirmation(${i})">√ó</button>
                    <div class="cart-item-header">
                        <span class="cart-item-name">${item.product_name}</span>
                        <span class="cart-item-code">${item.product_code}</span>
                    </div>
                    <div class="cart-item-details">
                        <span>${item.order_type} √ó ${item.qty}</span>
                        <span class="cart-item-price">‚Ç±${item.line_total_php.toFixed(2)}</span>
                    </div>
                </div>
            `;
            }).join('');
            
            // Update totals (only for items being shown)
            updateConfirmationTotals(itemsToShow);
            
            // Show modal
            modal.classList.add('show');
        }
        
        // Remove item from confirmation modal
        function removeFromConfirmation(index) {
            cartItems.splice(index, 1);
            
            if (cartItems.length === 0) {
                closeModal('order-confirmation-modal');
                updateCart();
                showToast('Cart is now empty');
                return;
            }
            
            // Update confirmation modal
            showOrderConfirmationModal();
            
            // Update main cart display
            updateCart();
            saveCart();
        }
        
        // Expose to global scope
        window.removeFromConfirmation = removeFromConfirmation;
        
        // Update confirmation modal totals
        function updateConfirmationTotals(items = null) {
            const itemsToCalculate = items || cartItems;
            const totalUsd = itemsToCalculate.reduce((sum, item) => sum + (item.line_total_usd || 0), 0);
            const totalPhp = itemsToCalculate.reduce((sum, item) => sum + (item.line_total_php || 0), 0) || (totalUsd * EXCHANGE_RATE);
            const grandTotal = totalPhp + ADMIN_FEE;
            
            document.getElementById('confirmation-subtotal-usd').textContent = `$${totalUsd.toFixed(2)}`;
            document.getElementById('confirmation-subtotal-php').textContent = `‚Ç±${totalPhp.toFixed(2)}`;
            document.getElementById('confirmation-grand-total').textContent = `‚Ç±${grandTotal.toFixed(2)}`;
        }
        
        // Confirm and submit order
        async function confirmOrderSubmission() {
            const fullName = document.getElementById('full-name').value.trim();
            const telegram = document.getElementById('telegram').value.trim();
            const btn = document.getElementById('confirm-submit-btn');
            
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            try {
                let response, result;
                
                // Check if customer has an existing pending order to update
                const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled' && !o.locked);
                
                if (pendingOrder) {
                    // Update existing order - send ALL items (backend will handle updates/deletions)
                    btn.textContent = 'Updating...';
                    
                    // Check if there are any changes
                    const hasChanges = cartItems.some(item => {
                        // New item (not from existing order)
                        if (item.isExisting !== true) return true;
                        // Updated item (quantity changed from original)
                        if (item.originalQty !== undefined && item.qty !== item.originalQty) return true;
                        return false;
                    });
                    
                    // Handle case where all items are removed - cancel the order instead
                    if (cartItems.length === 0) {
                        const confirmCancel = confirm('You have removed all items from your order. Would you like to cancel this order?');
                        if (confirmCancel) {
                            try {
                                const cancelResponse = await fetch(`/api/orders/${pendingOrder.order_id}/cancel`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                if (cancelResponse.ok) {
                                    const cancelResult = await cancelResponse.json();
                                    if (cancelResult.success) {
                                        showToast('‚úÖ Order cancelled successfully', 5000);
                                        closeModal('order-confirmation-modal');
                                        // Refresh order lookup
                                        if (typeof checkReturningCustomer === 'function') {
                                            setTimeout(() => {
                                                checkReturningCustomer();
                                            }, 500);
                                        }
                                        // Clear cart
                                        cartItems = [];
                                        updateCart();
                                        saveCart();
                                        btn.disabled = false;
                                        btn.textContent = 'Confirm & Submit Order';
                                        return;
                                    }
                                }
                            } catch (cancelError) {
                                console.error('Error cancelling order:', cancelError);
                            }
                        }
                        showToast('‚ùå Please add items to your order or cancel it', 3000);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                        return;
                    }
                    
                    // Send ALL items from cart (backend will update/delete as needed)
                    // Filter out items with qty 0 (they should be removed, not sent)
                    // Consolidate items by product_code and order_type before sending
                    // This prevents duplicate items from being sent to the backend
                    const consolidatedMap = new Map();
                    cartItems
                        .filter(item => item.qty > 0) // Only process items with qty > 0
                        .forEach(item => {
                            const key = `${item.product_code}|${item.order_type}`;
                            if (consolidatedMap.has(key)) {
                                // Merge: sum quantities and totals
                                const existing = consolidatedMap.get(key);
                                existing.qty += parseFloat(item.qty) || 0;
                                existing.line_total_usd += parseFloat(item.line_total_usd) || 0;
                                existing.line_total_php += parseFloat(item.line_total_php) || 0;
                                // Recalculate unit price based on new totals
                                existing.unit_price_usd = existing.qty > 0 ? existing.line_total_usd / existing.qty : existing.unit_price_usd;
                            } else {
                                // First occurrence, add to map
                                consolidatedMap.set(key, {
                                    product_code: item.product_code,
                                    product_name: item.product_name,
                                    order_type: item.order_type,
                                    qty: parseFloat(item.qty) || 0,
                                    unit_price_usd: parseFloat(item.unit_price_usd) || 0,
                                    line_total_usd: parseFloat(item.line_total_usd) || 0,
                                    line_total_php: parseFloat(item.line_total_php) || 0
                                });
                            }
                        });
                    
                    // Convert consolidated map to array
                    const itemsToSend = Array.from(consolidatedMap.values());
                    
                    // Validate all items have valid quantities
                    const invalidItems = itemsToSend.filter(item => !item.qty || item.qty <= 0);
                    if (invalidItems.length > 0) {
                        showToast('‚ùå Error: Some items have invalid quantities. Please check your order.', 3000);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                        return;
                    }
                    
                    // Validate we have items to send
                    if (itemsToSend.length === 0) {
                        showToast('‚ùå No items to update. Please add items to your order.', 3000);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                        return;
                    }
                    
                    console.log(`Updating order ${pendingOrder.order_id} with ${itemsToSend.length} items`);
                    
                    response = await fetch(`/api/orders/${pendingOrder.order_id}/add-items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            items: itemsToSend,  // Send all items with qty > 0
                            telegram_username: telegram
                        })
                    });
                    
                    // Check response status before parsing JSON to handle various errors
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = `Server error (${response.status})`;
                        
                        if (response.status === 404) {
                            // Order not found - suggest refreshing
                            errorMessage = 'Order not found. The order may have been cancelled or deleted. Please refresh the page and try again.';
                            console.error('Order not found:', pendingOrder.order_id, 'Telegram:', telegram);
                        } else if (response.status === 403) {
                            errorMessage = 'Order is locked and cannot be modified. Please contact admin.';
                        } else if (response.status === 502) {
                            errorMessage = 'Server temporarily unavailable. Please try again in a moment.';
                        } else if (errorText) {
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = errorJson.error || errorMessage;
                            } catch (e) {
                                errorMessage = `Server error: ${errorText.substring(0, 100)}`;
                            }
                        }
                        
                        showToast(`‚ùå ${errorMessage}`, 8000);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                        
                        // If 404, suggest refreshing the page
                        if (response.status === 404) {
                            setTimeout(() => {
                                if (confirm('Would you like to refresh the page to reload your orders?')) {
                                    window.location.reload();
                                }
                            }, 2000);
                        }
                        return;
                    }
                    
                    result = await response.json();
                    
                    if (result.success) {
                        currentOrderId = pendingOrder.order_id;
                        
                        // Clear removed items tracking (no longer needed since we send all items)
                        removedItems = [];
                        
                        // Finalize order immediately (send Telegram notification)
                        try {
                            const finalizeResponse = await fetch(`/api/orders/${pendingOrder.order_id}/finalize`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            
                            if (!finalizeResponse.ok) {
                                // If finalize fails, still show success for update
                                console.warn('Finalize failed but order was updated:', finalizeResponse.status);
                            } else {
                                const finalizeResult = await finalizeResponse.json();
                                if (!finalizeResult.success) {
                                    console.warn('Finalize returned error but order was updated:', finalizeResult.error);
                                }
                            }
                        } catch (finalizeError) {
                            console.warn('Error finalizing order (non-critical):', finalizeError);
                        }
                        
                        // Close confirmation modal
                        closeModal('order-confirmation-modal');
                        showToast('‚úÖ Order updated and PepHaul Admin notified!', 5000);
                        
                        // Refresh order lookup immediately to get updated totals
                        if (typeof checkReturningCustomer === 'function') {
                            setTimeout(() => {
                                checkReturningCustomer();
                            }, 500); // Small delay to ensure backend has processed
                        }
                        
                        // Clear cart
                        cartItems = [];
                        updateCart();
                        saveCart();
                    } else {
                        const errorMsg = result.error || 'Failed to update order';
                        showToast(`‚ùå ${errorMsg}`, 5000);
                        console.error('Order update error:', result);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                    }
                } else {
                    // Create new order
                    // If there's a paid order, only submit new items (not paid order items)
                    const paidOrder = existingCustomerOrders.find(o => 
                        o.status !== 'Cancelled' && 
                        o.payment_status && 
                        o.payment_status.toLowerCase() === 'paid'
                    );
                    
                    // Filter items by supplier if submitting supplier-specific order
                    const supplier = window.currentSubmitSupplier || null;
                    let itemsToSubmit = supplier 
                        ? cartItems.filter(item => (item.supplier || 'Default') === supplier)
                        : cartItems;
                    
                    if (paidOrder) {
                        // Filter only new items (not from paid order)
                        itemsToSubmit = itemsToSubmit.filter(item => !item.isExisting || item.isNewOrder);
                        
                        if (itemsToSubmit.length === 0) {
                            showToast('‚ùå Please add new items to create a new order', 3000);
                            btn.disabled = false;
                            btn.textContent = 'Confirm & Submit Order';
                            return;
                        }
                    }
                    
                    btn.textContent = 'Submitting...';
                    response = await fetch('/api/submit-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            full_name: fullName, 
                            telegram, 
                            items: itemsToSubmit,
                            supplier: supplier || null
                        })
                    });
                    
                    result = await response.json();
                    
                    if (result.success) {
                        currentOrderId = result.order_id;
                        
                        // Close confirmation modal
                        closeModal('order-confirmation-modal');
                        
                        // Show success modal
                        showOrderModal(result.order);
                        
                        // Clear cart and form
                        cartItems = [];
                        updateCart();
                        saveCart();
                        document.getElementById('full-name').value = '';
                        document.getElementById('telegram').value = '';
                    } else {
                        const errorMsg = result.error || 'Failed to submit order';
                        showToast(`‚ùå ${errorMsg}`, 5000);
                        console.error('Order submission error:', result);
                    }
                }
            } catch (error) {
                console.error('Order submission error:', error);
                let errorMessage = 'Error submitting order';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                showToast(errorMessage, 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm & Submit Order';
            }
        }
        
        // Expose to global scope
        window.confirmOrderSubmission = confirmOrderSubmission;
        
        // Finalize order modal removed - orders are finalized automatically after update

        function showOrderModal(order) {
            const modalOrderId = document.getElementById('modal-order-id');
            const modalSubtotalUsd = document.getElementById('modal-subtotal-usd');
            const modalSubtotalPhp = document.getElementById('modal-subtotal-php');
            const modalGrandTotal = document.getElementById('modal-grand-total');
            const modalItems = document.getElementById('modal-items');
            const orderModal = document.getElementById('order-modal');
            
            if (modalOrderId) modalOrderId.textContent = order.order_id;
            if (modalSubtotalUsd) modalSubtotalUsd.textContent = `$${order.subtotal_usd.toFixed(2)}`;
            if (modalSubtotalPhp) modalSubtotalPhp.textContent = `‚Ç±${order.subtotal_php.toFixed(2)}`;
            if (modalGrandTotal) modalGrandTotal.textContent = `‚Ç±${order.grand_total_php.toFixed(2)}`;
            
            if (modalItems) {
                modalItems.innerHTML = order.items.map(item => `
                    <div class="order-item-row">
                        <div class="order-item-info">
                            <div>${item.product_name}</div>
                            <div class="order-item-qty">${item.order_type} √ó ${item.qty}</div>
                        </div>
                        <div>‚Ç±${item.line_total_php.toFixed(2)}</div>
                    </div>
                `).join('');
            } else {
                console.error('modal-items element not found');
            }
            
            if (orderModal) {
                orderModal.classList.add('show');
            } else {
                console.error('order-modal element not found');
            }
        }

        // Payment Upload removed - customers now use "Payment Sent" button from order details

        // Load Orders - REMOVED (functionality moved to auto-populate on Telegram username entry)
        // This reduces memory usage and API calls
        
        // Search Orders - REMOVED (View Orders tab removed)
        // Orders now auto-populate when customer enters Telegram username
        
        // Placeholder for removed order-search event listener
        const orderSearchElement = document.getElementById('order-search');
        if (orderSearchElement) {
            orderSearchElement.addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) { 
                // Safe call to loadOrders if it exists
                if (typeof loadOrders === 'function') {
                    try {
                        loadOrders();
                    } catch (e) {
                        console.log('loadOrders not available');
                    }
                }
                return; 
            }
            
            try {
                const response = await fetch(`/api/orders/search?q=${encodeURIComponent(query)}`);
                const orders = await response.json();
                const list = document.getElementById('orders-list');
                
                if (!list) {
                    console.error('orders-list element not found');
                    return;
                }
                
                list.innerHTML = orders.length === 0 
                    ? '<div class="cart-empty">No matching orders</div>'
                    : orders.map(order => `
                        <div class="order-card" onclick="viewOrder('${escapeJS(order.order_id)}')">
                            <div class="order-card-header">
                                <span class="order-card-id">${order.order_id}</span>
                            </div>
                            <div class="order-card-customer">${order.full_name}</div>
                            <div style="display: flex; justify-content: space-between;">
                                <span class="status-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                                <span class="order-card-total">‚Ç±${order.grand_total_php.toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error searching orders:', error);
                const list = document.getElementById('orders-list');
                if (list) {
                    list.innerHTML = '<div class="cart-empty">Error searching orders. Please try again.</div>';
                }
            }
        });
        }

        // View Order Details
        let currentViewingOrder = null;
        
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch order: ${response.status}`);
                }
                const order = await response.json();
                currentViewingOrder = order;
                
                // Order can be edited/cancelled only if it's not locked, not cancelled, not paid, and not awaiting payment confirmation
                const orderIsPaid = order.payment_status === 'Paid' || (order.payment_status && order.payment_status.toLowerCase() === 'paid');
                const isAwaitingConfirmation = order.payment_status === 'Waiting for Confirmation';
                const canEdit = !order.locked && order.status !== 'Cancelled' && !orderIsPaid && !isAwaitingConfirmation;
                
                const body = document.getElementById('order-details-body');
                if (!body) {
                    console.error('order-details-body element not found');
                    showToast('‚ùå Error: Order details element not found', 3000);
                    return;
                }
                
                // Determine status tag to show (priority: locked > paid > awaiting confirmation)
                let statusTagHtml = '';
                if (order.locked) {
                    statusTagHtml = '<div class="order-status-tag locked">LOCKED üîê</div>';
                } else if (order.payment_status === 'Paid') {
                    statusTagHtml = '<div class="order-status-tag paid">PAID ü§ë</div>';
                } else if (order.payment_status === 'Waiting for Confirmation') {
                    statusTagHtml = '<div class="order-status-tag pending-payment">AWAITING ADMIN TO CONFIRM PAYMENT ü§ë</div>';
                }
                
                body.innerHTML = `
                    ${statusTagHtml}
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-teal); font-size: 1.25rem;">${order.order_id}</span>
                            <span class="status-badge ${order.status.toLowerCase()}">${order.status}</span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">${order.order_date}</div>
                    </div>
                    
                    <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        <div style="font-weight: 500;">${order.full_name}</div>
                        ${order.telegram ? `<div style="color: var(--text-muted); font-size: 0.75rem;">üì± ${order.telegram}</div>` : ''}
                        ${order.mailing_address ? `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 6px;">
                                <div style="color: #065f46; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">üì¨ Shipping Details</div>
                                <div style="color: #047857; font-size: 0.85rem; margin-bottom: 0.25rem;"><strong>Receiver:</strong> ${order.mailing_name || order.full_name}</div>
                                <div style="color: #047857; font-size: 0.85rem; margin-bottom: 0.25rem;"><strong>Phone:</strong> ${order.mailing_phone || order.contact_number || 'N/A'}</div>
                                <div style="color: #047857; font-size: 0.85rem;">${order.mailing_address}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <h4 style="margin-bottom: 0.75rem;">Items</h4>
                    <div id="order-items-list">
                    ${order.items.map((item, index) => `
                        <div class="order-item-row" style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="order-item-info" style="flex: 1;">
                                <div>${item.product_name}</div>
                                <div class="order-item-qty">${item.order_type} √ó <span id="item-qty-${index}">${item.qty}</span></div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${canEdit ? `
                                <button class="edit-qty-btn" onclick="editItemQty('${escapeJS(order.order_id)}', '${escapeJS(item.product_code)}', '${escapeJS(item.order_type)}', ${item.qty})" title="Edit quantity">‚úèÔ∏è</button>
                                ` : ''}
                                <span>‚Ç±${item.line_total_php.toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                    
                    <div class="cart-summary" style="margin-top: 1rem;">
                        <div class="summary-row grand-total">
                            <span class="summary-label">Grand Total</span>
                            <span class="summary-value" id="order-grand-total">‚Ç±${order.grand_total_php.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center;">
                        <span class="status-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                        ${order.payment_screenshot ? `<a href="${order.payment_screenshot}" target="_blank" style="color: var(--accent-teal); font-size: 0.85rem;">View Receipt</a>` : ''}
                    </div>
                    
                    ${(order.payment_status === 'Unpaid' || order.payment_status === 'Waiting for Confirmation') && order.status !== 'Cancelled' && !order.locked ? `
                    <!-- Payment Section for Unpaid Orders or Waiting for Confirmation -->
                    <div class="payment-section" style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 16px; border: 2px solid var(--accent-primary);">
                        <h4 style="margin-bottom: 1rem; color: var(--accent-primary); text-align: center;">üí≥ Make Payment</h4>
                        
                        <!-- Payment QR Options -->
                        <div style="margin-bottom: 1rem;">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-align: center;">Choose your payment method:</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                <a href="https://drive.google.com/file/d/1-Fbib327N9RXsGH4rtHGTtitag5-UbLl/view?usp=drive_link" target="_blank" class="payment-qr-btn">GCash</a>
                                <a href="https://drive.google.com/file/d/1RF4q3tZhzohS_Ic3-WdA83xpWgYLU1WY/view?usp=drive_link" target="_blank" class="payment-qr-btn">Maya</a>
                                <a href="https://drive.google.com/file/d/1k2aR2xHxLWaAY4T0JMzo0i7dHXUZ5V_b/view?usp=drive_link" target="_blank" class="payment-qr-btn">BPI</a>
                                <a href="https://drive.google.com/file/d/1jhlG1vlTarnNxvji__QtzwrtIGhlNa6f/view?usp=drive_link" target="_blank" class="payment-qr-btn">UnionBank</a>
                                <a href="https://drive.google.com/file/d/1P7KvA5Sgk0yl4L-Kn_W2OV4ek3HSueFU/view?usp=drive_link" target="_blank" class="payment-qr-btn">CIMB</a>
                                <a href="https://drive.google.com/file/d/1kuBfTepRzzNfvuXh9-kgz29-Dccvhjuh/view?usp=drive_link" target="_blank" class="payment-qr-btn">MariBank</a>
                                <a href="https://drive.google.com/file/d/12dqI1EVUNCI_V3Ht4zYaFHLLzEhvysfT/view?usp=sharing" target="_blank" class="payment-qr-btn">GoTyme</a>
                            </div>
                        </div>
                        
                        <!-- Friendly Reminder -->
                        <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px dashed var(--accent-purple);">
                            <p style="font-size: 0.95rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 0.5rem; text-align: center;">‚ú® Friendly Pep_Haul Reminder! ‚ú®</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Hiii Pep Hauler! üíô</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Please leave the <strong>Notes section blank</strong>, pretty please! üß¨üí´</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">If you must write something, just your <strong>telegram username</strong> is perfect.</p>
                            <p style="font-size: 0.85rem; color: #ef4444; margin-bottom: 0.5rem;">‚ùå No "peptide payment," "payment," or anything super serious like that.</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">My bank account is just a baby (personal account lang po üòÖ) ‚Äî ayaw natin ma-flag or ma-freeze and ma-delay ang pep-haul!</p>
                            <p style="font-size: 0.85rem; color: var(--accent-primary); text-align: center; margin-top: 0.75rem;">Thank you for keeping our pep-haul smooth, happy, and drama-free! üíïü•∞</p>
                        </div>
                        
                        ${order.payment_status === 'Waiting for Confirmation' ? `
                        <!-- Waiting for Confirmation Message -->
                        <div style="text-align: center; padding: 1.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 2px solid #3b82f6;">
                            <p style="font-size: 1rem; font-weight: 600; color: #3b82f6; margin-bottom: 0.5rem;">‚è≥ Pending payment confirmation by PepHaul Admin</p>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">Thank you for your patience.</p>
                        </div>
                        ` : `
                        <!-- Mark Payment as Sent -->
                        <div style="text-align: center;">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">After payment, let PepHaul Admin know:</p>

                            <button class="btn btn-primary" onclick="markPaymentSent('${escapeJS(order.order_id)}')" style="width: 100%; font-size: 1rem; padding: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">üí∏</span>
                                <span>Payment Sent to PepHaul Admin</span>
                            </button>

                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem;">PepHaul Admin will be notified via Telegram</p>
                        </div>
                        `}
                    </div>
                    ` : ''}
                `;
                
                const footer = document.getElementById('order-details-footer');
                const hasMailing = order.mailing_address && typeof order.mailing_address === 'string' && order.mailing_address.trim() !== '';
                const contactNumber = order.contact_number || '';
                const hasShippingDetails = order.mailing_address && typeof order.mailing_address === 'string' && 
                                         typeof contactNumber === 'string' && contactNumber.trim() !== '' && order.mailing_address.trim() !== '';
                
                let footerHtml = '';
                
                // If order is paid and has shipping details, disable all action buttons (only show Close)
                if (orderIsPaid && hasShippingDetails) {
                    // Order is finalized - no action buttons, only Close
                    footerHtml += `<button class="btn btn-secondary" onclick="closeModal('order-details-modal')">Close</button>`;
                } else {
                    // Show "Add Mailing Address" button for paid orders without mailing address
                    if (orderIsPaid && !hasMailing) {
                        footerHtml += `<button class="btn btn-violet" onclick="openMailingAddressModal('${escapeJS(order.order_id)}', '${escapeJS(order.full_name)}')">üì¨ Add Mailing Address</button>`;
                    }
                    
                    // Show edit/cancel buttons only if order can be edited
                    if (canEdit) {
                        footerHtml += `<button class="btn btn-rose" onclick="cancelOrder('${escapeJS(order.order_id)}', '${escapeJS(order.telegram || '')}')" style="font-weight: 600;" title="‚ö†Ô∏è Warning: This action cannot be undone. You will need to create a new order to reserve products.">üóëÔ∏è Cancel Order</button>`;
                    }
                    
                    footerHtml += `<button class="btn btn-secondary" onclick="closeModal('order-details-modal')">Close</button>`;
                }
                
                if (footer) {
                    footer.innerHTML = footerHtml;
                } else {
                    console.error('order-details-footer element not found');
                }
                
                const orderDetailsModal = document.getElementById('order-details-modal');
                if (orderDetailsModal) {
                    orderDetailsModal.classList.add('show');
                } else {
                    console.error('order-details-modal element not found');
                    showToast('‚ùå Error: Order details modal not found', 3000);
                }
            } catch (error) {
                console.error('Error fetching order:', error);
                let errorMessage = 'Error loading order details';
                if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                } else if (error instanceof TypeError) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                }
                showToast(`‚ùå ${errorMessage}`, 5000);
            }
        }
        
        // Expose viewOrder to global scope for onclick handlers
        window.viewOrder = viewOrder;
        
        // Edit item quantity
        function editItemQty(orderId, productCode, orderType, currentQty) {
            const newQty = prompt(`Update quantity for ${productCode} (${orderType}):`, currentQty);
            if (newQty === null) return; // Cancelled
            
            const qty = parseInt(newQty);
            if (isNaN(qty) || qty < 0) {
                showToast('Please enter a valid quantity (0 or more)');
                return;
            }
            
            updateItemQuantity(orderId, productCode, orderType, qty);
        }
        
        async function updateItemQuantity(orderId, productCode, orderType, newQty) {
            try {
                const response = await fetch(`/api/orders/${orderId}/update-item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        product_code: productCode, 
                        order_type: orderType, 
                        qty: newQty 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(newQty === 0 ? 'Item removed!' : 'Quantity updated!');
                    // Refresh the order view
                    viewOrder(orderId);
                } else {
                    showToast(result.error || 'Failed to update');
                }
            } catch (error) {
                showToast('Error updating quantity');
            }
        }

        // Payment file upload removed - customers now use "Payment Sent" button

        async function markPaymentSent(orderId) {
            if (!confirm('Confirm that you have sent payment to PepHaul Admin via GCash/Maya/Bank?')) {
                return;
            }

            try {
                const response = await fetch(`/api/mark-payment-sent/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('‚úÖ Payment marked as sent! PepHaul Admin will confirm soon.');
                    // Refresh the order view
                    viewOrder(orderId);
                    // Reload orders for Customer Summary if form is locked
                    const orderFormLocked = {{ order_form_locked|tojson }};
                    if (orderFormLocked && typeof loadAllOrdersForSummary === 'function') {
                        loadAllOrdersForSummary();
                    }
                    // Reload My Orders section
                    if (typeof checkReturningCustomer === 'function') {
                        checkReturningCustomer();
                    }
                } else {
                    showToast(result.error || 'Failed to update payment status');
                }
            } catch (error) {
                console.error('Error marking payment as sent:', error);
                showToast('Network error - please try again');
            }
        }

        let cancelOrderTimeout = null;
        let cancelOrderCountdown = null;
        let pendingCancelOrderId = null;
        let pendingCancelTelegram = null;
        
        function cancelOrder(orderId, telegramUsername = '') {
            pendingCancelOrderId = orderId;
            pendingCancelTelegram = telegramUsername;
            
            // Show cancel confirmation modal
            const modal = document.getElementById('cancel-order-modal');
            modal.classList.add('show');
            
            // Reset buttons
            const undoBtn = document.getElementById('undo-cancel-btn');
            const confirmBtn = document.getElementById('confirm-cancel-btn');
            undoBtn.disabled = false;
            confirmBtn.disabled = false;
            
            // Start 5-second countdown
            let countdown = 5;
            const countdownEl = document.getElementById('cancel-countdown');
            countdownEl.textContent = `You have ${countdown} seconds to undo...`;
            
            cancelOrderCountdown = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownEl.textContent = `You have ${countdown} seconds to undo...`;
                    undoBtn.textContent = `Undo (${countdown}s)`;
                } else {
                    clearInterval(cancelOrderCountdown);
                    countdownEl.textContent = '';
                    undoBtn.disabled = true;
                    undoBtn.textContent = 'Undo (expired)';
                    // Auto-confirm after countdown
                    confirmCancelOrder();
                }
            }, 1000);
        }
        
        function undoCancelOrder() {
            if (cancelOrderCountdown) {
                clearInterval(cancelOrderCountdown);
                cancelOrderCountdown = null;
            }
            if (cancelOrderTimeout) {
                clearTimeout(cancelOrderTimeout);
                cancelOrderTimeout = null;
            }
            
            pendingCancelOrderId = null;
            pendingCancelTelegram = null;
            
            closeModal('cancel-order-modal');
            showToast('‚úÖ Cancellation cancelled. Your order is safe.');
        }
        
        async function confirmCancelOrder() {
            if (!pendingCancelOrderId) {
                return;
            }
            
            // Clear countdown
            if (cancelOrderCountdown) {
                clearInterval(cancelOrderCountdown);
                cancelOrderCountdown = null;
            }
            
            // Disable buttons
            const undoBtn = document.getElementById('undo-cancel-btn');
            const confirmBtn = document.getElementById('confirm-cancel-btn');
            undoBtn.disabled = true;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Cancelling...';
            
            try {
                const requestBody = {};
                if (pendingCancelTelegram) {
                    requestBody.telegram_username = pendingCancelTelegram;
                }
                
                const response = await fetch(`/api/orders/${pendingCancelOrderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('‚úÖ Order cancelled permanently. You must create a new order to reserve products.', 5000);
                    closeModal('cancel-order-modal');
                    closeModal('order-details-modal');
                    
                    // Clear cart if cancelled order was the current order
                    if (currentOrderId === pendingCancelOrderId) {
                        currentOrderId = null;
                        cartItems = [];
                        updateCart();
                        saveCart();
                    }
                    
                    // Refresh existing orders if function exists (safe call)
                    if (typeof checkReturningCustomer === 'function') {
                        checkReturningCustomer();
                    }
                    
                    // Try to reload orders list if function exists (safe call)
                    if (typeof loadOrders === 'function') {
                        try {
                            loadOrders();
                        } catch (e) {
                            console.log('loadOrders not available, skipping');
                        }
                    }
                } else {
                    const errorMsg = result.error || 'Failed to cancel order';
                    showToast(`‚ùå ${errorMsg}`, 5000);
                    console.error('Cancel order error:', result);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Yes, Cancel Order';
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                let errorMessage = 'Error cancelling order';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                showToast(`‚ùå ${errorMessage}`, 5000);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Yes, Cancel Order';
            } finally {
                pendingCancelOrderId = null;
                pendingCancelTelegram = null;
            }
        }
        
        // Expose cancelOrder to global scope
        window.cancelOrder = cancelOrder;

        // Mailing Address Functions
        let currentMailingOrderId = null;
        
        function openMailingAddressModal(orderId, fullName) {
            currentMailingOrderId = orderId;
            document.getElementById('mailing-name').value = fullName || '';
            document.getElementById('mailing-phone').value = '';
            const addressInput = document.getElementById('mailing-address-input');
            addressInput.value = '';
            updateMailingAddressCharCount();
            closeModal('order-details-modal');
            document.getElementById('mailing-address-modal').classList.add('show');
        }
        
        function updateMailingAddressCharCount() {
            const addressInput = document.getElementById('mailing-address-input');
            const charCountEl = document.getElementById('mailing-address-char-count');
            if (addressInput && charCountEl) {
                const length = addressInput.value.length;
                charCountEl.textContent = `${length}/500`;
                if (length > 500) {
                    charCountEl.style.color = 'var(--accent-rose)';
                } else if (length > 450) {
                    charCountEl.style.color = '#f59e0b';
                } else {
                    charCountEl.style.color = 'var(--text-muted)';
                }
            }
        }
        
        // Add event listener for character count
        // Load Timeline - tab-specific
        async function loadTimeline() {
            const timelineSection = document.getElementById('timeline-section');
            const timelineContent = document.getElementById('timeline-content');
            
            if (!timelineSection || !timelineContent) return;
            
            // Don't show timeline when form is open
            const orderFormLocked = {{ order_form_locked|tojson }};
            if (!orderFormLocked) {
                timelineSection.style.display = 'none';
                return;
            }
            
            try {
                // Get current tab from session (will be set by admin panel or default)
                const response = await fetch('/api/timeline');
                if (!response.ok) {
                    throw new Error(`Failed to load timeline: ${response.status}`);
                }
                
                const data = await response.json();
                const entries = data.entries || [];
                
                if (entries.length === 0) {
                    timelineSection.style.display = 'none';
                    return;
                }
                
                // Sort by date (oldest first for timeline flow)
                const sortedEntries = entries.sort((a, b) => {
                    const dateA = parseTimelineDate(a.date, a.time);
                    const dateB = parseTimelineDate(b.date, b.time);
                    return dateA - dateB;
                });
                
                // Helper function to parse date/time
                function parseTimelineDate(dateStr, timeStr) {
                    if (!dateStr) return new Date(0);
                    // Try common date formats
                    let date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        // Try MM/DD/YYYY format
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            date = new Date(parts[2], parts[0] - 1, parts[1]);
                        }
                    }
                    // Add time if provided
                    if (timeStr && !isNaN(date.getTime())) {
                        const timeMatch = timeStr.match(/(\d+)\s*(AM|PM|am|pm)/i);
                        if (timeMatch) {
                            let hours = parseInt(timeMatch[1]);
                            const isPM = /PM|pm/.test(timeMatch[2]);
                            if (isPM && hours !== 12) hours += 12;
                            if (!isPM && hours === 12) hours = 0;
                            date.setHours(hours, 0, 0, 0);
                        }
                    }
                    return date;
                }
                
                // Helper function to calculate time difference
                function getTimeDifference(date1, date2) {
                    const diffMs = Math.abs(date2 - date1);
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    return { days: diffDays, hours: diffHours };
                }
                
                // Calculate total time span from first to last entry
                let totalTimeSpanHtml = '';
                if (sortedEntries.length > 1) {
                    const firstEntry = sortedEntries[0];
                    const lastEntry = sortedEntries[sortedEntries.length - 1];
                    const firstDate = parseTimelineDate(firstEntry.date, firstEntry.time);
                    const lastDate = parseTimelineDate(lastEntry.date, lastEntry.time);
                    const totalDiff = getTimeDifference(firstDate, lastDate);
                    if (totalDiff.days > 0 || totalDiff.hours > 0) {
                        const totalParts = [];
                        if (totalDiff.days > 0) totalParts.push(`${totalDiff.days} day${totalDiff.days !== 1 ? 's' : ''}`);
                        if (totalDiff.hours > 0) totalParts.push(`${totalDiff.hours} hour${totalDiff.hours !== 1 ? 's' : ''}`);
                        totalTimeSpanHtml = `<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; text-align: center;"><div style="font-size: 1.75rem; color: #374151; font-weight: 600;">üìä Total Timeline: ${totalParts.join(' and ')} from first to last update</div></div>`;
                    }
                }
                
                let html = '<div style="position: relative; padding-left: 2.5rem;">';
                sortedEntries.forEach((entry, index) => {
                    const entryDate = parseTimelineDate(entry.date, entry.time);
                    const isLast = index === sortedEntries.length - 1;
                    const isFirst = index === 0;
                    
                    // Calculate time difference from previous entry
                    let timeDiffHtml = '';
                    if (!isFirst) {
                        const prevEntry = sortedEntries[index - 1];
                        const prevDate = parseTimelineDate(prevEntry.date, prevEntry.time);
                        const diff = getTimeDifference(prevDate, entryDate);
                        if (diff.days > 0 || diff.hours > 0) {
                            const diffParts = [];
                            if (diff.days > 0) diffParts.push(`${diff.days} day${diff.days !== 1 ? 's' : ''}`);
                            if (diff.hours > 0) diffParts.push(`${diff.hours} hour${diff.hours !== 1 ? 's' : ''}`);
                            timeDiffHtml = `<div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">‚è±Ô∏è ${diffParts.join(' and ')} since last update</div>`;
                        }
                    }
                    
                    html += `
                        <div style="position: relative; margin-bottom: ${isLast ? '0' : '1.5rem'};">
                            <!-- Timeline dot -->
                            <div style="position: absolute; left: -2.5rem; top: 0.5rem; width: 14px; height: 14px; background: #fbbf24; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #fbbf24; z-index: 2;"></div>
                            <!-- Connecting line -->
                            ${!isLast ? '<div style="position: absolute; left: -2rem; top: 1.25rem; width: 2px; height: calc(100% + 0.5rem); background: linear-gradient(to bottom, #fbbf24 0%, rgba(251, 191, 36, 0.3) 100%); z-index: 1;"></div>' : ''}
                            <!-- Arrow pointing to card -->
                            <div style="position: absolute; left: -1.5rem; top: 0.5rem; width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-right: 8px solid #fbbf24; z-index: 2;"></div>
                            <!-- Card -->
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 3px solid #fbbf24;">
                                ${timeDiffHtml}
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <span style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${entry.date}</span>
                                    ${entry.time ? `<span style="color: var(--text-secondary); font-size: 0.9rem;">‚Ä¢ ${entry.time}</span>` : ''}
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(0,0,0,0.05);">${entry.details ? escapeJS(entry.details) : '<em style="color: #9ca3af;">No details provided</em>'}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                html += totalTimeSpanHtml;
                
                timelineContent.innerHTML = html;
                timelineSection.style.display = 'block';
            } catch (error) {
                console.error('Error loading timeline:', error);
                timelineSection.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const addressInput = document.getElementById('mailing-address-input');
            if (addressInput) {
                addressInput.addEventListener('input', updateMailingAddressCharCount);
            }
            
            // Load all orders for Customer Summary if order form is locked
            const orderFormLocked = {{ order_form_locked|tojson }};
            if (orderFormLocked) {
                loadAllOrdersForSummary();
            }
            
            // Load timeline
            loadTimeline();
        });
        
        async function saveMailingAddress() {
            if (!currentMailingOrderId) return;
            
            const mailingName = document.getElementById('mailing-name').value.trim();
            const mailingPhone = document.getElementById('mailing-phone').value.trim();
            const mailingAddress = document.getElementById('mailing-address-input').value.trim();
            
            if (!mailingName) {
                showToast('Please enter receiver name');
                return;
            }
            if (!mailingPhone || mailingPhone.length < 10) {
                showToast('Please enter valid phone number (10 digits)');
                return;
            }
            if (!mailingAddress) {
                showToast('Please enter mailing address');
                return;
            }
            if (mailingAddress.length > 500) {
                showToast('Mailing address must be 500 characters or less');
                return;
            }
            
            const btn = document.getElementById('save-mailing-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const response = await fetch(`/api/orders/${currentMailingOrderId}/mailing-address`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mailing_name: mailingName,
                        mailing_phone: '+63' + mailingPhone,
                        mailing_address: mailingAddress
                    })
                });
                
                if (!response.ok) {
                    // If response is not OK, try to parse error
                    const errorResult = await response.json().catch(() => ({ error: 'Failed to save address' }));
                    showToast(errorResult.error || 'Failed to save address');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Mailing address saved! üì¨');
                    closeModal('mailing-address-modal');
                    // Refresh order summary to update button visibility
                    if (typeof checkReturningCustomer === 'function') {
                        checkReturningCustomer();
                    }
                    if (typeof updateSubmitButtonText === 'function') {
                        updateSubmitButtonText();
                    }
                    // Reload all orders for Customer Summary
                    const orderFormLocked = {{ order_form_locked|tojson }};
                    if (orderFormLocked && typeof loadAllOrdersForSummary === 'function') {
                        loadAllOrdersForSummary();
                    } else if (typeof loadAllOrdersForSummary === 'function') {
                        loadAllOrdersForSummary();
                    }
                } else {
                    showToast(result.error || 'Failed to save address');
                }
            } catch (error) {
                console.error('Error saving mailing address:', error);
                showToast('Error saving address');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Address';
            }
        }

        // Add items to existing order
        let addingToOrderId = null;
        
        function addToExistingOrder(orderId) {
            addingToOrderId = orderId;
            closeModal('order-details-modal');
            
            // Switch to new order view
            switchView('view-new-order');
            
            // Show notification banner
            showAddToOrderBanner(orderId);
            
            showToast(`Adding items to order ${orderId}`);
        }
        
        function showAddToOrderBanner(orderId) {
            // Remove existing banner if any
            const existingBanner = document.getElementById('add-to-order-banner');
            if (existingBanner) existingBanner.remove();
            
            // Create banner
            const banner = document.createElement('div');
            banner.id = 'add-to-order-banner';
            banner.className = 'add-to-order-banner';
            banner.innerHTML = `
                <div class="banner-content">
                    <span class="banner-icon">‚ú®</span>
                    <span class="banner-text">Adding items to <strong>${orderId}</strong></span>
                    <button class="banner-cancel" onclick="cancelAddToOrder()">‚úï Cancel</button>
                </div>
            `;
            
            // Insert at top of order form card
            const card = document.querySelector('#view-new-order .card');
            if (card) {
                card.insertBefore(banner, card.firstChild);
            }
            
            // Update submit button text
            const submitBtn = document.getElementById('submit-order');
            if (submitBtn) {
                submitBtn.innerHTML = '‚ûï Add to Existing Order';
            }
        }
        
        function cancelAddToOrder() {
            addingToOrderId = null;
            const banner = document.getElementById('add-to-order-banner');
            if (banner) banner.remove();
            
            // Reset submit button text
            const submitBtn = document.getElementById('submit-order');
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Order';
            }
            
            showToast('Cancelled adding to order');
        }
        
        // Show updated order details after adding items
        async function showViewOrderDetails(orderId) {
            // Small delay to ensure backend has updated
            await new Promise(resolve => setTimeout(resolve, 500));
            viewOrder(orderId);
        }


        // Modals
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Toast
        // Inventory Card Quantity Management
        function adjustInvQty(productCode, orderType, delta) {
            const inputId = orderType === 'Kit' ? `inv-kit-qty-${productCode}` : `inv-vial-qty-${productCode}`;
            const input = document.getElementById(inputId);
            
            if (!input) {
                console.error('Input not found:', inputId);
                return;
            }
            
            const currentQty = parseInt(input.value) || 0;
            const maxQty = parseInt(input.getAttribute('max')) || 99;
            let newQty = currentQty + delta;
            
            // Enforce min/max limits
            if (newQty < 0) newQty = 0;
            if (newQty > maxQty) newQty = maxQty;
            
            input.value = newQty;
            
            // Trigger input event to ensure any listeners are notified
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Expose adjustInvQty to global scope for onclick handlers
        window.adjustInvQty = adjustInvQty;

        function quickAddToCart(productCode, productName, supplier) {
            console.log('quickAddToCart called:', { productCode, productName, supplier });
            
            // Check if products are loaded
            if (!allProducts || allProducts.length === 0) {
                console.error('‚ùå Products not loaded yet');
                showToast('‚è≥ Products are still loading. Please wait a moment and try again.');
                return;
            }
            
            // Find product data from allProducts array
            const product = allProducts.find(p => p.code === productCode);
            if (!product) {
                console.error('‚ùå Product not found:', productCode);
                console.log('Available products:', allProducts.map(p => p.code));
                showToast('‚ö†Ô∏è Product not found. Please refresh the page.');
                return;
            }
            
            // Check if product is locked
            if (product.inventory && product.inventory.is_locked) {
                showToast('‚ùå This product is locked and cannot be added to your order');
                return;
            }
            
            // Get supplier from product if not provided
            const productSupplier = supplier || product.supplier || 'Default';
            
            console.log('‚úÖ Found product:', product);
            
            const kitPrice = product.kit_price;
            const vialPrice = product.vial_price;

            // Get quantities from inputs
            const kitQtyInput = document.getElementById(`inv-kit-qty-${productCode}`);
            const vialQtyInput = document.getElementById(`inv-vial-qty-${productCode}`);
            
            const kitQty = kitQtyInput ? parseInt(kitQtyInput.value) || 0 : 0;
            const vialQty = vialQtyInput ? parseInt(vialQtyInput.value) || 0 : 0;
            
            let added = false;
            
            if (kitQty > 0) {
                // Add kits to cart - match by product_code, order_type, AND supplier
                const existingKitIndex = cartItems.findIndex(item => 
                    item.product_code === productCode && 
                    item.order_type === 'Kit' &&
                    item.supplier === productSupplier
                );
                
                if (existingKitIndex !== -1) {
                    cartItems[existingKitIndex].qty += kitQty;
                    // Recalculate totals
                    const item = cartItems[existingKitIndex];
                    item.line_total_usd = item.unit_price_usd * item.qty;
                    item.line_total_php = item.line_total_usd * EXCHANGE_RATE;
                } else {
                    const lineTotalUsd = kitPrice * kitQty;
                    cartItems.push({
                        product_code: productCode,
                        product_name: productName,
                        order_type: 'Kit',
                        supplier: productSupplier,
                        qty: kitQty,
                        unit_price_usd: kitPrice,
                        line_total_usd: lineTotalUsd,
                        line_total_php: lineTotalUsd * EXCHANGE_RATE
                    });
                }
                added = true;
            }
            
            if (vialQty > 0) {
                // Add vials to cart - match by product_code, order_type, AND supplier
                const existingVialIndex = cartItems.findIndex(item => 
                    item.product_code === productCode && 
                    item.order_type === 'Vial' &&
                    item.supplier === productSupplier
                );
                
                if (existingVialIndex !== -1) {
                    cartItems[existingVialIndex].qty += vialQty;
                    // Recalculate totals
                    const item = cartItems[existingVialIndex];
                    item.line_total_usd = item.unit_price_usd * item.qty;
                    item.line_total_php = item.line_total_usd * EXCHANGE_RATE;
                } else {
                    const lineTotalUsd = vialPrice * vialQty;
                    cartItems.push({
                        product_code: productCode,
                        product_name: productName,
                        order_type: 'Vial',
                        supplier: productSupplier,
                        qty: vialQty,
                        unit_price_usd: vialPrice,
                        line_total_usd: lineTotalUsd,
                        line_total_php: lineTotalUsd * EXCHANGE_RATE
                    });
                }
                added = true;
            }

            if (added) {
                updateCart();
                saveCart();
                showToast(`‚úÖ Added ${productName} to cart!`);
                
                // Reset quantities to 0
                if (kitQtyInput) kitQtyInput.value = 0;
                if (vialQtyInput) vialQtyInput.value = 0;
                
                // Scroll to cart (with error handling) - scroll to supplier-specific new-order-section
                try {
                    const newOrderSection = document.querySelector(`.new-order-section[data-supplier="${productSupplier}"]`);
                    if (newOrderSection) {
                        newOrderSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        // Fallback: scroll to supplier cart section
                        const supplierCart = document.querySelector(`.supplier-cart[data-supplier="${productSupplier}"]`);
                        if (supplierCart) {
                            supplierCart.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            console.warn(`new-order section not found for supplier: ${productSupplier}`);
                        }
                    }
                } catch (error) {
                    console.error('Error scrolling to cart:', error);
                }
            } else {
                showToast('Please select quantity using + buttons!');
            }
        }
        
        // Expose quickAddToCart to global scope for onclick handlers
        window.quickAddToCart = quickAddToCart;

        // Inventory Search
        const inventorySearchInput = document.getElementById('inventory-search');
        if (inventorySearchInput) {
            inventorySearchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.inventory-card').forEach(card => {
                    const code = card.dataset.code.toLowerCase();
                    const name = card.dataset.name.toLowerCase();
                    const visible = code.includes(query) || name.includes(query);
                    card.style.display = visible ? '' : 'none';
                });
            });
        }

        // Initialize
        // On page load: only load cart if Name and Telegram are filled
        // Otherwise, clear cart and wait for user input
        const initialTelegram = telegramInput ? telegramInput.value.trim() : '';
        const initialFullName = fullNameInput ? fullNameInput.value.trim() : '';
        
        if (initialTelegram && initialFullName) {
            // Fields are pre-filled (e.g., from URL params or previous session)
            // Load cart and check for existing orders
            loadCart();
            checkReturningCustomer();
        } else {
            // Fields are empty - clear cart and don't load anything
            cartItems = [];
            currentOrderId = null;
            originalOrderItems = [];
            updateCart();
            saveCart();
        }
        
        // Always update button visibility on page load
        setTimeout(() => {
            updateSubmitButtonText();
        }, 100); // Small delay to ensure DOM is fully ready
    </script>
</body>
</html>
