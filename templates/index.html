<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Pep Haulers Hub | Order Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Lobster&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fdf8ff;
            --bg-secondary: #fef1f8;
            --bg-card: rgba(255, 255, 255, 0.85);
            --bg-input: rgba(255, 248, 253, 0.9);
            --accent-primary: #e879a9;
            --accent-secondary: #c084fc;
            --accent-gold: #d4a574;
            --accent-rose: #f9a8d4;
            --accent-lavender: #ddd6fe;
            --accent-blush: #fecdd3;
            --accent-glow: #f0abfc;
            --text-primary: #4a1942;
            --text-secondary: #831843;
            --text-muted: #be185d;
            --border: rgba(236, 72, 153, 0.2);
            --border-glow: rgba(240, 171, 252, 0.5);
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Animated Background with Vials */
        body {
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
            background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 25%, #fbcfe8 50%, #f472b6 75%, #fce7f3 100%);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 10% 20%, rgba(244, 114, 182, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(192, 132, 252, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(240, 171, 252, 0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 20%, rgba(249, 168, 212, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 20% 80%, rgba(221, 214, 254, 0.12) 0%, transparent 45%);
            pointer-events: none;
            z-index: 0;
        }

        /* Floating Vials Background */
        .vial-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .vial {
            position: absolute;
            opacity: 0.08;
            animation: floatVial 20s ease-in-out infinite;
        }

        .vial:nth-child(1) { left: 5%; top: 10%; animation-delay: 0s; }
        .vial:nth-child(2) { left: 15%; top: 60%; animation-delay: -5s; }
        .vial:nth-child(3) { left: 85%; top: 20%; animation-delay: -10s; }
        .vial:nth-child(4) { left: 75%; top: 70%; animation-delay: -15s; }
        .vial:nth-child(5) { left: 45%; top: 85%; animation-delay: -7s; }
        .vial:nth-child(6) { left: 92%; top: 45%; animation-delay: -12s; }
        .vial:nth-child(7) { left: 8%; top: 35%; animation-delay: -3s; }
        .vial:nth-child(8) { left: 60%; top: 5%; animation-delay: -18s; }

        @keyframes floatVial {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(3deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(15px) rotate(-3deg); }
        }

        /* Sparkle Animation */
        .sparkle {
            position: fixed;
            pointer-events: none;
            z-index: 0;
        }

        .sparkle::before, .sparkle::after {
            content: '✦';
            position: absolute;
            font-size: 12px;
            color: var(--accent-rose);
            animation: twinkle 3s ease-in-out infinite;
        }

        .sparkle:nth-child(1)::before { left: 10%; top: 15%; animation-delay: 0s; }
        .sparkle:nth-child(1)::after { left: 85%; top: 25%; animation-delay: 1s; }
        .sparkle:nth-child(2)::before { left: 75%; top: 60%; animation-delay: 0.5s; }
        .sparkle:nth-child(2)::after { left: 20%; top: 80%; animation-delay: 1.5s; }
        .sparkle:nth-child(3)::before { left: 50%; top: 10%; animation-delay: 2s; }
        .sparkle:nth-child(3)::after { left: 30%; top: 40%; animation-delay: 2.5s; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem; 
            position: relative; 
            z-index: 1; 
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.08);
        }

        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(232, 121, 169, 0.3);
        }

        .nav-tab.admin {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15) 0%, rgba(232, 121, 169, 0.1) 100%);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .nav-tab.admin:hover {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-primary) 100%);
            color: white;
            border-color: transparent;
        }

        /* Header */
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 {
            font-family: 'Lobster', cursive;
            font-size: 4rem;
            font-weight: 400;
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 20%, #6d28d9 40%, #7c3aed 60%, #8b5cf6 80%, #9333ea 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.02em;
            text-shadow: 0 0 60px rgba(255, 107, 157, 0.5), 0 0 120px rgba(196, 69, 105, 0.3);
            animation: shimmer 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(196, 69, 105, 0.3));
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header-subtitle {
            font-family: 'Lobster', cursive;
            font-size: 1.3rem;
            background: linear-gradient(90deg, #9f1239 0%, #db2777 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 0.75rem;
            letter-spacing: 0.05em;
            text-shadow: 0 0 30px rgba(219, 39, 119, 0.3);
        }
        
        /* Consolidated Stats Section */
        .stats-banner {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(254, 205, 211, 0.7) 50%, rgba(251, 207, 232, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(244, 114, 182, 0.3);
            border-radius: 24px;
            padding: 1.5rem 2rem;
            margin: 1.5rem 0;
            box-shadow: 0 8px 32px rgba(244, 114, 182, 0.15);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(244, 114, 182, 0.2);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-family: 'Lobster', cursive;
            font-size: 2rem;
            background: linear-gradient(135deg, #be185d 0%, #c084fc 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Progress to Goal */
        .goal-section {
            margin-top: 1rem;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .goal-label {
            font-family: 'Lobster', cursive;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .goal-amount {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .goal-bar {
            height: 24px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(251, 207, 232, 0.5));
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(244, 114, 182, 0.3);
            position: relative;
        }
        
        .goal-fill {
            height: 100%;
            background: linear-gradient(90deg, #f472b6 0%, #ec4899 30%, #db2777 60%, #be185d 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .goal-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
            animation: goalShimmer 2s ease-in-out infinite;
        }
        
        @keyframes goalShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .goal-percentage {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            font-size: 0.85rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .goal-reached {
            background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%) !important;
        }
        
        /* Products with Orders Section */
        .orders-summary-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.85) 0%, rgba(221, 214, 254, 0.5) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .orders-summary-title {
            font-family: 'Lobster', cursive;
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .orders-product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .order-product-card {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 16px;
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .order-product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(192, 132, 252, 0.15);
        }
        
        .order-product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .order-product-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.2;
        }
        
        .order-product-code {
            font-size: 0.8rem;
            color: #e11d48;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .order-product-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .order-vials-count {
            color: #e11d48;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .missing-slots {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .kit-complete {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }

        /* Rate Banner - Glass Morphism */
        .rate-banner {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 8px 32px rgba(236, 72, 153, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        }

        .rate-item { display: flex; align-items: center; gap: 0.75rem; }
        .rate-label { 
            font-size: 0.75rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            font-weight: 500;
        }
        .rate-value { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 1.25rem; 
            font-weight: 600; 
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .rate-value.amber { 
            background: linear-gradient(135deg, var(--accent-gold) 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Main Grid - Equal width sections */
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 2rem; 
            align-items: start;
        }
        @media (max-width: 1024px) { 
            .main-grid { 
                grid-template-columns: 1fr; 
            } 
        }

        /* Cards - Glass Morphism */
        .card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 
                0 8px 32px rgba(232, 121, 169, 0.1),
                0 2px 8px rgba(192, 132, 252, 0.08),
                inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 
                0 12px 40px rgba(232, 121, 169, 0.15),
                0 4px 12px rgba(192, 132, 252, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }

        .card-title .icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(232, 121, 169, 0.3);
        }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            margin-bottom: 0.5rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
        }
        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(232, 121, 169, 0.2);
            border-radius: 14px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(232, 121, 169, 0.05);
        }
        .form-input::placeholder { color: var(--text-muted); opacity: 0.6; }
        .form-input:focus { 
            outline: none; 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 4px rgba(232, 121, 169, 0.15), 0 4px 12px rgba(232, 121, 169, 0.1);
        }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* Toggle - Two Clear Buttons */
        .order-type-toggle { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .toggle-btn {
            padding: 1rem 1.25rem;
            border: 2px solid var(--accent-primary);
            background: rgba(255, 255, 255, 0.8);
            color: var(--accent-primary);
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-btn:hover {
            background: rgba(232, 121, 169, 0.1);
            transform: translateY(-2px);
        }
        .toggle-btn.active { 
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); 
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(232, 121, 169, 0.4);
        }

        /* Buttons - Elegant with Glow */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 30px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        .btn:hover::before { left: 100%; }
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(232, 121, 169, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 30px rgba(232, 121, 169, 0.4);
        }
        .btn-secondary { 
            background: rgba(255, 255, 255, 0.8); 
            border: 1px solid rgba(232, 121, 169, 0.3); 
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--accent-primary);
        }
        .btn-violet { 
            background: linear-gradient(135deg, var(--accent-secondary) 0%, #a855f7 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.3);
        }
        .btn-violet:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(192, 132, 252, 0.4);
        }
        .btn-rose { 
            background: linear-gradient(135deg, rgba(249, 168, 212, 0.2) 0%, rgba(244, 114, 182, 0.15) 100%); 
            border: 1px solid var(--accent-rose); 
            color: var(--text-secondary);
        }
        .btn-rose:hover {
            background: linear-gradient(135deg, var(--accent-rose) 0%, #f472b6 100%);
            color: white;
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-full { width: 100%; }

        /* Product Dropdown */
        .product-search-container { position: relative; z-index: 1000; }
        .product-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            max-height: 420px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .product-dropdown.show { display: block; }
        .product-option {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .product-option:hover { background: rgba(20, 184, 166, 0.1); }
        .product-option.locked { opacity: 0.5; pointer-events: none; }
        .product-option-name { font-weight: 500; margin-bottom: 0.25rem; }
        .product-option-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 1rem; }
        .product-option-meta span { font-family: 'JetBrains Mono', monospace; }
        .locked-badge { background: var(--accent-rose); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* Inventory Stats */
        .inventory-stats {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .inventory-title { font-size: 0.75rem; font-weight: 600; color: var(--accent-emerald); text-transform: uppercase; margin-bottom: 0.75rem; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .inventory-item { text-align: center; }
        .inventory-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; }
        .inventory-value.highlight { color: var(--accent-amber); }
        .inventory-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

        /* Cart */
        .cart-empty { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .cart-items { 
            /* Remove scrolling - show all items */
            overflow-y: visible;
            max-height: none;
        }
        .cart-item {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
        }
        .cart-item-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .cart-item-name { font-weight: 500; }
        .cart-item-code { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-teal); background: rgba(20, 184, 166, 0.1); padding: 2px 8px; border-radius: 4px; }
        .cart-item-details { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary); }
        .cart-item-price { font-family: 'JetBrains Mono', monospace; color: var(--accent-amber); }
        .cart-item-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(244, 63, 94, 0.1);
            color: var(--accent-rose);
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
        }
        .cart-item:hover .cart-item-remove { opacity: 1; }

        .cart-summary {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .summary-row { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem; }
        .summary-row.grand-total { font-size: 1.25rem; font-weight: 700; color: var(--accent-teal); border-top: 2px solid var(--border); margin-top: 0.5rem; padding-top: 1rem; }
        .summary-label { color: var(--text-secondary); }
        .summary-value { font-family: 'JetBrains Mono', monospace; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(88, 28, 135, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #fdf4ff 50%, #fce7f3 100%);
            border: 2px solid #e9d5ff;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(168, 85, 247, 0.25), 0 10px 25px rgba(236, 72, 153, 0.15);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-input);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
        }
        .modal-body { margin-bottom: 1.5rem; }
        .modal-footer { display: flex; gap: 1rem; justify-content: flex-end; }

        /* Order Summary in Modal */
        .order-summary-header { text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(252, 231, 243, 0.9) 0%, rgba(249, 168, 212, 0.7) 100%); border-radius: 12px; margin-bottom: 1.5rem; }
        .order-summary-header h2 { 
            background: linear-gradient(135deg, #be185d 0%, #dc2626 50%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        .order-id { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 1.25rem; 
            background: linear-gradient(135deg, #be185d 0%, #dc2626 50%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .order-items-list { margin-bottom: 1.5rem; }
        .order-item-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .order-item-info { flex: 1; }
        .order-item-qty { color: var(--text-muted); font-size: 0.85rem; }

        /* Payment Upload */
        .payment-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border); }
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .upload-area:hover { border-color: var(--accent-teal); background: rgba(20, 184, 166, 0.05); }
        .upload-area.has-file { border-color: var(--accent-emerald); background: rgba(16, 185, 129, 0.1); }
        .upload-preview { max-width: 200px; max-height: 150px; margin-top: 1rem; border-radius: 8px; }

        /* Full-Width Inventory Section */
        .inventory-full-section {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .inventory-card {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }
        
        /* Darker gradient for products with registered orders */
        .inventory-card.has-orders {
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.25) 0%, rgba(232, 121, 169, 0.3) 50%, rgba(251, 146, 60, 0.2) 100%);
            border: 2px solid var(--accent-purple);
            box-shadow: 0 4px 15px rgba(192, 132, 252, 0.2);
        }
        
        .inventory-card.has-orders .inv-card-name {
            color: var(--accent-purple);
            font-weight: 600;
        }
        
        .inventory-card.has-orders .inv-stat-value {
            color: var(--accent-purple);
        }

        .inventory-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(232, 121, 169, 0.15);
            border-color: var(--accent-primary);
        }
        
        .inventory-card.has-orders:hover {
            box-shadow: 0 8px 25px rgba(192, 132, 252, 0.3);
            border-color: var(--accent-purple);
        }
        
        .inventory-card.clickable {
            cursor: pointer;
        }
        
        .inventory-card.clickable:not(.card-locked):hover {
            background: rgba(232, 121, 169, 0.1);
            border-color: var(--accent-primary);
        }
        
        .inventory-card.clickable.has-orders:not(.card-locked):hover {
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.35) 0%, rgba(232, 121, 169, 0.4) 50%, rgba(251, 146, 60, 0.3) 100%);
        }
        
        .inventory-card.clickable:not(.card-locked):active {
            transform: scale(0.98);
        }
        
        .inventory-card.card-locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .inv-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .inv-card-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.3;
            flex: 1;
            padding-right: 0.5rem;
        }

        .inv-card-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-primary);
            background: rgba(232, 121, 169, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .inv-card-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .inv-stat {
            text-align: center;
            flex: 1;
        }

        .inv-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
        }

        .inv-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .inv-card-progress {
            margin-bottom: 0.75rem;
        }

        .inv-progress-bar-full {
            width: 100%;
            height: 8px;
            background: rgba(232, 121, 169, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .inv-card-status {
            text-align: center;
        }

        .inv-product-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
            font-weight: 500;
        }
        .inv-kits-badge {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            background: rgba(232, 121, 169, 0.15);
            color: var(--accent-primary);
        }
        .inv-lock-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .inv-lock-badge.open {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }
        .inv-lock-badge.locked {
            background: rgba(244, 63, 94, 0.15);
            color: #f43f5e;
        }
        .inventory-search {
            margin-bottom: 1rem;
        }
        .inventory-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .inventory-scroll {
            max-height: 350px;
            overflow-y: auto;
        }
        .inv-progress-bar {
            width: 60px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .inv-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Edit Quantity Button */
        .edit-qty-btn {
            background: rgba(232, 121, 169, 0.1);
            border: 1px solid var(--accent-primary);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .edit-qty-btn:hover {
            background: var(--accent-primary);
            transform: scale(1.1);
        }

        /* Returning Customer Banner */
        .returning-customer-banner {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: gentle-pulse 2s infinite;
        }
        @keyframes gentle-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 15px 3px rgba(16, 185, 129, 0.2); }
        }
        .returning-customer-banner .banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .returning-customer-banner strong {
            color: #059669;
        }

        /* Payment QR Buttons */
        .payment-qr-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--accent-primary);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 2px solid var(--accent-primary);
            transition: all 0.2s;
        }
        .payment-qr-btn:hover {
            background: white;
            color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 121, 169, 0.3);
        }

        /* Add to Order Banner */
        .add-to-order-banner {
            background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: var(--accent-primary); box-shadow: 0 0 0 0 rgba(232, 121, 169, 0.4); }
            50% { border-color: var(--accent-purple); box-shadow: 0 0 10px 2px rgba(232, 121, 169, 0.3); }
        }
        .banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .banner-icon {
            font-size: 1.5rem;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .banner-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .banner-text strong {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
        }
        .banner-cancel {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .banner-cancel:hover {
            background: rgba(244, 63, 94, 0.2);
        }

        /* Orders List */
        .orders-section { margin-top: 2rem; }
        .orders-search { margin-bottom: 1rem; }
        .orders-list { max-height: 400px; overflow-y: auto; }
        .order-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .order-card:hover { border-color: var(--accent-teal); transform: translateX(4px); }
        .order-card-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .order-card-id { font-family: 'JetBrains Mono', monospace; color: var(--accent-teal); }
        .order-card-date { font-size: 0.8rem; color: var(--text-muted); }
        .order-card-customer { font-weight: 500; margin-bottom: 0.25rem; }
        .order-card-total { font-family: 'JetBrains Mono', monospace; color: var(--accent-amber); }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-badge.pending { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .status-badge.paid { background: rgba(16, 185, 129, 0.15); color: var(--accent-emerald); }
        .status-badge.unpaid { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        .status-badge.waiting { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .status-badge.locked { background: rgba(139, 92, 246, 0.15); color: var(--accent-violet); }
        .status-badge.cancelled { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-teal);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-icon { width: 32px; height: 32px; background: var(--accent-teal); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-primary); }

        /* Quantity Controls */
        .qty-input-group { display: flex; align-items: center; gap: 0.5rem; }
        .qty-btn {
            width: 44px;
            height: 44px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 1.25rem;
            cursor: pointer;
        }
        .qty-btn:hover { border-color: var(--accent-teal); color: var(--accent-teal); }
        .qty-input { width: 80px; text-align: center; font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        /* Quantity Control for Inventory Cards */
        .inv-qty-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        .inv-qty-btn {
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .inv-qty-btn:hover {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            border-color: #ec4899;
        }
        .inv-qty-btn:active {
            transform: scale(0.95);
        }
        .inv-qty-input {
            width: 40px;
            height: 24px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--accent-primary);
            border-radius: 8px;
            padding: 0;
        }

        /* Click to Add Button */
        .btn-click-to-add {
            width: 100%;
            padding: 0.5rem;
            background: linear-gradient(135deg, #10b981, #14b8a6);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-click-to-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-click-to-add:active {
            transform: scale(0.95);
        }

        /* Price Display */
        .price-display { background: var(--bg-input); border-radius: 10px; padding: 1rem; margin-top: 1rem; }
        .price-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
        .price-row:last-child { border-bottom: none; }
        .price-label { color: var(--text-secondary); }
        .price-value { font-family: 'JetBrains Mono', monospace; font-weight: 500; }

        /* Progress Bar */
        .kit-progress { margin-top: 0.75rem; }
        .kit-progress-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .kit-progress-bar { height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .kit-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-teal), var(--accent-emerald)); border-radius: 4px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Floating Vials Background -->
    <div class="vial-bg">
        <svg class="vial" width="60" height="120" viewBox="0 0 60 120" fill="none">
            <defs>
                <linearGradient id="vialGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#f9a8d4;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect x="15" y="25" width="30" height="85" rx="5" fill="url(#vialGrad1)" opacity="0.6"/>
            <rect x="20" y="5" width="20" height="25" rx="3" fill="#ddd6fe" opacity="0.8"/>
            <ellipse cx="30" cy="5" rx="12" ry="4" fill="#e879a9" opacity="0.7"/>
            <rect x="22" y="40" width="16" height="50" rx="2" fill="white" opacity="0.3"/>
        </svg>
        <svg class="vial" width="50" height="100" viewBox="0 0 50 100" fill="none">
            <defs>
                <linearGradient id="vialGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ddd6fe;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f9a8d4;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect x="12" y="20" width="26" height="72" rx="4" fill="url(#vialGrad2)" opacity="0.5"/>
            <rect x="16" y="4" width="18" height="20" rx="2" fill="#fecdd3" opacity="0.7"/>
            <ellipse cx="25" cy="4" rx="10" ry="3" fill="#c084fc" opacity="0.6"/>
        </svg>
        <svg class="vial" width="45" height="90" viewBox="0 0 45 90" fill="none">
            <rect x="10" y="18" width="25" height="65" rx="4" fill="#f9a8d4" opacity="0.4"/>
            <rect x="14" y="4" width="17" height="18" rx="2" fill="#ddd6fe" opacity="0.6"/>
            <ellipse cx="22" cy="4" rx="9" ry="3" fill="#e879a9" opacity="0.5"/>
        </svg>
        <svg class="vial" width="55" height="110" viewBox="0 0 55 110" fill="none">
            <rect x="13" y="22" width="29" height="78" rx="5" fill="#c084fc" opacity="0.35"/>
            <rect x="18" y="5" width="19" height="22" rx="3" fill="#fecdd3" opacity="0.5"/>
            <ellipse cx="27" cy="5" rx="11" ry="4" fill="#f9a8d4" opacity="0.4"/>
        </svg>
        <svg class="vial" width="40" height="85" viewBox="0 0 40 85" fill="none">
            <rect x="8" y="16" width="24" height="62" rx="4" fill="#ddd6fe" opacity="0.45"/>
            <rect x="12" y="3" width="16" height="17" rx="2" fill="#f9a8d4" opacity="0.55"/>
            <ellipse cx="20" cy="3" rx="8" ry="3" fill="#c084fc" opacity="0.5"/>
        </svg>
        <svg class="vial" width="48" height="95" viewBox="0 0 48 95" fill="none">
            <rect x="11" y="19" width="26" height="68" rx="4" fill="#fecdd3" opacity="0.4"/>
            <rect x="15" y="4" width="18" height="19" rx="2" fill="#c084fc" opacity="0.5"/>
            <ellipse cx="24" cy="4" rx="9" ry="3" fill="#ddd6fe" opacity="0.45"/>
        </svg>
        <svg class="vial" width="52" height="105" viewBox="0 0 52 105" fill="none">
            <rect x="12" y="21" width="28" height="76" rx="5" fill="#f9a8d4" opacity="0.35"/>
            <rect x="17" y="5" width="18" height="20" rx="3" fill="#ddd6fe" opacity="0.45"/>
            <ellipse cx="26" cy="5" rx="10" ry="3" fill="#e879a9" opacity="0.4"/>
        </svg>
        <svg class="vial" width="42" height="88" viewBox="0 0 42 88" fill="none">
            <rect x="9" y="17" width="24" height="64" rx="4" fill="#c084fc" opacity="0.3"/>
            <rect x="13" y="4" width="16" height="17" rx="2" fill="#fecdd3" opacity="0.5"/>
            <ellipse cx="21" cy="4" rx="8" ry="3" fill="#f9a8d4" opacity="0.4"/>
        </svg>
    </div>

    <!-- Sparkles -->
    <div class="sparkle"></div>
    <div class="sparkle"></div>
    <div class="sparkle"></div>

    <div class="container">
        <!-- Navigation -->
        <nav class="nav-bar">
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="new-order">Customer Order Section</button>
            </div>
            <a href="/admin" class="nav-tab admin">Admin Panel</a>
        </nav>

        <!-- Header -->
        <header class="header">
            <h1>✨ Pep Haulers Order Form ✨</h1>
            <p class="header-subtitle">Your access to high purity (99%) affordable peptide reservations</p>
        </header>

        <!-- Consolidated Order Stats Banner -->
        <div class="stats-banner">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">📦 Total Kits Value</div>
                    <div class="stat-value">${{ "%.2f"|format(order_stats.total_kits_usd) }}</div>
                    <div class="stat-count">{{ order_stats.total_kits_count }} kits ordered</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">🧪 Total Vials Value</div>
                    <div class="stat-value">${{ "%.2f"|format(order_stats.total_vials_usd) }}</div>
                    <div class="stat-count">{{ order_stats.total_vials_count }} vials ordered</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">💎 Combined Total</div>
                    <div class="stat-value">${{ "%.2f"|format(order_stats.combined_total_usd) }}</div>
                    <div class="stat-count">All active orders</div>
                </div>
            </div>
            
            <!-- Progress to $1000 Goal -->
            <div class="goal-section">
                <div class="goal-header">
                    <span class="goal-label">🎯 Progress to Goal</span>
                    <span class="goal-amount">${{ "%.2f"|format(order_stats.combined_total_usd) }} / ${{ "%.0f"|format(order_goal) }}</span>
                </div>
                <div class="goal-bar">
                    {% if order_goal > 0 %}
                        {% set calculated_progress = (order_stats.combined_total_usd / order_goal * 100) %}
                        {% set progress = calculated_progress if calculated_progress < 100 else 100 %}
                    {% else %}
                        {% set progress = 0 %}
                    {% endif %}
                    <div class="goal-fill{% if progress >= 100 %} goal-reached{% endif %}" style="width: {{ progress|round(0, 'floor') }}%;">
                        <span class="goal-percentage">{{ progress|round(0, 'floor') }}%</span>
                    </div>
                </div>
            </div>
        </div>

        {% if order_form_locked %}
        <!-- Order Form Locked Banner -->
        <div class="locked-banner" style="background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border: 2px solid #ef4444; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">🔒</div>
            <h2 style="color: #991b1b; margin-bottom: 0.75rem; font-size: 1.5rem;">Orders Currently Closed</h2>
            <p style="color: #7f1d1d; font-size: 1rem; max-width: 500px; margin: 0 auto;">
                {{ order_form_lock_message or 'The order form is currently locked. New orders cannot be submitted at this time. Please check back later!' }}
            </p>
        </div>
        {% endif %}

        <!-- Rate Banner -->
        <div class="rate-banner">
            <div class="rate-item">
                <span class="rate-label">USD to PHP</span>
                <span class="rate-value">₱{{ "%.2f"|format(exchange_rate) }}</span>
            </div>
            <div class="rate-item">
                <span class="rate-label">Admin Fee</span>
                <span class="rate-value amber">₱{{ "%.2f"|format(admin_fee) }}</span>
            </div>
            <div class="rate-item">
                <span class="rate-label">Vials/Kit</span>
                <span class="rate-value" style="color: var(--accent-violet);">{{ vials_per_kit }}</span>
            </div>
        </div>

        <!-- View: New / Update Order -->
        <div id="view-new-order" class="view-content">
            <div class="main-grid">
                <!-- Order Form -->
                <div class="card">
                    <h2 class="card-title"><span class="icon">📦</span> Customer Order Section</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1.5rem;">💡 Enter your Name and Telegram username and your existing orders will auto-populate in the Order Summary</p>

                    <div class="form-row" style="margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-input" id="full-name" placeholder="Juan Dela Cruz" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telegram Username <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-input" id="telegram" placeholder="@username (enter to view/update your orders)" required>
                            <small style="color: var(--accent-violet); font-size: 0.85rem; margin-top: 0.5rem; display: block; font-weight: 500;">📱 Message @pephaul_bot for GB admin to receive updates from orders</small>
                        </div>
                    </div>

                    <div class="form-group product-search-container">
                        <label class="form-label">Select Product</label>
                        <input type="text" class="form-input" id="product-search" placeholder="Please enter your Name and Telegram username first..." autocomplete="off" disabled>
                        <div class="product-dropdown" id="product-dropdown">
                            <!-- Products loaded dynamically via JavaScript -->
                        </div>
                        <small id="product-search-hint" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem; display: block; font-weight: 500;">⚠️ Name and Telegram username are required before selecting products</small>
                    </div>

                    <div id="selected-product" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Selected</label>
                            <div class="form-input" style="background: rgba(20, 184, 166, 0.1); border-color: var(--accent-teal);">
                                <span id="selected-name"></span>
                                <span id="selected-code" style="float: right; font-family: 'JetBrains Mono', monospace; color: var(--accent-teal);"></span>
                            </div>
                        </div>

                        <div class="inventory-stats">
                            <div class="inventory-title">📊 Inventory</div>
                            <div class="inventory-grid">
                                <div class="inventory-item">
                                    <div class="inventory-value" id="inv-total-vials">0</div>
                                    <div class="inventory-label">Total Vials</div>
                                </div>
                                <div class="inventory-item">
                                    <div class="inventory-value" id="inv-kits">0</div>
                                    <div class="inventory-label">Kits Generated</div>
                                </div>
                                <div class="inventory-item">
                                    <div class="inventory-value" id="inv-remaining">0</div>
                                    <div class="inventory-label">Extra Vials</div>
                                </div>
                                <div class="inventory-item">
                                    <div class="inventory-value highlight" id="inv-slots">0</div>
                                    <div class="inventory-label">Slots Left</div>
                                </div>
                            </div>
                            <div class="kit-progress">
                                <div class="kit-progress-label">
                                    <span>Progress to Next Kit</span>
                                    <span id="progress-text">0/{{ vials_per_kit }}</span>
                                </div>
                                <div class="kit-progress-bar">
                                    <div class="kit-progress-fill" id="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1.25rem;">
                            <label class="form-label">Order Type</label>
                            <div class="order-type-toggle">
                                <button type="button" class="toggle-btn" data-type="Kit">Kit ({{ vials_per_kit }} vials)</button>
                                <button type="button" class="toggle-btn active" data-type="Vial">Per Vial</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <div class="qty-input-group">
                                <button type="button" class="qty-btn" id="qty-minus">−</button>
                                <input type="number" class="form-input qty-input" id="quantity" value="1" min="1">
                                <button type="button" class="qty-btn" id="qty-plus">+</button>
                            </div>
                        </div>

                        <div class="price-display">
                            <div class="price-row">
                                <span class="price-label">Unit Price (USD)</span>
                                <span class="price-value" id="unit-price-usd">$0.00</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Line Total (USD)</span>
                                <span class="price-value" id="line-total-usd">$0.00</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Line Total (PHP)</span>
                                <span class="price-value" id="line-total-php">₱0.00</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-full" style="margin-top: 1.5rem;" id="add-to-cart">Add to Order</button>
                    </div>
                </div>

                <!-- Cart -->
                <div class="card">
                    <h2 class="card-title"><span class="icon">🛒</span> Order Summary</h2>

                    <div id="cart-empty" class="cart-empty">
                        <p>No items yet</p>
                    </div>

                    <div id="cart-items" class="cart-items" style="display: none;"></div>

                    <div id="cart-summary" class="cart-summary" style="display: none;">
                        <div class="summary-row">
                            <span class="summary-label">Subtotal (USD)</span>
                            <span class="summary-value" id="summary-usd">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Subtotal (PHP)</span>
                            <span class="summary-value" id="summary-php">₱0.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Admin Fee</span>
                            <span class="summary-value">₱{{ "%.2f"|format(admin_fee) }}</span>
                        </div>
                        <div class="summary-row grand-total">
                            <span class="summary-label">Grand Total</span>
                            <span class="summary-value" id="grand-total">₱0.00</span>
                        </div>
                    </div>

                    {% if order_form_locked %}
                    <button type="button" class="btn btn-full" style="margin-top: 1.5rem; background: #9ca3af; cursor: not-allowed;" disabled>🔒 Orders Closed</button>
                    {% else %}
                    <!-- Button container for dynamic buttons -->
                    <div id="order-action-buttons" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                        <button type="button" class="btn btn-violet btn-full" id="submit-order" disabled>Submit Order</button>
                        <div id="existing-order-buttons" style="display: none; display: flex; gap: 0.75rem;">
                            <button type="button" class="btn btn-secondary btn-full" id="view-total-order-btn" style="flex: 1;">View Total Order</button>
                            <button type="button" class="btn btn-violet btn-full" id="update-order-btn" style="flex: 1;">Update Order</button>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>

        <!-- View My Orders Section -->
        <div id="my-orders-section" class="orders-summary-section" style="display: none;">
            <div class="card">
                <h2 class="card-title"><span class="icon">📦</span> My Orders</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">View and manage your orders</p>
                
                <div style="margin-bottom: 1rem;">
                    <input type="text" class="form-input" id="my-orders-search" placeholder="🔍 Search by Order ID or product..." style="max-width: 400px;">
                </div>
                
                <div id="my-orders-list" style="display: grid; gap: 1rem;">
                    <!-- Orders populated by JavaScript -->
                </div>
                
                <div id="my-orders-empty" style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
                    <p>No orders found. Create your first order above!</p>
                </div>
            </div>
        </div>

        <!-- Products with Active Orders Summary -->
        <div class="orders-summary-section">
            <h3 class="orders-summary-title">🛒 Products with Active Orders</h3>
            {% if products_with_orders and products_with_orders|length > 0 %}
            <div class="orders-product-grid">
                {% for product in products_with_orders %}
                <div class="order-product-card">
                    <div class="order-product-info">
                        <div class="order-product-name">{{ product.name }}</div>
                        <div class="order-product-code">{{ product.code }}</div>
                    </div>
                    <div class="order-product-stats">
                        <span class="order-vials-count">{{ product.inventory.total_vials }} vials</span>
                        {% if product.inventory.slots_to_next_kit > 0 and product.inventory.remaining_vials > 0 %}
                        <span class="missing-slots">{{ product.inventory.slots_to_next_kit }} to next kit</span>
                        {% elif product.inventory.remaining_vials == 0 and product.inventory.kits_generated > 0 %}
                        <span class="missing-slots kit-complete">✓ Kit complete</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <p style="font-size: 1rem; margin-bottom: 0.5rem;">📦 No product orders yet</p>
                <p style="font-size: 0.85rem;">Orders will appear here once customers start ordering</p>
            </div>
            {% endif %}
        </div>

        <!-- Live Product Inventory Section -->
        <div class="orders-summary-section">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="background: linear-gradient(135deg, #ec4899, #8b5cf6); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 1.5rem;">📊</span>
                </div>
                <div>
                    <h3 class="orders-summary-title" style="margin: 0;">Live Product Inventory</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">Real-time tracking of peptide reservations and kit availability</p>
                </div>
            </div>

            <div class="inventory-search" style="max-width: 400px; margin-bottom: 1.5rem;">
                <input type="text" class="form-input" id="inventory-search" placeholder="🔍 Search products by name or code...">
            </div>

            <div class="inventory-grid">
                {% for product in products %}
                <div class="inventory-card {% if product.inventory.total_vials > 0 %}has-orders{% endif %} {% if product.inventory.is_locked %}card-locked{% endif %}"
                     data-code="{{ product.code }}"
                     data-name="{{ product.name }}"
                     data-kit-price="{{ product.kit_price }}"
                     data-vial-price="{{ product.vial_price }}">
                    <div class="inv-card-header">
                        <span class="inv-card-name">{{ product.name }}</span>
                        <span class="inv-card-code">{{ product.code }}</span>
                    </div>
                    <div class="inv-card-prices" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(232, 121, 169, 0.1); border-radius: 8px; display: flex; justify-content: space-between; gap: 1rem; font-size: 0.85rem;">
                        <div style="flex: 1;">
                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Kit Price</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary);">
                                ${{ "%.2f"|format(product.kit_price) }} <span style="color: var(--text-secondary);">(₱{{ "%.2f"|format(product.kit_price * exchange_rate) }})</span>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.25rem;">Vial Price</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary);">
                                ${{ "%.2f"|format(product.vial_price) }} <span style="color: var(--text-secondary);">(₱{{ "%.2f"|format(product.vial_price * exchange_rate) }})</span>
                            </div>
                        </div>
                    </div>
                    <div class="inv-card-stats">
                        <div class="inv-stat">
                            <span class="inv-stat-value">{{ product.inventory.kits_generated }}</span>
                            <span class="inv-stat-label">KITS</span>
                            <div class="inv-qty-control" style="margin-top: 0.5rem;">
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Kit', -1)">−</button>
                                <input type="number" class="inv-qty-input" id="inv-kit-qty-{{ product.code }}" value="0" min="0" max="99" readonly>
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Kit', 1)">+</button>
                            </div>
                        </div>
                        <div class="inv-stat">
                            <span class="inv-stat-value">{{ product.inventory.total_vials }}</span>
                            <span class="inv-stat-label">VIALS</span>
                            <div class="inv-qty-control" style="margin-top: 0.5rem;">
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Vial', -1)">−</button>
                                <input type="number" class="inv-qty-input" id="inv-vial-qty-{{ product.code }}" value="0" min="0" max="99" readonly>
                                <button class="inv-qty-btn" onclick="adjustInvQty('{{ product.code }}', 'Vial', 1)">+</button>
                            </div>
                        </div>
                        <div class="inv-stat">
                            <span class="inv-stat-value">{{ product.inventory.remaining_vials }}/{{ product.vials_per_kit }}</span>
                            <span class="inv-stat-label">NEXT KIT</span>
                        </div>
                    </div>
                    <div class="inv-card-progress">
                        <div class="inv-progress-bar-full">
                            <div class="inv-progress-fill" style="width: {{ (product.inventory.remaining_vials / product.vials_per_kit * 100)|int if product.vials_per_kit > 0 else 0 }}%;"></div>
                        </div>
                    </div>
                    <div class="inv-card-status">
                        {% if product.inventory.is_locked %}
                        <span class="inv-lock-badge locked">🔒 Locked</span>
                        {% else %}
                        <button class="btn-click-to-add" onclick="quickAddToCart('{{ product.code }}', '{{ product.name }}')">
                            ✨ Click to Add
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <!-- Order Confirmation Modal (Before Submission) -->
    <div class="modal" id="order-confirmation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Review Your Order</h3>
                <button class="modal-close" onclick="closeModal('order-confirmation-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Please review your order before submitting. You can remove items if needed.</p>
                
                <div id="confirmation-items-list" style="margin-bottom: 1.5rem;">
                    <!-- Items will be populated here -->
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (USD)</span>
                        <span class="summary-value" id="confirmation-subtotal-usd">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (PHP)</span>
                        <span class="summary-value" id="confirmation-subtotal-php">₱0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Admin Fee</span>
                        <span class="summary-value">₱{{ "%.2f"|format(admin_fee) }}</span>
                    </div>
                    <div class="summary-row grand-total">
                        <span class="summary-label">Grand Total</span>
                        <span class="summary-value" id="confirmation-grand-total">₱0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('order-confirmation-modal')">Cancel</button>
                <button class="btn btn-violet" id="confirm-submit-btn" onclick="confirmOrderSubmission()">Confirm & Submit Order</button>
            </div>
        </div>
    </div>

    <!-- Order Summary Modal (After Submission) -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Submitted!</h3>
                <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="order-summary-header">
                    <h2>Thank You!</h2>
                    <div class="order-id" id="modal-order-id">ORD-123456</div>
                </div>

                <div class="pep-haul-message" style="background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 2px dashed #d946ef; text-align: center;">
                    <p style="font-size: 1.1rem; font-weight: 600; color: #a855f7; margin-bottom: 0.75rem;">Hello Pep Hauler! 💜</p>
                    <p style="font-size: 0.95rem; color: #7c3aed; line-height: 1.6; margin-bottom: 0.5rem;">
                        <strong style="color: #ec4899;">Please SCREENSHOT or SAVE this Total Summary!</strong>
                    </p>
                    <p style="font-size: 0.85rem; color: #9333ea; line-height: 1.5; margin-bottom: 0.75rem;">
                        This on-screen summary serves as your official reference for all current reservations and totals.
                    </p>
                    
                    <p style="font-size: 0.95rem; font-weight: 500; color: #d946ef; margin-top: 0.5rem;">
                        Thank you for joining the Pep Haul! ✨
                    </p>
                </div>

                <div class="order-items-list" id="modal-items"></div>

                <div class="cart-summary">
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (USD)</span>
                        <span class="summary-value" id="modal-subtotal-usd">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Subtotal (PHP)</span>
                        <span class="summary-value" id="modal-subtotal-php">₱0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Admin Fee</span>
                        <span class="summary-value">₱{{ "%.2f"|format(admin_fee) }}</span>
                    </div>
                    <div class="summary-row grand-total">
                        <span class="summary-label">Grand Total</span>
                        <span class="summary-value" id="modal-grand-total">₱0.00</span>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="payment-section" style="margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 16px; border: 2px solid var(--accent-primary);">
                    <h4 style="margin-bottom: 1rem; color: var(--accent-primary); text-align: center;">💳 Pay Now</h4>
                    
                    <!-- Payment QR Options -->
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-align: center;">Choose your payment method:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1rem;">
                        <a href="https://drive.google.com/file/d/1-Fbib327N9RXsGH4rtHGTtitag5-UbLl/view?usp=drive_link" target="_blank" class="payment-qr-btn">GCash</a>
                        <a href="https://drive.google.com/file/d/1RF4q3tZhzohS_Ic3-WdA83xpWgYLU1WY/view?usp=drive_link" target="_blank" class="payment-qr-btn">Maya</a>
                        <a href="https://drive.google.com/file/d/1k2aR2xHxLWaAY4T0JMzo0i7dHXUZ5V_b/view?usp=drive_link" target="_blank" class="payment-qr-btn">BPI</a>
                        <a href="https://drive.google.com/file/d/1jhlG1vlTarnNxvji__QtzwrtIGhlNa6f/view?usp=drive_link" target="_blank" class="payment-qr-btn">UnionBank</a>
                        <a href="https://drive.google.com/file/d/1P7KvA5Sgk0yl4L-Kn_W2OV4ek3HSueFU/view?usp=drive_link" target="_blank" class="payment-qr-btn">CIMB</a>
                        <a href="https://drive.google.com/file/d/1kuBfTepRzzNfvuXh9-kgz29-Dccvhjuh/view?usp=drive_link" target="_blank" class="payment-qr-btn">MariBank</a>
                        <a href="https://drive.google.com/file/d/12dqI1EVUNCI_V3Ht4zYaFHLLzEhvysfT/view?usp=sharing" target="_blank" class="payment-qr-btn">GoTyme</a>
                    </div>
                    
                    <!-- Friendly Reminder -->
                    <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px dashed var(--accent-purple);">
                        <p style="font-size: 0.95rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 0.5rem; text-align: center;">✨ Friendly Pep_Haul Reminder! ✨</p>
                        <p style="font-size: 0.85rem; color: var(--text-secondary);">Please leave the <strong>Notes section blank</strong>, pretty please! 🧬💫 If you must write something, just your <strong>telegram username</strong> is perfect.</p>
                        <p style="font-size: 0.85rem; color: #ef4444; margin-top: 0.5rem;">❌ No "peptide payment," "payment," or anything super serious like that.</p>
                        <p style="font-size: 0.85rem; color: var(--accent-primary); text-align: center; margin-top: 0.5rem;">Thank you! 💕🥰</p>
                    </div>
                    
                    <!-- Payment Instructions -->
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(20, 184, 166, 0.1)); border-radius: 12px;">
                        <p style="font-size: 1rem; font-weight: 600; color: var(--accent-emerald); margin-bottom: 0.5rem;">📱 Order submitted successfully!</p>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Enter your Telegram username in the form to view and update your orders</p>
                        <button class="btn btn-primary" onclick="closeModal('order-modal');">
                            Got it!
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('order-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="order-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <button class="modal-close" onclick="closeModal('order-details-modal')">&times;</button>
            </div>
            <div class="modal-body" id="order-details-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer" id="order-details-footer">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Cancel Order Confirmation Modal -->
    <div class="modal" id="cancel-order-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #ef4444;">⚠️ Cancel Order</h3>
                <button class="modal-close" onclick="closeModal('cancel-order-modal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🗑️</div>
                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Are you sure you want to cancel this order?</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                    This action <strong>cannot be undone</strong>.<br>
                    Your order will be permanently deleted and all product reservations will be released.<br>
                    You will need to create a <strong>new order</strong> to reserve products again.
                </p>
                <div id="cancel-countdown" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-rose); margin-bottom: 1.5rem; min-height: 2rem;"></div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="undo-cancel-btn" onclick="undoCancelOrder()" style="min-width: 150px;">Undo (5s)</button>
                <button class="btn btn-rose" id="confirm-cancel-btn" onclick="confirmCancelOrder()" style="min-width: 150px;">Yes, Cancel Order</button>
            </div>
        </div>
    </div>

    <!-- Mailing Address Modal -->
    <div class="modal" id="mailing-address-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">📬 Add Mailing Address</h3>
                <button class="modal-close" onclick="closeModal('mailing-address-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
                    Your payment has been confirmed! 🎉 Please provide your shipping details:
                </p>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Full Name (Receiver)</label>
                    <input type="text" class="form-input" id="mailing-name" placeholder="Juan Dela Cruz">
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Contact Number</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <span style="display: flex; align-items: center; padding: 0 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px 0 0 10px; color: var(--text-secondary); font-size: 0.9rem;">+63</span>
                        <input type="tel" class="form-input" id="mailing-phone" style="border-radius: 0 10px 10px 0; flex: 1;" placeholder="9XX XXX XXXX" maxlength="10">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Full Mailing Address</label>
                    <textarea class="form-input" id="mailing-address-input" rows="3" style="resize: vertical;" placeholder="Street, Village, Barangay, City, Province, Zipcode"></textarea>
                    <small style="color: var(--text-muted); font-size: 0.75rem;">Include: Street, Village/Subdivision, Barangay, City, Province, Zipcode</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('mailing-address-modal')">Cancel</button>
                <button class="btn btn-primary" id="save-mailing-btn" onclick="saveMailingAddress()">💾 Save Address</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon">✓</div>
        <span id="toast-message">Success!</span>
    </div>

    <script>
        // Config
        const EXCHANGE_RATE = {{ exchange_rate|default(59.0)|tojson }};
        const ADMIN_FEE = {{ admin_fee|default(300.0)|tojson }};
        const VIALS_PER_KIT = {{ vials_per_kit|default(10)|tojson }};
        
        // State
        let selectedProduct = null;
        let orderType = 'Vial';
        let cartItems = [];
        let currentOrderId = null;
        let paymentFile = null;
        // Removed items tracking no longer needed - we send all items when updating

        // DOM Elements
        const productSearch = document.getElementById('product-search');
        const productDropdown = document.getElementById('product-dropdown');
        const selectedProductDiv = document.getElementById('selected-product');
        const quantityInput = document.getElementById('quantity');
        const fullNameInput = document.getElementById('full-name');
        const telegramInput = document.getElementById('telegram');
        const productSearchHint = document.getElementById('product-search-hint');
        
        // Function to check if required fields are filled and enable/disable product search
        function checkRequiredFields() {
            const fullName = fullNameInput.value.trim();
            const telegram = telegramInput.value.trim();
            const isFilled = fullName && telegram;
            
            if (isFilled) {
                productSearch.disabled = false;
                productSearch.placeholder = 'Search products...';
                if (productSearchHint) productSearchHint.style.display = 'none';
                productSearch.style.cursor = 'text';
            } else {
                productSearch.disabled = true;
                productSearch.placeholder = 'Please enter your Name and Telegram username first...';
                if (productSearchHint) productSearchHint.style.display = 'block';
                productSearch.style.cursor = 'not-allowed';
                // Hide dropdown if shown
                productDropdown.classList.remove('show');
            }
        }
        
        // Check required fields on input
        if (fullNameInput) {
            fullNameInput.addEventListener('input', () => {
                checkRequiredFields();
                checkReturningCustomer(); // Also check for existing orders
            });
        }
        if (telegramInput) {
            telegramInput.addEventListener('input', () => {
                checkRequiredFields();
                checkReturningCustomer(); // Also check for existing orders
            });
        }
        
        // Initial check
        checkRequiredFields();

        // Toast Notification Function (must be defined early)
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            if (toast && toastMessage) {
                toastMessage.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            } else {
                console.log('Toast:', message);
            }
        }

        // Navigation (simplified - single tab only)
        document.querySelectorAll('.nav-tab[data-view]').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab[data-view]').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.view-content').forEach(v => v.style.display = 'none');
                document.getElementById('view-' + tab.dataset.view).style.display = 'block';
            });
        });

        // Load Products Dynamically
        let allProducts = [];
        async function loadProducts() {
            try {
                console.log('Loading products...');
                const response = await fetch('/api/products');
                allProducts = await response.json();
                console.log('Loaded products:', allProducts.length);
                renderProductDropdown(allProducts);
                attachProductClickHandlers();
                console.log('Products rendered and ready');
            } catch (error) {
                console.error('Error loading products:', error);
                productDropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">Error loading products. Please refresh the page.</div>';
            }
        }

        function renderProductDropdown(products) {
            productDropdown.innerHTML = products.map(product => {
                const isLocked = product.inventory && product.inventory.is_locked;
                return `
                    <div class="product-option ${isLocked ? 'locked' : ''}"
                         data-code="${product.code}" 
                         data-name="${product.name}" 
                         data-kit="${product.kit_price}" 
                         data-vial="${product.vial_price}"
                         data-vials-per-kit="${product.vials_per_kit || 10}"
                         data-locked="${isLocked}"
                         data-total-vials="${product.inventory ? product.inventory.total_vials : 0}"
                         data-kits="${product.inventory ? product.inventory.kits_generated : 0}"
                         data-remaining="${product.inventory ? product.inventory.remaining_vials : 0}"
                         data-slots="${product.inventory ? product.inventory.slots_to_next_kit : (product.vials_per_kit || 10)}">
                        <div class="product-option-name">
                            ${product.name}
                            ${isLocked ? '<span class="locked-badge">LOCKED</span>' : ''}
                        </div>
                        <div class="product-option-meta">
                            <span>${product.code}</span>
                            <span>Kit: $${product.kit_price.toFixed(2)} (₱${(product.kit_price * EXCHANGE_RATE).toFixed(2)})</span>
                            <span>Vial: $${product.vial_price.toFixed(2)} (₱${(product.vial_price * EXCHANGE_RATE).toFixed(2)})</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function attachProductClickHandlers() {
            productDropdown.querySelectorAll('.product-option:not(.locked)').forEach(option => {
                option.addEventListener('click', () => {
                    // Validate required fields before allowing product selection
                    const fullName = fullNameInput.value.trim();
                    const telegram = telegramInput.value.trim();
                    
                    if (!fullName || !telegram) {
                        showToast('Please enter your Name and Telegram username first', 3000);
                        productDropdown.classList.remove('show');
                        return;
                    }
                    
                    const productVialsPerKit = parseInt(option.dataset.vialsPerKit) || VIALS_PER_KIT;
                    selectedProduct = {
                        code: option.dataset.code,
                        name: option.dataset.name,
                        kit_price: parseFloat(option.dataset.kit),
                        vial_price: parseFloat(option.dataset.vial),
                        vials_per_kit: productVialsPerKit,
                        inventory: {
                            total_vials: parseInt(option.dataset.totalVials) || 0,
                            kits_generated: parseInt(option.dataset.kits) || 0,
                            remaining_vials: parseInt(option.dataset.remaining) || 0,
                            slots_to_next_kit: parseInt(option.dataset.slots) || productVialsPerKit,
                            vials_per_kit: productVialsPerKit
                        }
                    };
                    
                    document.getElementById('selected-name').textContent = selectedProduct.name;
                    document.getElementById('selected-code').textContent = selectedProduct.code;
                    selectedProductDiv.style.display = 'block';
                    productSearch.value = selectedProduct.name;
                    // Hide dropdown after selection
                    productDropdown.classList.remove('show');
                    
                    updateInventoryDisplay();
                    updatePricePreview();
                });
            });
        }

        // Load products on page load
        loadProducts();

        // Product Search - Show dropdown when typing (only if fields are filled)
        productSearch.addEventListener('focus', () => {
            // Check if required fields are filled
            const fullName = fullNameInput.value.trim();
            const telegram = telegramInput.value.trim();
            
            if (!fullName || !telegram) {
                showToast('Please enter your Name and Telegram username first', 3000);
                productSearch.blur();
                return;
            }
            
            // Show all products when user focuses on search
            if (allProducts.length > 0) {
                productDropdown.classList.add('show');
                productDropdown.querySelectorAll('.product-option').forEach(option => {
                    option.style.display = 'block';
                });
            }
        });
        
        productSearch.addEventListener('input', (e) => {
            // Check if required fields are filled
            const fullName = fullNameInput.value.trim();
            const telegram = telegramInput.value.trim();
            
            if (!fullName || !telegram) {
                productDropdown.classList.remove('show');
                return;
            }
            
            const query = e.target.value.toLowerCase().trim();
            console.log('Search query:', query);
            
            // Always show dropdown when there's input or when focused
            productDropdown.classList.add('show');
            
            // Filter products by name or code
            productDropdown.querySelectorAll('.product-option').forEach(option => {
                if (!query) {
                    // Show all if empty
                    option.style.display = 'block';
                } else {
                    // Filter by search query
                    const match = option.dataset.name.toLowerCase().includes(query) || option.dataset.code.toLowerCase().includes(query);
                    option.style.display = match ? 'block' : 'none';
                }
            });
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.product-search-container')) {
                productDropdown.classList.remove('show');
            }
        });

        function updateInventoryDisplay() {
            if (!selectedProduct) return;
            const inv = selectedProduct.inventory;
            const vialsPerKit = selectedProduct.vials_per_kit || VIALS_PER_KIT;
            document.getElementById('inv-total-vials').textContent = inv.total_vials;
            document.getElementById('inv-kits').textContent = inv.kits_generated;
            document.getElementById('inv-remaining').textContent = inv.remaining_vials;
            document.getElementById('inv-slots').textContent = inv.slots_to_next_kit;
            
            const progressPercent = (inv.remaining_vials / vialsPerKit) * 100;
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `${inv.remaining_vials}/${vialsPerKit}`;
        }

        // Order Type Toggle
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                orderType = btn.dataset.type;
                updatePricePreview();
            });
        });

        // Quantity Controls
        document.getElementById('qty-minus').addEventListener('click', () => {
            const current = parseInt(quantityInput.value) || 1;
            if (current > 1) { quantityInput.value = current - 1; updatePricePreview(); }
        });
        document.getElementById('qty-plus').addEventListener('click', () => {
            quantityInput.value = (parseInt(quantityInput.value) || 1) + 1;
            updatePricePreview();
        });
        quantityInput.addEventListener('input', updatePricePreview);

        function updatePricePreview() {
            if (!selectedProduct) return;
            const qty = parseInt(quantityInput.value) || 1;
            const unitPrice = orderType === 'Kit' ? selectedProduct.kit_price : selectedProduct.vial_price;
            const lineTotalUsd = unitPrice * qty;
            const lineTotalPhp = lineTotalUsd * EXCHANGE_RATE;
            
            document.getElementById('unit-price-usd').textContent = `$${unitPrice.toFixed(2)}`;
            document.getElementById('line-total-usd').textContent = `$${lineTotalUsd.toFixed(2)}`;
            document.getElementById('line-total-php').textContent = `₱${lineTotalPhp.toFixed(2)}`;
        }

        // Add to Cart
        document.getElementById('add-to-cart').addEventListener('click', () => {
            console.log('Add to Order button clicked');
            console.log('Selected product:', selectedProduct);
            
            if (!selectedProduct) {
                showToast('Please select a product first');
                return;
            }
            
            const qty = parseInt(quantityInput.value) || 1;
            if (qty <= 0) {
                showToast('Please enter a quantity greater than 0');
                return;
            }
            
            const unitPrice = orderType === 'Kit' ? selectedProduct.kit_price : selectedProduct.vial_price;
            
            // Check if same product_code + order_type already exists in cart - consolidate!
            const existingIndex = cartItems.findIndex(item => 
                item.product_code === selectedProduct.code && item.order_type === orderType
            );
            
            if (existingIndex !== -1) {
                // Consolidate: Add to existing quantity
                cartItems[existingIndex].qty += qty;
                cartItems[existingIndex].line_total_usd = cartItems[existingIndex].qty * unitPrice;
                cartItems[existingIndex].line_total_php = cartItems[existingIndex].line_total_usd * EXCHANGE_RATE;
                // If consolidating with existing item, mark as new (user is updating)
                cartItems[existingIndex].isExisting = false;
                showToast('✅ Quantity updated!');
            } else {
                // New item
                cartItems.push({
                    product_code: selectedProduct.code,
                    product_name: selectedProduct.name,
                    order_type: orderType,
                    qty: qty,
                    unit_price_usd: unitPrice,
                    line_total_usd: unitPrice * qty,
                    line_total_php: unitPrice * qty * EXCHANGE_RATE,
                    isExisting: false  // Mark as new item
                });
                showToast('✅ Item added to cart!');
            }
            
            console.log('Cart updated:', cartItems);
            updateCart();
            saveCart();
            resetSelection();
        });

        function saveCart() {
            try {
                localStorage.setItem('pephaul_cart', JSON.stringify(cartItems));
            } catch (e) {
                console.warn('Could not save cart to localStorage:', e);
            }
        }

        function loadCart() {
            // Only load cart if Name and Telegram username are filled
            const telegram = fullNameInput && telegramInput ? telegramInput.value.trim() : '';
            const fullName = fullNameInput ? fullNameInput.value.trim() : '';
            
            // If fields are empty, don't load cart - clear it instead
            if (!telegram || !fullName) {
                cartItems = [];
                currentOrderId = null;
                updateCart();
                saveCart();
                return;
            }
            
            try {
                const saved = localStorage.getItem('pephaul_cart');
                if (saved) {
                    // Only load if we have matching telegram username
                    // Otherwise, clear cart and check for existing orders
                    cartItems = JSON.parse(saved);
                    // Verify the saved cart matches current telegram username
                    // If not, clear and reload from server
                    updateCart();
                }
            } catch (e) {
                console.warn('Could not load cart from localStorage:', e);
                cartItems = [];
                updateCart();
            }
        }

        function resetSelection() {
            selectedProduct = null;
            selectedProductDiv.style.display = 'none';
            productSearch.value = '';
            quantityInput.value = 1;
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.toggle-btn[data-type="Vial"]').classList.add('active');
            orderType = 'Vial';
        }

        function updateCart() {
            const empty = document.getElementById('cart-empty');
            const items = document.getElementById('cart-items');
            const summary = document.getElementById('cart-summary');
            const submit = document.getElementById('submit-order');
            
            // Initialize totals variables at the start of function (before any early returns)
            let totalUsd = 0;
            let totalPhp = 0;
            let existingTotalUsd = 0;
            let existingTotalPhp = 0;
            let newTotalUsd = 0;
            let newTotalPhp = 0;
            
            if (cartItems.length === 0) {
                if (empty) empty.style.display = 'block';
                if (items) items.style.display = 'none';
                if (summary) summary.style.display = 'none';
                if (submit) submit.disabled = true;
                
                // Reset summary displays when cart is empty
                const existingSummary = document.getElementById('existing-summary');
                const newSummary = document.getElementById('new-summary');
                if (existingSummary) existingSummary.style.display = 'none';
                if (newSummary) newSummary.style.display = 'none';
                
                // Update totals to zero
                const summaryUsd = document.getElementById('summary-usd');
                const summaryPhp = document.getElementById('summary-php');
                const grandTotal = document.getElementById('grand-total');
                if (summaryUsd) summaryUsd.textContent = '$0.00';
                if (summaryPhp) summaryPhp.textContent = '₱0.00';
                if (grandTotal) grandTotal.textContent = `₱${ADMIN_FEE.toFixed(2)}`;
                
                updateSubmitButtonText();
                return;
            }
            
            if (empty) empty.style.display = 'none';
            if (items) items.style.display = 'block';
            if (summary) summary.style.display = 'block';
            if (submit) submit.disabled = false;
            
            // Display all items together with + - X buttons
            if (items) {
                items.innerHTML = cartItems.map((item, i) => {
                    const isExisting = item.isExisting === true;
                    const hasChanged = item.originalQty !== undefined && item.qty !== item.originalQty;
                    return `
                        <div class="cart-item" style="${isExisting ? 'border-left: 3px solid var(--accent-amber);' : ''}">
                            <button class="cart-item-remove" onclick="removeItem(${i})" style="position: absolute; top: 0.5rem; right: 0.5rem; width: 24px; height: 24px; border: none; background: var(--accent-rose); color: white; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; justify-content: center; line-height: 1; z-index: 10;">×</button>
                            <div class="cart-item-header">
                                <span class="cart-item-name">${item.product_name}${hasChanged ? ' <span style="font-size: 0.75rem; color: var(--accent-teal);">(Updated)</span>' : ''}</span>
                                <span class="cart-item-code">${item.product_code}</span>
                            </div>
                            <div class="cart-item-details" style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="flex: 1;">${item.order_type} × <span id="qty-${i}">${item.qty}</span></span>
                                <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-input); border-radius: 8px; padding: 0.25rem;">
                                    <button type="button" class="qty-btn-minus" data-index="${i}" data-action="decrease" style="width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-rose); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: auto; z-index: 10; position: relative;">−</button>
                                    <span id="qty-display-${i}" style="min-width: 30px; text-align: center; font-weight: 600; color: var(--text-primary);">${item.qty}</span>
                                    <button type="button" class="qty-btn-plus" data-index="${i}" data-action="increase" style="width: 28px; height: 28px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-teal); font-size: 1.2rem; font-weight: 600; line-height: 1; pointer-events: auto; z-index: 10; position: relative;">+</button>
                                </div>
                                <span class="cart-item-price">₱<span id="price-${i}">${(item.line_total_php || 0).toFixed(2)}</span></span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Attach event listeners using event delegation
                const clonedItems = items.cloneNode(true);
                items.parentNode.replaceChild(clonedItems, items);
                
                clonedItems.addEventListener('click', function(e) {
                    try {
                        const btn = e.target.closest('.qty-btn-minus, .qty-btn-plus');
                        if (btn) {
                            const index = parseInt(btn.getAttribute('data-index'));
                            const action = btn.getAttribute('data-action');
                            if (!isNaN(index) && index >= 0 && index < cartItems.length) {
                                const change = action === 'increase' ? 1 : -1;
                                updateItemQty(index, change);
                            } else {
                                console.warn('Invalid button click - index out of range:', index);
                            }
                        }
                    } catch (error) {
                        console.error('Error handling quantity button click:', error);
                        showToast('❌ Error updating quantity. Please try again.', 3000);
                    }
                });
            }
            
            // Calculate totals with proper NaN handling - ensure all items have valid prices
            cartItems.forEach(item => {
                // Ensure item has valid price values
                let itemUsd = parseFloat(item.line_total_usd);
                let itemPhp = parseFloat(item.line_total_php);
                
                // If USD is missing or invalid, calculate from PHP
                if (isNaN(itemUsd) || itemUsd === 0) {
                    if (!isNaN(itemPhp) && itemPhp > 0) {
                        itemUsd = itemPhp / EXCHANGE_RATE;
                        item.line_total_usd = itemUsd;
                    } else {
                        // If both are missing, try to calculate from unit price and quantity
                        const unitPrice = parseFloat(item.unit_price_usd) || 0;
                        const qty = parseFloat(item.qty) || 1;
                        itemUsd = unitPrice * qty;
                        itemPhp = itemUsd * EXCHANGE_RATE;
                        item.line_total_usd = itemUsd;
                        item.line_total_php = itemPhp;
                    }
                }
                
                // If PHP is missing or invalid, calculate from USD
                if (isNaN(itemPhp) || itemPhp === 0) {
                    if (!isNaN(itemUsd) && itemUsd > 0) {
                        itemPhp = itemUsd * EXCHANGE_RATE;
                        item.line_total_php = itemPhp;
                    }
                }
                
                // Add to totals (ensure values are valid numbers)
                if (!isNaN(itemUsd) && itemUsd > 0) {
                    totalUsd += itemUsd;
                }
                if (!isNaN(itemPhp) && itemPhp > 0) {
                    totalPhp += itemPhp;
                } else if (!isNaN(itemUsd) && itemUsd > 0) {
                    // Fallback: calculate PHP from USD if PHP is still missing
                    const calculatedPhp = itemUsd * EXCHANGE_RATE;
                    totalPhp += calculatedPhp;
                }
            });
            
            // Ensure totals are calculated correctly
            if (totalPhp === 0 && totalUsd > 0) {
                totalPhp = totalUsd * EXCHANGE_RATE;
            }
            if (totalUsd === 0 && totalPhp > 0) {
                totalUsd = totalPhp / EXCHANGE_RATE;
            }
            
            const grandTotal = totalPhp + ADMIN_FEE;
            
            // Update button text based on existing order
            updateSubmitButtonText();
            
            // Save updated cart items with corrected prices
            saveCart();
            
            // Update summary displays
            const summaryUsdEl = document.getElementById('summary-usd');
            const summaryPhpEl = document.getElementById('summary-php');
            const grandTotalEl = document.getElementById('grand-total');
            
            if (summaryUsdEl) summaryUsdEl.textContent = `$${totalUsd.toFixed(2)}`;
            if (summaryPhpEl) summaryPhpEl.textContent = `₱${totalPhp.toFixed(2)}`;
            if (grandTotalEl) grandTotalEl.textContent = `₱${grandTotal.toFixed(2)}`;
        }

        function removeItem(index) {
            if (index < 0 || index >= cartItems.length) {
                console.error('Invalid index for removeItem:', index);
                return;
            }
            
            const item = cartItems[index];
            
            // Removed items tracking no longer needed - we send all items when updating
            
            cartItems.splice(index, 1);
            updateCart();
            saveCart();
            updateSubmitButtonText(); // Update button state when items are removed
        }
        
        // Expose removeItem to global scope for onclick handlers
        window.removeItem = removeItem;
        
        // Function to update quantity of any item
        function updateItemQty(index, change) {
            // Validate index
            if (index < 0 || index >= cartItems.length) {
                console.error('Invalid index for updateItemQty:', index, 'cartItems.length:', cartItems.length);
                return;
            }
            
            const item = cartItems[index];
            if (!item) {
                console.error('Item not found at index:', index);
                return;
            }
            
            // Store original qty if not set (for existing items)
            if (item.isExisting === true && item.originalQty === undefined) {
                item.originalQty = item.qty;
            }
            
            const originalQty = item.originalQty !== undefined ? item.originalQty : item.qty;
            const newQty = Math.max(0, item.qty + change);
            
            if (newQty === item.qty) return; // No change
            
            // Update quantity
            item.qty = newQty;
            
            // Recalculate line totals
            const unitPriceUsd = parseFloat(item.unit_price_usd) || 0;
            item.line_total_usd = unitPriceUsd * newQty;
            item.line_total_php = item.line_total_usd * EXCHANGE_RATE;
            
            // Mark as updated if quantity changed from original
            if (newQty !== originalQty) {
                item.isUpdated = true; // Mark as updated for change detection
            } else {
                item.isUpdated = false; // Revert if quantity matches original
            }
            
            // If quantity is 0, remove from cart
            if (newQty === 0) {
                cartItems.splice(index, 1);
                showToast(`✅ ${item.product_name} removed from cart`, 3000);
            } else {
                showToast(newQty > originalQty ? `✅ ${item.product_name} quantity increased to ${newQty}` : `✅ ${item.product_name} quantity decreased to ${newQty}`, 3000);
            }
            
            // Update cart display and button state
            updateCart();
            saveCart();
            updateSubmitButtonText(); // Update button state when items change
        }
        window.updateItemQty = updateItemQty; // Expose to global scope

        // Auto-lookup returning customers
        let customerLookupTimeout = null;
        let existingCustomerOrders = [];
        
        // Function to update submit button text and state based on existing order
        function updateSubmitButtonText() {
            const submitBtn = document.getElementById('submit-order');
            const existingButtons = document.getElementById('existing-order-buttons');
            const viewTotalBtn = document.getElementById('view-total-order-btn');
            const updateOrderBtn = document.getElementById('update-order-btn');
            
            if (!submitBtn) return;
            
            // Check if there's a pending order
            const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled' && !o.locked);
            
            // Check if there are any changes (new items, updated quantities, or removed items)
            const hasNewItems = cartItems.some(item => item.isExisting !== true);
            const hasUpdatedItems = cartItems.some(item => item.isUpdated === true);
            const hasChanges = hasNewItems || hasUpdatedItems || cartItems.length === 0;
            
            if (pendingOrder && cartItems.length > 0) {
                // Show existing order buttons, hide submit button
                submitBtn.style.display = 'none';
                if (existingButtons) existingButtons.style.display = 'flex';
                
                // Set up view total order button
                if (viewTotalBtn) {
                    viewTotalBtn.onclick = () => {
                        if (typeof viewOrder === 'function') {
                            viewOrder(pendingOrder.order_id);
                        }
                    };
                }
                
                // Set up update order button (same as submit)
                if (updateOrderBtn) {
                    // Enable/disable update button based on whether there are changes
                    updateOrderBtn.disabled = !hasChanges;
                    updateOrderBtn.onclick = () => {
                        if (!hasChanges) {
                            showToast('❌ No changes detected. Please add, update, or remove items before updating.', 3000);
                            return;
                        }
                        // Trigger the submit order click handler
                        const submitBtnClick = document.getElementById('submit-order');
                        if (submitBtnClick && submitBtnClick.onclick) {
                            submitBtnClick.onclick();
                        } else {
                            // Fallback: trigger click event
                            submitBtnClick?.click();
                        }
                    };
                }
            } else {
                // Show submit button, hide existing order buttons
                submitBtn.style.display = 'block';
                submitBtn.textContent = 'Submit Order';
                // Enable submit button if cart has items
                submitBtn.disabled = cartItems.length === 0;
                if (existingButtons) existingButtons.style.display = 'none';
            }
        }
        
        function checkReturningCustomer() {
            const telegram = document.getElementById('telegram').value.trim();
            const fullName = document.getElementById('full-name').value.trim();
            
            // Need both name and telegram to populate orders
            if (!telegram || !fullName) {
                hideMyOrdersSection();
                hideReturningCustomerBanner();
                // Clear cart if fields are cleared
                if (!telegram || !fullName) {
                    currentOrderId = null;
                    cartItems = [];
                    // Removed items tracking no longer needed
                    updateCart();
                    saveCart();
                    updateSubmitButtonText();
                }
                return;
            }
            
            // Clear previous timeout
            if (customerLookupTimeout) clearTimeout(customerLookupTimeout);
            
            // Debounce the lookup
            customerLookupTimeout = setTimeout(async () => {
                try {
                    console.log('Looking up orders for telegram:', telegram);
                    const response = await fetch(`/api/orders/lookup?telegram=${encodeURIComponent(telegram)}`);
                    const orders = await response.json();
                    console.log('Found orders:', orders);
                    
                    if (orders && orders.length > 0) {
                        existingCustomerOrders = orders;
                        
                        // Find the most recent pending (non-cancelled, non-locked) order
                        const pendingOrder = orders.find(o => o.status !== 'Cancelled' && !o.locked);
                        
                        if (pendingOrder && pendingOrder.items && pendingOrder.items.length > 0) {
                            // Store pending order ID for button text
                            currentOrderId = pendingOrder.order_id;
                            
                            // Clear removed items tracking when loading fresh order
                            // Removed items tracking no longer needed
                            
                            // Filter out items with 0 quantity before populating cart
                            const validItems = pendingOrder.items.filter(item => {
                                const qty = parseFloat(item.qty) || 0;
                                return qty > 0;
                            });
                            
                            // Populate cart with existing order items (marked as existing)
                            cartItems = validItems.map(item => {
                                // Ensure we have all required fields with proper defaults
                                const qty = parseFloat(item.qty) || 1;
                                
                                // Try to get prices from item, prioritizing PHP since that's what's stored
                                let lineTotalPhp = parseFloat(item.line_total_php) || 0;
                                let lineTotalUsd = parseFloat(item.line_total_usd) || 0;
                                
                                // If PHP exists but USD doesn't, calculate USD from PHP
                                if (lineTotalPhp > 0 && (lineTotalUsd === 0 || isNaN(lineTotalUsd))) {
                                    lineTotalUsd = lineTotalPhp / EXCHANGE_RATE;
                                }
                                
                                // If USD exists but PHP doesn't, calculate PHP from USD
                                if (lineTotalUsd > 0 && (lineTotalPhp === 0 || isNaN(lineTotalPhp))) {
                                    lineTotalPhp = lineTotalUsd * EXCHANGE_RATE;
                                }
                                
                                // If both are missing, try to calculate from unit price
                                if ((lineTotalUsd === 0 || isNaN(lineTotalUsd)) && (lineTotalPhp === 0 || isNaN(lineTotalPhp))) {
                                    const unitPriceUsd = parseFloat(item.unit_price_usd) || 0;
                                    if (unitPriceUsd > 0) {
                                        lineTotalUsd = unitPriceUsd * qty;
                                        lineTotalPhp = lineTotalUsd * EXCHANGE_RATE;
                                    } else {
                                        // Last resort: try to calculate from PHP price if available
                                        const unitPricePhp = parseFloat(item.unit_price_php) || 0;
                                        if (unitPricePhp > 0) {
                                            lineTotalPhp = unitPricePhp * qty;
                                            lineTotalUsd = lineTotalPhp / EXCHANGE_RATE;
                                        }
                                    }
                                }
                                
                                // Calculate unit price if missing
                                const unitPriceUsd = parseFloat(item.unit_price_usd) || (qty > 0 ? lineTotalUsd / qty : 0);
                                
                                return {
                                    product_code: item.product_code,
                                    product_name: item.product_name,
                                    order_type: item.order_type || 'Vial',
                                    qty: qty,
                                    unit_price_usd: unitPriceUsd,
                                    line_total_usd: lineTotalUsd,
                                    line_total_php: lineTotalPhp,
                                    isExisting: true,  // Mark as existing item
                                    originalQty: qty   // Store original quantity for comparison
                                };
                            });
                            
                            updateCart();
                            saveCart();
                            updateSubmitButtonText(); // Update buttons after loading existing items
                            showToast(`✅ Loaded ${cartItems.length} item(s) from your existing order`, 3000);
                        } else {
                            // No pending order, clear cart and reset order ID
                            currentOrderId = null;
                            cartItems = [];
                            // Removed items tracking no longer needed
                            updateCart();
                            saveCart();
                        }
                        
                        // Update button text
                        updateSubmitButtonText();
                        
                        hideMyOrdersSection();
                        hideReturningCustomerBanner();
                    } else {
                        console.log('No orders found for', telegram);
                        currentOrderId = null;
                        cartItems = [];
                        // Removed items tracking no longer needed
                        updateCart();
                        saveCart();
                        updateSubmitButtonText();
                        hideReturningCustomerBanner();
                        hideMyOrdersSection();
                    }
                } catch (error) {
                    console.error('Customer lookup error:', error);
                    hideReturningCustomerBanner();
                    hideMyOrdersSection();
                }
            }, 500);
        }
        
        function showMyOrdersSection(orders) {
            const section = document.getElementById('my-orders-section');
            const list = document.getElementById('my-orders-list');
            const empty = document.getElementById('my-orders-empty');
            
            if (orders.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
                section.style.display = 'block';
                return;
            }
            
            list.innerHTML = orders.map(order => {
                const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
                const items = order.items || [];  // Safety check for items array
                const itemsPreview = items.map(i => `${i.product_name || i.product_code} (${i.order_type || 'Vial'} x${i.qty || 0})`).join(', ');
                
                return `
                    <div class="card" style="cursor: pointer; padding: 1.5rem; border: 2px solid ${isPaid ? 'var(--accent-emerald)' : 'var(--accent-amber)'}; background: ${isPaid ? 'rgba(16, 185, 129, 0.05)' : 'rgba(245, 158, 11, 0.05)'};" onclick="viewOrder('${order.order_id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary); font-weight: 700; font-size: 1.1rem; margin-bottom: 0.35rem;">${order.order_id}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">${order.order_date}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--accent-primary); margin-bottom: 0.35rem;">₱${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                <div style="display: inline-block; padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; ${isPaid ? 'background: rgba(16, 185, 129, 0.2); color: #065f46;' : 'background: rgba(245, 158, 11, 0.2); color: #92400e;'}">${isPaid ? '✅ PAID' : '⏳ UNPAID'}</div>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500;">📦 Items:</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${itemsPreview}</div>
                        ${!isPaid && order.payment_screenshot ? '<div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--accent-teal);">📷 Payment screenshot uploaded - pending confirmation</div>' : ''}
                    </div>
                `;
            }).join('');
            
            list.style.display = 'grid';
            empty.style.display = 'none';
            section.style.display = 'block';
            
            // Scroll to show the orders section
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }
        
        function hideMyOrdersSection() {
            const section = document.getElementById('my-orders-section');
            section.style.display = 'none';
        }
        
        function showReturningCustomerBanner(orders) {
            // Remove existing banner if any
            hideReturningCustomerBanner();
            
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.status !== 'Cancelled').length;
            const unpaidOrders = orders.filter(o => o.payment_status && o.payment_status.toLowerCase() !== 'paid').length;
            
            const banner = document.createElement('div');
            banner.id = 'returning-customer-banner';
            banner.style.cssText = `
                background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15));
                border: 2px solid var(--accent-violet);
                border-radius: 16px;
                padding: 1.25rem;
                margin-bottom: 1.5rem;
                animation: slideIn 0.3s ease;
            `;
            banner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div style="background: linear-gradient(135deg, #8b5cf6, #ec4899); padding: 0.75rem; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 1.75rem;">👋</span>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; color: var(--text-primary);">Welcome back!</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            You have <strong style="color: var(--accent-violet);">${pendingOrders}</strong> existing order(s)
                            ${unpaidOrders > 0 ? ` • <strong style="color: var(--accent-amber);">${unpaidOrders}</strong> unpaid` : ''}
                        </div>
                    </div>
                    <button class="btn btn-violet" style="padding: 0.65rem 1.25rem; font-size: 0.9rem; font-weight: 600;" onclick="scrollToMyOrders()">
                        📋 View My Orders Below
                    </button>
                </div>
            `;
            
            // Insert at the top of customer info section
            const customerInfo = document.querySelector('.customer-info-card');
            if (customerInfo) {
                customerInfo.insertBefore(banner, customerInfo.firstChild);
            }
        }
        
        function scrollToMyOrders() {
            const section = document.getElementById('my-orders-section');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function hideReturningCustomerBanner() {
            const banner = document.getElementById('returning-customer-banner');
            if (banner) banner.remove();
        }
        
        function viewMyExistingOrders() {
            // Scroll to orders section (orders auto-populate when telegram username is entered)
            const section = document.getElementById('my-orders-section');
            if (section && section.style.display !== 'none') {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Add event listeners for customer lookup
        // checkReturningCustomer is now called from the required fields check above

        // Submit Order - Show confirmation modal first
        document.getElementById('submit-order').addEventListener('click', () => {
            const fullName = document.getElementById('full-name').value.trim();
            const telegram = document.getElementById('telegram').value.trim();
            
            if (!fullName || !telegram) {
                showToast('Please fill in name and telegram username');
                return;
            }
            
            if (cartItems.length === 0) {
                showToast('Your cart is empty');
                return;
            }
            
            // Show confirmation modal
            showOrderConfirmationModal();
        });
        
        // Show order confirmation modal
        function showOrderConfirmationModal() {
            const modal = document.getElementById('order-confirmation-modal');
            const itemsList = document.getElementById('confirmation-items-list');
            
            // Render cart items with remove buttons
            itemsList.innerHTML = cartItems.map((item, i) => `
                <div class="cart-item" id="confirmation-item-${i}">
                    <button class="cart-item-remove" onclick="removeFromConfirmation(${i})">×</button>
                    <div class="cart-item-header">
                        <span class="cart-item-name">${item.product_name}</span>
                        <span class="cart-item-code">${item.product_code}</span>
                    </div>
                    <div class="cart-item-details">
                        <span>${item.order_type} × ${item.qty}</span>
                        <span class="cart-item-price">₱${item.line_total_php.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
            
            // Update totals
            updateConfirmationTotals();
            
            // Show modal
            modal.classList.add('show');
        }
        
        // Remove item from confirmation modal
        function removeFromConfirmation(index) {
            cartItems.splice(index, 1);
            
            if (cartItems.length === 0) {
                closeModal('order-confirmation-modal');
                updateCart();
                showToast('Cart is now empty');
                return;
            }
            
            // Update confirmation modal
            showOrderConfirmationModal();
            
            // Update main cart display
            updateCart();
            saveCart();
        }
        
        // Expose to global scope
        window.removeFromConfirmation = removeFromConfirmation;
        
        // Update confirmation modal totals
        function updateConfirmationTotals() {
            const totalUsd = cartItems.reduce((sum, item) => sum + item.line_total_usd, 0);
            const totalPhp = totalUsd * EXCHANGE_RATE;
            const grandTotal = totalPhp + ADMIN_FEE;
            
            document.getElementById('confirmation-subtotal-usd').textContent = `$${totalUsd.toFixed(2)}`;
            document.getElementById('confirmation-subtotal-php').textContent = `₱${totalPhp.toFixed(2)}`;
            document.getElementById('confirmation-grand-total').textContent = `₱${grandTotal.toFixed(2)}`;
        }
        
        // Confirm and submit order
        async function confirmOrderSubmission() {
            const fullName = document.getElementById('full-name').value.trim();
            const telegram = document.getElementById('telegram').value.trim();
            const btn = document.getElementById('confirm-submit-btn');
            
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            try {
                let response, result;
                
                // Check if customer has an existing pending order to update
                const pendingOrder = existingCustomerOrders.find(o => o.status !== 'Cancelled' && !o.locked);
                
                if (pendingOrder) {
                    // Update existing order - send ALL items (backend will handle updates/deletions)
                    btn.textContent = 'Updating...';
                    
                    // Check if there are any changes
                    const hasChanges = cartItems.some(item => {
                        // New item (not from existing order)
                        if (item.isExisting !== true) return true;
                        // Updated item (quantity changed from original)
                        if (item.originalQty !== undefined && item.qty !== item.originalQty) return true;
                        return false;
                    });
                    
                    if (!hasChanges && cartItems.length === 0) {
                        showToast('❌ Please add items, update quantities, or remove items before submitting', 3000);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                        return;
                    }
                    
                    // Send ALL items from cart (backend will update/delete as needed)
                    // Filter out items with qty 0 (they should be removed, not sent)
                    const itemsToSend = cartItems
                        .filter(item => item.qty > 0) // Only send items with qty > 0
                        .map(item => ({
                            product_code: item.product_code,
                            product_name: item.product_name,
                            order_type: item.order_type,
                            qty: parseFloat(item.qty) || 0, // Ensure qty is a number
                            unit_price_usd: parseFloat(item.unit_price_usd) || 0,
                            line_total_usd: parseFloat(item.line_total_usd) || 0,
                            line_total_php: parseFloat(item.line_total_php) || 0
                        }));
                    
                    // Validate all items have valid quantities
                    const invalidItems = itemsToSend.filter(item => !item.qty || item.qty <= 0);
                    if (invalidItems.length > 0) {
                        showToast('❌ Error: Some items have invalid quantities. Please check your order.', 3000);
                        btn.disabled = false;
                        btn.textContent = 'Confirm & Submit Order';
                        return;
                    }
                    
                    response = await fetch(`/api/orders/${pendingOrder.order_id}/add-items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            items: itemsToSend,  // Send all items with qty > 0
                            telegram_username: telegram
                        })
                    });
                    
                    result = await response.json();
                    
                    if (result.success) {
                        currentOrderId = pendingOrder.order_id;
                        
                        // Clear removed items tracking (no longer needed since we send all items)
                        removedItems = [];
                        
                        // Close confirmation modal
                        closeModal('order-confirmation-modal');
                        
                        // Refresh order lookup immediately to get updated totals
                        if (typeof checkReturningCustomer === 'function') {
                            setTimeout(() => {
                                checkReturningCustomer();
                            }, 500); // Small delay to ensure backend has processed
                        }
                        
                        // Show finalize order modal
                        showFinalizeOrderModal(pendingOrder.order_id);
                        
                        // Clear cart
                        cartItems = [];
                        updateCart();
                        saveCart();
                    } else {
                        const errorMsg = result.error || 'Failed to update order';
                        showToast(`❌ ${errorMsg}`, 5000);
                        console.error('Order update error:', result);
                    }
                } else {
                    // Create new order
                    btn.textContent = 'Submitting...';
                    response = await fetch('/api/submit-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ full_name: fullName, telegram, items: cartItems })
                    });
                    
                    result = await response.json();
                    
                    if (result.success) {
                        currentOrderId = result.order_id;
                        
                        // Close confirmation modal
                        closeModal('order-confirmation-modal');
                        
                        // Show success modal
                        showOrderModal(result.order);
                        
                        // Clear cart and form
                        cartItems = [];
                        updateCart();
                        saveCart();
                        document.getElementById('full-name').value = '';
                        document.getElementById('telegram').value = '';
                    } else {
                        const errorMsg = result.error || 'Failed to submit order';
                        showToast(`❌ ${errorMsg}`, 5000);
                        console.error('Order submission error:', result);
                    }
                }
            } catch (error) {
                console.error('Order submission error:', error);
                let errorMessage = 'Error submitting order';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                showToast(errorMessage, 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm & Submit Order';
            }
        }
        
        // Expose to global scope
        window.confirmOrderSubmission = confirmOrderSubmission;
        
        let pendingFinalizeOrderId = null;
        
        function showFinalizeOrderModal(orderId) {
            pendingFinalizeOrderId = orderId;
            
            // Fetch updated order details (with cache busting to get fresh data)
            fetch(`/api/orders/${orderId}?t=${Date.now()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch order');
                    }
                    return response.json();
                })
                .then(order => {
                    const summaryEl = document.getElementById('finalize-order-summary');
                    if (!summaryEl) {
                        console.error('finalize-order-summary element not found');
                        showToast('❌ Error: Order summary element not found', 3000);
                        return;
                    }
                    
                    // Filter out 0 quantity items
                    const items = order.items.filter(item => item.qty > 0);
                    
                    if (items.length === 0) {
                        summaryEl.innerHTML = '<p style="color: var(--accent-rose); text-align: center; padding: 2rem;">No items with quantity > 0 in this order. Please add items before finalizing.</p>';
                        return;
                    }
                    
                    // Calculate subtotal from items (only qty > 0)
                    const subtotalPhp = items.reduce((sum, item) => sum + (parseFloat(item.line_total_php) || 0), 0);
                    const grandTotalPhp = order.grand_total_php || (subtotalPhp + ADMIN_FEE);
                    
                    summaryEl.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-teal); font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem;">${order.order_id}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">${order.order_date}</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">Items:</div>
                            ${items.map(item => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border);">
                                    <span>${item.product_name} (${item.order_type} × ${item.qty})</span>
                                    <span style="font-weight: 600;">₱${item.line_total_php.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="border-top: 2px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Subtotal (PHP):</span>
                                <span>₱${subtotalPhp.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Admin Fee:</span>
                                <span>₱${ADMIN_FEE.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; color: var(--accent-teal); margin-top: 0.5rem;">
                                <span>Grand Total:</span>
                                <span>₱${grandTotalPhp.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    
                    const modal = document.getElementById('finalize-order-modal');
                    if (modal) {
                        modal.classList.add('show');
                    } else {
                        console.error('finalize-order-modal element not found');
                        showToast('❌ Error: Order modal not found', 3000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching order:', error);
                    showToast('❌ Error loading order details. Please try again.', 3000);
                });
        }
        
        async function finalizeOrder() {
            if (!pendingFinalizeOrderId) {
                return;
            }
            
            const btn = document.getElementById('finalize-order-btn');
            btn.disabled = true;
            btn.textContent = 'Finalizing...';
            
            try {
                const response = await fetch(`/api/orders/${pendingFinalizeOrderId}/finalize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('✅ Order finalized! GB Admin has been notified.', 5000);
                    closeModal('finalize-order-modal');
                    
                    // Refresh order lookup
                    if (typeof checkReturningCustomer === 'function') {
                        checkReturningCustomer();
                    }
                    
                    // Show order details
                    if (typeof viewOrder === 'function') {
                        viewOrder(pendingFinalizeOrderId);
                    }
                } else {
                    const errorMsg = result.error || 'Failed to finalize order';
                    showToast(`❌ ${errorMsg}`, 5000);
                    btn.disabled = false;
                    btn.textContent = 'Finalize Order';
                }
            } catch (error) {
                console.error('Error finalizing order:', error);
                showToast('❌ Error finalizing order. Please try again.', 5000);
                btn.disabled = false;
                btn.textContent = 'Finalize Order';
            } finally {
                pendingFinalizeOrderId = null;
            }
        }
        
        // Expose to global scope
        window.finalizeOrder = finalizeOrder;

        function showOrderModal(order) {
            const modalOrderId = document.getElementById('modal-order-id');
            const modalSubtotalUsd = document.getElementById('modal-subtotal-usd');
            const modalSubtotalPhp = document.getElementById('modal-subtotal-php');
            const modalGrandTotal = document.getElementById('modal-grand-total');
            const modalItems = document.getElementById('modal-items');
            const orderModal = document.getElementById('order-modal');
            
            if (modalOrderId) modalOrderId.textContent = order.order_id;
            if (modalSubtotalUsd) modalSubtotalUsd.textContent = `$${order.subtotal_usd.toFixed(2)}`;
            if (modalSubtotalPhp) modalSubtotalPhp.textContent = `₱${order.subtotal_php.toFixed(2)}`;
            if (modalGrandTotal) modalGrandTotal.textContent = `₱${order.grand_total_php.toFixed(2)}`;
            
            if (modalItems) {
                modalItems.innerHTML = order.items.map(item => `
                    <div class="order-item-row">
                        <div class="order-item-info">
                            <div>${item.product_name}</div>
                            <div class="order-item-qty">${item.order_type} × ${item.qty}</div>
                        </div>
                        <div>₱${item.line_total_php.toFixed(2)}</div>
                    </div>
                `).join('');
            } else {
                console.error('modal-items element not found');
            }
            
            if (orderModal) {
                orderModal.classList.add('show');
            } else {
                console.error('order-modal element not found');
            }
        }

        // Payment Upload removed - customers now use "Payment Sent" button from order details

        // Load Orders - REMOVED (functionality moved to auto-populate on Telegram username entry)
        // This reduces memory usage and API calls
        
        // Search Orders - REMOVED (View Orders tab removed)
        // Orders now auto-populate when customer enters Telegram username
        
        // Placeholder for removed order-search event listener
        const orderSearchElement = document.getElementById('order-search');
        if (orderSearchElement) {
            orderSearchElement.addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) { 
                // Safe call to loadOrders if it exists
                if (typeof loadOrders === 'function') {
                    try {
                        loadOrders();
                    } catch (e) {
                        console.log('loadOrders not available');
                    }
                }
                return; 
            }
            
            try {
                const response = await fetch(`/api/orders/search?q=${encodeURIComponent(query)}`);
                const orders = await response.json();
                const list = document.getElementById('orders-list');
                
                if (!list) {
                    console.error('orders-list element not found');
                    return;
                }
                
                list.innerHTML = orders.length === 0 
                    ? '<div class="cart-empty">No matching orders</div>'
                    : orders.map(order => `
                        <div class="order-card" onclick="viewOrder('${order.order_id}')">
                            <div class="order-card-header">
                                <span class="order-card-id">${order.order_id}</span>
                            </div>
                            <div class="order-card-customer">${order.full_name}</div>
                            <div style="display: flex; justify-content: space-between;">
                                <span class="status-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                                <span class="order-card-total">₱${order.grand_total_php.toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error searching orders:', error);
                const list = document.getElementById('orders-list');
                if (list) {
                    list.innerHTML = '<div class="cart-empty">Error searching orders. Please try again.</div>';
                }
            }
        });
        }

        // View Order Details
        let currentViewingOrder = null;
        
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch order: ${response.status}`);
                }
                const order = await response.json();
                currentViewingOrder = order;
                
                const canEdit = !order.locked && order.status !== 'Cancelled';
                
                const body = document.getElementById('order-details-body');
                if (!body) {
                    console.error('order-details-body element not found');
                    showToast('❌ Error: Order details element not found', 3000);
                    return;
                }
                
                body.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-teal); font-size: 1.25rem;">${order.order_id}</span>
                            <span class="status-badge ${order.status.toLowerCase()}">${order.status}</span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">${order.order_date}</div>
                    </div>
                    
                    <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        <div style="font-weight: 500;">${order.full_name}</div>
                        ${order.telegram ? `<div style="color: var(--text-muted); font-size: 0.75rem;">📱 ${order.telegram}</div>` : ''}
                        ${order.mailing_address ? `
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border);">
                                <div style="color: var(--accent-primary); font-size: 0.8rem; font-weight: 600;">📬 Mailing Address:</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">${order.mailing_name || order.full_name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${order.mailing_phone}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${order.mailing_address}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <h4 style="margin-bottom: 0.75rem;">Items</h4>
                    <div id="order-items-list">
                    ${order.items.map((item, index) => `
                        <div class="order-item-row" style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="order-item-info" style="flex: 1;">
                                <div>${item.product_name}</div>
                                <div class="order-item-qty">${item.order_type} × <span id="item-qty-${index}">${item.qty}</span></div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${canEdit ? `
                                <button class="edit-qty-btn" onclick="editItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', ${item.qty})" title="Edit quantity">✏️</button>
                                ` : ''}
                                <span>₱${item.line_total_php.toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                    
                    <div class="cart-summary" style="margin-top: 1rem;">
                        <div class="summary-row grand-total">
                            <span class="summary-label">Grand Total</span>
                            <span class="summary-value" id="order-grand-total">₱${order.grand_total_php.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center;">
                        <span class="status-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                        ${order.payment_screenshot ? `<a href="${order.payment_screenshot}" target="_blank" style="color: var(--accent-teal); font-size: 0.85rem;">View Receipt</a>` : ''}
                    </div>
                    
                    ${order.payment_status === 'Unpaid' && order.status !== 'Cancelled' ? `
                    <!-- Payment Section for Unpaid Orders -->
                    <div class="payment-section" style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 16px; border: 2px solid var(--accent-primary);">
                        <h4 style="margin-bottom: 1rem; color: var(--accent-primary); text-align: center;">💳 Make Payment</h4>
                        
                        <!-- Payment QR Options -->
                        <div style="margin-bottom: 1rem;">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-align: center;">Choose your payment method:</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                <a href="https://drive.google.com/file/d/1-Fbib327N9RXsGH4rtHGTtitag5-UbLl/view?usp=drive_link" target="_blank" class="payment-qr-btn">GCash</a>
                                <a href="https://drive.google.com/file/d/1RF4q3tZhzohS_Ic3-WdA83xpWgYLU1WY/view?usp=drive_link" target="_blank" class="payment-qr-btn">Maya</a>
                                <a href="https://drive.google.com/file/d/1k2aR2xHxLWaAY4T0JMzo0i7dHXUZ5V_b/view?usp=drive_link" target="_blank" class="payment-qr-btn">BPI</a>
                                <a href="https://drive.google.com/file/d/1jhlG1vlTarnNxvji__QtzwrtIGhlNa6f/view?usp=drive_link" target="_blank" class="payment-qr-btn">UnionBank</a>
                                <a href="https://drive.google.com/file/d/1P7KvA5Sgk0yl4L-Kn_W2OV4ek3HSueFU/view?usp=drive_link" target="_blank" class="payment-qr-btn">CIMB</a>
                                <a href="https://drive.google.com/file/d/1kuBfTepRzzNfvuXh9-kgz29-Dccvhjuh/view?usp=drive_link" target="_blank" class="payment-qr-btn">MariBank</a>
                                <a href="https://drive.google.com/file/d/12dqI1EVUNCI_V3Ht4zYaFHLLzEhvysfT/view?usp=sharing" target="_blank" class="payment-qr-btn">GoTyme</a>
                            </div>
                        </div>
                        
                        <!-- Friendly Reminder -->
                        <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px dashed var(--accent-purple);">
                            <p style="font-size: 0.95rem; font-weight: 600; color: var(--accent-purple); margin-bottom: 0.5rem; text-align: center;">✨ Friendly Pep_Haul Reminder! ✨</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Hiii Pep Hauler! 💙</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Please leave the <strong>Notes section blank</strong>, pretty please! 🧬💫</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">If you must write something, just your <strong>telegram username</strong> is perfect.</p>
                            <p style="font-size: 0.85rem; color: #ef4444; margin-bottom: 0.5rem;">❌ No "peptide payment," "payment," or anything super serious like that.</p>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">My bank account is just a baby (personal account lang po 😅) — ayaw natin ma-flag or ma-freeze and ma-delay ang pep-haul!</p>
                            <p style="font-size: 0.85rem; color: var(--accent-primary); text-align: center; margin-top: 0.75rem;">Thank you for keeping our pep-haul smooth, happy, and drama-free! 💕🥰</p>
                        </div>
                        
                        <!-- Mark Payment as Sent -->
                        <div style="text-align: center;">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">After payment, let GB Admin know:</p>

                            <button class="btn btn-primary" onclick="markPaymentSent('${order.order_id}')" style="width: 100%; font-size: 1rem; padding: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">💸</span>
                                <span>Payment Sent to GB Admin</span>
                            </button>

                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem;">GB Admin will be notified via Telegram</p>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                const footer = document.getElementById('order-details-footer');
                const isPaid = order.payment_status === 'Paid';
                const hasMailing = order.mailing_address && order.mailing_address.trim() !== '';
                
                let footerHtml = '';
                
                // Show "Add Mailing Address" button for paid orders without mailing address
                if (isPaid && !hasMailing) {
                    footerHtml += `<button class="btn btn-violet" onclick="openMailingAddressModal('${order.order_id}', '${order.full_name}')">📬 Add Mailing Address</button>`;
                }
                
                if (canEdit) {
                    footerHtml += `<button class="btn btn-rose" onclick="cancelOrder('${order.order_id}', '${(order.telegram || '').replace(/'/g, "\\'")}')" style="font-weight: 600;" title="⚠️ Warning: This action cannot be undone. You will need to create a new order to reserve products.">🗑️ Cancel Order</button>`;
                }
                
                footerHtml += `<button class="btn btn-secondary" onclick="closeModal('order-details-modal')">Close</button>`;
                
                if (footer) {
                    footer.innerHTML = footerHtml;
                } else {
                    console.error('order-details-footer element not found');
                }
                
                const orderDetailsModal = document.getElementById('order-details-modal');
                if (orderDetailsModal) {
                    orderDetailsModal.classList.add('show');
                } else {
                    console.error('order-details-modal element not found');
                    showToast('❌ Error: Order details modal not found', 3000);
                }
            } catch (error) {
                console.error('Error fetching order:', error);
                let errorMessage = 'Error loading order details';
                if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                } else if (error instanceof TypeError) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                }
                showToast(`❌ ${errorMessage}`, 5000);
            }
        }
        
        // Expose viewOrder to global scope for onclick handlers
        window.viewOrder = viewOrder;
        
        // Edit item quantity
        function editItemQty(orderId, productCode, orderType, currentQty) {
            const newQty = prompt(`Update quantity for ${productCode} (${orderType}):`, currentQty);
            if (newQty === null) return; // Cancelled
            
            const qty = parseInt(newQty);
            if (isNaN(qty) || qty < 0) {
                showToast('Please enter a valid quantity (0 or more)');
                return;
            }
            
            updateItemQuantity(orderId, productCode, orderType, qty);
        }
        
        async function updateItemQuantity(orderId, productCode, orderType, newQty) {
            try {
                const response = await fetch(`/api/orders/${orderId}/update-item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        product_code: productCode, 
                        order_type: orderType, 
                        qty: newQty 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(newQty === 0 ? 'Item removed!' : 'Quantity updated!');
                    // Refresh the order view
                    viewOrder(orderId);
                } else {
                    showToast(result.error || 'Failed to update');
                }
            } catch (error) {
                showToast('Error updating quantity');
            }
        }

        // Payment file upload removed - customers now use "Payment Sent" button

        async function markPaymentSent(orderId) {
            if (!confirm('Confirm that you have sent payment to GB Admin via GCash/Maya/Bank?')) {
                return;
            }

            try {
                const response = await fetch(`/api/mark-payment-sent/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('✅ Payment marked as sent! GB Admin will confirm soon.');
                    // Refresh the order view
                    viewOrder(orderId);
                } else {
                    showToast(result.error || 'Failed to update payment status');
                }
            } catch (error) {
                console.error('Error marking payment as sent:', error);
                showToast('Network error - please try again');
            }
        }

        let cancelOrderTimeout = null;
        let cancelOrderCountdown = null;
        let pendingCancelOrderId = null;
        let pendingCancelTelegram = null;
        
        function cancelOrder(orderId, telegramUsername = '') {
            pendingCancelOrderId = orderId;
            pendingCancelTelegram = telegramUsername;
            
            // Show cancel confirmation modal
            const modal = document.getElementById('cancel-order-modal');
            modal.classList.add('show');
            
            // Reset buttons
            const undoBtn = document.getElementById('undo-cancel-btn');
            const confirmBtn = document.getElementById('confirm-cancel-btn');
            undoBtn.disabled = false;
            confirmBtn.disabled = false;
            
            // Start 5-second countdown
            let countdown = 5;
            const countdownEl = document.getElementById('cancel-countdown');
            countdownEl.textContent = `You have ${countdown} seconds to undo...`;
            
            cancelOrderCountdown = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownEl.textContent = `You have ${countdown} seconds to undo...`;
                    undoBtn.textContent = `Undo (${countdown}s)`;
                } else {
                    clearInterval(cancelOrderCountdown);
                    countdownEl.textContent = '';
                    undoBtn.disabled = true;
                    undoBtn.textContent = 'Undo (expired)';
                    // Auto-confirm after countdown
                    confirmCancelOrder();
                }
            }, 1000);
        }
        
        function undoCancelOrder() {
            if (cancelOrderCountdown) {
                clearInterval(cancelOrderCountdown);
                cancelOrderCountdown = null;
            }
            if (cancelOrderTimeout) {
                clearTimeout(cancelOrderTimeout);
                cancelOrderTimeout = null;
            }
            
            pendingCancelOrderId = null;
            pendingCancelTelegram = null;
            
            closeModal('cancel-order-modal');
            showToast('✅ Cancellation cancelled. Your order is safe.');
        }
        
        async function confirmCancelOrder() {
            if (!pendingCancelOrderId) {
                return;
            }
            
            // Clear countdown
            if (cancelOrderCountdown) {
                clearInterval(cancelOrderCountdown);
                cancelOrderCountdown = null;
            }
            
            // Disable buttons
            const undoBtn = document.getElementById('undo-cancel-btn');
            const confirmBtn = document.getElementById('confirm-cancel-btn');
            undoBtn.disabled = true;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Cancelling...';
            
            try {
                const requestBody = {};
                if (pendingCancelTelegram) {
                    requestBody.telegram_username = pendingCancelTelegram;
                }
                
                const response = await fetch(`/api/orders/${pendingCancelOrderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('✅ Order cancelled permanently. You must create a new order to reserve products.', 5000);
                    closeModal('cancel-order-modal');
                    closeModal('order-details-modal');
                    
                    // Clear cart if cancelled order was the current order
                    if (currentOrderId === pendingCancelOrderId) {
                        currentOrderId = null;
                        cartItems = [];
                        updateCart();
                        saveCart();
                    }
                    
                    // Refresh existing orders if function exists (safe call)
                    if (typeof checkReturningCustomer === 'function') {
                        checkReturningCustomer();
                    }
                    
                    // Try to reload orders list if function exists (safe call)
                    if (typeof loadOrders === 'function') {
                        try {
                            loadOrders();
                        } catch (e) {
                            console.log('loadOrders not available, skipping');
                        }
                    }
                } else {
                    const errorMsg = result.error || 'Failed to cancel order';
                    showToast(`❌ ${errorMsg}`, 5000);
                    console.error('Cancel order error:', result);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Yes, Cancel Order';
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                let errorMessage = 'Error cancelling order';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                showToast(`❌ ${errorMessage}`, 5000);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Yes, Cancel Order';
            } finally {
                pendingCancelOrderId = null;
                pendingCancelTelegram = null;
            }
        }
        
        // Expose cancelOrder to global scope
        window.cancelOrder = cancelOrder;

        // Mailing Address Functions
        let currentMailingOrderId = null;
        
        function openMailingAddressModal(orderId, fullName) {
            currentMailingOrderId = orderId;
            document.getElementById('mailing-name').value = fullName || '';
            document.getElementById('mailing-phone').value = '';
            document.getElementById('mailing-address-input').value = '';
            closeModal('order-details-modal');
            document.getElementById('mailing-address-modal').classList.add('show');
        }
        
        async function saveMailingAddress() {
            if (!currentMailingOrderId) return;
            
            const mailingName = document.getElementById('mailing-name').value.trim();
            const mailingPhone = document.getElementById('mailing-phone').value.trim();
            const mailingAddress = document.getElementById('mailing-address-input').value.trim();
            
            if (!mailingName) {
                showToast('Please enter receiver name');
                return;
            }
            if (!mailingPhone || mailingPhone.length < 10) {
                showToast('Please enter valid phone number (10 digits)');
                return;
            }
            if (!mailingAddress) {
                showToast('Please enter mailing address');
                return;
            }
            
            const btn = document.getElementById('save-mailing-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const response = await fetch(`/api/orders/${currentMailingOrderId}/mailing-address`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mailing_name: mailingName,
                        mailing_phone: '+63' + mailingPhone,
                        mailing_address: mailingAddress
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Mailing address saved! 📬');
                    closeModal('mailing-address-modal');
                    loadOrders();
                } else {
                    showToast(result.error || 'Failed to save address');
                }
            } catch (error) {
                console.error('Error saving mailing address:', error);
                showToast('Error saving address');
            } finally {
                btn.disabled = false;
                btn.textContent = '💾 Save Address';
            }
        }

        // Add items to existing order
        let addingToOrderId = null;
        
        function addToExistingOrder(orderId) {
            addingToOrderId = orderId;
            closeModal('order-details-modal');
            
            // Switch to new order view
            switchView('view-new-order');
            
            // Show notification banner
            showAddToOrderBanner(orderId);
            
            showToast(`Adding items to order ${orderId}`);
        }
        
        function showAddToOrderBanner(orderId) {
            // Remove existing banner if any
            const existingBanner = document.getElementById('add-to-order-banner');
            if (existingBanner) existingBanner.remove();
            
            // Create banner
            const banner = document.createElement('div');
            banner.id = 'add-to-order-banner';
            banner.className = 'add-to-order-banner';
            banner.innerHTML = `
                <div class="banner-content">
                    <span class="banner-icon">✨</span>
                    <span class="banner-text">Adding items to <strong>${orderId}</strong></span>
                    <button class="banner-cancel" onclick="cancelAddToOrder()">✕ Cancel</button>
                </div>
            `;
            
            // Insert at top of order form card
            const card = document.querySelector('#view-new-order .card');
            if (card) {
                card.insertBefore(banner, card.firstChild);
            }
            
            // Update submit button text
            const submitBtn = document.getElementById('submit-order');
            if (submitBtn) {
                submitBtn.innerHTML = '➕ Add to Existing Order';
            }
        }
        
        function cancelAddToOrder() {
            addingToOrderId = null;
            const banner = document.getElementById('add-to-order-banner');
            if (banner) banner.remove();
            
            // Reset submit button text
            const submitBtn = document.getElementById('submit-order');
            if (submitBtn) {
                submitBtn.innerHTML = 'Submit Order';
            }
            
            showToast('Cancelled adding to order');
        }
        
        // Show updated order details after adding items
        async function showViewOrderDetails(orderId) {
            // Small delay to ensure backend has updated
            await new Promise(resolve => setTimeout(resolve, 500));
            viewOrder(orderId);
        }


        // Modals
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Toast
        // Inventory Card Quantity Management
        function adjustInvQty(productCode, orderType, delta) {
            const inputId = orderType === 'Kit' ? `inv-kit-qty-${productCode}` : `inv-vial-qty-${productCode}`;
            const input = document.getElementById(inputId);
            
            if (!input) {
                console.error('Input not found:', inputId);
                return;
            }
            
            const currentQty = parseInt(input.value) || 0;
            const maxQty = parseInt(input.getAttribute('max')) || 99;
            let newQty = currentQty + delta;
            
            // Enforce min/max limits
            if (newQty < 0) newQty = 0;
            if (newQty > maxQty) newQty = maxQty;
            
            input.value = newQty;
            
            // Trigger input event to ensure any listeners are notified
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Expose adjustInvQty to global scope for onclick handlers
        window.adjustInvQty = adjustInvQty;

        function quickAddToCart(productCode, productName) {
            console.log('quickAddToCart called:', { productCode, productName });
            
            // Check if products are loaded
            if (!allProducts || allProducts.length === 0) {
                console.error('❌ Products not loaded yet');
                showToast('⏳ Products are still loading. Please wait a moment and try again.');
                return;
            }
            
            // Find product data from allProducts array
            const product = allProducts.find(p => p.code === productCode);
            if (!product) {
                console.error('❌ Product not found:', productCode);
                console.log('Available products:', allProducts.map(p => p.code));
                showToast('⚠️ Product not found. Please refresh the page.');
                return;
            }
            
            console.log('✅ Found product:', product);
            
            const kitPrice = product.kit_price;
            const vialPrice = product.vial_price;

            // Get quantities from inputs
            const kitQtyInput = document.getElementById(`inv-kit-qty-${productCode}`);
            const vialQtyInput = document.getElementById(`inv-vial-qty-${productCode}`);
            
            const kitQty = kitQtyInput ? parseInt(kitQtyInput.value) || 0 : 0;
            const vialQty = vialQtyInput ? parseInt(vialQtyInput.value) || 0 : 0;
            
            let added = false;
            
            if (kitQty > 0) {
                // Add kits to cart
                const existingKitIndex = cartItems.findIndex(item => 
                    item.product_code === productCode && item.order_type === 'Kit'
                );
                
                if (existingKitIndex !== -1) {
                    cartItems[existingKitIndex].qty += kitQty;
                    // Recalculate totals
                    const item = cartItems[existingKitIndex];
                    item.line_total_usd = item.unit_price_usd * item.qty;
                    item.line_total_php = item.line_total_usd * EXCHANGE_RATE;
                } else {
                    const lineTotalUsd = kitPrice * kitQty;
                    cartItems.push({
                        product_code: productCode,
                        product_name: productName,
                        order_type: 'Kit',
                        qty: kitQty,
                        unit_price_usd: kitPrice,
                        line_total_usd: lineTotalUsd,
                        line_total_php: lineTotalUsd * EXCHANGE_RATE
                    });
                }
                added = true;
            }
            
            if (vialQty > 0) {
                // Add vials to cart
                const existingVialIndex = cartItems.findIndex(item => 
                    item.product_code === productCode && item.order_type === 'Vial'
                );
                
                if (existingVialIndex !== -1) {
                    cartItems[existingVialIndex].qty += vialQty;
                    // Recalculate totals
                    const item = cartItems[existingVialIndex];
                    item.line_total_usd = item.unit_price_usd * item.qty;
                    item.line_total_php = item.line_total_usd * EXCHANGE_RATE;
                } else {
                    const lineTotalUsd = vialPrice * vialQty;
                    cartItems.push({
                        product_code: productCode,
                        product_name: productName,
                        order_type: 'Vial',
                        qty: vialQty,
                        unit_price_usd: vialPrice,
                        line_total_usd: lineTotalUsd,
                        line_total_php: lineTotalUsd * EXCHANGE_RATE
                    });
                }
                added = true;
            }

            if (added) {
                updateCart();
                saveCart();
                showToast(`✅ Added ${productName} to cart!`);
                
                // Reset quantities to 0
                if (kitQtyInput) kitQtyInput.value = 0;
                if (vialQtyInput) vialQtyInput.value = 0;
                
                // Scroll to cart (with error handling)
                try {
                    const newOrderSection = document.getElementById('new-order');
                    if (newOrderSection) {
                        newOrderSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        console.warn('new-order section not found for scrolling');
                    }
                } catch (error) {
                    console.error('Error scrolling to cart:', error);
                }
            } else {
                showToast('Please select quantity using + buttons!');
            }
        }
        
        // Expose quickAddToCart to global scope for onclick handlers
        window.quickAddToCart = quickAddToCart;

        // Inventory Search
        const inventorySearchInput = document.getElementById('inventory-search');
        if (inventorySearchInput) {
            inventorySearchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.inventory-card').forEach(card => {
                    const code = card.dataset.code.toLowerCase();
                    const name = card.dataset.name.toLowerCase();
                    const visible = code.includes(query) || name.includes(query);
                    card.style.display = visible ? '' : 'none';
                });
            });
        }

        // Initialize
        // On page load: only load cart if Name and Telegram are filled
        // Otherwise, clear cart and wait for user input
        const initialTelegram = telegramInput ? telegramInput.value.trim() : '';
        const initialFullName = fullNameInput ? fullNameInput.value.trim() : '';
        
        if (initialTelegram && initialFullName) {
            // Fields are pre-filled (e.g., from URL params or previous session)
            // Load cart and check for existing orders
            loadCart();
            checkReturningCustomer();
        } else {
            // Fields are empty - clear cart and don't load anything
            cartItems = [];
            currentOrderId = null;
            updateCart();
            saveCart();
        }
    </script>
</body>
</html>
