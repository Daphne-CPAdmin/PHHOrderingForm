<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PepHaul Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf5ff;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --accent-teal: #a78bfa;
            --accent-amber: #f9a8d4;
            --accent-rose: #f472b6;
            --accent-violet: #c084fc;
            --accent-emerald: #a78bfa;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(192, 132, 252, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(249, 168, 212, 0.12) 0%, transparent 50%);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #c084fc 0%, #f472b6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .back-link {
            color: var(--accent-teal);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Login */
        .login-container {
            max-width: 400px;
            margin: 4rem auto;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; }
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
        }
        .form-input:focus { outline: none; border-color: #c084fc; }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-violet { background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%); color: white; }
        .btn:hover { transform: translateY(-2px); }

        /* Admin Content */
        .admin-content { display: none; }
        .admin-content.show { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: #c084fc;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        /* Products Table */
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }

        .products-table th,
        .products-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .products-table th {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .products-table tr:hover {
            background: rgba(192, 132, 252, 0.1);
        }
        
        .products-table tr.locked-order {
            background: rgba(249, 168, 212, 0.1);
        }
        
        .products-table tr.locked-order:hover {
            background: rgba(249, 168, 212, 0.15);
        }
        
        .products-table tr.incomplete-kit {
            background: rgba(249, 168, 212, 0.12);
        }
        
        .products-table tr.incomplete-kit:hover {
            background: rgba(249, 168, 212, 0.18);
        }

        .product-code {
            font-family: 'JetBrains Mono', monospace;
            color: #a78bfa;
        }

        .kits-badge {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .kits-badge.normal {
            background: rgba(167, 139, 250, 0.2);
            color: #7c3aed;
        }

        .kits-badge.warning {
            background: rgba(249, 168, 212, 0.2);
            color: #ec4899;
        }

        .kits-badge.danger {
            background: rgba(244, 114, 182, 0.25);
            color: #db2777;
        }
        
        .kits-badge.incomplete {
            background: rgba(249, 168, 212, 0.25);
            color: #ec4899;
            font-weight: 600;
        }

        /* Completed Kits Gradient Styles */
        .completed-kit-row {
            transition: all 0.2s ease;
        }

        .completed-kit-row:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .lock-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 26px;
            transition: all 0.3s ease;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #f472b6;
            border-color: #f472b6;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background: white;
        }

        .max-kits-input {
            width: 80px;
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }

        .max-kits-input:focus {
            outline: none;
            border-color: #c084fc;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid #c084fc;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            color: var(--text-primary);
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        .search-bar {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
        }

        .table-container {
            overflow-x: auto;
        }

        .error-msg {
            color: var(--accent-rose);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Payment status badges */
        .payment-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-badge.unpaid {
            background: rgba(249, 168, 212, 0.2);
            color: #ec4899;
        }

        .payment-badge.waiting {
            background: rgba(192, 132, 252, 0.2);
            color: #a855f7;
        }

        .payment-badge.paid {
            background: rgba(167, 139, 250, 0.2);
            color: #7c3aed;
        }

        .payment-badge.partial {
            background: rgba(251, 191, 36, 0.2);
            color: #f59e0b;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-confirm {
            background: #a78bfa;
            color: white;
        }

        .btn-confirm:hover {
            opacity: 0.9;
        }

        .btn-view {
            background: #a78bfa;
            color: white;
        }

        .screenshot-link {
            color: #c084fc;
            text-decoration: none;
            font-size: 0.85rem;
        }

        .screenshot-link:hover {
            text-decoration: underline;
        }

        .order-items-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-width: 200px;
        }

        /* Order Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .order-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .order-detail-label {
            color: var(--text-muted);
        }

        .order-item-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        /* Rich text editor (Lock Message) */
        .rich-editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(192, 132, 252, 0.06);
        }
        .rich-editor-toolbar select,
        .rich-editor-toolbar input[type="color"] {
            padding: 0.5rem 0.6rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
        }
        .rich-editor-toolbar .rt-btn {
            padding: 0.5rem 0.6rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            cursor: pointer;
            font-weight: 700;
            color: var(--text-primary);
        }
        .rich-editor-toolbar .rt-btn:hover {
            border-color: rgba(192, 132, 252, 0.6);
        }
        .rich-editor {
            min-height: 110px;
            padding: 0.9rem 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            outline: none;
            line-height: 1.4;
        }
        .rich-editor:focus {
            border-color: #c084fc;
            box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.15);
        }
        .rich-editor:empty:before {
            content: attr(data-placeholder);
            color: var(--text-muted);
        }
        .muted-hint {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="login-section" class="login-container">
            <div class="card">
                <h2 class="card-title">üîê Admin Login</h2>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="admin-password" placeholder="Enter admin password">
                </div>
                <div id="login-error" class="error-msg" style="display: none;"></div>
                <button class="btn btn-violet" id="admin-login-btn">Login</button>
            </div>
        </div>

        <!-- Admin Content -->
        <div id="admin-content" class="admin-content">
            <div class="header">
                <h1>Admin Panel</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button id="export-html-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; width: auto;">
                        üìÑ Export Page as HTML
                    </button>
                    <a href="/" class="back-link">‚Üê Back to Order Form</a>
                </div>
            </div>

            <!-- PepHaul Entry Tab Management -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìã PepHaul Entry Tab Management
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Create new PepHaul Entry tabs (e.g., PepHaul Entry-01, PepHaul Entry-02) and switch between them. All order records are preserved when switching tabs.
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Current Tab</label>
                        <select id="pephaul-tab-selector" class="form-input" style="width: 100%;">
                            <option value="PepHaul Entry-01">PepHaul Entry-01</option>
                        </select>
                    </div>
                    <button id="create-new-tab-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; margin-top: 1.5rem;">
                        ‚ûï Create New Tab
                    </button>
                    <button id="switch-tab-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #c084fc; color: white; margin-top: 1.5rem;">
                        üîÑ Switch to Selected Tab
                    </button>
                </div>
                <div id="tab-status" style="margin-top: 1rem; font-size: 0.85rem; color: #7c3aed; display: none;">
                    ‚úì Tab operation completed successfully!
                </div>
            </div>

            <!-- Supplier Filter Toggle -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #8b5cf6;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üè¢ Supplier Filter
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Filter the pricelist display by supplier. Choose to show Supplier 1, Supplier 2, or both.
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div id="supplier-filter-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button id="supplier-filter-all" class="btn supplier-filter-btn active" data-filter="all" style="padding: 0.75rem 1.5rem; background: #8b5cf6; color: white;">
                                All Suppliers
                            </button>
                            {% for supplier in suppliers %}
                            <button class="btn supplier-filter-btn" data-filter="{{ supplier }}" data-supplier-name="{{ supplier }}" style="padding: 0.75rem 1.5rem; background: #c084fc; color: white;">
                                {{ supplier }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div id="supplier-filter-status" style="margin-top: 1rem; font-size: 0.85rem; color: #7c3aed; display: none;">
                    ‚úì Supplier filter updated!
                </div>
            </div>

            <!-- Order Form Lock Control -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #f472b6;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span id="form-lock-icon">üîì</span> Order Form Status
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Lock the entire order form to prevent new orders when finalizing.
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="form-lock-status" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem;">
                            Loading...
                        </span>
                        <button id="toggle-form-lock" class="btn" style="padding: 0.75rem 1.5rem; background: var(--accent-rose);">
                            Toggle Lock
                        </button>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: none;" id="lock-message-container">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Lock Message (shown to customers)</label>
                    <div class="rich-editor-toolbar" aria-label="Lock message formatting toolbar">
                        <select id="lock-rt-format" title="Header style">
                            <option value="P">Normal</option>
                            <option value="H3">Header (H3)</option>
                            <option value="H2">Header (H2)</option>
                            <option value="H1">Header (H1)</option>
                        </select>
                        <button class="rt-btn" type="button" title="Bold" onclick="rtCmd('bold')">B</button>
                        <button class="rt-btn" type="button" title="Italic" onclick="rtCmd('italic')"><span style="font-style: italic;">I</span></button>
                        <button class="rt-btn" type="button" title="Underline" onclick="rtCmd('underline')"><span style="text-decoration: underline;">U</span></button>
                        <button class="rt-btn" type="button" title="Align left" onclick="rtCmd('justifyLeft')">‚ü∏</button>
                        <button class="rt-btn" type="button" title="Align center" onclick="rtCmd('justifyCenter')">‚â°</button>
                        <button class="rt-btn" type="button" title="Align right" onclick="rtCmd('justifyRight')">‚üπ</button>
                        <input id="lock-rt-color" type="color" value="#7f1d1d" title="Text color" />
                        <select id="lock-rt-font" title="Font">
                            <option value="Outfit">Outfit (default)</option>
                            <option value="Inter">Inter</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Arial">Arial</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="JetBrains Mono">JetBrains Mono</option>
                        </select>
                        <select id="lock-rt-size" title="Font size">
                            <option value="3">Normal</option>
                            <option value="4">Large</option>
                            <option value="5">X-Large</option>
                        </select>
                        <button class="rt-btn" type="button" title="Clear formatting" onclick="clearLockMessageFormatting()">Tx</button>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: flex-start; margin-top: 0.75rem;">
                        <div id="lock-message-editor" class="rich-editor" contenteditable="true" style="flex: 1; min-width: 0;" data-placeholder="Orders are currently closed. Thank you for your patience!"></div>
                        <!-- Hidden legacy textarea (kept for backwards compatibility in code paths) -->
                        <textarea id="lock-message" class="form-input" rows="3" style="display:none;" placeholder="Orders are currently closed. Thank you for your patience!"></textarea>
                        <button id="save-lock-message-btn" class="btn" style="padding: 0.75rem 1.25rem; background: var(--accent-violet); white-space: nowrap; margin-top: 0; flex-shrink: 0; width: auto; min-width: 140px;">
                            üíæ Save Message
                        </button>
                    </div>
                    <div class="muted-hint">Tip: highlight text, then pick a font/color/alignment. This message is shown publicly when the form is locked.</div>
                    <div id="lock-message-save-status" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--accent-violet); display: none;">
                        ‚úì Message saved successfully!
                    </div>
                </div>
            </div>

            <!-- Timeline Management -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #fbbf24;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìÖ Timeline Management
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Add timeline entries to track order updates and show customers.
                        </p>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(251, 191, 36, 0.05); border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.2);">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Add New Timeline Entry</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Date</label>
                            <input type="date" id="timeline-date" class="form-input" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Time (e.g., 10 PM, 11AM)</label>
                            <input type="text" id="timeline-time" class="form-input" placeholder="10 PM" style="width: 100%;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Details of Transaction</label>
                        <textarea id="timeline-details" class="form-input" rows="3" placeholder="Enter transaction details..." style="width: 100%; resize: vertical;"></textarea>
                    </div>
                    
                    <button id="add-timeline-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #fbbf24; width: auto; min-width: 150px;">
                        ‚ûï Add Timeline Entry
                    </button>
                    
                    <div id="timeline-add-status" style="margin-top: 0.75rem; font-size: 0.85rem; color: #f59e0b; display: none;">
                        ‚úì Timeline entry added successfully!
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Timeline Entries</h3>
                    <div id="timeline-entries-list" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            Loading timeline entries...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Selection -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #c084fc;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üé® Theme Selection
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Choose a holiday or seasonal theme for the order form.
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Select Theme</label>
                    <select id="theme-selector" class="form-input" style="width: 100%; max-width: 400px;">
                        <option value="default">Default Theme</option>
                        <option value="merry_christmas">üéÑ Merry Christmas</option>
                        <option value="happy_new_year">üéÜ Happy New Year</option>
                        <option value="chinese_new_year">üßß Happy Chinese New Year</option>
                        <option value="summer">‚òÄÔ∏è Summer Theme</option>
                        <option value="valentines">üíù Happy Valentines / Hearts Day</option>
                        <option value="halloween">üéÉ Halloween Theme</option>
                        <option value="holy_week">‚úùÔ∏è Holy Week Theme</option>
                    </select>
                    <button id="save-theme-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #c084fc; margin-top: 1rem;">
                        üíæ Save Theme
                    </button>
                    <div id="theme-save-status" style="margin-top: 0.75rem; font-size: 0.85rem; color: #7c3aed; display: none;">
                        ‚úì Theme saved successfully!
                    </div>
                </div>
            </div>

            <!-- Order Goal Settings -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #f9a8d4;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üéØ Order Goal Settings
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Set the order goal displayed on the progress bar. The goal is in USD.
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Goal Amount (USD)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="display: flex; align-items: center; padding: 0 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px 0 0 10px; color: var(--text-secondary);">$</span>
                            <input type="number" id="order-goal-amount" class="form-input" style="border-radius: 0 10px 10px 0; flex: 1;" value="1000" min="1" step="100" placeholder="1000">
                        </div>
                    </div>
                    <button id="save-goal-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #f9a8d4; margin-top: 1.5rem;">
                        üíæ Save Goal
                    </button>
                </div>
                <div id="goal-save-status" style="margin-top: 0.75rem; font-size: 0.85rem; color: #7c3aed; display: none;">
                    ‚úì Goal saved successfully!
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-products">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="locked-products">0</div>
                    <div class="stat-label">Locked Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-kits">0</div>
                    <div class="stat-label">Total Kits Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-vials">0</div>
                    <div class="stat-label">Total Vials Ordered</div>
                </div>
            </div>

            <!-- Customer Summary Section - One per Supplier -->
            {% for supplier in suppliers %}
            <div class="card supplier-section" data-supplier="{{ supplier }}" style="margin-bottom: 2rem; border: 2px solid #c084fc;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">üë• Customer Summary - {{ supplier }}</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Overview of all customers showing unique orders, total vials, and grand totals (including PepHaul Admin fee) for {{ supplier }}.
                </p>

                <div class="table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Order Number/s</th>
                                <th>Payment Status</th>
                                <th>Unique Orders</th>
                                <th>Total Vials</th>
                                <th>Grand Total (PHP)</th>
                            </tr>
                        </thead>
                        <tbody class="customer-summary-tbody" data-supplier="{{ supplier }}">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <!-- Orders Management - One per Supplier -->
            {% for supplier in suppliers %}
            <div class="card supplier-section" data-supplier="{{ supplier }}" style="margin-bottom: 2rem;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">üì¶ Orders Management - {{ supplier }}</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    View all orders and confirm payments after verification for {{ supplier }}.
                </p>

                <div class="search-bar" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <input type="text" class="search-input order-search" data-supplier="{{ supplier }}" placeholder="Search orders by name, telegram, or order ID...">
                    <select class="form-input payment-filter" data-supplier="{{ supplier }}" style="width: auto; padding: 0.75rem 1rem;">
                        <option value="all">All Orders</option>
                        <option value="unpaid">Unpaid Only</option>
                        <option value="paid">Paid Only</option>
                    </select>
                </div>
                
                <!-- Bulk Actions -->
                <div class="bulk-actions" data-supplier="{{ supplier }}" style="display: none; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 12px; border: 2px solid #c084fc;">
                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: var(--text-primary);"><span class="selected-count" data-supplier="{{ supplier }}">0</span> orders selected</span>
                        <button class="btn-sm" style="background: #f472b6; color: white;" onclick="bulkLockOrders(true, '{{ supplier }}')">üîí Lock Selected</button>
                        <button class="btn-sm" style="background: #a78bfa; color: white;" onclick="bulkLockOrders(false, '{{ supplier }}')">üîì Unlock Selected</button>
                        <button class="btn-sm" style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);" onclick="clearSelection('{{ supplier }}')">Clear Selection</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="products-table orders-table" data-supplier="{{ supplier }}">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" class="select-all-orders" data-supplier="{{ supplier }}" onchange="toggleSelectAll(this, '{{ supplier }}')" style="cursor: pointer;"></th>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total (PHP)</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="orders-tbody" data-supplier="{{ supplier }}">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <!-- Incomplete Kits Section - One per Supplier -->
            {% for supplier in suppliers %}
            <div class="card supplier-section" data-supplier="{{ supplier }}" style="margin-bottom: 2rem; border: 2px solid #f472b6;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">‚ö†Ô∏è Incomplete Kits - {{ supplier }}</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Products with incomplete kits (not divisible by 10 vials) for {{ supplier }}. Sorted by vials needed (fewest first). Shows pending vials needed to complete the next kit.
                </p>

                <div class="table-container" style="background: rgba(221, 214, 254, 0.3); padding: 1rem; border-radius: 12px;">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Product Name</th>
                                <th style="text-align: center;">Code</th>
                                <th style="text-align: center;">Total Vials</th>
                                <th style="text-align: center;">Kits Generated</th>
                                <th style="text-align: center;">Extra Vials</th>
                                <th style="text-align: center;">Pending Vials to Complete Kit</th>
                                <th style="text-align: center;">Pep Hauler/s</th>
                            </tr>
                        </thead>
                        <tbody class="incomplete-kits-tbody" data-supplier="{{ supplier }}">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <!-- Completed Kits Section - One per Supplier -->
            {% for supplier in suppliers %}
            <div class="card supplier-section" data-supplier="{{ supplier }}" style="margin-bottom: 2rem; border: 2px solid #a78bfa;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">‚úÖ Completed Kits - {{ supplier }}</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Products with completed kits for {{ supplier }}, sorted by number of kits (most first). BAC Water products grouped at bottom. Easy to copy to table.
                </p>

                <div class="table-container" style="background: rgba(221, 214, 254, 0.2); padding: 1rem; border-radius: 12px;">
                    <table class="products-table completed-kits-table" data-supplier="{{ supplier }}">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Product Name</th>
                                <th style="text-align: center;">Code</th>
                                <th style="text-align: center;">Kits Generated</th>
                                <th style="text-align: center;">Total Vials</th>
                            </tr>
                        </thead>
                        <tbody class="completed-kits-tbody" data-supplier="{{ supplier }}">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <!-- Shared Products Section - One per Supplier -->
            {% for supplier in suppliers %}
            <div class="card supplier-section" data-supplier="{{ supplier }}" style="margin-bottom: 2rem; border: 2px solid #10b981;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">ü§ù Shared Products - {{ supplier }}</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Products with active orders for {{ supplier }} showing all Pep Haulers sharing each product, with breakdown of vial orders and kit orders per user.
                </p>

                <div class="table-container" style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 12px;">
                    <table class="products-table shared-products-table" data-supplier="{{ supplier }}">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Product Name</th>
                                <th style="text-align: center;">Vial Orders</th>
                                <th style="text-align: center;">Kit Orders</th>
                                <th style="text-align: center;">Total Completed Kits</th>
                            </tr>
                        </thead>
                        <tbody class="shared-products-tbody" data-supplier="{{ supplier }}">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <!-- Products Management - One per Supplier -->
            {% for supplier in suppliers %}
            <div class="card supplier-section" data-supplier="{{ supplier }}">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">Product Management - {{ supplier }}</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Lock products for {{ supplier }} when they reach maximum kits or manually lock/unlock products.
                </p>

                <div class="search-bar" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" class="search-input product-search" data-supplier="{{ supplier }}" placeholder="Search products..." style="flex: 1;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-sm" style="background: #f472b6; color: white;" onclick="lockAllProducts(true, '{{ supplier }}')">üîí Lock All Products</button>
                        <button class="btn-sm" style="background: #a78bfa; color: white;" onclick="lockAllProducts(false, '{{ supplier }}')">üîì Unlock All Products</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Code</th>
                                <th>Kits Generated</th>
                                <th>Total Vials</th>
                                <th>Max Kits</th>
                                <th>Lock Status</th>
                            </tr>
                        </thead>
                        <tbody class="products-tbody" data-supplier="{{ supplier }}">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toast-message">Success!</span>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body" id="order-modal-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer" id="order-modal-footer">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Tracking Number Modal -->
    <div class="modal" id="tracking-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">üì¶ Add Tracking Number</h3>
                <button class="modal-close" onclick="closeTrackingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
                    Enter the tracking number for this order's shipment.
                </p>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Tracking Number</label>
                    <input type="text" class="form-input" id="tracking-number-input" placeholder="Enter tracking number (e.g., ABC123456789)" maxlength="100">
                    <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 0.25rem;">This will be displayed in the shipping details section</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTrackingModal()">Cancel</button>
                <button class="btn btn-primary" id="save-tracking-btn" onclick="saveTrackingNumber()">üíæ Save Tracking Number</button>
            </div>
        </div>
    </div>

    <!-- Timeline Edit Modal -->
    <div class="modal" id="timeline-edit-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Edit Timeline Entry</h3>
                <button class="modal-close" onclick="closeTimelineEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label class="form-label" style="text-transform: none;">Date</label>
                        <input type="date" id="timeline-edit-date" class="form-input" style="width: 100%;">
                    </div>
                    <div>
                        <label class="form-label" style="text-transform: none;">Time</label>
                        <input type="text" id="timeline-edit-time" class="form-input" placeholder="10 PM" style="width: 100%;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="text-transform: none;">Details of Transaction</label>
                    <textarea id="timeline-edit-details" class="form-input" rows="4" style="resize: vertical;"></textarea>
                </div>
                <div id="timeline-edit-status" class="muted-hint" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTimelineEditModal()">Cancel</button>
                <button class="btn btn-primary" id="timeline-edit-save-btn" onclick="saveTimelineEdit()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Pep Haulers Modal -->
    <div class="modal" id="pep-haulers-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="pep-haulers-modal-title">üë• Pep Hauler/s</h3>
                <button class="modal-close" onclick="closePepHaulersModal()">&times;</button>
            </div>
            <div class="modal-body" id="pep-haulers-modal-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePepHaulersModal()">Close</button>
            </div>
        </div>
    </div>


    <script>
        let isLoggedIn = false;

        // Login function - will be attached via addEventListener
        async function handleLogin() {
            const password = document.getElementById('admin-password').value;
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isLoggedIn = true;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-content').classList.add('show');
                    loadProducts();
                    loadOrders();
                    loadCustomerSummary();
                    loadOrderFormStatus();
                    loadOrderGoal();
                    loadTheme();
                    loadTimelineEntries();
                } else {
                    document.getElementById('login-error').textContent = 'Invalid password';
                    document.getElementById('login-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('login-error').textContent = 'Login error';
                document.getElementById('login-error').style.display = 'block';
            }
        }
        
        // Attach login handler when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('admin-login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
        });

        // Boot: if session is already authenticated, show admin content and load data.
        async function bootAdmin() {
            try {
                const resp = await fetch('/api/admin/whoami', { credentials: 'same-origin' });
                const data = await resp.json();
                if (data && data.is_admin) {
                    isLoggedIn = true;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-content').classList.add('show');
                    loadProducts();
                    loadOrders();
                    loadCustomerSummary();
                    loadOrderFormStatus();
                    loadOrderGoal();
                    loadTheme();
                    loadTimelineEntries();
                }
            } catch (e) {
                // If this fails, user can still log in manually.
            }
        }

        // Enter key for login
        document.getElementById('admin-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Order Form Lock State
        let orderFormLocked = false;

        // Rich text helpers for lock message editor
        function _getLockEditor() {
            return document.getElementById('lock-message-editor');
        }

        function _htmlToText(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html || '';
            return (tmp.textContent || '').replace(/\s+/g, ' ').trim();
        }

        function setLockMessageEditorContent(message) {
            const editor = _getLockEditor();
            if (!editor) return;
            const msg = (message || '').toString();
            // If it looks like HTML, render it; otherwise treat as plain text
            if (msg.includes('<') && msg.includes('>')) {
                editor.innerHTML = msg;
            } else {
                editor.textContent = msg;
            }
            // Keep legacy textarea in sync (for any old code paths)
            const legacy = document.getElementById('lock-message');
            if (legacy) legacy.value = msg;
        }

        function getLockMessageHtml() {
            const editor = _getLockEditor();
            return editor ? (editor.innerHTML || '').trim() : '';
        }

        function rtCmd(cmd, value = null) {
            const editor = _getLockEditor();
            if (!editor) return;
            editor.focus();
            try {
                document.execCommand(cmd, false, value);
            } catch (e) {
                // ignore
            }
        }

        function clearLockMessageFormatting() {
            rtCmd('removeFormat');
            rtCmd('formatBlock', 'P');
        }

        // Toolbar change handlers
        document.addEventListener('DOMContentLoaded', () => {
            const fmt = document.getElementById('lock-rt-format');
            const color = document.getElementById('lock-rt-color');
            const font = document.getElementById('lock-rt-font');
            const size = document.getElementById('lock-rt-size');

            if (fmt) fmt.addEventListener('change', (e) => rtCmd('formatBlock', e.target.value));
            if (color) color.addEventListener('input', (e) => rtCmd('foreColor', e.target.value));
            if (font) font.addEventListener('change', (e) => rtCmd('fontName', e.target.value));
            if (size) size.addEventListener('change', (e) => rtCmd('fontSize', e.target.value));
        });

        async function loadOrderFormStatus() {
            try {
                const response = await fetch('/api/admin/order-form-status', { credentials: 'same-origin' });
                const data = await response.json();
                orderFormLocked = data.is_locked;
                updateFormLockUI(data.is_locked, data.message);
            } catch (error) {
                console.error('Error loading order form status:', error);
            }
        }

        // Order Goal Functions
        async function loadOrderGoal() {
            try {
                const response = await fetch('/api/admin/order-goal', { credentials: 'same-origin' });
                const data = await response.json();
                document.getElementById('order-goal-amount').value = data.goal || 1000;
            } catch (error) {
                console.error('Error loading order goal:', error);
            }
        }

        // Theme Functions
        async function loadTheme() {
            try {
                const response = await fetch('/api/admin/theme', { credentials: 'same-origin' });
                const data = await response.json();
                const themeSelector = document.getElementById('theme-selector');
                if (themeSelector && data.theme) {
                    themeSelector.value = data.theme;
                }
            } catch (error) {
                console.error('Error loading theme:', error);
            }
        }

        document.getElementById('save-theme-btn').addEventListener('click', async () => {
            const themeSelector = document.getElementById('theme-selector');
            const selectedTheme = themeSelector.value;
            
            if (!selectedTheme) {
                alert('Please select a theme');
                return;
            }
            
            const btn = document.getElementById('save-theme-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/admin/theme', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: selectedTheme })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const statusEl = document.getElementById('theme-save-status');
                    statusEl.style.display = 'block';
                    const themeNames = {
                        'default': 'Default Theme',
                        'merry_christmas': 'Merry Christmas',
                        'happy_new_year': 'Happy New Year',
                        'chinese_new_year': 'Chinese New Year',
                        'summer': 'Summer Theme',
                        'valentines': 'Valentines Theme',
                        'halloween': 'Halloween Theme',
                        'holy_week': 'Holy Week Theme'
                    };
                    statusEl.textContent = `‚úì Theme saved successfully! (${themeNames[selectedTheme] || selectedTheme})`;
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    alert('Failed to save theme: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving theme:', error);
                alert('Error saving theme');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Theme';
            }
        });

        // Supplier Filter Functions
        let currentSupplierFilter = localStorage.getItem('supplierFilter') || 'all';
        
        function updateSupplierFilterUI(filter) {
            document.querySelectorAll('.supplier-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-filter') === filter) {
                    btn.classList.add('active');
                    btn.style.background = '#8b5cf6';
                } else {
                    btn.style.background = '#c084fc';
                }
            });
        }
        
        function applySupplierFilterToAdmin() {
            // Show/hide supplier sections based on current filter
            document.querySelectorAll('.supplier-section').forEach(section => {
                const sectionSupplier = section.getAttribute('data-supplier');
                let shouldShow = false;
                
                if (currentSupplierFilter === 'all') {
                    shouldShow = true;
                } else {
                    // Filter matches supplier name exactly
                    shouldShow = sectionSupplier === currentSupplierFilter;
                }
                
                section.style.display = shouldShow ? 'block' : 'none';
            });
        }
        
        function applySupplierFilter(filter) {
            currentSupplierFilter = filter;
            localStorage.setItem('supplierFilter', filter);
            updateSupplierFilterUI(filter);
            
            // Apply filter to admin panel sections
            applySupplierFilterToAdmin();
            
            // Get supplier name for display
            const btn = document.querySelector(`[data-filter="${filter}"]`);
            const supplierName = btn ? (btn.getAttribute('data-supplier-name') || filter) : filter;
            const filterText = filter === 'all' ? 'All Suppliers' : supplierName;
            
            const statusEl = document.getElementById('supplier-filter-status');
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.textContent = `‚úì Filter set to: ${filterText}`;
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
            
            // Apply filter to main page if it's open
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage({ type: 'supplierFilter', filter: filter }, '*');
                } catch (e) {
                    console.log('Could not communicate with main window');
                }
            }
        }
        
        // Apply filter on page load
        document.addEventListener('DOMContentLoaded', () => {
            applySupplierFilterToAdmin();
        });
        
        // Initialize supplier filter UI
        document.addEventListener('DOMContentLoaded', () => {
            updateSupplierFilterUI(currentSupplierFilter);
            
            // Add event listeners for supplier filter buttons
            document.querySelectorAll('.supplier-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.getAttribute('data-filter');
                    applySupplierFilter(filter);
                });
            });
        });
        
        document.getElementById('save-goal-btn').addEventListener('click', async () => {
            const goalAmount = parseFloat(document.getElementById('order-goal-amount').value);
            
            if (!goalAmount || goalAmount <= 0) {
                alert('Please enter a valid goal amount');
                return;
            }
            
            const btn = document.getElementById('save-goal-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/admin/order-goal', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal: goalAmount })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const statusEl = document.getElementById('goal-save-status');
                    statusEl.style.display = 'block';
                    statusEl.textContent = '‚úì Goal saved successfully! ($' + goalAmount.toLocaleString() + ')';
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    alert('Failed to save goal: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving goal:', error);
                alert('Error saving goal');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Goal';
            }
        });

        function updateFormLockUI(isLocked, message) {
            const statusEl = document.getElementById('form-lock-status');
            const iconEl = document.getElementById('form-lock-icon');
            const messageContainer = document.getElementById('lock-message-container');
            const toggleBtn = document.getElementById('toggle-form-lock');

            if (isLocked) {
                statusEl.textContent = 'LOCKED';
                statusEl.style.background = 'rgba(244, 114, 182, 0.2)';
                statusEl.style.color = '#db2777';
                iconEl.textContent = 'üîí';
                toggleBtn.textContent = 'Unlock Form';
                toggleBtn.style.background = '#a78bfa';
                messageContainer.style.display = 'block';
            } else {
                statusEl.textContent = 'OPEN';
                statusEl.style.background = 'rgba(167, 139, 250, 0.2)';
                statusEl.style.color = '#7c3aed';
                iconEl.textContent = 'üîì';
                toggleBtn.textContent = 'Lock Form';
                toggleBtn.style.background = '#f472b6';
                messageContainer.style.display = 'none';
            }

            if (message) {
                setLockMessageEditorContent(message);
            }
        }

        document.getElementById('toggle-form-lock').addEventListener('click', async () => {
            const newLockState = !orderFormLocked;
            const message = getLockMessageHtml() || 'Orders are currently closed. Thank you for your patience!';
            
            try {
                const response = await fetch('/api/admin/lock-order-form', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_locked: newLockState, message: message })
                });
                
                const data = await response.json();
                if (data.success) {
                    orderFormLocked = newLockState;
                    updateFormLockUI(newLockState, message);
                    showToast(newLockState ? 'Order form is now LOCKED!' : 'Order form is now OPEN!');
                } else {
                    showToast('Failed to update lock status');
                }
            } catch (error) {
                console.error('Error toggling form lock:', error);
                showToast('Error updating lock status');
            }
        });

        // Save Lock Message button
        document.getElementById('save-lock-message-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-lock-message-btn');
            const statusEl = document.getElementById('lock-message-save-status');
            const message = getLockMessageHtml();
            
            if (!_htmlToText(message)) {
                showToast('Please enter a lock message');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Saving...';
            statusEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/lock-order-form', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_locked: orderFormLocked, message: message })
                });
                
                const data = await response.json();
                if (data.success) {
                    statusEl.style.display = 'block';
                    statusEl.style.color = '#7c3aed';
                    statusEl.textContent = '‚úì Message saved successfully!';
                    showToast('Lock message saved successfully!');
                    
                    // Hide status message after 3 seconds
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    statusEl.style.display = 'block';
                    statusEl.style.color = '#dc2626';
                    statusEl.textContent = '‚úó Failed to save message';
                    showToast('Failed to save lock message');
                }
            } catch (error) {
                console.error('Error saving lock message:', error);
                statusEl.style.display = 'block';
                statusEl.style.color = '#dc2626';
                statusEl.textContent = '‚úó Error saving message';
                showToast('Error saving lock message');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Message';
            }
        });

        // Timeline Management - tab-specific
        async function loadTimelineEntries() {
            try {
                // Get current tab
                const tabsResponse = await fetch('/api/admin/pephaul-tabs', { credentials: 'same-origin' });
                const tabsData = await tabsResponse.json();
                const currentTab = tabsData.current_tab || 'PepHaul Entry-01';
                
                const response = await fetch(`/api/admin/timeline?tab_name=${encodeURIComponent(currentTab)}`, { credentials: 'same-origin' });
                const data = await response.json();
                const entriesList = document.getElementById('timeline-entries-list');
                
                if (!data.entries || data.entries.length === 0) {
                    entriesList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No timeline entries yet for ${currentTab}. Add one above!</div>`;
                    return;
                }
                
                // Sort by date (newest first)
                const sortedEntries = data.entries.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || ''));
                    const dateB = new Date(b.date + ' ' + (b.time || ''));
                    return dateB - dateA;
                });

                // Cache by id for editing
                window._timelineEntriesById = {};
                sortedEntries.forEach(e => {
                    if (e && e.id) window._timelineEntriesById[String(e.id)] = e;
                });
                
                let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                sortedEntries.forEach((entry, index) => {
                    html += `
                        <div style="padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; border-left: 4px solid #fbbf24;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                                        ${entry.date} ${entry.time ? '‚Ä¢ ' + entry.time : ''}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem; white-space: pre-wrap;">${escapeHtml(entry.details)}</div>
                                </div>
                                <div style="display:flex; gap: 0.5rem; align-items:center;">
                                    <button onclick="openTimelineEditModal('${escapeJS(entry.id)}')" style="padding: 0.25rem 0.5rem; background: #fbbf24; color: #111827; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 700;">‚úèÔ∏è Edit</button>
                                    <button onclick="deleteTimelineEntry('${escapeJS(entry.id)}')" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                entriesList.innerHTML = html;
            } catch (error) {
                console.error('Error loading timeline entries:', error);
                document.getElementById('timeline-entries-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading timeline entries</div>';
            }
        }

        // Timeline editing
        let _editingTimelineId = null;

        function openTimelineEditModal(entryId) {
            const id = String(entryId || '');
            const entry = (window._timelineEntriesById || {})[id];
            if (!entry) {
                showToast('Timeline entry not found');
                return;
            }
            _editingTimelineId = id;
            document.getElementById('timeline-edit-date').value = entry.date || '';
            document.getElementById('timeline-edit-time').value = entry.time || '';
            document.getElementById('timeline-edit-details').value = entry.details || '';
            const statusEl = document.getElementById('timeline-edit-status');
            if (statusEl) statusEl.style.display = 'none';
            document.getElementById('timeline-edit-modal').classList.add('show');
        }

        function closeTimelineEditModal() {
            _editingTimelineId = null;
            document.getElementById('timeline-edit-modal').classList.remove('show');
        }

        async function saveTimelineEdit() {
            if (!_editingTimelineId) return;
            const btn = document.getElementById('timeline-edit-save-btn');
            const statusEl = document.getElementById('timeline-edit-status');
            const date = (document.getElementById('timeline-edit-date').value || '').trim();
            const time = (document.getElementById('timeline-edit-time').value || '').trim();
            const details = (document.getElementById('timeline-edit-details').value || '').trim();

            if (!date || !details) {
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.style.color = '#dc2626';
                    statusEl.textContent = 'Date and details are required.';
                }
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Saving...';
            try {
                // Get current tab
                const tabsResponse = await fetch('/api/admin/pephaul-tabs', { credentials: 'same-origin' });
                const tabsData = await tabsResponse.json();
                const currentTab = tabsData.current_tab || 'PepHaul Entry-01';
                
                const resp = await fetch(`/api/admin/timeline/${encodeURIComponent(_editingTimelineId)}`, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, time, details, tab_name: currentTab })
                });
                const data = await resp.json();
                if (data && data.success) {
                    showToast('Timeline entry updated');
                    closeTimelineEditModal();
                    loadTimelineEntries();
                } else {
                    throw new Error(data.error || 'Failed to update timeline entry');
                }
            } catch (e) {
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.style.color = '#dc2626';
                    statusEl.textContent = e.message || 'Error updating timeline entry';
                }
                showToast('Error updating timeline entry');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Changes';
            }
        }

        window.openTimelineEditModal = openTimelineEditModal;
        window.closeTimelineEditModal = closeTimelineEditModal;
        window.saveTimelineEdit = saveTimelineEdit;
        
        async function deleteTimelineEntry(entryId) {
            if (!confirm('Are you sure you want to delete this timeline entry?')) {
                return;
            }
            
            try {
                // Get current tab
                const tabsResponse = await fetch('/api/admin/pephaul-tabs', { credentials: 'same-origin' });
                const tabsData = await tabsResponse.json();
                const currentTab = tabsData.current_tab || 'PepHaul Entry-01';
                
                const response = await fetch(`/api/admin/timeline/${entryId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tab_name: currentTab })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('Timeline entry deleted');
                    loadTimelineEntries();
                } else {
                    showToast('Failed to delete timeline entry');
                }
            } catch (error) {
                console.error('Error deleting timeline entry:', error);
                showToast('Error deleting timeline entry');
            }
        }
        
        window.deleteTimelineEntry = deleteTimelineEntry;
        
        function escapeJS(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/\\/g, '\\\\')  // Escape backslashes first
                .replace(/`/g, '\\`')    // Escape backticks
                .replace(/\${/g, '\\${') // Escape ${ in template literals
                .replace(/"/g, '\\"')     // Escape double quotes
                .replace(/'/g, "\\'")     // Escape single quotes
                .replace(/\u0000/g, '\\0'); // Escape null characters
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        document.getElementById('add-timeline-btn').addEventListener('click', async () => {
            const btn = document.getElementById('add-timeline-btn');
            const statusEl = document.getElementById('timeline-add-status');
            const date = document.getElementById('timeline-date').value.trim();
            const time = document.getElementById('timeline-time').value.trim();
            const details = document.getElementById('timeline-details').value.trim();
            
            if (!date) {
                showToast('Please select a date');
                return;
            }
            if (!details) {
                showToast('Please enter transaction details');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Adding...';
            statusEl.style.display = 'none';
            
            try {
                // Get current tab
                const tabsResponse = await fetch('/api/admin/pephaul-tabs', { credentials: 'same-origin' });
                const tabsData = await tabsResponse.json();
                const currentTab = tabsData.current_tab || 'PepHaul Entry-01';
                
                const response = await fetch('/api/admin/timeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        date: date,
                        time: time,
                        details: details,
                        tab_name: currentTab
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    statusEl.style.display = 'block';
                    statusEl.style.color = '#f59e0b';
                    statusEl.textContent = '‚úì Timeline entry added successfully!';
                    showToast('Timeline entry added successfully!');
                    
                    // Clear form
                    document.getElementById('timeline-date').value = '';
                    document.getElementById('timeline-time').value = '';
                    document.getElementById('timeline-details').value = '';
                    
                    // Reload timeline entries
                    loadTimelineEntries();
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    statusEl.style.display = 'block';
                    statusEl.style.color = '#dc2626';
                    statusEl.textContent = '‚úó Failed to add timeline entry';
                    showToast(data.error || 'Failed to add timeline entry');
                }
            } catch (error) {
                console.error('Error adding timeline entry:', error);
                statusEl.style.display = 'block';
                statusEl.style.color = '#dc2626';
                statusEl.textContent = '‚úó Error adding timeline entry';
                showToast('Error adding timeline entry');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ûï Add Timeline Entry';
            }
        });
        
        // Get suppliers from template
        const ADMIN_SUPPLIERS = {{ suppliers|tojson|safe }};
        
        // Load Products - Per Supplier
        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/products', { credentials: 'same-origin' });
                const products = await response.json();

                // Cache for modals / secondary views
                window._productsCache = Array.isArray(products) ? products : [];
                
                // Update stats (aggregate across all suppliers)
                let totalKits = 0;
                let totalVials = 0;
                let lockedCount = 0;
                
                products.forEach(p => {
                    totalKits += p.kits_generated || 0;
                    totalVials += p.total_vials || 0;
                    if (p.is_locked) lockedCount++;
                });
                
                document.getElementById('total-products').textContent = products.length;
                document.getElementById('locked-products').textContent = lockedCount;
                document.getElementById('total-kits').textContent = totalKits;
                document.getElementById('total-vials').textContent = totalVials;
                
                // Load incomplete kits per supplier
                ADMIN_SUPPLIERS.forEach(supplier => {
                    const supplierProducts = products.filter(p => (p.supplier || 'Default') === supplier);
                    loadIncompleteKits(supplierProducts, supplier);
                });
                
                // Load completed kits per supplier
                ADMIN_SUPPLIERS.forEach(supplier => {
                    const supplierProducts = products.filter(p => (p.supplier || 'Default') === supplier);
                    loadCompletedKits(supplierProducts, supplier);
                });
                
                // Load shared products per supplier
                ADMIN_SUPPLIERS.forEach(supplier => {
                    const supplierProducts = products.filter(p => (p.supplier || 'Default') === supplier);
                    loadSharedProducts(supplierProducts, supplier);
                });
                
                // Render table per supplier
                ADMIN_SUPPLIERS.forEach(supplier => {
                    const supplierProducts = products.filter(p => (p.supplier || 'Default') === supplier);
                    const tbody = document.querySelector(`.products-tbody[data-supplier="${supplier}"]`);
                    if (!tbody) return;
                    
                    tbody.innerHTML = supplierProducts.map(product => {
                        const kitsPercent = product.max_kits > 0 ? (product.kits_generated / product.max_kits) * 100 : 0;
                        let badgeClass = 'normal';
                        if (kitsPercent >= 90) badgeClass = 'danger';
                        else if (kitsPercent >= 70) badgeClass = 'warning';
                        
                        // Check if incomplete kit
                        const vialsPerKit = product.vials_per_kit || 10;
                        const remainingVials = (product.total_vials || 0) % vialsPerKit;
                        const isIncomplete = remainingVials > 0 && product.total_vials > 0;
                        
                        // Escape product code and name for safe use in template literal
                        const prodCode = escapeJS(String(product.code || ''));
                        const prodName = escapeHtml(String(product.name || ''));
                        const prodCodeHtml = escapeHtml(String(product.code || ''));
                        return `
                            <tr data-code="${prodCode}" class="${isIncomplete ? 'incomplete-kit' : ''}">
                                <td>${prodName}</td>
                                <td><span class="product-code">${prodCodeHtml}</span></td>
                                <td><span class="kits-badge ${badgeClass}">${product.kits_generated} / ${product.max_kits}</span></td>
                                <td>${product.total_vials}</td>
                                <td>
                                    <input type="number" class="max-kits-input" 
                                           value="${product.max_kits}" 
                                           onchange="updateMaxKits('${prodCode}', this.value)"
                                           min="1">
                                </td>
                                <td>
                                    <label class="toggle-switch">
                                        <input type="checkbox" 
                                               ${product.is_locked ? 'checked' : ''} 
                                               onchange="toggleLock('${prodCode}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </td>
                            </tr>
                        `;
                    }).join('');  // Close arrow function body, map(), and join
                });
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Load Customer Summary - Per Supplier
        async function loadCustomerSummary() {
            try {
                const response = await fetch('/api/admin/customer-summary', { credentials: 'same-origin' });
                const customers = await response.json();
                
                // Also get products and orders to match suppliers
                const productsResponse = await fetch('/api/admin/products', { credentials: 'same-origin' });
                const products = await productsResponse.json();
                const ordersResponse = await fetch('/api/admin/orders', { credentials: 'same-origin' });
                const orders = await ordersResponse.json();
                
                // Create a map of order IDs to suppliers based on order items
                const orderSupplierMap = {};
                orders.forEach(order => {
                    order.items?.forEach(item => {
                        const product = products.find(p => p.code === item.product_code);
                        if (product) {
                            const supplier = product.supplier || 'Default';
                            if (!orderSupplierMap[order.order_id]) {
                                orderSupplierMap[order.order_id] = new Set();
                            }
                            orderSupplierMap[order.order_id].add(supplier);
                        }
                    });
                });
                
                // Group customers by supplier based on their orders
                ADMIN_SUPPLIERS.forEach(supplier => {
                    const tbody = document.querySelector(`.customer-summary-tbody[data-supplier="${supplier}"]`);
                    if (!tbody) return;
                    
                    // Filter customers who have orders for this supplier
                    const supplierCustomers = customers.filter(customer => {
                        // Check if customer has any orders with products from this supplier
                        const customerOrderIds = customer.order_numbers?.split(', ').map(id => id.trim()) || [];
                        return customerOrderIds.some(orderId => {
                            const suppliers = orderSupplierMap[orderId];
                            return suppliers && suppliers.has(supplier);
                        });
                    });
                    
                    if (supplierCustomers.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">No customers found for ${supplier}</td></tr>`;
                        return;
                    }
                    
                    tbody.innerHTML = supplierCustomers.map(customer => {
                        // Determine payment status badge color
                        let paymentStatusClass = 'unpaid';
                        let paymentStatusIcon = '‚è≥';
                        if (customer.payment_status === 'Paid') {
                            paymentStatusClass = 'paid';
                            paymentStatusIcon = '‚úÖ';
                        } else if (customer.payment_status === 'Partially Paid') {
                            paymentStatusClass = 'partial';
                            paymentStatusIcon = 'üîÑ';
                        } else if (customer.payment_status === 'Waiting for Confirmation') {
                            paymentStatusClass = 'waiting';
                            paymentStatusIcon = '‚è≥';
                        }
                        
                        return `
                            <tr>
                                <td style="font-weight: 500;">${customer.customer_name}</td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: #c084fc; font-weight: 600; cursor: pointer; user-select: all; position: relative;" onclick="navigator.clipboard.writeText('${customer.order_numbers}').then(() => { const el = event.target; const original = el.textContent; el.textContent = 'Copied!'; el.style.color = '#10b981'; setTimeout(() => { el.textContent = original; el.style.color = '#c084fc'; }, 1000); })" title="Click to copy order numbers">${customer.order_numbers}</td>
                                <td><span class="payment-badge ${paymentStatusClass}" style="font-size: 0.85rem;">${paymentStatusIcon} ${customer.payment_status}</span></td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: #c084fc; font-weight: 600;">${customer.order_count}</td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-weight: 600;">${customer.total_vials}</td>
                                <td style="font-family: 'JetBrains Mono', monospace; color: #7c3aed; font-weight: 700; font-size: 1.1rem;">‚Ç±${customer.total_grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                            </tr>
                        `;
                    }).join('');  // Close arrow function body, map(), and join
                });  // Close forEach for ADMIN_SUPPLIERS
                
            } catch (error) {
                console.error('Error loading customer summary:', error);
                document.getElementById('customer-summary-tbody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--accent-rose);">Error loading customer summary</td></tr>';
            }
        }

        // Shared color assignment function for Pep Haulers (consistent across all sections)
        function getColorForUsername(username) {
            // Extended color palette with distinct colors
            const colorPalette = [
                { bg: 'rgba(124, 58, 237, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(124, 58, 237, 0.5)' }, // Dark purple
                { bg: 'rgba(139, 92, 246, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(139, 92, 246, 0.5)' }, // Deep purple
                { bg: 'rgba(168, 85, 247, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(168, 85, 247, 0.5)' }, // Rich purple
                { bg: 'rgba(219, 39, 119, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(219, 39, 119, 0.5)' }, // Dark rose
                { bg: 'rgba(236, 72, 153, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(236, 72, 153, 0.5)' }, // Deep pink
                { bg: 'rgba(190, 24, 93, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(190, 24, 93, 0.5)' }, // Dark pink
                { bg: 'rgba(147, 51, 234, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(147, 51, 234, 0.5)' }, // Violet
                { bg: 'rgba(107, 33, 168, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(107, 33, 168, 0.5)' }, // Dark violet
                { bg: 'rgba(79, 70, 229, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(79, 70, 229, 0.5)' }, // Indigo
                { bg: 'rgba(99, 102, 241, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(99, 102, 241, 0.5)' }, // Blue-purple
                { bg: 'rgba(59, 130, 246, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(59, 130, 246, 0.5)' }, // Blue
                { bg: 'rgba(37, 99, 235, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(37, 99, 235, 0.5)' }, // Dark blue
                { bg: 'rgba(16, 185, 129, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(16, 185, 129, 0.5)' }, // Emerald
                { bg: 'rgba(5, 150, 105, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(5, 150, 105, 0.5)' }, // Dark emerald
                { bg: 'rgba(245, 158, 11, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(245, 158, 11, 0.5)' }, // Amber
                { bg: 'rgba(217, 119, 6, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(217, 119, 6, 0.5)' }, // Dark amber
                { bg: 'rgba(239, 68, 68, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(239, 68, 68, 0.5)' }, // Red
                { bg: 'rgba(220, 38, 38, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(220, 38, 38, 0.5)' }, // Dark red
                { bg: 'rgba(251, 146, 60, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(251, 146, 60, 0.5)' }, // Orange
                { bg: 'rgba(234, 88, 12, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(234, 88, 12, 0.5)' }, // Dark orange
            ];
            
            // Hash username to get consistent color assignment
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % colorPalette.length;
            return colorPalette[index];
        }

        // Load Incomplete Kits - Per Supplier
        function loadIncompleteKits(products, supplier) {
            const incompleteKits = products.filter(product => {
                const totalVials = product.total_vials || 0;
                if (totalVials === 0) return false; // Skip products with no orders
                const vialsPerKit = product.vials_per_kit || 10; // Use product's vials_per_kit, default to 10
                const remainingVials = totalVials % vialsPerKit;
                return remainingVials > 0; // Incomplete if remainder > 0
            });

            const tbody = document.querySelector(`.incomplete-kits-tbody[data-supplier="${supplier}"]`);
            if (!tbody) return;
            
            if (incompleteKits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">üéâ All kits are complete! No incomplete kits found.</td></tr>';
                return;
            }

            // Calculate pending vials and sort by pending vials (ascending - least needed first)
            const incompleteKitsWithPending = incompleteKits.map(product => {
                const totalVials = product.total_vials || 0;
                const vialsPerKit = product.vials_per_kit || 10;
                const kitsGenerated = Math.floor(totalVials / vialsPerKit);
                const remainingVials = totalVials % vialsPerKit;
                const pendingVials = vialsPerKit - remainingVials;
                return {
                    ...product,
                    totalVials,
                    kitsGenerated,
                    remainingVials,
                    pendingVials
                };
            });

            // Sort by pending vials (ascending - least needed first)
            incompleteKitsWithPending.sort((a, b) => a.pendingVials - b.pendingVials);

            tbody.innerHTML = incompleteKitsWithPending.map(product => {
                const { totalVials, kitsGenerated, remainingVials, pendingVials } = product;
                const pepHaulers = product.pep_haulers || [];
                
                // Color coding based on vials needed
                let rowBgColor = '';
                let badgeBgColor = '';
                let badgeTextColor = '';
                
                if (pendingVials <= 2) {
                    // Almost complete (1-2 vials) - light green/lilac
                    rowBgColor = 'background: rgba(167, 139, 250, 0.15);';
                    badgeBgColor = 'rgba(167, 139, 250, 0.3)';
                    badgeTextColor = '#7c3aed';
                } else if (pendingVials <= 5) {
                    // Moderate (3-5 vials) - light pink/lilac
                    rowBgColor = 'background: rgba(249, 168, 212, 0.15);';
                    badgeBgColor = 'rgba(249, 168, 212, 0.3)';
                    badgeTextColor = '#ec4899';
                } else if (pendingVials <= 8) {
                    // More needed (6-8 vials) - medium pink
                    rowBgColor = 'background: rgba(244, 114, 182, 0.2);';
                    badgeBgColor = 'rgba(244, 114, 182, 0.35)';
                    badgeTextColor = '#db2777';
                } else {
                    // Far from complete (9 vials) - darker pink
                    rowBgColor = 'background: rgba(244, 114, 182, 0.25);';
                    badgeBgColor = 'rgba(244, 114, 182, 0.4)';
                    badgeTextColor = '#be185d';
                }
                
                // Format pep haulers as badges with unique colors (using shared function)
                const pepHaulersHtml = pepHaulers.length > 0 
                    ? pepHaulers.map(username => {
                        const color = getColorForUsername(username);
                        return `<span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ${color.bg}; color: ${color.text}; margin: 0.125rem; text-shadow: ${color.shadow}; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">@${username}</span>`;
                    }).join('')
                    : '<span style="color: var(--text-muted); font-size: 0.85rem;">‚Äî</span>';
                
                return `
                    <tr class="incomplete-kit" style="${rowBgColor}">
                        <td style="font-weight: 500; text-align: center;">${product.name}</td>
                        <td style="text-align: center;"><span class="product-code">${product.code}</span></td>
                        <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600; text-align: center;">${totalVials}</td>
                        <td style="text-align: center;"><span class="kits-badge normal">${kitsGenerated}</span></td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: #ec4899; font-weight: 600; text-align: center;">${remainingVials}</td>
                        <td style="text-align: center;">
                            <span class="kits-badge incomplete" style="font-size: 0.9rem; background: ${badgeBgColor}; color: ${badgeTextColor}; font-weight: 600;">
                                ${pendingVials} vial${pendingVials !== 1 ? 's' : ''} needed
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: center;">
                                ${pepHaulersHtml}
                            </div>
                            ${pepHaulers.length > 0 ? `<button onclick="openPepHaulersModal('${escapeJS(product.code)}')" style="margin-top:0.5rem; padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.6); color: #6d28d9; border: 1px solid rgba(192, 132, 252, 0.35); border-radius: 999px; cursor:pointer; font-size:0.75rem; font-weight:800;">View breakdown</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load Completed Kits - Per Supplier
        function loadCompletedKits(products, supplier) {
            // Filter products with completed kits (kits_generated > 0)
            const completedKits = products.filter(product => {
                const kitsGenerated = product.kits_generated || 0;
                return kitsGenerated > 0;
            });

            // Escape supplier for safe use in template literal
            const supplierEscaped = escapeJS(supplier || '');
            const tbody = document.querySelector(`.completed-kits-tbody[data-supplier="${supplierEscaped}"]`);
            if (!tbody) return;
            
            if (completedKits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">No completed kits yet</td></tr>';
                return;
            }

            // Separate BAC Water products (BA03, BA05, BA10) from others
            const bacWaterCodes = ['BA03', 'BA05', 'BA10'];
            const regularProducts = [];
            const bacWaterProducts = [];

            completedKits.forEach(product => {
                const productCode = product && product.code ? String(product.code) : '';
                if (productCode && bacWaterCodes.includes(productCode)) {
                    bacWaterProducts.push(product);
                } else {
                    regularProducts.push(product);
                }
            });

            // Sort regular products by kits_generated descending (most kits first)
            regularProducts.sort((a, b) => (b.kits_generated || 0) - (a.kits_generated || 0));
            
            // Sort BAC Water products by kits_generated descending
            bacWaterProducts.sort((a, b) => (b.kits_generated || 0) - (a.kits_generated || 0));

            // Combine: regular products first, then BAC Water products at bottom
            const sortedProducts = [...regularProducts, ...bacWaterProducts];

            // Find max kits for gradient calculation
            // Safety: Ensure sortedProducts is an array and has items before using spread operator
            let maxKits = 1;
            if (Array.isArray(sortedProducts) && sortedProducts.length > 0) {
                const kitsValues = sortedProducts.map(p => p && p.kits_generated ? p.kits_generated : 0);
                maxKits = Math.max(...kitsValues, 1);
            }

            // Build HTML array using map, then join
            const htmlArray = sortedProducts.map((product, index) => {
                // Safety check - skip if product is invalid
                if (!product) return '';
                
                const kitsGenerated = product.kits_generated || 0;
                const totalVials = product.total_vials || 0;
                
                // Calculate gradient intensity (0 to 1) based on kits_generated
                // Light gradient for better readability
                const intensity = Math.min(kitsGenerated / maxKits, 1);
                
                // Create light gradient from light purple to slightly darker purple
                // Light background for easy copying
                const r = Math.floor(221 - (intensity * 20)); // Start at 221 (very light purple), go slightly darker
                const g = Math.floor(214 - (intensity * 15)); // Start at 214, go slightly darker
                const b = Math.floor(254 - (intensity * 20)); // Start at 254, go slightly darker
                
                // Background gradient - light for easy copying (construct as string, not template literal)
                const bgColor = 'rgba(' + r + ', ' + g + ', ' + b + ', 0.3)'; // Light opacity
                const textColor = '#7c3aed'; // Consistent purple text
                
                // Safely get product code and name with null checks
                const productCodeValue = product && product.code ? String(product.code) : '';
                const productNameValue = product && product.name ? String(product.name) : '';
                
                // Check if this is a BAC Water product (for visual separation)
                const isBacWater = productCodeValue && bacWaterCodes.includes(productCodeValue);
                const separatorStyle = isBacWater && index === regularProducts.length 
                    ? 'border-top: 3px solid rgba(167, 139, 250, 0.5);' 
                    : '';

                // Escape for both JavaScript template literal and HTML
                const productCode = escapeHtml(productCodeValue);
                const productName = escapeHtml(productNameValue);
                const productCodeAttr = escapeJS(productCodeValue); // For HTML attributes in template literal
                // Escape separatorStyle for safe insertion into template literal (though it should be safe CSS)
                const separatorStyleSafe = separatorStyle ? separatorStyle.replace(/`/g, '\\`').replace(/\${/g, '\\${') : '';
                return `
                    <tr class="completed-kit-row" style="background: ${bgColor}; ${separatorStyleSafe}" data-kits="${kitsGenerated}" data-code="${productCodeAttr}">
                        <td style="font-weight: 500; text-align: center; color: ${textColor};">
                            ${productName}
                            ${isBacWater ? '<span style="font-size: 0.75rem; opacity: 0.8;"> (BAC Water)</span>' : ''}
                        </td>
                        <td style="text-align: center;">
                            <span class="product-code" style="color: ${textColor};">${productCode}</span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; color: ${textColor};">
                                ${kitsGenerated}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${textColor};">
                                ${totalVials}
                            </span>
                        </td>
                    </tr>
                `;
            });  // Close arrow function body and map() call
            tbody.innerHTML = htmlArray.join('');  // Join the array into a single string

            // Make table easy to copy (add copy functionality hint)
            const table = document.querySelector(`.completed-kits-table[data-supplier="${supplierEscaped}"]`);
            if (table) {
                table.style.cursor = 'default';
                // Add title attribute for copy hint
                table.title = 'Click and drag to select rows, then copy (Ctrl+C / Cmd+C) to paste into spreadsheet';
            }
        }

        // Load Shared Products - Per Supplier
        function loadSharedProducts(products, supplier) {
            // Filter products with active orders (total_vials > 0)
            const sharedProducts = products.filter(product => {
                const totalVials = product.total_vials || 0;
                return totalVials > 0;
            });

            const tbody = document.querySelector(`.shared-products-tbody[data-supplier="${supplier}"]`);
            if (!tbody) return;
            
            if (sharedProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">No products with active orders</td></tr>';
                return;
            }

            // Sort by total completed kits (descending)
            sharedProducts.sort((a, b) => (b.kits_generated || 0) - (a.kits_generated || 0));

            tbody.innerHTML = sharedProducts.map(product => {
                const breakdown = Array.isArray(product.pep_hauler_breakdown) ? product.pep_hauler_breakdown : [];
                const kitsGenerated = product.kits_generated || 0;

                // Separate vial orders and kit orders
                const vialOrders = breakdown.filter(u => (u.vials || 0) > 0);
                const kitOrders = breakdown.filter(u => (u.kits || 0) > 0);

                // Format vial orders: one line per user with smaller font and unique colors
                const vialOrdersHtml = vialOrders.length > 0
                    ? vialOrders.map(u => {
                        const color = getColorForUsername(u.username);
                        return `<div style="padding: 0.2rem 0; line-height: 1.4; font-size: 0.75rem;">
                            <span style="display: inline-block; padding: 0.2rem 0.4rem; border-radius: 8px; background: ${color.bg}; color: ${color.text}; font-weight: 600; margin-right: 0.3rem;">@${escapeHtml(u.username)}</span>
                            <span style="color: var(--text-secondary);">(${u.vials} vial${u.vials !== 1 ? 's' : ''})</span>
                        </div>`;
                    }).join('')
                    : '<div style="color: var(--text-muted); font-size: 0.75rem;">‚Äî</div>';

                // Format kit orders: one line per user with smaller font and unique colors
                const kitOrdersHtml = kitOrders.length > 0
                    ? kitOrders.map(u => {
                        const color = getColorForUsername(u.username);
                        return `<div style="padding: 0.2rem 0; line-height: 1.4; font-size: 0.75rem;">
                            <span style="display: inline-block; padding: 0.2rem 0.4rem; border-radius: 8px; background: ${color.bg}; color: ${color.text}; font-weight: 600; margin-right: 0.3rem;">@${escapeHtml(u.username)}</span>
                            <span style="color: var(--text-secondary);">(${u.kits} kit${u.kits !== 1 ? 's' : ''})</span>
                        </div>`;
                    }).join('')
                    : '<div style="color: var(--text-muted); font-size: 0.75rem;">‚Äî</div>';

                // Escape product name and code for safe use in template literal
                const sharedProdName = escapeHtml(String(product.name || ''));
                const sharedProdCode = escapeHtml(String(product.code || ''));
                return `
                    <tr>
                        <td style="font-weight: 500; text-align: center; vertical-align: top; padding: 1rem;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${sharedProdName}</div>
                            <div style="font-family: 'JetBrains Mono', monospace; color: var(--accent-violet); font-size: 0.85rem;">${sharedProdCode}</div>
                        </td>
                        <td style="text-align: left; vertical-align: top; padding: 1rem;">
                            ${vialOrdersHtml}
                        </td>
                        <td style="text-align: left; vertical-align: top; padding: 1rem;">
                            ${kitOrdersHtml}
                        </td>
                        <td style="text-align: center; vertical-align: top; padding: 1rem;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; color: var(--accent-violet);">
                                ${kitsGenerated}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Pep haulers modal (used by Completed Kits)
        function openPepHaulersModal(productCode) {
            const code = String(productCode || '');
            const products = window._productsCache || [];
            const product = products.find(p => String(p.code) === code);
            if (!product) {
                showToast('Product not found');
                return;
            }

            const breakdown = Array.isArray(product.pep_hauler_breakdown) ? product.pep_hauler_breakdown : [];
            const title = document.getElementById('pep-haulers-modal-title');
            if (title) title.textContent = `üë• Pep Hauler/s ‚Ä¢ ${product.name} (${product.code})`;

            const body = document.getElementById('pep-haulers-modal-body');
            if (!body) return;

            if (breakdown.length === 0) {
                body.innerHTML = '<div style="text-align:center; padding: 1.5rem; color: var(--text-muted);">No Pep Hauler usernames found for this product.</div>';
            } else {
                const rows = breakdown.map(u => {
                    const v = u.vials || 0;
                    const k = u.kits || 0;
                    const parts = [];
                    if (v) parts.push(`<span style="display:inline-block; padding:0.2rem 0.5rem; border-radius:999px; background: rgba(236, 72, 153, 0.18); color:#be185d; font-weight:700; margin-right:0.35rem;">${v} vial${v !== 1 ? 's' : ''}</span>`);
                    if (k) parts.push(`<span style="display:inline-block; padding:0.2rem 0.5rem; border-radius:999px; background: rgba(124, 58, 237, 0.18); color:#6d28d9; font-weight:700;">${k} kit${k !== 1 ? 's' : ''}</span>`);
                    return `
                        <div style="display:flex; justify-content: space-between; gap: 1rem; padding: 0.75rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(221, 214, 254, 0.18);">
                            <div style="font-weight: 800; color: var(--text-primary); user-select: all;">@${escapeHtml(u.username)}</div>
                            <div style="white-space: nowrap;">${parts.join('')}</div>
                        </div>
                    `;
                }).join('');
                body.innerHTML = `
                    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.75rem;">
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Tip: you can click-drag to copy usernames from this list.</div>
                        <button class="btn-sm" style="background: rgba(192, 132, 252, 0.2); color: #6d28d9; border: 1px solid rgba(192, 132, 252, 0.35);" onclick="copyPepHaulers('${escapeJS(product.code)}')">Copy Summary</button>
                    </div>
                    <div style="display:flex; flex-direction: column; gap: 0.6rem;">
                        ${rows}
                    </div>
                `;
            }

            document.getElementById('pep-haulers-modal').classList.add('show');
        }

        function closePepHaulersModal() {
            document.getElementById('pep-haulers-modal').classList.remove('show');
        }

        function copyPepHaulers(productCode) {
            const code = String(productCode || '');
            const products = window._productsCache || [];
            const product = products.find(p => String(p.code) === code);
            if (!product) return;
            const breakdown = Array.isArray(product.pep_hauler_breakdown) ? product.pep_hauler_breakdown : [];
            const lines = breakdown.map(u => {
                const parts = [];
                if (u.vials) parts.push(`${u.vials} vials`);
                if (u.kits) parts.push(`${u.kits} kits`);
                return `@${u.username} (${parts.join(', ')})`;
            }).join(', ');
            navigator.clipboard.writeText(lines || '').then(() => showToast('Copied Pep Hauler summary'), () => showToast('Failed to copy'));
        }

        window.openPepHaulersModal = openPepHaulersModal;
        window.closePepHaulersModal = closePepHaulersModal;
        window.copyPepHaulers = copyPepHaulers;

        // Toggle Lock
        async function toggleLock(productCode, isLocked) {
            try {
                const response = await fetch('/api/admin/lock-product', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_code: productCode, is_locked: isLocked })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(isLocked ? 'Product locked' : 'Product unlocked');
                    loadProducts();
                } else {
                    showToast('Failed to update');
                }
            } catch (error) {
                showToast('Error updating lock status');
            }
        }

        // Lock/Unlock All Products - Per Supplier (updated version)
        async function lockAllProducts(isLocked, supplier) {
            try {
                // Get all products
                const response = await fetch('/api/admin/products', { credentials: 'same-origin' });
                const products = await response.json();
                
                // Filter products for this supplier
                const supplierProducts = products.filter(p => (p.supplier || 'Default') === supplier);
                
                if (supplierProducts.length === 0) {
                    showToast(`No products found for ${supplier}`);
                    return;
                }
                
                // Confirm action
                const action = isLocked ? 'lock' : 'unlock';
                if (!confirm(`Are you sure you want to ${action} all ${supplierProducts.length} products for ${supplier}?`)) {
                    return;
                }
                
                // Show loading message
                showToast(`‚è≥ ${action.charAt(0).toUpperCase() + action.slice(1)}ing ${supplierProducts.length} products...`);
                
                // Extract product codes
                const productCodes = supplierProducts.map(p => p.code);
                
                // Use bulk endpoint instead of individual calls
                try {
                    const bulkResponse = await fetch('/api/admin/products/bulk-lock', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            product_codes: productCodes,
                            is_locked: isLocked
                        })
                    });
                    
                    if (!bulkResponse.ok) {
                        const errorData = await bulkResponse.json();
                        throw new Error(errorData.error || 'Failed to update products');
                    }
                    
                    const result = await bulkResponse.json();
                    
                    // Reload products to reflect changes
                    loadProducts();
                    
                    if (result.failed_count === 0) {
                        showToast(`‚úÖ Successfully ${action}ed all ${result.success_count} products for ${supplier}`);
                    } else {
                        const failedMsg = result.failed_products ? ` (Failed: ${result.failed_products.join(', ')})` : '';
                        showToast(`‚ö†Ô∏è ${action}ed ${result.success_count} products, ${result.failed_count} failed${failedMsg}`);
                    }
                } catch (error) {
                    console.error(`Error bulk ${action}ing products:`, error);
                    showToast(`Error ${action}ing products: ${error.message}`);
                }
            } catch (error) {
                console.error('Error locking/unlocking all products:', error);
                showToast('Error updating products');
            }
        }
        
        // Expose lockAllProducts to global scope
        window.lockAllProducts = lockAllProducts;

        // Update Max Kits
        async function updateMaxKits(productCode, maxKits) {
            try {
                const response = await fetch('/api/admin/lock-product', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_code: productCode, is_locked: false, max_kits: parseInt(maxKits) })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Max kits updated');
                    loadProducts();
                }
            } catch (error) {
                showToast('Error updating max kits');
            }
        }

        // Search products per supplier
        ADMIN_SUPPLIERS.forEach(supplier => {
            const searchInput = document.querySelector(`.product-search[data-supplier="${supplier}"]`);
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const tbody = document.querySelector(`.products-tbody[data-supplier="${supplier}"]`);
                    if (tbody) {
                        tbody.querySelectorAll('tr').forEach(row => {
                            const code = row.dataset.code?.toLowerCase() || '';
                            const name = row.querySelector('td')?.textContent?.toLowerCase() || '';
                            row.style.display = (code.includes(query) || name.includes(query)) ? '' : 'none';
                        });
                    }
                });
            }
        });

        // Toast
        function showToast(message) {
            document.getElementById('toast-message').textContent = message;
            document.getElementById('toast').classList.add('show');
            setTimeout(() => document.getElementById('toast').classList.remove('show'), 3000);
        }

        // ===== ORDERS MANAGEMENT =====
        let allOrders = [];

        async function loadOrders() {
            try {
                console.log('üìä Admin: Fetching orders from /api/admin/orders...');
                const response = await fetch('/api/admin/orders', { credentials: 'same-origin' });
                console.log('üìä Admin: Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('üìä Admin: Response not OK:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('üìä Admin: Error response:', errorText);
                    return;
                }
                
                const orders = await response.json();
                console.log('üìä Admin: Received orders:', orders.length, 'orders');
                console.log('üìä Admin: Orders data:', orders);
                
                if (orders.length === 0) {
                    console.warn('üìä Admin: WARNING - No orders returned from API!');
                } else {
                    console.log('üìä Admin: Sample order:', orders[0]);
                }
                
                // Get products to match suppliers
                const productsResponse = await fetch('/api/admin/products', { credentials: 'same-origin' });
                const products = await productsResponse.json();
                
                allOrders = orders;
                
                // Render orders per supplier
                ADMIN_SUPPLIERS.forEach(supplier => {
                    const supplierOrders = orders.filter(order => {
                        // Check if order has items from this supplier
                        return order.items?.some(item => {
                            const product = products.find(p => p.code === item.product_code);
                            return product && (product.supplier || 'Default') === supplier;
                        });
                    });
                    renderOrders(supplierOrders, supplier);
                });
            } catch (error) {
                console.error('üìä Admin: Error loading orders:', error);
                console.error('üìä Admin: Error stack:', error.stack);
            }
        }

        function renderOrders(orders, supplier) {
            const tbody = document.querySelector(`.orders-tbody[data-supplier="${supplier}"]`);
            if (!tbody) return;
            
            console.log('üìä Admin: renderOrders called with', orders.length, 'orders');
            
            if (!orders || orders.length === 0) {
                console.warn('üìä Admin: No orders to render');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                // Safety check for items
                const items = order.items || [];
                const itemsPreview = items.length > 0 
                    ? items.map(i => `${i.product_code || 'N/A'} (${i.qty || 0})`).join(', ')
                    : 'No items';
                const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
                const isWaitingForConfirmation = order.payment_status && order.payment_status.toLowerCase() === 'waiting for confirmation';
                const isLocked = order.locked === true;
                const isNonEditableDueToPayment = isPaid || isWaitingForConfirmation;
                const showUnlockButton = isLocked || isNonEditableDueToPayment;
                const hasShippingDetails = order.mailing_address && order.mailing_address.trim() !== '';
                const hasTrackingNumber = order.tracking_number && order.tracking_number.trim() !== '';
                
                return `
                    <tr data-order-id="${order.order_id}" class="${isLocked ? 'locked-order' : ''}">
                        <td><input type="checkbox" class="order-checkbox" data-supplier="${supplier}" value="${order.order_id}" onchange="updateBulkActions('${supplier}')" style="cursor: pointer;"></td>
                        <td><span class="product-code">${order.order_id}</span></td>
                        <td style="font-size: 0.85rem;">${order.order_date}</td>
                        <td>
                            <div style="font-weight: 500;">${order.full_name}</div>
                            <div style="font-size: 0.8rem; color: #c084fc; font-family: 'JetBrains Mono', monospace;">${order.telegram ? '@' + order.telegram.replace('@', '') : '‚Äî'}</div>
                        </td>
                        <td><div class="order-items-preview">${itemsPreview.length > 30 ? itemsPreview.substring(0, 30) + '...' : itemsPreview}</div></td>
                        <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                        <td><span class="payment-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span></td>
                        <td>
                            ${isLocked 
                                ? '<span style="color: #ec4899; font-weight: 600;">üîí Locked</span>'
                                : '<span style="color: #7c3aed; font-weight: 600;">üîì Open</span>'}
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-sm btn-view" onclick="viewOrderDetails('${order.order_id}')">View</button>
                                ${!isPaid && !isLocked 
                                    ? `<button class="btn-sm" style="background: #c084fc; color: white;" onclick="editOrder('${order.order_id}')" title="Edit order items">‚úèÔ∏è Edit</button>` 
                                    : ''}
                                ${showUnlockButton 
                                    ? `<button class="btn-sm" style="background: #a78bfa; color: white;" onclick="toggleOrderLock('${order.order_id}', false)">üîì Unlock</button>`
                                    : `<button class="btn-sm" style="background: #f472b6; color: white;" onclick="toggleOrderLock('${order.order_id}', true)">üîí Lock</button>`}
                                ${!isPaid 
                                    ? `<button class="btn-sm btn-confirm" onclick="confirmPayment('${order.order_id}')">‚úì Confirm</button>
                                       <button class="btn-sm" style="background: #c084fc; color: white;" onclick="sendReminder('${order.order_id}')">üì≤ Remind</button>` 
                                    : `<button class="btn-sm" style="background: #a78bfa; color: white;" onclick="notifyCustomer('${order.order_id}')">üì± Notify</button>`}
                                ${isPaid && hasShippingDetails 
                                    ? `<button class="btn-sm" style="background: #10b981; color: white;" onclick="openTrackingModal('${order.order_id}', '${(order.tracking_number || '').replace(/'/g, "\\'")}')" title="${hasTrackingNumber ? 'Update' : 'Add'} tracking number">üì¶ ${hasTrackingNumber ? 'Update Tracking' : 'Add Tracking'}</button>` 
                                    : ''}
                                <button class="btn-sm" style="background: #f472b6; color: white;" onclick="cancelOrder('${order.order_id}', '${order.telegram || ''}')" title="Cancel order and delete all rows">üóëÔ∏è Cancel</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Reset select all checkbox for this supplier
            const selectAllCheckbox = document.querySelector(`.select-all-orders[data-supplier="${supplier}"]`);
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBulkActions(supplier);
        }

        // Filter orders per supplier
        ADMIN_SUPPLIERS.forEach(supplier => {
            const searchInput = document.querySelector(`.order-search[data-supplier="${supplier}"]`);
            const paymentFilter = document.querySelector(`.payment-filter[data-supplier="${supplier}"]`);
            
            if (searchInput) {
                searchInput.addEventListener('input', () => filterOrders(supplier));
            }
            if (paymentFilter) {
                paymentFilter.addEventListener('change', () => filterOrders(supplier));
            }
        });

        function filterOrders(supplier) {
            const searchInput = document.querySelector(`.order-search[data-supplier="${supplier}"]`);
            const paymentFilterEl = document.querySelector(`.payment-filter[data-supplier="${supplier}"]`);
            
            if (!searchInput || !paymentFilterEl) return;
            
            const query = searchInput.value.toLowerCase();
            const paymentFilter = paymentFilterEl.value;
            
            // Get products to match suppliers
            const products = window._productsCache || [];
            
            // Filter orders for this supplier
            const supplierOrders = allOrders.filter(order => {
                // Check if order has items from this supplier
                const hasSupplierItems = order.items?.some(item => {
                    const product = products.find(p => p.code === item.product_code);
                    return product && (product.supplier || 'Default') === supplier;
                });
                return hasSupplierItems;
            });
            
            console.log('üìä Admin: Filtering orders - query:', query, 'paymentFilter:', paymentFilter);
            console.log('üìä Admin: Total orders before filter:', allOrders.length);
            
            let filtered = supplierOrders.filter(order => {
                const matchesSearch = 
                    order.order_id.toLowerCase().includes(query) ||
                    order.full_name.toLowerCase().includes(query) ||
                    (order.telegram && order.telegram.toLowerCase().includes(query));
                
                const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
                const matchesPayment = 
                    paymentFilter === 'all' ||
                    (paymentFilter === 'paid' && isPaid) ||
                    (paymentFilter === 'unpaid' && !isPaid);
                
                return matchesSearch && matchesPayment;
            });
            
            console.log('üìä Admin: Orders after filter:', filtered.length);
            renderOrders(filtered, supplier);
        }

        // View order details
        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.order_id === orderId);
            if (!order) return;

            const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
            
            const body = document.getElementById('order-modal-body');
            body.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-size: 1.25rem;">${order.order_id}</span>
                        <span class="payment-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${order.order_date}</div>
                </div>
                
                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600;">${order.full_name}</div>
                    ${order.telegram ? `<div style="color: var(--text-muted); font-size: 0.9rem;">@${order.telegram.replace('@', '')}</div>` : ''}
                </div>
                
                <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary);">Order Items</h4>
                <div style="background: var(--bg-input); border-radius: 10px; padding: 0.5rem 1rem; margin-bottom: 1.5rem;">
                    ${order.items.map(item => `
                        <div class="order-item-row">
                            <div>
                                <div style="font-weight: 500;">${item.product_name || item.product_code}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${item.order_type} √ó ${item.qty}</div>
                            </div>
                            <div style="font-family: 'JetBrains Mono', monospace; color: #a78bfa;">
                                ‚Ç±${item.line_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: linear-gradient(135deg, #c084fc, #f472b6); padding: 1rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: white; font-weight: 600;">Grand Total</span>
                    <span style="font-family: 'JetBrains Mono', monospace; color: white; font-size: 1.5rem; font-weight: 700;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
                
                ${order.payment_screenshot ? `
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary);">Payment Screenshot</h4>
                        <a href="${order.payment_screenshot}" target="_blank" class="screenshot-link" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            üì∑ View Payment Screenshot
                        </a>
                    </div>
                ` : ''}
            `;

            const footer = document.getElementById('order-modal-footer');
            const isLocked = order.locked === true;
            footer.innerHTML = `
                ${!isPaid && !isLocked ? `<button class="btn" style="padding: 0.75rem 1.5rem; background: #c084fc; color: white;" onclick="editOrder('${order.order_id}'); closeOrderModal();">‚úèÔ∏è Edit Order</button>` : ''}
                ${!isPaid ? `<button class="btn btn-violet" style="padding: 0.75rem 1.5rem;" onclick="confirmPayment('${order.order_id}'); closeOrderModal();">‚úì Confirm Payment</button>` : 
                           `<button class="btn" style="padding: 0.75rem 1.5rem; background: #a78bfa; color: white;" onclick="notifyCustomer('${order.order_id}')">üì± Notify Customer</button>`}
                <button class="btn" style="padding: 0.75rem 1.5rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);" onclick="closeOrderModal()">Close</button>
            `;

            document.getElementById('order-modal').classList.add('show');
        }

        // Edit Order
        function editOrder(orderId) {
            const order = allOrders.find(o => o.order_id === orderId);
            if (!order) {
                showToast('Order not found');
                return;
            }

            const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
            const isLocked = order.locked === true;
            
            if (isPaid || isLocked) {
                showToast(isPaid ? 'Cannot edit paid orders' : 'Cannot edit locked orders. Unlock first.');
                return;
            }

            const body = document.getElementById('order-modal-body');
            body.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-size: 1.25rem;">${order.order_id}</span>
                        <span class="payment-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${order.order_date}</div>
                </div>
                
                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600;">${order.full_name}</div>
                    ${order.telegram ? `<div style="color: var(--text-muted); font-size: 0.9rem;">@${order.telegram.replace('@', '')}</div>` : ''}
                </div>
                
                <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary);">Edit Order Items</h4>
                <div style="background: var(--bg-input); border-radius: 10px; padding: 0.5rem 1rem; margin-bottom: 1.5rem;">
                    ${order.items.map((item, idx) => `
                        <div class="order-item-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${item.product_name || item.product_code}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${item.order_type}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <button class="btn-sm" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="updateItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', ${item.qty - 1})">‚àí</button>
                                    <input type="number" id="qty-${order.order_id}-${idx}" value="${item.qty}" min="0" style="width: 60px; padding: 0.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); text-align: center; font-family: 'JetBrains Mono', monospace;" onchange="updateItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', parseInt(this.value) || 0)">
                                    <button class="btn-sm" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="updateItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', ${item.qty + 1})">+</button>
                                </div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; min-width: 100px; text-align: right;">
                                    ‚Ç±${item.line_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: linear-gradient(135deg, #c084fc, #f472b6); padding: 1rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: white; font-weight: 600;">Grand Total</span>
                    <span style="font-family: 'JetBrains Mono', monospace; color: white; font-size: 1.5rem; font-weight: 700;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(192, 132, 252, 0.1); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                    üí° Changes will be saved automatically. The order total will be recalculated after updates.
                </div>
            `;

            const footer = document.getElementById('order-modal-footer');
            footer.innerHTML = `
                <button class="btn" style="padding: 0.75rem 1.5rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);" onclick="closeOrderModal(); loadOrders(); loadProducts();">Close</button>
            `;

            document.getElementById('order-modal').classList.add('show');
        }

        // Update item quantity in order
        async function updateItemQty(orderId, productCode, orderType, newQty) {
            if (newQty < 0) newQty = 0;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/update-item`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_code: productCode,
                        order_type: orderType,
                        qty: newQty
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Updated ${productCode} (${orderType}) to ${newQty}`);
                    // Reload orders and products to reflect changes
                    await loadOrders();
                    await loadProducts();
                    // Refresh the edit modal if it's open
                    const order = allOrders.find(o => o.order_id === orderId);
                    if (order && document.getElementById('order-modal').classList.contains('show')) {
                        editOrder(orderId);
                    }
                } else {
                    showToast(result.error || 'Failed to update item');
                }
            } catch (error) {
                console.error('Error updating item:', error);
                showToast('Error updating item');
            }
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('show');
        }

        // Tracking Number Modal Functions
        let currentTrackingOrderId = null;
        
        function openTrackingModal(orderId, existingTrackingNumber = '') {
            currentTrackingOrderId = orderId;
            document.getElementById('tracking-number-input').value = existingTrackingNumber || '';
            document.getElementById('tracking-modal').classList.add('show');
        }
        
        function closeTrackingModal() {
            document.getElementById('tracking-modal').classList.remove('show');
            currentTrackingOrderId = null;
            document.getElementById('tracking-number-input').value = '';
        }
        
        async function saveTrackingNumber() {
            if (!currentTrackingOrderId) {
                showToast('‚ö†Ô∏è No order selected');
                return;
            }
            
            const trackingNumber = document.getElementById('tracking-number-input').value.trim();
            
            if (!trackingNumber) {
                showToast('‚ö†Ô∏è Please enter a tracking number');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/orders/${currentTrackingOrderId}/tracking-number`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracking_number: trackingNumber })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('‚úÖ Tracking number saved successfully!');
                    closeTrackingModal();
                    loadOrders(); // Reload to reflect changes
                } else {
                    showToast(result.error || 'Failed to save tracking number');
                }
            } catch (error) {
                console.error('Error saving tracking number:', error);
                showToast('Error saving tracking number');
            }
        }

        // Confirm payment
        async function confirmPayment(orderId) {
            if (!confirm(`Are you sure you want to mark order ${orderId} as PAID?`)) return;
            
            try {
                const response = await fetch('/api/admin/confirm-payment', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Payment confirmation failed:', response.status, errorText);
                    showToast(`Failed to confirm payment (${response.status})`);
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    showToast('Payment confirmed! ‚úÖ');
                    loadOrders();
                    // Close modal if open
                    const orderModal = document.getElementById('order-modal');
                    if (orderModal && orderModal.classList.contains('show')) {
                        closeOrderModal();
                    }
                } else {
                    showToast(result.error || 'Failed to confirm payment');
                }
            } catch (error) {
                console.error('Error confirming payment:', error);
                showToast('Error confirming payment. Please try again.');
            }
        }
        
        // Expose confirmPayment to global scope
        window.confirmPayment = confirmPayment;

        // ===== ORDER LOCKING FUNCTIONS =====
        
        // Toggle select all checkbox
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActions();
        }
        
        // Update bulk actions visibility based on selection
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (checkboxes.length > 0) {
                bulkActions.style.display = 'block';
                selectedCount.textContent = checkboxes.length;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        // Clear all selections
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('select-all-orders').checked = false;
            updateBulkActions();
        }
        
        // Lock/unlock a single order
        async function toggleOrderLock(orderId, isLocked) {
            const action = isLocked ? 'lock' : 'unlock';
            if (!confirm(`Are you sure you want to ${action} order ${orderId}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/lock`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locked: isLocked })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Order ${isLocked ? 'locked' : 'unlocked'} successfully!`);
                    loadOrders(); // Reload to reflect changes
                } else {
                    showToast(result.error || `Failed to ${action} order`);
                }
            } catch (error) {
                console.error(`Error ${action}ing order:`, error);
                showToast(`Error ${action}ing order`);
            }
        }
        
        // Bulk lock/unlock orders
        async function bulkLockOrders(isLocked) {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const orderIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (orderIds.length === 0) {
                showToast('‚ö†Ô∏è No orders selected');
                return;
            }
            
            const action = isLocked ? 'lock' : 'unlock';
            if (!confirm(`Are you sure you want to ${action} ${orderIds.length} order(s)?`)) return;
            
            try {
                const response = await fetch('/api/admin/orders/bulk-lock', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        order_ids: orderIds,
                        locked: isLocked
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ ${result.message}`);
                    clearSelection();
                    loadOrders(); // Reload to reflect changes
                } else {
                    showToast(result.error || `Failed to ${action} orders`);
                }
            } catch (error) {
                console.error(`Error bulk ${action}ing orders:`, error);
                showToast(`Error bulk ${action}ing orders`);
            }
        }

        // Notify customer via Telegram (for paid orders)
        async function notifyCustomer(orderId) {
            if (!confirm(`Send payment confirmation notification to customer via Telegram for order ${orderId}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/notify-customer`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Notification sent to customer via Telegram!`);
                } else if (result.error && result.telegram_handle && result.bot_username) {
                    // Customer hasn't messaged the bot yet
                    showToast(`‚ö†Ô∏è Customer @${result.telegram_handle} hasn't messaged @${result.bot_username} yet`, 5000);
                    alert(`Customer @${result.telegram_handle} needs to message @${result.bot_username} first to receive notifications.\n\nPlease ask them to start a chat with the bot.`);
                } else {
                    showToast(result.error || 'Failed to send notification');
                }
            } catch (error) {
                console.error('Error sending notification:', error);
                showToast('Error sending notification');
            }
        }

        // Send payment reminder
        async function sendReminder(orderId) {
            if (!confirm(`Send payment reminder via Telegram for order ${orderId}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/send-reminder`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('‚úÖ Reminder sent via Telegram!');
                } else {
                    // Show detailed error message
                    const errorMsg = result.error || 'Failed to send reminder';
                    const detailMsg = result.message || '';
                    
                    if (detailMsg) {
                        alert(`‚ùå ${errorMsg}\n\n${detailMsg}`);
                    } else {
                        showToast(`‚ö†Ô∏è ${errorMsg}`);
                    }
                    
                    console.error('Reminder error:', result);
                }
            } catch (error) {
                console.error('Error sending reminder:', error);
                showToast('‚ùå Error sending reminder - check console');
            }
        }

        // Close modal on background click
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') {
                closeOrderModal();
            }
        });


        // Cancel order function
        async function cancelOrder(orderId, telegramUsername) {
            const telegram = telegramUsername || '';
            const telegramDisplay = telegram ? ` (@${telegram.replace('@', '')})` : '';
            
            if (!confirm(`‚ö†Ô∏è Are you sure you want to CANCEL order ${orderId}${telegramDisplay}?\n\nThis will:\n- Delete ALL rows matching this order ID\n- Delete ALL rows matching the telegram username\n- Recalculate inventory automatically\n- This action CANNOT be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${orderId}/cancel`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        telegram_username: telegram 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`‚úÖ Order ${orderId} cancelled and all rows deleted! Inventory recalculated.`);
                    // Reload orders and products to reflect changes
                    await loadOrders();
                    await loadProducts();
                    if (document.getElementById('order-modal').classList.contains('show')) {
                        closeOrderModal(); // Close modal if open
                    }
                } else {
                    showToast(result.error || 'Failed to cancel order');
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                showToast('‚ùå Error cancelling order - check console');
            }
        }

        // Export page as HTML
        function exportPageAsHTML() {
            try {
                // Get the entire page HTML
                const htmlContent = document.documentElement.outerHTML;
                
                // Create a blob with the HTML content
                const blob = new Blob([htmlContent], { type: 'text/html' });
                
                // Create a download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pephaul-admin-panel-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('‚úÖ Page exported as HTML successfully!');
            } catch (error) {
                console.error('Error exporting HTML:', error);
                showToast('‚ùå Error exporting HTML');
            }
        }

        // Load available PepHaul Entry tabs
        async function loadPepHaulTabs() {
            try {
                const response = await fetch('/api/admin/pephaul-tabs', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load tabs: ${response.status}`);
                }
                
                const result = await response.json();
                const tabs = result.tabs || [];
                const currentTab = result.current_tab || 'PepHaul Entry';
                
                // Update selector
                const selector = document.getElementById('pephaul-tab-selector');
                selector.innerHTML = tabs.map(tab => 
                    `<option value="${tab}" ${tab === currentTab ? 'selected' : ''}>${tab}</option>`
                ).join('');
                
            } catch (error) {
                console.error('Error loading tabs:', error);
                showToast('‚ö†Ô∏è Could not load tabs - using default');
            }
        }

        // Create new PepHaul Entry tab
        async function createNewPepHaulTab() {
            if (!confirm('Create a new PepHaul Entry tab? This will create a new tab with headers only.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/pephaul-tabs/create', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Created new tab: ${result.tab_name}`);
                    loadPepHaulTabs(); // Reload tabs list
                    loadOrders(); // Reload orders to show new tab's data
                } else {
                    showToast(result.error || 'Failed to create tab');
                }
            } catch (error) {
                console.error('Error creating tab:', error);
                showToast('‚ùå Error creating tab');
            }
        }

        // Switch to selected PepHaul Entry tab
        async function switchPepHaulTab() {
            const selector = document.getElementById('pephaul-tab-selector');
            const selectedTab = selector.value;
            
            if (!selectedTab) {
                showToast('‚ö†Ô∏è Please select a tab');
                return;
            }
            
            if (!confirm(`Switch to tab "${selectedTab}"? All order records will be preserved.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/pephaul-tabs/switch', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tab_name: selectedTab })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Switched to tab: ${selectedTab}`);
                    loadOrders(); // Reload orders from new tab
                    loadCustomerSummary(); // Reload customer summary
                    loadTimelineEntries(); // Reload timeline for new tab
                    // Notify main page to reload timeline if it's open
                    if (window.opener && !window.opener.closed) {
                        try {
                            window.opener.postMessage({ type: 'tabSwitched', tab_name: selectedTab }, '*');
                        } catch (e) {
                            console.log('Could not communicate with main window');
                        }
                    }
                } else {
                    showToast(result.error || 'Failed to switch tab');
                }
            } catch (error) {
                console.error('Error switching tab:', error);
                showToast('‚ùå Error switching tab');
            }
        }

        // Setup event listeners for new features
        function setupNewFeatures() {
            // HTML Export button
            const exportBtn = document.getElementById('export-html-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportPageAsHTML);
            }
            
            // PepHaul Tab Management
            const createTabBtn = document.getElementById('create-new-tab-btn');
            if (createTabBtn) {
                createTabBtn.addEventListener('click', createNewPepHaulTab);
            }
            
            const switchTabBtn = document.getElementById('switch-tab-btn');
            if (switchTabBtn) {
                switchTabBtn.addEventListener('click', switchPepHaulTab);
            }
            
            // Load tabs on page load
            loadPepHaulTabs();
        }

        // Auto-boot on page load (if session is already logged in)
        document.addEventListener('DOMContentLoaded', function() {
            bootAdmin();
            setupNewFeatures();
        });
    }}  // Close 2 unclosed braces (accounting for regex pattern braces)
    </script>
</body>
</html>

