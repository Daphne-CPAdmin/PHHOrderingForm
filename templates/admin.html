<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PepHaul Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf5ff;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --accent-teal: #a78bfa;
            --accent-amber: #f9a8d4;
            --accent-rose: #f472b6;
            --accent-violet: #c084fc;
            --accent-emerald: #a78bfa;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(192, 132, 252, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(249, 168, 212, 0.12) 0%, transparent 50%);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #c084fc 0%, #f472b6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .back-link {
            color: var(--accent-teal);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Login */
        .login-container {
            max-width: 400px;
            margin: 4rem auto;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; }
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
        }
        .form-input:focus { outline: none; border-color: #c084fc; }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-violet { background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%); color: white; }
        .btn:hover { transform: translateY(-2px); }

        /* Admin Content */
        .admin-content { display: none; }
        .admin-content.show { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: #c084fc;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        /* Products Table */
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }

        .products-table th,
        .products-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .products-table th {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .products-table tr:hover {
            background: rgba(192, 132, 252, 0.1);
        }
        
        .products-table tr.locked-order {
            background: rgba(249, 168, 212, 0.1);
        }
        
        .products-table tr.locked-order:hover {
            background: rgba(249, 168, 212, 0.15);
        }
        
        .products-table tr.incomplete-kit {
            background: rgba(249, 168, 212, 0.12);
        }
        
        .products-table tr.incomplete-kit:hover {
            background: rgba(249, 168, 212, 0.18);
        }

        .product-code {
            font-family: 'JetBrains Mono', monospace;
            color: #a78bfa;
        }

        .kits-badge {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .kits-badge.normal {
            background: rgba(167, 139, 250, 0.2);
            color: #7c3aed;
        }

        .kits-badge.warning {
            background: rgba(249, 168, 212, 0.2);
            color: #ec4899;
        }

        .kits-badge.danger {
            background: rgba(244, 114, 182, 0.25);
            color: #db2777;
        }
        
        .kits-badge.incomplete {
            background: rgba(249, 168, 212, 0.25);
            color: #ec4899;
            font-weight: 600;
        }

        /* Completed Kits Gradient Styles */
        .completed-kit-row {
            transition: all 0.2s ease;
        }

        .completed-kit-row:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .lock-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 26px;
            transition: all 0.3s ease;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #f472b6;
            border-color: #f472b6;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background: white;
        }

        .max-kits-input {
            width: 80px;
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }

        .max-kits-input:focus {
            outline: none;
            border-color: #c084fc;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid #c084fc;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            color: var(--text-primary);
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        .search-bar {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
        }

        .table-container {
            overflow-x: auto;
        }

        .error-msg {
            color: var(--accent-rose);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Payment status badges */
        .payment-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-badge.unpaid {
            background: rgba(249, 168, 212, 0.2);
            color: #ec4899;
        }

        .payment-badge.waiting {
            background: rgba(192, 132, 252, 0.2);
            color: #a855f7;
        }

        .payment-badge.paid {
            background: rgba(167, 139, 250, 0.2);
            color: #7c3aed;
        }

        .payment-badge.partial {
            background: rgba(251, 191, 36, 0.2);
            color: #f59e0b;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-confirm {
            background: #a78bfa;
            color: white;
        }

        .btn-confirm:hover {
            opacity: 0.9;
        }

        .btn-view {
            background: #a78bfa;
            color: white;
        }

        .screenshot-link {
            color: #c084fc;
            text-decoration: none;
            font-size: 0.85rem;
        }

        .screenshot-link:hover {
            text-decoration: underline;
        }

        .order-items-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-width: 200px;
        }

        /* Order Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .order-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .order-detail-label {
            color: var(--text-muted);
        }

        .order-item-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="login-section" class="login-container">
            <div class="card">
                <h2 class="card-title">üîê Admin Login</h2>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="admin-password" placeholder="Enter admin password">
                </div>
                <div id="login-error" class="error-msg" style="display: none;"></div>
                <button class="btn btn-violet" onclick="login()">Login</button>
            </div>
        </div>

        <!-- Admin Content -->
        <div id="admin-content" class="admin-content">
            <div class="header">
                <h1>Admin Panel</h1>
                <a href="/" class="back-link">‚Üê Back to Order Form</a>
            </div>

            <!-- Order Form Lock Control -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #f472b6;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span id="form-lock-icon">üîì</span> Order Form Status
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Lock the entire order form to prevent new orders when finalizing.
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="form-lock-status" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem;">
                            Loading...
                        </span>
                        <button id="toggle-form-lock" class="btn" style="padding: 0.75rem 1.5rem; background: var(--accent-rose);">
                            Toggle Lock
                        </button>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: none;" id="lock-message-container">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Lock Message (shown to customers)</label>
                    <textarea id="lock-message" class="form-input" rows="2" style="resize: vertical;" placeholder="Orders are currently closed. Thank you for your patience!"></textarea>
                </div>
            </div>

            <!-- Theme Selection -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #c084fc;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üé® Theme Selection
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Choose a holiday or seasonal theme for the order form.
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Select Theme</label>
                    <select id="theme-selector" class="form-input" style="width: 100%; max-width: 400px;">
                        <option value="default">Default Theme</option>
                        <option value="merry_christmas">üéÑ Merry Christmas</option>
                        <option value="happy_new_year">üéÜ Happy New Year</option>
                        <option value="chinese_new_year">üßß Happy Chinese New Year</option>
                        <option value="summer">‚òÄÔ∏è Summer Theme</option>
                        <option value="valentines">üíù Happy Valentines / Hearts Day</option>
                        <option value="halloween">üéÉ Halloween Theme</option>
                        <option value="holy_week">‚úùÔ∏è Holy Week Theme</option>
                    </select>
                    <button id="save-theme-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #c084fc; margin-top: 1rem;">
                        üíæ Save Theme
                    </button>
                    <div id="theme-save-status" style="margin-top: 0.75rem; font-size: 0.85rem; color: #7c3aed; display: none;">
                        ‚úì Theme saved successfully!
                    </div>
                </div>
            </div>

            <!-- Order Goal Settings -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #f9a8d4;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            üéØ Order Goal Settings
                        </h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Set the order goal displayed on the progress bar. The goal is in USD.
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Goal Amount (USD)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="display: flex; align-items: center; padding: 0 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px 0 0 10px; color: var(--text-secondary);">$</span>
                            <input type="number" id="order-goal-amount" class="form-input" style="border-radius: 0 10px 10px 0; flex: 1;" value="1000" min="1" step="100" placeholder="1000">
                        </div>
                    </div>
                    <button id="save-goal-btn" class="btn" style="padding: 0.75rem 1.5rem; background: #f9a8d4; margin-top: 1.5rem;">
                        üíæ Save Goal
                    </button>
                </div>
                <div id="goal-save-status" style="margin-top: 0.75rem; font-size: 0.85rem; color: #7c3aed; display: none;">
                    ‚úì Goal saved successfully!
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-products">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="locked-products">0</div>
                    <div class="stat-label">Locked Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-kits">0</div>
                    <div class="stat-label">Total Kits Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-vials">0</div>
                    <div class="stat-label">Total Vials Ordered</div>
                </div>
            </div>

            <!-- Customer Summary Section -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #c084fc;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">üë• Customer Summary</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Overview of all customers showing unique orders, total vials, and grand totals (including PepHaul Admin fee).
                </p>

                <div class="table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Order Number/s</th>
                                <th>Payment Status</th>
                                <th>Unique Orders</th>
                                <th>Total Vials</th>
                                <th>Grand Total (PHP)</th>
                            </tr>
                        </thead>
                        <tbody id="customer-summary-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Management -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">üì¶ Orders Management</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    View all orders and confirm payments after verification.
                </p>

                <div class="search-bar" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <input type="text" class="search-input" id="order-search" placeholder="Search orders by name, telegram, or order ID...">
                    <select class="form-input" id="payment-filter" style="width: auto; padding: 0.75rem 1rem;">
                        <option value="all">All Orders</option>
                        <option value="unpaid">Unpaid Only</option>
                        <option value="paid">Paid Only</option>
                    </select>
                </div>
                
                <!-- Bulk Actions -->
                <div id="bulk-actions" style="display: none; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fdf4ff 0%, #fce7f3 100%); border-radius: 12px; border: 2px solid #c084fc;">
                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: var(--text-primary);"><span id="selected-count">0</span> orders selected</span>
                        <button class="btn-sm" style="background: #f472b6; color: white;" onclick="bulkLockOrders(true)">üîí Lock Selected</button>
                        <button class="btn-sm" style="background: #a78bfa; color: white;" onclick="bulkLockOrders(false)">üîì Unlock Selected</button>
                        <button class="btn-sm" style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);" onclick="clearSelection()">Clear Selection</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="products-table" id="orders-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-orders" onchange="toggleSelectAll(this)" style="cursor: pointer;"></th>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total (PHP)</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Incomplete Kits Section -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #f472b6;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">‚ö†Ô∏è Incomplete Kits</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Products with incomplete kits (not divisible by 10 vials). Sorted by vials needed (fewest first). Shows pending vials needed to complete the next kit.
                </p>

                <div class="table-container" style="background: rgba(221, 214, 254, 0.3); padding: 1rem; border-radius: 12px;">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Product Name</th>
                                <th style="text-align: center;">Code</th>
                                <th style="text-align: center;">Total Vials</th>
                                <th style="text-align: center;">Kits Generated</th>
                                <th style="text-align: center;">Extra Vials</th>
                                <th style="text-align: center;">Pending Vials to Complete Kit</th>
                                <th style="text-align: center;">Pep Hauler/s</th>
                            </tr>
                        </thead>
                        <tbody id="incomplete-kits-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Completed Kits Section -->
            <div class="card" style="margin-bottom: 2rem; border: 2px solid #a78bfa;">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">‚úÖ Completed Kits</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Products with completed kits, sorted by number of kits (most first). BAC Water products grouped at bottom. Easy to copy to table.
                </p>

                <div class="table-container" style="background: rgba(221, 214, 254, 0.2); padding: 1rem; border-radius: 12px;">
                    <table class="products-table" id="completed-kits-table">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Product Name</th>
                                <th style="text-align: center;">Code</th>
                                <th style="text-align: center;">Kits Generated</th>
                                <th style="text-align: center;">Total Vials</th>
                            </tr>
                        </thead>
                        <tbody id="completed-kits-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Management -->
            <div class="card">
                <h2 class="card-title" style="text-align: left; margin-bottom: 1rem;">Product Management</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Lock products when they reach maximum kits or manually lock/unlock products.
                </p>

                <div class="search-bar" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" class="search-input" id="product-search" placeholder="Search products..." style="flex: 1;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-sm" style="background: #f472b6; color: white;" onclick="lockAllProducts(true)">üîí Lock All Products</button>
                        <button class="btn-sm" style="background: #a78bfa; color: white;" onclick="lockAllProducts(false)">üîì Unlock All Products</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Code</th>
                                <th>Kits Generated</th>
                                <th>Total Vials</th>
                                <th>Max Kits</th>
                                <th>Lock Status</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toast-message">Success!</span>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body" id="order-modal-body">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer" id="order-modal-footer">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>


    <script>
        let isLoggedIn = false;

        // Login
        async function login() {
            const password = document.getElementById('admin-password').value;
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isLoggedIn = true;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-content').classList.add('show');
                    loadProducts();
                    loadOrders();
                    loadCustomerSummary();
                    loadOrderFormStatus();
                    loadOrderGoal();
                    loadTheme();
                } else {
                    document.getElementById('login-error').textContent = 'Invalid password';
                    document.getElementById('login-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('login-error').textContent = 'Login error';
                document.getElementById('login-error').style.display = 'block';
            }
        }

        // Boot: if session is already authenticated, show admin content and load data.
        async function bootAdmin() {
            try {
                const resp = await fetch('/api/admin/whoami', { credentials: 'same-origin' });
                const data = await resp.json();
                if (data && data.is_admin) {
                    isLoggedIn = true;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-content').classList.add('show');
                    loadProducts();
                    loadOrders();
                    loadCustomerSummary();
                    loadOrderFormStatus();
                    loadOrderGoal();
                    loadTheme();
                }
            } catch (e) {
                // If this fails, user can still log in manually.
            }
        }

        // Enter key for login
        document.getElementById('admin-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Order Form Lock State
        let orderFormLocked = false;

        async function loadOrderFormStatus() {
            try {
                const response = await fetch('/api/admin/order-form-status', { credentials: 'same-origin' });
                const data = await response.json();
                orderFormLocked = data.is_locked;
                updateFormLockUI(data.is_locked, data.message);
            } catch (error) {
                console.error('Error loading order form status:', error);
            }
        }

        // Order Goal Functions
        async function loadOrderGoal() {
            try {
                const response = await fetch('/api/admin/order-goal', { credentials: 'same-origin' });
                const data = await response.json();
                document.getElementById('order-goal-amount').value = data.goal || 1000;
            } catch (error) {
                console.error('Error loading order goal:', error);
            }
        }

        // Theme Functions
        async function loadTheme() {
            try {
                const response = await fetch('/api/admin/theme', { credentials: 'same-origin' });
                const data = await response.json();
                const themeSelector = document.getElementById('theme-selector');
                if (themeSelector && data.theme) {
                    themeSelector.value = data.theme;
                }
            } catch (error) {
                console.error('Error loading theme:', error);
            }
        }

        document.getElementById('save-theme-btn').addEventListener('click', async () => {
            const themeSelector = document.getElementById('theme-selector');
            const selectedTheme = themeSelector.value;
            
            if (!selectedTheme) {
                alert('Please select a theme');
                return;
            }
            
            const btn = document.getElementById('save-theme-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/admin/theme', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: selectedTheme })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const statusEl = document.getElementById('theme-save-status');
                    statusEl.style.display = 'block';
                    const themeNames = {
                        'default': 'Default Theme',
                        'merry_christmas': 'Merry Christmas',
                        'happy_new_year': 'Happy New Year',
                        'chinese_new_year': 'Chinese New Year',
                        'summer': 'Summer Theme',
                        'valentines': 'Valentines Theme',
                        'halloween': 'Halloween Theme',
                        'holy_week': 'Holy Week Theme'
                    };
                    statusEl.textContent = `‚úì Theme saved successfully! (${themeNames[selectedTheme] || selectedTheme})`;
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    alert('Failed to save theme: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving theme:', error);
                alert('Error saving theme');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Theme';
            }
        });

        document.getElementById('save-goal-btn').addEventListener('click', async () => {
            const goalAmount = parseFloat(document.getElementById('order-goal-amount').value);
            
            if (!goalAmount || goalAmount <= 0) {
                alert('Please enter a valid goal amount');
                return;
            }
            
            const btn = document.getElementById('save-goal-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/admin/order-goal', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal: goalAmount })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const statusEl = document.getElementById('goal-save-status');
                    statusEl.style.display = 'block';
                    statusEl.textContent = '‚úì Goal saved successfully! ($' + goalAmount.toLocaleString() + ')';
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    alert('Failed to save goal: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving goal:', error);
                alert('Error saving goal');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save Goal';
            }
        });

        function updateFormLockUI(isLocked, message) {
            const statusEl = document.getElementById('form-lock-status');
            const iconEl = document.getElementById('form-lock-icon');
            const messageContainer = document.getElementById('lock-message-container');
            const messageInput = document.getElementById('lock-message');
            const toggleBtn = document.getElementById('toggle-form-lock');

            if (isLocked) {
                statusEl.textContent = 'LOCKED';
                statusEl.style.background = 'rgba(244, 114, 182, 0.2)';
                statusEl.style.color = '#db2777';
                iconEl.textContent = 'üîí';
                toggleBtn.textContent = 'Unlock Form';
                toggleBtn.style.background = '#a78bfa';
                messageContainer.style.display = 'block';
            } else {
                statusEl.textContent = 'OPEN';
                statusEl.style.background = 'rgba(167, 139, 250, 0.2)';
                statusEl.style.color = '#7c3aed';
                iconEl.textContent = 'üîì';
                toggleBtn.textContent = 'Lock Form';
                toggleBtn.style.background = '#f472b6';
                messageContainer.style.display = 'none';
            }

            if (message) {
                messageInput.value = message;
            }
        }

        document.getElementById('toggle-form-lock').addEventListener('click', async () => {
            const newLockState = !orderFormLocked;
            const message = document.getElementById('lock-message').value || 'Orders are currently closed. Thank you for your patience!';
            
            try {
                const response = await fetch('/api/admin/lock-order-form', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_locked: newLockState, message: message })
                });
                
                const data = await response.json();
                if (data.success) {
                    orderFormLocked = newLockState;
                    updateFormLockUI(newLockState, message);
                    showToast(newLockState ? 'Order form is now LOCKED!' : 'Order form is now OPEN!');
                } else {
                    showToast('Failed to update lock status');
                }
            } catch (error) {
                console.error('Error toggling form lock:', error);
                showToast('Error updating lock status');
            }
        });

        // Load Products
        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/products', { credentials: 'same-origin' });
                const products = await response.json();
                
                // Update stats
                let totalKits = 0;
                let totalVials = 0;
                let lockedCount = 0;
                
                products.forEach(p => {
                    totalKits += p.kits_generated || 0;
                    totalVials += p.total_vials || 0;
                    if (p.is_locked) lockedCount++;
                });
                
                document.getElementById('total-products').textContent = products.length;
                document.getElementById('locked-products').textContent = lockedCount;
                document.getElementById('total-kits').textContent = totalKits;
                document.getElementById('total-vials').textContent = totalVials;
                
                // Load incomplete kits
                loadIncompleteKits(products);
                
                // Load completed kits
                loadCompletedKits(products);
                
                // Render table
                const tbody = document.getElementById('products-tbody');
                tbody.innerHTML = products.map(product => {
                    const kitsPercent = product.max_kits > 0 ? (product.kits_generated / product.max_kits) * 100 : 0;
                    let badgeClass = 'normal';
                    if (kitsPercent >= 90) badgeClass = 'danger';
                    else if (kitsPercent >= 70) badgeClass = 'warning';
                    
                    // Check if incomplete kit
                    const vialsPerKit = product.vials_per_kit || 10;
                    const remainingVials = (product.total_vials || 0) % vialsPerKit;
                    const isIncomplete = remainingVials > 0 && product.total_vials > 0;
                    
                    return `
                        <tr data-code="${product.code}" class="${isIncomplete ? 'incomplete-kit' : ''}">
                            <td>${product.name}</td>
                            <td><span class="product-code">${product.code}</span></td>
                            <td><span class="kits-badge ${badgeClass}">${product.kits_generated} / ${product.max_kits}</span></td>
                            <td>${product.total_vials}</td>
                            <td>
                                <input type="number" class="max-kits-input" 
                                       value="${product.max_kits}" 
                                       onchange="updateMaxKits('${product.code}', this.value)"
                                       min="1">
                            </td>
                            <td>
                                <label class="toggle-switch">
                                    <input type="checkbox" 
                                           ${product.is_locked ? 'checked' : ''} 
                                           onchange="toggleLock('${product.code}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load Customer Summary
        async function loadCustomerSummary() {
            try {
                const response = await fetch('/api/admin/customer-summary', { credentials: 'same-origin' });
                const customers = await response.json();
                
                const tbody = document.getElementById('customer-summary-tbody');
                
                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">No customers found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = customers.map(customer => {
                    // Determine payment status badge color
                    let paymentStatusClass = 'unpaid';
                    let paymentStatusIcon = '‚è≥';
                    if (customer.payment_status === 'Paid') {
                        paymentStatusClass = 'paid';
                        paymentStatusIcon = '‚úÖ';
                    } else if (customer.payment_status === 'Partially Paid') {
                        paymentStatusClass = 'partial';
                        paymentStatusIcon = 'üîÑ';
                    } else if (customer.payment_status === 'Waiting for Confirmation') {
                        paymentStatusClass = 'waiting';
                        paymentStatusIcon = '‚è≥';
                    }
                    
                    return `
                        <tr>
                            <td style="font-weight: 500;">${customer.customer_name}</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: #c084fc; font-weight: 600; cursor: pointer; user-select: all; position: relative;" onclick="navigator.clipboard.writeText('${customer.order_numbers}').then(() => { const el = event.target; const original = el.textContent; el.textContent = 'Copied!'; el.style.color = '#10b981'; setTimeout(() => { el.textContent = original; el.style.color = '#c084fc'; }, 1000); })" title="Click to copy order numbers">${customer.order_numbers}</td>
                            <td><span class="payment-badge ${paymentStatusClass}" style="font-size: 0.85rem;">${paymentStatusIcon} ${customer.payment_status}</span></td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: #c084fc; font-weight: 600;">${customer.order_count}</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-weight: 600;">${customer.total_vials}</td>
                            <td style="font-family: 'JetBrains Mono', monospace; color: #7c3aed; font-weight: 700; font-size: 1.1rem;">‚Ç±${customer.total_grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading customer summary:', error);
                document.getElementById('customer-summary-tbody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--accent-rose);">Error loading customer summary</td></tr>';
            }
        }

        // Load Incomplete Kits
        function loadIncompleteKits(products) {
            const incompleteKits = products.filter(product => {
                const totalVials = product.total_vials || 0;
                if (totalVials === 0) return false; // Skip products with no orders
                const vialsPerKit = product.vials_per_kit || 10; // Use product's vials_per_kit, default to 10
                const remainingVials = totalVials % vialsPerKit;
                return remainingVials > 0; // Incomplete if remainder > 0
            });

            const tbody = document.getElementById('incomplete-kits-tbody');
            
            if (incompleteKits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">üéâ All kits are complete! No incomplete kits found.</td></tr>';
                return;
            }

            // Calculate pending vials and sort by pending vials (ascending - least needed first)
            const incompleteKitsWithPending = incompleteKits.map(product => {
                const totalVials = product.total_vials || 0;
                const vialsPerKit = product.vials_per_kit || 10;
                const kitsGenerated = Math.floor(totalVials / vialsPerKit);
                const remainingVials = totalVials % vialsPerKit;
                const pendingVials = vialsPerKit - remainingVials;
                return {
                    ...product,
                    totalVials,
                    kitsGenerated,
                    remainingVials,
                    pendingVials
                };
            });

            // Sort by pending vials (ascending - least needed first)
            incompleteKitsWithPending.sort((a, b) => a.pendingVials - b.pendingVials);

            tbody.innerHTML = incompleteKitsWithPending.map(product => {
                const { totalVials, kitsGenerated, remainingVials, pendingVials } = product;
                const pepHaulers = product.pep_haulers || [];
                
                // Color coding based on vials needed
                let rowBgColor = '';
                let badgeBgColor = '';
                let badgeTextColor = '';
                
                if (pendingVials <= 2) {
                    // Almost complete (1-2 vials) - light green/lilac
                    rowBgColor = 'background: rgba(167, 139, 250, 0.15);';
                    badgeBgColor = 'rgba(167, 139, 250, 0.3)';
                    badgeTextColor = '#7c3aed';
                } else if (pendingVials <= 5) {
                    // Moderate (3-5 vials) - light pink/lilac
                    rowBgColor = 'background: rgba(249, 168, 212, 0.15);';
                    badgeBgColor = 'rgba(249, 168, 212, 0.3)';
                    badgeTextColor = '#ec4899';
                } else if (pendingVials <= 8) {
                    // More needed (6-8 vials) - medium pink
                    rowBgColor = 'background: rgba(244, 114, 182, 0.2);';
                    badgeBgColor = 'rgba(244, 114, 182, 0.35)';
                    badgeTextColor = '#db2777';
                } else {
                    // Far from complete (9 vials) - darker pink
                    rowBgColor = 'background: rgba(244, 114, 182, 0.25);';
                    badgeBgColor = 'rgba(244, 114, 182, 0.4)';
                    badgeTextColor = '#be185d';
                }
                
                // Color palette for username badges (darker, more contrasting colors with glow effect)
                const colorPalette = [
                    { bg: 'rgba(124, 58, 237, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(124, 58, 237, 0.5)' }, // Dark purple with glow
                    { bg: 'rgba(139, 92, 246, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(139, 92, 246, 0.5)' }, // Deep purple with glow
                    { bg: 'rgba(168, 85, 247, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(168, 85, 247, 0.5)' }, // Rich purple with glow
                    { bg: 'rgba(219, 39, 119, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(219, 39, 119, 0.5)' }, // Dark rose with glow
                    { bg: 'rgba(236, 72, 153, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(236, 72, 153, 0.5)' }, // Deep pink with glow
                    { bg: 'rgba(190, 24, 93, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(190, 24, 93, 0.5)' }, // Dark pink with glow
                    { bg: 'rgba(147, 51, 234, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(147, 51, 234, 0.5)' }, // Violet with glow
                    { bg: 'rgba(107, 33, 168, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(107, 33, 168, 0.5)' }, // Dark violet with glow
                    { bg: 'rgba(79, 70, 229, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(79, 70, 229, 0.5)' }, // Indigo with glow
                    { bg: 'rgba(99, 102, 241, 0.4)', text: '#ffffff', shadow: '0 0 8px rgba(99, 102, 241, 0.5)' }, // Blue-purple with glow
                ];
                
                // Assign color based on username hash for consistency
                const getColorForUsername = (username) => {
                    let hash = 0;
                    for (let i = 0; i < username.length; i++) {
                        hash = username.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const index = Math.abs(hash) % colorPalette.length;
                    return colorPalette[index];
                };
                
                // Format pep haulers as badges with unique colors
                const pepHaulersHtml = pepHaulers.length > 0 
                    ? pepHaulers.map(username => {
                        const color = getColorForUsername(username);
                        return `<span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: ${color.bg}; color: ${color.text}; margin: 0.125rem; text-shadow: ${color.shadow}; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">@${username}</span>`;
                    }).join('')
                    : '<span style="color: var(--text-muted); font-size: 0.85rem;">‚Äî</span>';
                
                return `
                    <tr class="incomplete-kit" style="${rowBgColor}">
                        <td style="font-weight: 500; text-align: center;">${product.name}</td>
                        <td style="text-align: center;"><span class="product-code">${product.code}</span></td>
                        <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600; text-align: center;">${totalVials}</td>
                        <td style="text-align: center;"><span class="kits-badge normal">${kitsGenerated}</span></td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: #ec4899; font-weight: 600; text-align: center;">${remainingVials}</td>
                        <td style="text-align: center;">
                            <span class="kits-badge incomplete" style="font-size: 0.9rem; background: ${badgeBgColor}; color: ${badgeTextColor}; font-weight: 600;">
                                ${pendingVials} vial${pendingVials !== 1 ? 's' : ''} needed
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: center;">
                                ${pepHaulersHtml}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load Completed Kits
        function loadCompletedKits(products) {
            // Filter products with completed kits (kits_generated > 0)
            const completedKits = products.filter(product => {
                const kitsGenerated = product.kits_generated || 0;
                return kitsGenerated > 0;
            });

            if (completedKits.length === 0) {
                const tbody = document.getElementById('completed-kits-tbody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-muted);">No completed kits yet</td></tr>';
                return;
            }

            // Separate BAC Water products (BA03, BA05, BA10) from others
            const bacWaterCodes = ['BA03', 'BA05', 'BA10'];
            const regularProducts = [];
            const bacWaterProducts = [];

            completedKits.forEach(product => {
                if (bacWaterCodes.includes(product.code)) {
                    bacWaterProducts.push(product);
                } else {
                    regularProducts.push(product);
                }
            });

            // Sort regular products by kits_generated descending (most kits first)
            regularProducts.sort((a, b) => (b.kits_generated || 0) - (a.kits_generated || 0));
            
            // Sort BAC Water products by kits_generated descending
            bacWaterProducts.sort((a, b) => (b.kits_generated || 0) - (a.kits_generated || 0));

            // Combine: regular products first, then BAC Water products at bottom
            const sortedProducts = [...regularProducts, ...bacWaterProducts];

            // Find max kits for gradient calculation
            const maxKits = Math.max(...sortedProducts.map(p => p.kits_generated || 0), 1);

            const tbody = document.getElementById('completed-kits-tbody');
            tbody.innerHTML = sortedProducts.map((product, index) => {
                const kitsGenerated = product.kits_generated || 0;
                const totalVials = product.total_vials || 0;
                
                // Calculate gradient intensity (0 to 1) based on kits_generated
                // Darker gradient for more kits
                const intensity = Math.min(kitsGenerated / maxKits, 1);
                
                // Create gradient from light purple to dark purple/pink
                // More kits = darker color
                const r = Math.floor(167 - (intensity * 50)); // Start at 167 (light purple), go darker
                const g = Math.floor(139 - (intensity * 30)); // Start at 139, go darker
                const b = Math.floor(250 - (intensity * 80)); // Start at 250, go darker
                
                // Background gradient - darker for more kits
                const bgColor = `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.3})`; // 0.3 to 0.6 opacity
                const textColor = intensity > 0.6 ? '#ffffff' : '#7c3aed'; // White text for dark backgrounds
                
                // Check if this is a BAC Water product (for visual separation)
                const isBacWater = bacWaterCodes.includes(product.code);
                const separatorStyle = isBacWater && index === regularProducts.length 
                    ? 'border-top: 3px solid rgba(167, 139, 250, 0.5);' 
                    : '';

                return `
                    <tr class="completed-kit-row" style="background: ${bgColor}; ${separatorStyle}" data-kits="${kitsGenerated}" data-code="${product.code}">
                        <td style="font-weight: 500; text-align: center; color: ${textColor};">
                            ${product.name}
                            ${isBacWater ? '<span style="font-size: 0.75rem; opacity: 0.8;"> (BAC Water)</span>' : ''}
                        </td>
                        <td style="text-align: center;">
                            <span class="product-code" style="color: ${textColor};">${product.code}</span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; color: ${textColor};">
                                ${kitsGenerated}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${textColor};">
                                ${totalVials}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Make table easy to copy (add copy functionality hint)
            const table = document.getElementById('completed-kits-table');
            if (table) {
                table.style.cursor = 'default';
                // Add title attribute for copy hint
                table.title = 'Click and drag to select rows, then copy (Ctrl+C / Cmd+C) to paste into spreadsheet';
            }
        }

        // Toggle Lock
        async function toggleLock(productCode, isLocked) {
            try {
                const response = await fetch('/api/admin/lock-product', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_code: productCode, is_locked: isLocked })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(isLocked ? 'Product locked' : 'Product unlocked');
                    loadProducts();
                } else {
                    showToast('Failed to update');
                }
            } catch (error) {
                showToast('Error updating lock status');
            }
        }

        // Lock/Unlock All Products
        async function lockAllProducts(isLocked) {
            try {
                // Get all products
                const response = await fetch('/api/admin/products', { credentials: 'same-origin' });
                const products = await response.json();
                
                if (products.length === 0) {
                    showToast('No products found');
                    return;
                }
                
                // Confirm action
                const action = isLocked ? 'lock' : 'unlock';
                if (!confirm(`Are you sure you want to ${action} all ${products.length} products?`)) {
                    return;
                }
                
                // Show loading message
                showToast(`‚è≥ ${action.charAt(0).toUpperCase() + action.slice(1)}ing ${products.length} products...`);
                
                // Extract product codes
                const productCodes = products.map(p => p.code);
                
                // Use bulk endpoint instead of individual calls
                try {
                    const bulkResponse = await fetch('/api/admin/products/bulk-lock', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            product_codes: productCodes,
                            is_locked: isLocked
                        })
                    });
                    
                    if (!bulkResponse.ok) {
                        const errorData = await bulkResponse.json();
                        throw new Error(errorData.error || 'Failed to update products');
                    }
                    
                    const result = await bulkResponse.json();
                    
                    // Reload products to reflect changes
                    loadProducts();
                    
                    if (result.failed_count === 0) {
                        showToast(`‚úÖ Successfully ${action}ed all ${result.success_count} products`);
                    } else {
                        const failedMsg = result.failed_products ? ` (Failed: ${result.failed_products.join(', ')})` : '';
                        showToast(`‚ö†Ô∏è ${action}ed ${result.success_count} products, ${result.failed_count} failed${failedMsg}`);
                    }
                } catch (error) {
                    console.error(`Error bulk ${action}ing products:`, error);
                    showToast(`Error ${action}ing products: ${error.message}`);
                }
            } catch (error) {
                console.error('Error locking/unlocking all products:', error);
                showToast('Error updating products');
            }
        }
        
        // Expose lockAllProducts to global scope
        window.lockAllProducts = lockAllProducts;

        // Update Max Kits
        async function updateMaxKits(productCode, maxKits) {
            try {
                const response = await fetch('/api/admin/lock-product', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_code: productCode, is_locked: false, max_kits: parseInt(maxKits) })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Max kits updated');
                    loadProducts();
                }
            } catch (error) {
                showToast('Error updating max kits');
            }
        }

        // Search
        document.getElementById('product-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#products-tbody tr').forEach(row => {
                const code = row.dataset.code.toLowerCase();
                const name = row.querySelector('td').textContent.toLowerCase();
                row.style.display = (code.includes(query) || name.includes(query)) ? '' : 'none';
            });
        });

        // Toast
        function showToast(message) {
            document.getElementById('toast-message').textContent = message;
            document.getElementById('toast').classList.add('show');
            setTimeout(() => document.getElementById('toast').classList.remove('show'), 3000);
        }

        // ===== ORDERS MANAGEMENT =====
        let allOrders = [];

        async function loadOrders() {
            try {
                console.log('üìä Admin: Fetching orders from /api/admin/orders...');
                const response = await fetch('/api/admin/orders', { credentials: 'same-origin' });
                console.log('üìä Admin: Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('üìä Admin: Response not OK:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('üìä Admin: Error response:', errorText);
                    return;
                }
                
                const orders = await response.json();
                console.log('üìä Admin: Received orders:', orders.length, 'orders');
                console.log('üìä Admin: Orders data:', orders);
                
                if (orders.length === 0) {
                    console.warn('üìä Admin: WARNING - No orders returned from API!');
                } else {
                    console.log('üìä Admin: Sample order:', orders[0]);
                }
                
                allOrders = orders;
                renderOrders(orders);
            } catch (error) {
                console.error('üìä Admin: Error loading orders:', error);
                console.error('üìä Admin: Error stack:', error.stack);
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            
            console.log('üìä Admin: renderOrders called with', orders.length, 'orders');
            
            if (!orders || orders.length === 0) {
                console.warn('üìä Admin: No orders to render');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--text-muted);">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                // Safety check for items
                const items = order.items || [];
                const itemsPreview = items.length > 0 
                    ? items.map(i => `${i.product_code || 'N/A'} (${i.qty || 0})`).join(', ')
                    : 'No items';
                const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
                const isWaitingForConfirmation = order.payment_status && order.payment_status.toLowerCase() === 'waiting for confirmation';
                const isLocked = order.locked === true;
                const isNonEditableDueToPayment = isPaid || isWaitingForConfirmation;
                const showUnlockButton = isLocked || isNonEditableDueToPayment;
                
                return `
                    <tr data-order-id="${order.order_id}" class="${isLocked ? 'locked-order' : ''}">
                        <td><input type="checkbox" class="order-checkbox" value="${order.order_id}" onchange="updateBulkActions()" style="cursor: pointer;"></td>
                        <td><span class="product-code">${order.order_id}</span></td>
                        <td style="font-size: 0.85rem;">${order.order_date}</td>
                        <td>
                            <div style="font-weight: 500;">${order.full_name}</div>
                            <div style="font-size: 0.8rem; color: #c084fc; font-family: 'JetBrains Mono', monospace;">${order.telegram ? '@' + order.telegram.replace('@', '') : '‚Äî'}</div>
                        </td>
                        <td><div class="order-items-preview">${itemsPreview.length > 30 ? itemsPreview.substring(0, 30) + '...' : itemsPreview}</div></td>
                        <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                        <td><span class="payment-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span></td>
                        <td>
                            ${isLocked 
                                ? '<span style="color: #ec4899; font-weight: 600;">üîí Locked</span>'
                                : '<span style="color: #7c3aed; font-weight: 600;">üîì Open</span>'}
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-sm btn-view" onclick="viewOrderDetails('${order.order_id}')">View</button>
                                ${!isPaid && !isLocked 
                                    ? `<button class="btn-sm" style="background: #c084fc; color: white;" onclick="editOrder('${order.order_id}')" title="Edit order items">‚úèÔ∏è Edit</button>` 
                                    : ''}
                                ${showUnlockButton 
                                    ? `<button class="btn-sm" style="background: #a78bfa; color: white;" onclick="toggleOrderLock('${order.order_id}', false)">üîì Unlock</button>`
                                    : `<button class="btn-sm" style="background: #f472b6; color: white;" onclick="toggleOrderLock('${order.order_id}', true)">üîí Lock</button>`}
                                ${!isPaid 
                                    ? `<button class="btn-sm btn-confirm" onclick="confirmPayment('${order.order_id}')">‚úì Confirm</button>
                                       <button class="btn-sm" style="background: #c084fc; color: white;" onclick="sendReminder('${order.order_id}')">üì≤ Remind</button>` 
                                    : `<button class="btn-sm" style="background: #a78bfa; color: white;" onclick="notifyCustomer('${order.order_id}')">üì± Notify</button>`}
                                <button class="btn-sm" style="background: #f472b6; color: white;" onclick="cancelOrder('${order.order_id}', '${order.telegram || ''}')" title="Cancel order and delete all rows">üóëÔ∏è Cancel</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Reset select all checkbox
            document.getElementById('select-all-orders').checked = false;
            updateBulkActions();
        }

        // Filter orders
        document.getElementById('order-search').addEventListener('input', filterOrders);
        document.getElementById('payment-filter').addEventListener('change', filterOrders);

        function filterOrders() {
            const query = document.getElementById('order-search').value.toLowerCase();
            const paymentFilter = document.getElementById('payment-filter').value;
            
            console.log('üìä Admin: Filtering orders - query:', query, 'paymentFilter:', paymentFilter);
            console.log('üìä Admin: Total orders before filter:', allOrders.length);
            
            let filtered = allOrders.filter(order => {
                const matchesSearch = 
                    order.order_id.toLowerCase().includes(query) ||
                    order.full_name.toLowerCase().includes(query) ||
                    (order.telegram && order.telegram.toLowerCase().includes(query));
                
                const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
                const matchesPayment = 
                    paymentFilter === 'all' ||
                    (paymentFilter === 'paid' && isPaid) ||
                    (paymentFilter === 'unpaid' && !isPaid);
                
                if (!matchesSearch) {
                    console.log(`  Order ${order.order_id}: Filtered out (search mismatch)`);
                }
                if (!matchesPayment) {
                    console.log(`  Order ${order.order_id}: Filtered out (payment filter mismatch - isPaid: ${isPaid}, filter: ${paymentFilter})`);
                }
                
                return matchesSearch && matchesPayment;
            });
            
            console.log('üìä Admin: Orders after filter:', filtered.length);
            renderOrders(filtered);
        }

        // View order details
        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.order_id === orderId);
            if (!order) return;

            const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
            
            const body = document.getElementById('order-modal-body');
            body.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-size: 1.25rem;">${order.order_id}</span>
                        <span class="payment-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${order.order_date}</div>
                </div>
                
                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600;">${order.full_name}</div>
                    ${order.telegram ? `<div style="color: var(--text-muted); font-size: 0.9rem;">@${order.telegram.replace('@', '')}</div>` : ''}
                </div>
                
                <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary);">Order Items</h4>
                <div style="background: var(--bg-input); border-radius: 10px; padding: 0.5rem 1rem; margin-bottom: 1.5rem;">
                    ${order.items.map(item => `
                        <div class="order-item-row">
                            <div>
                                <div style="font-weight: 500;">${item.product_name || item.product_code}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${item.order_type} √ó ${item.qty}</div>
                            </div>
                            <div style="font-family: 'JetBrains Mono', monospace; color: #a78bfa;">
                                ‚Ç±${item.line_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: linear-gradient(135deg, #c084fc, #f472b6); padding: 1rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: white; font-weight: 600;">Grand Total</span>
                    <span style="font-family: 'JetBrains Mono', monospace; color: white; font-size: 1.5rem; font-weight: 700;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
                
                ${order.payment_screenshot ? `
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary);">Payment Screenshot</h4>
                        <a href="${order.payment_screenshot}" target="_blank" class="screenshot-link" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            üì∑ View Payment Screenshot
                        </a>
                    </div>
                ` : ''}
            `;

            const footer = document.getElementById('order-modal-footer');
            const isLocked = order.locked === true;
            footer.innerHTML = `
                ${!isPaid && !isLocked ? `<button class="btn" style="padding: 0.75rem 1.5rem; background: #c084fc; color: white;" onclick="editOrder('${order.order_id}'); closeOrderModal();">‚úèÔ∏è Edit Order</button>` : ''}
                ${!isPaid ? `<button class="btn btn-violet" style="padding: 0.75rem 1.5rem;" onclick="confirmPayment('${order.order_id}'); closeOrderModal();">‚úì Confirm Payment</button>` : 
                           `<button class="btn" style="padding: 0.75rem 1.5rem; background: #a78bfa; color: white;" onclick="notifyCustomer('${order.order_id}')">üì± Notify Customer</button>`}
                <button class="btn" style="padding: 0.75rem 1.5rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);" onclick="closeOrderModal()">Close</button>
            `;

            document.getElementById('order-modal').classList.add('show');
        }

        // Edit Order
        function editOrder(orderId) {
            const order = allOrders.find(o => o.order_id === orderId);
            if (!order) {
                showToast('Order not found');
                return;
            }

            const isPaid = order.payment_status && order.payment_status.toLowerCase() === 'paid';
            const isLocked = order.locked === true;
            
            if (isPaid || isLocked) {
                showToast(isPaid ? 'Cannot edit paid orders' : 'Cannot edit locked orders. Unlock first.');
                return;
            }

            const body = document.getElementById('order-modal-body');
            body.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-size: 1.25rem;">${order.order_id}</span>
                        <span class="payment-badge ${order.payment_status.toLowerCase().replace(/\s+/g, '-').replace('waiting-for-confirmation', 'waiting')}">${order.payment_status}</span>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${order.order_date}</div>
                </div>
                
                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600;">${order.full_name}</div>
                    ${order.telegram ? `<div style="color: var(--text-muted); font-size: 0.9rem;">@${order.telegram.replace('@', '')}</div>` : ''}
                </div>
                
                <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary);">Edit Order Items</h4>
                <div style="background: var(--bg-input); border-radius: 10px; padding: 0.5rem 1rem; margin-bottom: 1.5rem;">
                    ${order.items.map((item, idx) => `
                        <div class="order-item-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${item.product_name || item.product_code}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${item.order_type}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <button class="btn-sm" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="updateItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', ${item.qty - 1})">‚àí</button>
                                    <input type="number" id="qty-${order.order_id}-${idx}" value="${item.qty}" min="0" style="width: 60px; padding: 0.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); text-align: center; font-family: 'JetBrains Mono', monospace;" onchange="updateItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', parseInt(this.value) || 0)">
                                    <button class="btn-sm" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="updateItemQty('${order.order_id}', '${item.product_code}', '${item.order_type}', ${item.qty + 1})">+</button>
                                </div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: #a78bfa; min-width: 100px; text-align: right;">
                                    ‚Ç±${item.line_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: linear-gradient(135deg, #c084fc, #f472b6); padding: 1rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: white; font-weight: 600;">Grand Total</span>
                    <span style="font-family: 'JetBrains Mono', monospace; color: white; font-size: 1.5rem; font-weight: 700;">‚Ç±${order.grand_total_php.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                </div>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(192, 132, 252, 0.1); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                    üí° Changes will be saved automatically. The order total will be recalculated after updates.
                </div>
            `;

            const footer = document.getElementById('order-modal-footer');
            footer.innerHTML = `
                <button class="btn" style="padding: 0.75rem 1.5rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);" onclick="closeOrderModal(); loadOrders(); loadProducts();">Close</button>
            `;

            document.getElementById('order-modal').classList.add('show');
        }

        // Update item quantity in order
        async function updateItemQty(orderId, productCode, orderType, newQty) {
            if (newQty < 0) newQty = 0;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/update-item`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_code: productCode,
                        order_type: orderType,
                        qty: newQty
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Updated ${productCode} (${orderType}) to ${newQty}`);
                    // Reload orders and products to reflect changes
                    await loadOrders();
                    await loadProducts();
                    // Refresh the edit modal if it's open
                    const order = allOrders.find(o => o.order_id === orderId);
                    if (order && document.getElementById('order-modal').classList.contains('show')) {
                        editOrder(orderId);
                    }
                } else {
                    showToast(result.error || 'Failed to update item');
                }
            } catch (error) {
                console.error('Error updating item:', error);
                showToast('Error updating item');
            }
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('show');
        }

        // Confirm payment
        async function confirmPayment(orderId) {
            if (!confirm(`Are you sure you want to mark order ${orderId} as PAID?`)) return;
            
            try {
                const response = await fetch('/api/admin/confirm-payment', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Payment confirmation failed:', response.status, errorText);
                    showToast(`Failed to confirm payment (${response.status})`);
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    showToast('Payment confirmed! ‚úÖ');
                    loadOrders();
                    // Close modal if open
                    const orderModal = document.getElementById('order-modal');
                    if (orderModal && orderModal.classList.contains('show')) {
                        closeOrderModal();
                    }
                } else {
                    showToast(result.error || 'Failed to confirm payment');
                }
            } catch (error) {
                console.error('Error confirming payment:', error);
                showToast('Error confirming payment. Please try again.');
            }
        }
        
        // Expose confirmPayment to global scope
        window.confirmPayment = confirmPayment;

        // ===== ORDER LOCKING FUNCTIONS =====
        
        // Toggle select all checkbox
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActions();
        }
        
        // Update bulk actions visibility based on selection
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (checkboxes.length > 0) {
                bulkActions.style.display = 'block';
                selectedCount.textContent = checkboxes.length;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        // Clear all selections
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('select-all-orders').checked = false;
            updateBulkActions();
        }
        
        // Lock/unlock a single order
        async function toggleOrderLock(orderId, isLocked) {
            const action = isLocked ? 'lock' : 'unlock';
            if (!confirm(`Are you sure you want to ${action} order ${orderId}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/lock`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locked: isLocked })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Order ${isLocked ? 'locked' : 'unlocked'} successfully!`);
                    loadOrders(); // Reload to reflect changes
                } else {
                    showToast(result.error || `Failed to ${action} order`);
                }
            } catch (error) {
                console.error(`Error ${action}ing order:`, error);
                showToast(`Error ${action}ing order`);
            }
        }
        
        // Bulk lock/unlock orders
        async function bulkLockOrders(isLocked) {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const orderIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (orderIds.length === 0) {
                showToast('‚ö†Ô∏è No orders selected');
                return;
            }
            
            const action = isLocked ? 'lock' : 'unlock';
            if (!confirm(`Are you sure you want to ${action} ${orderIds.length} order(s)?`)) return;
            
            try {
                const response = await fetch('/api/admin/orders/bulk-lock', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        order_ids: orderIds,
                        locked: isLocked
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ ${result.message}`);
                    clearSelection();
                    loadOrders(); // Reload to reflect changes
                } else {
                    showToast(result.error || `Failed to ${action} orders`);
                }
            } catch (error) {
                console.error(`Error bulk ${action}ing orders:`, error);
                showToast(`Error bulk ${action}ing orders`);
            }
        }

        // Notify customer via Telegram (for paid orders)
        async function notifyCustomer(orderId) {
            if (!confirm(`Send payment confirmation notification to customer via Telegram for order ${orderId}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/notify-customer`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(`‚úÖ Notification sent to customer via Telegram!`);
                } else if (result.error && result.telegram_handle && result.bot_username) {
                    // Customer hasn't messaged the bot yet
                    showToast(`‚ö†Ô∏è Customer @${result.telegram_handle} hasn't messaged @${result.bot_username} yet`, 5000);
                    alert(`Customer @${result.telegram_handle} needs to message @${result.bot_username} first to receive notifications.\n\nPlease ask them to start a chat with the bot.`);
                } else {
                    showToast(result.error || 'Failed to send notification');
                }
            } catch (error) {
                console.error('Error sending notification:', error);
                showToast('Error sending notification');
            }
        }

        // Send payment reminder
        async function sendReminder(orderId) {
            if (!confirm(`Send payment reminder via Telegram for order ${orderId}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/send-reminder`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('‚úÖ Reminder sent via Telegram!');
                } else {
                    // Show detailed error message
                    const errorMsg = result.error || 'Failed to send reminder';
                    const detailMsg = result.message || '';
                    
                    if (detailMsg) {
                        alert(`‚ùå ${errorMsg}\n\n${detailMsg}`);
                    } else {
                        showToast(`‚ö†Ô∏è ${errorMsg}`);
                    }
                    
                    console.error('Reminder error:', result);
                }
            } catch (error) {
                console.error('Error sending reminder:', error);
                showToast('‚ùå Error sending reminder - check console');
            }
        }

        // Close modal on background click
        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.id === 'order-modal') {
                closeOrderModal();
            }
        });


        // Cancel order function
        async function cancelOrder(orderId, telegramUsername) {
            const telegram = telegramUsername || '';
            const telegramDisplay = telegram ? ` (@${telegram.replace('@', '')})` : '';
            
            if (!confirm(`‚ö†Ô∏è Are you sure you want to CANCEL order ${orderId}${telegramDisplay}?\n\nThis will:\n- Delete ALL rows matching this order ID\n- Delete ALL rows matching the telegram username\n- Recalculate inventory automatically\n- This action CANNOT be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/orders/${orderId}/cancel`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        telegram_username: telegram 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`‚úÖ Order ${orderId} cancelled and all rows deleted! Inventory recalculated.`);
                    // Reload orders and products to reflect changes
                    await loadOrders();
                    await loadProducts();
                    if (document.getElementById('order-modal').classList.contains('show')) {
                        closeOrderModal(); // Close modal if open
                    }
                } else {
                    showToast(result.error || 'Failed to cancel order');
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                showToast('‚ùå Error cancelling order - check console');
            }
        }

        // Auto-boot on page load (if session is already logged in)
        document.addEventListener('DOMContentLoaded', bootAdmin);
    </script>
</body>
</html>

